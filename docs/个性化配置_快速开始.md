# 个性化配置功能 - 快速开始指南

## 🚀 5分钟快速部署

### 步骤1：数据库迁移

```bash
# 方式1: 使用SQL脚本
cd backend/migrations
mysql -u root -p emotional_chat < add_personalization_table.sql

# 方式2: 使用Python创建（如果有create_tables函数）
cd backend
python -c "from database import create_tables; create_tables()"
```

### 步骤2：启动后端服务

```bash
cd backend
python main.py

# 服务启动后，访问API文档
# http://localhost:8000/docs
```

### 步骤3：启动前端服务

```bash
cd frontend
npm install  # 如果是首次运行
npm start

# 前端启动后，访问
# http://localhost:3000
```

### 步骤4：测试个性化配置

1. 打开浏览器访问 `http://localhost:3000`
2. 点击左侧边栏的"个性化配置"按钮
3. 选择一个角色模板（如"智慧导师"）
4. 调整风格参数
5. 点击"保存配置"
6. 发送消息测试AI回复

## 🧪 API测试

### 测试1：获取角色模板

```bash
curl http://localhost:8000/api/personalization/templates
```

**期望输出**：
```json
[
  {
    "id": "warm_listener",
    "name": "温暖倾听者",
    "icon": "❤️",
    ...
  }
]
```

### 测试2：获取用户配置

```bash
curl http://localhost:8000/api/personalization/config/test_user
```

**期望输出**：
```json
{
  "user_id": "test_user",
  "config": {
    "role": "温暖倾听者",
    "role_name": "心语",
    ...
  },
  "is_default": true
}
```

### 测试3：更新配置

```bash
curl -X POST http://localhost:8000/api/personalization/config/test_user \
  -H "Content-Type: application/json" \
  -d '{
    "role": "智慧导师",
    "role_name": "智者",
    "tone": "沉稳",
    "empathy_level": 0.7
  }'
```

**期望输出**：
```json
{
  "user_id": "test_user",
  "config": {
    "role": "智慧导师",
    "role_name": "智者",
    ...
  },
  "is_default": false
}
```

### 测试4：应用模板

```bash
curl -X POST "http://localhost:8000/api/personalization/config/test_user/apply-template?template_id=wise_mentor"
```

### 测试5：预览Prompt

```bash
curl "http://localhost:8000/api/personalization/preview/test_user?context=今天很开心&emotion=happy&intensity=8"
```

**期望输出**：
```json
{
  "user_id": "test_user",
  "config_summary": {
    "role": "智慧导师",
    "tone": "沉稳",
    ...
  },
  "prompt": "你是'智者'，一位智慧导师..."
}
```

## 🎯 功能验证清单

- [ ] 数据库表创建成功
- [ ] 后端API正常运行
- [ ] 前端界面正常显示
- [ ] 可以打开个性化配置面板
- [ ] 可以查看5个角色模板
- [ ] 可以应用角色模板
- [ ] 可以调整风格滑块
- [ ] 可以保存配置
- [ ] 配置可以正常读取

## 🐛 常见问题排查

### 问题1：数据库表不存在

**症状**：API返回数据库错误

**解决**：
```bash
cd backend/migrations
mysql -u root -p emotional_chat < add_personalization_table.sql
```

### 问题2：前端无法连接后端

**症状**：前端显示"加载配置失败"

**检查**：
1. 后端是否正常运行（访问 http://localhost:8000/health）
2. CORS是否正确配置
3. 检查浏览器控制台的网络请求

**解决**：
```javascript
// 检查 frontend/src/components/PersonalizationPanel.js 中的API_BASE
const API_BASE = 'http://localhost:8000';
```

### 问题3：配置无法保存

**症状**：点击保存后提示失败

**检查**：
1. 检查后端日志
2. 检查数据库连接
3. 验证数据格式

**调试**：
```bash
# 查看后端日志
cd backend
python main.py  # 观察控制台输出
```

### 问题4：角色模板不显示

**症状**：配置面板中角色卡片为空

**检查**：
```bash
# 测试API
curl http://localhost:8000/api/personalization/templates

# 应该返回5个模板
```

**解决**：
- 确保 `backend/services/prompt_composer.py` 中的 `ROLE_TEMPLATES` 定义正确
- 重启后端服务

## 📊 性能优化建议

### 1. 启用配置缓存

配置已自动缓存在内存中，但可以进一步优化：

```python
# backend/services/personalization_service.py
# 可以添加Redis缓存替代内存缓存
```

### 2. 数据库索引

确保user_id字段有索引：

```sql
CREATE INDEX idx_user_id ON user_personalizations(user_id);
```

### 3. 前端缓存

在前端localStorage中缓存配置：

```javascript
// 保存到localStorage
localStorage.setItem('user_config', JSON.stringify(config));

// 下次访问时优先从localStorage读取
```

## 🔐 安全建议

### 1. API访问控制

添加认证中间件：

```python
# backend/routers/personalization.py
@router.get("/config/{user_id}", dependencies=[Depends(verify_user)])
async def get_user_config(user_id: str):
    # 验证用户权限
    pass
```

### 2. 输入验证

确保所有用户输入都经过验证：

```python
# 限制字符串长度
role_name: str = Field(..., min_length=1, max_length=100)

# 限制数值范围
formality: float = Field(..., ge=0, le=1)
```

### 3. 敏感词过滤

对用户自定义内容进行过滤：

```python
def filter_sensitive_words(text: str) -> str:
    """过滤敏感词"""
    # 实现敏感词过滤逻辑
    return text
```

## 📈 监控和日志

### 启用详细日志

```python
# backend/logging_config.py
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
```

### 监控关键指标

```python
# 监控配置更新频率
logger.info(f"用户 {user_id} 更新配置，版本: {config_version}")

# 监控API响应时间
import time
start = time.time()
# ... 处理请求
logger.info(f"请求耗时: {time.time() - start:.3f}s")
```

## 🎓 下一步

1. **集成到对话流程**
   - 参考 `backend/services/chat_service_integration_example.py`
   - 修改 `backend/services/chat_service.py`

2. **启用学习模式**
   - 收集用户反馈
   - 自动调整配置参数

3. **添加更多角色模板**
   - 在 `backend/services/prompt_composer.py` 中添加新模板
   - 设计独特的角色人格

4. **实现情境化角色**
   - 基于时间自动切换角色
   - 基于情绪状态调整表达风格

5. **开发角色工坊**
   - 允许用户创建自定义角色
   - 支持角色分享和导入

## 📚 参考资料

- [完整文档](./个性化配置功能文档.md)
- [API文档](http://localhost:8000/docs)
- [示例代码](../backend/services/chat_service_integration_example.py)
- [数据库迁移](../backend/migrations/add_personalization_table.sql)

## 💬 反馈与支持

如有问题或建议，请：
1. 查看[完整文档](./个性化配置功能文档.md)中的常见问题
2. 提交[GitHub Issue](https://github.com/your-repo/issues)
3. 加入社区讨论

---

**祝你使用愉快！** 🎉

让每一个AI，都成为"你的AI"。

