# 响应生成模块 - 技术架构说明

## 整体架构概览

```
┌─────────────────────────────────────────────────────────────┐
│                     用户输入处理层                            │
│  enhanced_input_processor.py - 预处理、纠错、风险检测        │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                     情感分析层                                │
│  emotion_analyzer.py - 识别情绪类型和强度                    │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
┌─────────────────────────────────────────────────────────────┐
│                 响应生成核心层 (本模块)                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │         ResponseGenerator                            │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │  1. 危机检测 → 规则引擎                      │   │   │
│  │  │     - 高风险关键词识别                       │   │   │
│  │  │     - 预设危机干预话术                       │   │   │
│  │  │     - 热线电话推荐                           │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │  2. 缓存匹配 → 快速响应                      │   │   │
│  │  │     - 问候语（你好/在吗）                    │   │   │
│  │  │     - 道别语（再见/晚安）                    │   │   │
│  │  │     - 感谢语（谢谢）                         │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │  3. LLM生成 → 主要路径                       │   │   │
│  │  │  ┌────────────────────────────────────────┐  │   │   │
│  │  │  │ DynamicPromptBuilder                   │  │   │   │
│  │  │  │ - 加载情感策略配置                     │  │   │   │
│  │  │  │ - 注入情绪状态                         │  │   │   │
│  │  │  │ - 融合对话历史                         │  │   │   │
│  │  │  │ - 融合用户记忆                         │  │   │   │
│  │  │  │ - 添加Few-shot示例                     │  │   │   │
│  │  │  └────────────────────────────────────────┘  │   │   │
│  │  │  ┌────────────────────────────────────────┐  │   │   │
│  │  │  │ LLM调用                                │  │   │   │
│  │  │  │ - QWen / 其他模型                    │  │   │   │
│  │  │  └────────────────────────────────────────┘  │   │   │
│  │  │  ┌────────────────────────────────────────┐  │   │   │
│  │  │  │ 后处理                                 │  │   │   │
│  │  │  │ - 去除前缀                             │  │   │   │
│  │  │  │ - 长度控制                             │  │   │   │
│  │  │  │ - 身份暴露检测                         │  │   │   │
│  │  │  └────────────────────────────────────────┘  │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │  4. 一致性校验 → 质量保障                    │   │   │
│  │  │  ┌────────────────────────────────────────┐  │   │   │
│  │  │  │ SentimentClassifier                    │  │   │   │
│  │  │  │ - 检测AI回复情绪                       │  │   │   │
│  │  │  │ - 与用户情绪对比                       │  │   │   │
│  │  │  │ - 禁用词检测                           │  │   │   │
│  │  │  │ - 语气验证                             │  │   │   │
│  │  │  └────────────────────────────────────────┘  │   │   │
│  │  │  校验通过 → 输出                             │   │   │
│  │  │  校验失败 → 降级兜底                         │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  │  ┌──────────────────────────────────────────────┐   │   │
│  │  │  5. 降级策略 → 安全兜底                      │   │   │
│  │  │     - 从策略配置读取fallback                 │   │   │
│  │  │     - 默认安全回复                           │   │   │
│  │  └──────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ↓
                    最终回复输出
```

## 核心组件详解

### 1. ResponseGenerator（响应生成器）

**职责**：
- 统一管理所有响应生成策略
- 协调各个子模块
- 收集统计信息

**决策流程**：
```python
def generate_response():
    1. if 危机情况:
        return 规则引擎回复
    
    2. if 缓存匹配:
        return 缓存回复
    
    3. try:
        prompt = build_dynamic_prompt()
        raw_response = call_llm(prompt)
        processed = post_process(raw_response)
        
        if 一致性校验失败:
            return fallback_response
        
        return processed
    
    4. except:
        return fallback_response
```

### 2. DynamicPromptBuilder（动态Prompt构建器）

**职责**：
- 根据情绪动态生成Prompt
- 融合上下文信息
- 提供示例引导

**Prompt结构**：
```
[系统设定]
- 角色：心语，28岁女性心理陪伴者
- 目标：提供安全、温暖的倾诉空间
- 准则：温和、非评判、不说教

[当前情境]
- 用户情绪：{emotion_label}（如"悲伤"）
- 情绪强度：{intensity}/10
- 共情等级：{empathy_level}（high/medium/low）

[回应策略]
- 目标：{goal}（如"接纳情绪，提供安全感"）
- 语气：{tone}（如"温柔、缓慢、包容"）
- 关键词：{keywords}（如"我理解"、"你并不孤单"）
- 避免词：{avoid_words}（如"振作起来"、"想开点"）

[上下文]
- 情绪强度说明
- 用户偏好（如果有）

[相关记忆]
- 历史对话片段（最多3条）

[参考示例]
- Few-shot示例（最多2个）

[对话历史]
- 最近5轮对话

[用户输入]
{user_input}

[回复要求]
- 语气要求
- 长度限制
- 表情符号使用
```

### 3. SentimentClassifier（情感一致性校验器）

**职责**：
- 检测AI回复的情绪倾向
- 验证与用户情绪的一致性
- 检测禁用词汇和不当表达

**检测逻辑**：
```python
def check_consistency(ai_response, user_emotion):
    1. 检测是否为共情表达
       if "我能感受到你..." or "我理解你...":
           return "reassuring"  # 安抚语气
    
    2. 关键词匹配
       统计各类情绪关键词出现频率
    
    3. 正则模式匹配
       匹配特定情感表达模式
    
    4. 表情符号匹配
       识别表情符号的情感倾向
    
    5. 情感兼容性检查
       if response_emotion in COMPATIBILITY[user_emotion]:
           return True
       
       if (user_emotion, response_emotion) in FORBIDDEN:
           return False
    
    6. 禁用词检查
       if 包含避免词汇:
           return False
```

**情感兼容性矩阵**：
```
用户情绪  →  允许的AI情绪
────────────────────────────
sad       →  calm, neutral, reassuring
anxious   →  calm, reassuring, neutral
angry     →  calm, neutral, reassuring
happy     →  happy, excited, grateful, neutral
excited   →  excited, happy, neutral
confused  →  calm, neutral, reassuring
...
```

## 数据流图

```
┌──────────┐
│用户输入  │
└────┬─────┘
     │
     ↓
┌──────────────────┐
│预处理            │
│- 清洗            │
│- 纠错            │    ┌─────────────────┐
│- 风险检测        │───→│emotion_strategy │
└────┬─────────────┘    │    .yaml        │
     │                  └─────────────────┘
     ↓                           ↓
┌──────────────────┐    ┌─────────────────┐
│情感分析          │    │加载策略配置      │
│- 情绪类型        │    │- 11种情绪策略    │
│- 情绪强度        │    │- 全局配置        │
└────┬─────────────┘    └────┬────────────┘
     │                       │
     └───────┬───────────────┘
             ↓
     ┌────────────────┐
     │PromptBuilder   │
     │构建动态Prompt  │
     └───────┬────────┘
             │
             ↓
     ┌────────────────┐
     │LLM调用         │
     │生成原始回复    │
     └───────┬────────┘
             │
             ↓
     ┌────────────────┐
     │后处理          │
     │- 去前缀        │
     │- 控制长度      │
     └───────┬────────┘
             │
             ↓
     ┌────────────────┐
     │一致性校验      │
     │- 情绪匹配      │
     │- 禁用词检测    │
     └───────┬────────┘
             │
        通过 │ 失败
             ↓
     ┌───────────────┐
     │最终回复       │
     └───────────────┘
```

## 配置文件结构

### emotion_strategy.yaml

```yaml
# 情绪类型配置
{emotion_name}:
  goal: "回应目标"
  tone: "语气要求"
  empathy_level: "high/medium/low"
  keywords: [关键表达词汇列表]
  response_patterns: [回应模式列表]
  avoid_words: [避免词汇列表]
  max_length: 句子数量
  use_emoji: true/false
  emoji_suggestions: [表情符号列表]
  fallback: "兜底回复"
  examples:
    - input: "用户输入示例"
      output: "AI回复示例"

# 全局配置
global_settings:
  intensity_thresholds:
    low: 3
    medium: 6
    high: 10
  
  cached_responses:
    greeting: [问候语列表]
    goodbye: [道别语列表]
    thanks: [感谢语列表]
  
  max_sentence_count: 3
  max_word_count: 100
  
  emoji_usage:
    enabled: true
    max_per_response: 2
    avoid_in_emotions: [angry, high_risk_depression]
```

## 性能指标

### 响应速度
- **缓存命中**：~0ms（内存查找）
- **规则引擎**：~5-10ms（条件判断）
- **LLM生成**：1-3秒（取决于模型）
- **一致性校验**：~10-20ms（规则匹配）

### 准确性保障
- **情感匹配**：通过一致性校验机制
- **危机识别**：100%触发预设回复
- **降级保障**：异常时使用兜底回复

### 资源消耗
- **内存**：策略配置 ~500KB，历史记录按用户累积
- **计算**：主要开销在LLM调用
- **Token消耗**：单次Prompt约500-1500 tokens

## 扩展性设计

### 1. 新增情绪类型
```yaml
# 在emotion_strategy.yaml中添加
my_new_emotion:
  goal: "..."
  tone: "..."
  ...
```

### 2. 自定义LLM客户端
```python
class MyLLMClient:
    def predict(self, prompt: str) -> str:
        # 你的实现
        return response
```

### 3. 添加新的校验规则
```python
class SentimentClassifier:
    def my_custom_check(self, text):
        # 你的校验逻辑
        return is_valid
```

## 监控与调试

### 统计信息
```python
stats = generator.get_statistics()
# {
#   "total_generations": 100,
#   "llm_generated": 70,
#   "cached": 20,
#   "rule_based": 5,
#   "consistency_failures": 5,
#   "llm_rate": 0.70,
#   "cached_rate": 0.20,
#   ...
# }
```

### 日志级别
```python
import logging
logging.basicConfig(level=logging.DEBUG)

# DEBUG: 详细的执行信息
# INFO: 关键步骤信息
# WARNING: 一致性失败、降级使用
# ERROR: 异常情况
```

---

## 总结

该响应生成模块通过**情感驱动的动态生成**、**多层防护机制**和**严格的一致性校验**，实现了：

✅ 情绪精准匹配  
✅ 温暖共情表达  
✅ 危机安全保障  
✅ 高效稳定运行  

这是一个**生产级**的共情式AI对话系统核心组件。

