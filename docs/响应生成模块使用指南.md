# 响应生成模块使用指南

> **从"听懂"到"说好"——让AI真正懂得"共情式回应"**

本文档详细介绍"心语"情感陪伴机器人的响应生成模块的架构设计、使用方法和最佳实践。

---

## 目录

1. [模块概述](#模块概述)
2. [核心架构](#核心架构)
3. [快速开始](#快速开始)
4. [详细使用说明](#详细使用说明)
5. [配置与定制](#配置与定制)
6. [测试与验证](#测试与验证)
7. [最佳实践](#最佳实践)
8. [常见问题](#常见问题)

---

## 模块概述

### 设计理念

响应生成模块是"心语"机器人的核心能力之一，实现了从"感知情绪"到"生成回复"的完整链路。其设计遵循以下原则：

- **情感驱动**：根据用户情绪动态调整回应策略
- **多层防护**：规则引擎 + 缓存 + LLM + 一致性校验
- **人性温暖**：每一次回复都贴合用户情绪，避免机械感
- **安全可控**：危机干预优先，内容校验严格

### 技术特点

| 特性 | 说明 |
|-----|------|
| **动态Prompt生成** | 根据情绪、强度、历史自动构建Prompt |
| **混合生成架构** | 规则/缓存/LLM三层生成策略 |
| **情感一致性校验** | 自动检测回复情绪是否匹配用户 |
| **危机干预机制** | 高风险场景自动触发预设回复 |
| **个性化定制** | 支持用户画像和偏好设置 |

---

## 核心架构

### 模块组成

```
响应生成模块
├── config/
│   └── emotion_strategy.yaml          # 情感策略配置
├── modules/intent/core/
│   ├── response_generator.py          # 核心生成器
│   └── dynamic_prompt_builder.py      # 动态Prompt构建
└── utils/
    └── sentiment_classifier.py        # 情感一致性校验
```

### 处理流程

```
用户输入
    ↓
情感识别 (enhanced_input_processor.py)
    ↓
┌─────────────────────────────────────┐
│      响应生成器 (response_generator)  │
├─────────────────────────────────────┤
│ 1. 危机检测 → 预设回复（如有）       │
│ 2. 缓存匹配 → 固定回复（高频）       │
│ 3. LLM生成 → 动态回复（主路径）      │
│    ├─ 构建动态Prompt                │
│    ├─ 调用大模型                    │
│    ├─ 后处理                        │
│    └─ 一致性校验                    │
│ 4. 降级策略 → 兜底回复（异常时）     │
└─────────────────────────────────────┘
    ↓
AI回复输出
```

---

## 快速开始

### 安装依赖

```bash
# 确保已安装基础依赖
pip install pyyaml

# 可选：如果需要使用高级情感分析
pip install transformers torch
```

### 基础使用

```python
from backend.modules.intent.core.response_generator import ResponseGenerator
from langchain_openai import ChatOpenAI

# 1. 创建LLM客户端
llm_client = ChatOpenAI(
    api_key="your_api_key",
    base_url="https://api.openai.com/v1",
    model_name="gpt-4",
    temperature=0.7
)

# 2. 创建响应生成器
generator = ResponseGenerator(llm_client)

# 3. 生成回复
result = generator.generate_response(
    user_input="我今天被领导批评了，觉得自己一无是处",
    user_emotion="sad",              # 情绪类型
    user_id="user_001",              # 用户ID
    emotion_intensity=7.5            # 情绪强度(0-10)
)

# 4. 获取结果
print(f"AI回复: {result['response']}")
print(f"生成方法: {result['generation_method']}")
print(f"是否有效: {result['is_valid']}")
```

### 运行测试

```bash
# 运行完整测试套件
python test_response_generation.py

# 预期输出：
# ✓ 通过 - 策略配置加载
# ✓ 通过 - 动态Prompt构建
# ✓ 通过 - 情感一致性校验
# ✓ 通过 - 完整响应生成
# ✓ 通过 - 危机干预触发
# ✓ 通过 - 缓存回复匹配
```

---

## 详细使用说明

### 1. 响应生成器 (ResponseGenerator)

#### 初始化参数

```python
generator = ResponseGenerator(
    llm_client,                          # LLM客户端（必需）
    strategy_file="config/emotion_strategy.yaml",  # 策略文件路径
    enable_consistency_check=True,       # 是否启用一致性检查
    enable_cache=True                    # 是否启用缓存
)
```

#### 生成回复

```python
result = generator.generate_response(
    user_input="用户的输入文本",           # 必需
    user_emotion="sad",                  # 必需：情绪类型
    user_id="user_001",                  # 必需：用户ID
    emotion_intensity=7.5,               # 可选：情绪强度(0-10)，默认5.0
    conversation_history=[               # 可选：对话历史
        {"role": "user", "content": "之前的对话..."},
        {"role": "assistant", "content": "AI的回复..."}
    ],
    retrieved_memories=[                 # 可选：检索到的记忆
        {
            "content": "用户上周提到过工作压力大",
            "importance": 0.8,
            "timestamp": "2025-10-11T10:00:00"
        }
    ],
    user_profile={                       # 可选：用户画像
        "preferred_tone": "温柔",
        "avoid_topics": ["家庭"],
        "communication_style": "倾听型"
    },
    metadata={                           # 可选：额外元数据
        "requires_crisis_intervention": False,
        "risk_keywords": []
    }
)
```

#### 返回结果

```python
{
    "response": "我能感受到你现在的低落...",  # 生成的回复文本
    "generation_method": "llm_generated",      # 生成方法
    "is_valid": True,                         # 是否通过校验
    "warnings": [],                           # 警告信息列表
    "metadata": {                             # 元数据
        "user_emotion": "sad",
        "emotion_intensity": 7.5,
        "timestamp": "2025-10-18T..."
    }
}
```

**generation_method 可能的值：**
- `rule_based_crisis`: 规则引擎（危机干预）
- `cached`: 缓存匹配
- `llm_generated`: LLM生成
- `fallback`: 降级兜底
- `fallback_error`: 异常兜底

### 2. 动态Prompt构建器 (DynamicPromptBuilder)

#### 直接使用

```python
from backend.modules.intent.core.dynamic_prompt_builder import DynamicPromptBuilder
import yaml

# 加载策略
with open("config/emotion_strategy.yaml", 'r') as f:
    strategy = yaml.safe_load(f)

# 创建构建器
builder = DynamicPromptBuilder(strategy)

# 构建完整Prompt
prompt = builder.build_prompt(
    user_input="我今天很焦虑",
    emotion="anxious",
    emotion_intensity=6.5,
    conversation_history=[...],
    retrieved_memories=[...],
    user_profile={...}
)

# 构建简化Prompt（快速响应）
simple_prompt = builder.build_simple_prompt(
    user_input="我今天很焦虑",
    emotion="anxious"
)
```

#### Prompt模板自定义

可以通过修改 `DynamicPromptBuilder` 类中的模板常量来定制Prompt：

```python
# 修改基础系统Prompt
builder.BASE_SYSTEM_TEMPLATE = """
# 你的自定义角色设定
...
"""

# 修改情感驱动模板
builder.EMOTION_DRIVEN_TEMPLATE = """
...
"""
```

### 3. 情感一致性校验器 (SentimentClassifier)

#### 基础校验

```python
from backend.utils.sentiment_classifier import SentimentClassifier

classifier = SentimentClassifier()

# 检查情感一致性
is_consistent, reason = classifier.check_emotion_consistency(
    ai_response="我能感受到你的难过...",
    user_emotion="sad"
)

print(f"是否一致: {is_consistent}")
print(f"原因: {reason}")
```

#### 综合检查

```python
result = classifier.comprehensive_check(
    ai_response="哈哈，这有什么好难过的！",
    user_emotion="sad",
    expected_tone="温柔"
)

print(f"是否有效: {result['is_valid']}")
print(f"情绪一致: {result['emotion_consistent']}")
print(f"包含禁用词: {result['has_forbidden']}")
print(f"语气符合: {result['tone_valid']}")
print(f"警告信息: {result['warnings']}")
```

#### 便捷函数

```python
from backend.utils.sentiment_classifier import (
    check_emotion_consistency,
    validate_response
)

# 快速检查
is_ok = check_emotion_consistency(ai_response, user_emotion)

# 完整验证
is_valid, warnings = validate_response(
    ai_response, 
    user_emotion, 
    expected_tone="温柔"
)
```

---

## 配置与定制

### 情感策略配置 (emotion_strategy.yaml)

#### 添加新情绪类型

```yaml
# 在 emotion_strategy.yaml 中添加
my_new_emotion:
  goal: "回应目标"
  tone: "语气要求"
  empathy_level: "high"  # high/medium/low
  keywords:
    - "关键词1"
    - "关键词2"
  response_patterns:
    - "回应模式1"
    - "回应模式2"
  avoid_words:
    - "避免词1"
  max_length: 3
  use_emoji: true
  emoji_suggestions: ["😊", "💖"]
  fallback: "兜底回复"
  examples:
    - input: "用户输入示例"
      output: "AI回复示例"
```

#### 修改全局配置

```yaml
global_settings:
  # 情绪强度阈值
  intensity_thresholds:
    low: 3
    medium: 6
    high: 10
  
  # 缓存回复
  cached_responses:
    greeting:
      - "你好！我是心语😊"
      - "嗨，很高兴见到你！"
    
    goodbye:
      - "再见！保重哦👋"
    
    thanks:
      - "不客气！很高兴帮到你😊"
  
  # 回复长度限制
  max_sentence_count: 3
  max_word_count: 100
  
  # 表情符号使用
  emoji_usage:
    enabled: true
    max_per_response: 2
    avoid_in_emotions: ["angry", "high_risk_depression"]
```

### 自定义LLM客户端

如果使用非OpenAI的模型，需要包装客户端接口：

```python
class CustomLLMClient:
    def __init__(self, your_model):
        self.model = your_model
    
    def predict(self, prompt: str) -> str:
        """必须实现predict方法"""
        response = self.model.generate(prompt)
        return response.text
    
    # 或实现 generate / invoke 方法
    def generate(self, prompt: str) -> str:
        return self.predict(prompt)

# 使用自定义客户端
custom_client = CustomLLMClient(your_model)
generator = ResponseGenerator(custom_client)
```

### 添加用户画像支持

```python
# 定义用户画像结构
user_profile = {
    "preferred_tone": "温柔",          # 偏好语气
    "avoid_topics": ["政治", "宗教"],   # 避免话题
    "communication_style": "倾听型",    # 沟通风格
    "emoji_preference": "moderate",     # 表情符号偏好
    "response_length": "short"          # 回复长度偏好
}

# 传入生成器
result = generator.generate_response(
    user_input="...",
    user_emotion="sad",
    user_id="user_001",
    user_profile=user_profile  # 使用用户画像
)
```

---

## 测试与验证

### 运行完整测试套件

```bash
cd /home/workSpace/emotional_chat
python test_response_generation.py
```

### 单独测试某个功能

```python
# 测试策略加载
python -c "
import yaml
with open('backend/config/emotion_strategy.yaml', 'r') as f:
    strategy = yaml.safe_load(f)
print(f'加载了 {len(strategy)} 个情感策略')
"

# 测试情感校验
python -c "
from backend.utils.sentiment_classifier import check_emotion_consistency
result = check_emotion_consistency('我能感受到你的难过', 'sad')
print(f'一致性检查: {result}')
"
```

### 集成到现有系统

```python
# 在你的主对话逻辑中
from backend.modules.intent.core.enhanced_input_processor import EnhancedInputProcessor
from backend.modules.intent.core.response_generator import ResponseGenerator
from your_emotion_analyzer import EmotionAnalyzer

# 初始化
input_processor = EnhancedInputProcessor()
emotion_analyzer = EmotionAnalyzer()
response_generator = ResponseGenerator(llm_client)

# 处理对话
def handle_user_message(user_input, user_id):
    # 1. 预处理
    processed = input_processor.preprocess(user_input, user_id)
    
    if processed["blocked"]:
        return processed["friendly_message"]
    
    cleaned_input = processed["cleaned"]
    
    # 2. 情感分析
    emotion_data = emotion_analyzer.analyze(cleaned_input)
    
    # 3. 生成回复
    result = response_generator.generate_response(
        user_input=cleaned_input,
        user_emotion=emotion_data["emotion"],
        user_id=user_id,
        emotion_intensity=emotion_data["intensity"],
        metadata=processed["metadata"]
    )
    
    return result["response"]
```

---

## 最佳实践

### 1. 情感策略设计

**✓ 推荐做法：**
- 每种情绪至少提供2个示例
- 明确定义避免使用的词汇
- 设置合理的回复长度（通常3句话以内）
- 根据情绪强度调整共情等级

**✗ 避免：**
- 使用说教性语言（"你应该..."）
- 过度使用表情符号（每次最多2个）
- 回复过长，失去焦点

### 2. Prompt工程

**✓ 推荐做法：**
- 在Prompt中明确角色设定和行为准则
- 提供具体的示例（Few-shot）
- 使用结构化的Prompt模板
- 融合对话历史和记忆

**✗ 避免：**
- Prompt过于简单，缺乏上下文
- 没有明确禁止行为
- 忽略情绪强度信息

### 3. 一致性校验

**✓ 推荐做法：**
- 始终启用情感一致性检查
- 对高风险场景（如危机）使用严格模式
- 定期审查失败案例，优化策略

**✗ 避免：**
- 完全依赖LLM输出，不做校验
- 忽略警告信息
- 过于宽松的校验规则

### 4. 性能优化

**✓ 推荐做法：**
- 启用缓存匹配，减少LLM调用
- 对高频场景使用预设回复
- 监控生成统计，优化策略

**✗ 避免：**
- 每次都调用LLM，即使是简单问候
- 不记录统计信息
- 忽视响应时间

### 5. 安全与伦理

**✓ 推荐做法：**
- 危机干预场景必须使用规则引擎
- 明确告知用户AI的局限性
- 提供专业求助渠道
- 避免给出医疗/法律建议

**✗ 避免：**
- 依赖LLM处理危机情况
- 越界提供专业诊断
- 建立过度依赖关系

---

## 常见问题

### Q1: 如何调整回复的语气？

修改 `emotion_strategy.yaml` 中对应情绪的 `tone` 字段：

```yaml
sad:
  tone: "温柔、缓慢、包容"  # 修改为你想要的语气描述
```

### Q2: 如何添加新的表情符号？

在策略配置中的 `emoji_suggestions` 添加：

```yaml
sad:
  emoji_suggestions: ["💙", "🤗", "🌙", "✨", "你的新表情"]
```

### Q3: 回复太长/太短怎么办？

调整 `max_length` 参数（单位：句子数）：

```yaml
sad:
  max_length: 2  # 改为2句话
```

### Q4: 如何禁用情感一致性检查？

```python
generator = ResponseGenerator(
    llm_client,
    enable_consistency_check=False  # 禁用检查
)
```

**注意：** 不推荐在生产环境禁用。

### Q5: 如何自定义危机干预回复？

修改 `emotion_strategy.yaml` 中的 `high_risk_depression` 配置：

```yaml
high_risk_depression:
  fallback: "你的自定义危机回复..."
  crisis_hotlines:
    - name: "你的热线名称"
      number: "热线电话"
```

### Q6: 如何集成用户记忆？

通过 `retrieved_memories` 参数传入：

```python
from backend.memory_manager import MemoryManager

memory_manager = MemoryManager()

# 检索相关记忆
memories = memory_manager.retrieve_memories(
    user_id=user_id,
    query=user_input,
    n_results=3
)

# 传入生成器
result = generator.generate_response(
    user_input=user_input,
    user_emotion=emotion,
    user_id=user_id,
    retrieved_memories=memories  # 使用记忆
)
```

### Q7: 如何处理多语言？

目前主要支持中文。如需支持其他语言：

1. 在策略配置中添加对应语言的关键词
2. 修改情感校验器的关键词映射
3. 调整Prompt模板中的语言

### Q8: 生成统计信息在哪里查看？

```python
stats = generator.get_statistics()

print(f"总计: {stats['total_generations']}")
print(f"LLM生成率: {stats['llm_rate']:.2%}")
print(f"缓存命中率: {stats['cached_rate']:.2%}")
print(f"失败率: {stats['failure_rate']:.2%}")
```

---

## 版本更新

### v1.0.0 (2025-10-18)

- ✨ 初始版本发布
- 🎯 实现情感驱动的动态Prompt生成
- 🛡️ 集成情感一致性校验机制
- 🚨 完善危机干预处理流程
- 📊 添加生成统计功能
- 📝 完整的文档和测试套件

---

## 技术支持

如有问题或建议，请联系：

- **作者**: 袁从德
- **项目**: emotional_chat
- **文档**: `/docs/响应生成模块使用指南.md`

---

## 许可证

本模块遵循项目整体许可证。详见根目录 `LICENSE` 文件。

---

**祝你使用愉快！让我们一起打造有温度的AI陪伴者。** 💖

