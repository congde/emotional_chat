# 意图识别模块 - 快速开始指南

## 📚 目录

- [简介](#简介)
- [安装](#安装)
- [基本使用](#基本使用)
- [API接口](#api接口)
- [集成到项目](#集成到项目)
- [常见问题](#常见问题)

## 简介

意图识别模块是"心语"情感陪伴机器人的核心功能之一，能够准确识别用户的真实意图，包括：

- 😊 **情感表达** - 用户倾诉情绪
- 💡 **寻求建议** - 请求解决方案
- 💬 **普通对话** - 日常交流
- ⚙️ **功能请求** - 提醒、记录等
- 🚨 **危机干预** - 紧急情况 ⚠️
- 👋 **闲聊** - 打招呼、寒暄

## 安装

意图识别模块已经集成到主项目中，无需额外安装。

```bash
# 确保已安装项目依赖
pip install -r requirements.txt
```

## 基本使用

### Python代码使用

```python
from backend.modules.intent.services import IntentService

# 初始化服务
intent_service = IntentService()

# 分析用户输入
text = "我该怎么办？"
result = intent_service.analyze(text, user_id="user_123")

# 查看结果
print(f"意图: {result['intent']['intent']}")
print(f"置信度: {result['intent']['confidence']}")
print(f"来源: {result['intent']['source']}")

# 如果检测到危机情况
if result['action_required']:
    print("⚠️ 需要特殊关注！")
```

### 运行示例

```bash
# 运行使用示例
python3 examples/intent_recognition_demo.py

# 运行测试套件
python3 test_intent_module.py
```

## API接口

### 1. 分析意图

**端点**: `POST /intent/analyze`

**请求**:
```bash
curl -X POST http://localhost:8000/intent/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "text": "我最近睡不好，该怎么办？",
    "user_id": "user_123"
  }'
```

**响应**:
```json
{
  "code": 200,
  "message": "意图识别成功",
  "data": {
    "success": true,
    "intent": {
      "intent": "advice",
      "confidence": 0.85,
      "source": "model"
    },
    "action_required": false,
    "suggestion": {
      "response_style": "建设性、实用、温和",
      "priority": "medium",
      "actions": ["分析问题", "提供多个选择", "分享相关知识"]
    }
  }
}
```

### 2. 快速检测

**端点**: `POST /intent/detect?text=你好`

```bash
curl -X POST "http://localhost:8000/intent/detect?text=你好"
```

### 3. 获取意图类型

**端点**: `GET /intent/types`

```bash
curl http://localhost:8000/intent/types
```

### 4. 服务状态

**端点**: `GET /intent/status`

```bash
curl http://localhost:8000/intent/status
```

### 5. 批量分析

**端点**: `POST /intent/batch`

```bash
curl -X POST http://localhost:8000/intent/batch \
  -H "Content-Type: application/json" \
  -d '{
    "texts": ["你好", "我很难过", "该怎么办？"]
  }'
```

## 集成到项目

### 在聊天服务中使用

意图识别已经自动集成到 `ChatService` 中：

```python
from backend.services.chat_service import ChatService

# 初始化聊天服务（默认启用意图识别）
chat_service = ChatService(use_intent=True)

# 处理用户消息时会自动进行意图识别
response = await chat_service.chat(request)

# 响应中会包含意图信息
print(response.context['intent'])  # 意图类型
print(response.context['intent_confidence'])  # 置信度
```

### 自定义集成

```python
from backend.modules.intent.services import IntentService

class MyService:
    def __init__(self):
        self.intent_service = IntentService()
    
    async def process_message(self, message: str, user_id: str):
        # 1. 意图识别
        intent_analysis = self.intent_service.analyze(message, user_id)
        
        # 2. 检查危机情况
        if intent_analysis['action_required']:
            return await self.handle_crisis(intent_analysis)
        
        # 3. 根据意图选择处理策略
        intent = intent_analysis['intent']['intent']
        
        if intent == 'advice':
            return await self.provide_advice(message, intent_analysis)
        elif intent == 'emotion':
            return await self.provide_empathy(message, intent_analysis)
        elif intent == 'function':
            return await self.execute_function(message, intent_analysis)
        else:
            return await self.normal_chat(message, intent_analysis)
```

### 使用Prompt构建

```python
# 构建用户上下文
user_context = {
    "analysis": {
        "emotion": {"primary": "焦虑"},
        "intent": {
            "intent": "advice",
            "confidence": 0.85,
            "source": "model"
        }
    }
}

# 生成针对性的Prompt
prompt = intent_service.build_prompt(user_context)

# 将prompt传递给大模型
response = llm.generate(prompt, user_message)
```

## 常见问题

### Q1: 如何提高意图识别准确率？

A: 意图识别准确率取决于：
1. **关键词规则** - 可以在 `rule_engine.py` 中添加更多关键词
2. **ML模型** - 使用训练好的BERT模型替换启发式规则
3. **上下文信息** - 结合对话历史和用户画像

### Q2: 如何处理危机情况？

A: 当检测到危机意图时：
1. `action_required` 会返回 `True`
2. 风险等级会标记为 `high`
3. 建议提供：
   - 专业求助热线（如心理危机热线）
   - 表达关心和支持
   - 建议寻求专业帮助

示例代码：
```python
if result['action_required']:
    crisis_response = {
        "message": "我非常关心你的感受。如果你正在经历困难，建议你联系专业的心理咨询师。",
        "hotline": "全国心理危机干预热线: 400-161-9995",
        "resources": [
            "24小时心理援助热线",
            "当地精神卫生中心",
            "社区心理咨询服务"
        ]
    }
```

### Q3: 如何扩展新的意图类型？

A: 步骤如下：
1. 在 `intent_models.py` 中添加新的 `IntentType`
2. 在 `rule_engine.py` 中添加对应的关键词规则
3. 在 `intent_service.py` 的 `_generate_suggestion` 中添加响应策略
4. 如果使用ML模型，需要重新训练模型

### Q4: 意图识别失败怎么办？

A: 意图识别模块设计为高度容错：
- 如果没有明确匹配，默认返回 `conversation` 意图
- 所有异常都会被捕获并记录日志
- 不会影响正常的聊天功能

### Q5: 如何禁用意图识别？

A: 两种方式：
1. **在ChatService中**:
   ```python
   chat_service = ChatService(use_intent=False)
   ```

2. **在配置文件中** (如果添加了配置):
   ```python
   INTENT_ENABLED = False
   ```

## 性能优化建议

1. **使用规则引擎优先** - 对于常见模式，规则引擎比模型更快
2. **批量处理** - 使用 `/intent/batch` 接口批量处理多条消息
3. **缓存结果** - 对相同或相似的输入可以缓存结果
4. **异步处理** - 在FastAPI中使用 `async/await`

## 更多资源

- 📖 [完整文档](./意图识别模块说明.md)
- 🔧 [增强版输入处理器使用指南](./增强版输入处理器使用指南.md) ⭐ **新增**
- 💻 [代码示例](../examples/intent_recognition_demo.py)
- 🧪 [测试套件](../test_intent_module.py)
- 🌐 [API文档](http://localhost:8000/docs#/intent)

## 联系和反馈

如有问题或建议，欢迎：
- 提交 GitHub Issue
- 查看项目文档
- 运行示例代码学习

---

**版本**: v1.0.0  
**最后更新**: 2025-10-17

