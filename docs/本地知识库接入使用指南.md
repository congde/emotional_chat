# 本地知识库接入使用指南

## 🚀 快速开始

### 方法一：一键启动（推荐）

```bash
# 快速启动，自动构建知识库
make quick-start

# 或者直接运行
python quick_start.py
```

### 方法二：智能启动

```bash
# 带RAG功能的智能启动
make run-rag

# 或者直接运行
python start_with_rag.py
```

### 方法三：传统启动

```bash
# 传统启动（已集成知识库自动构建）
make run

# 或者直接运行
python run_backend.py
```

## 📚 知识库管理

### 初始化知识库

```bash
# 初始化内置示例知识
make rag-init

# 或者直接运行
python init_rag_knowledge.py
```

### 测试知识库

```bash
# 测试RAG系统
make rag-test

# 或者直接运行
python test_rag_system.py
```

### 演示RAG效果

```bash
# 演示RAG效果对比
make rag-demo

# 或者直接运行
python demo_rag_comparison.py
```

## 🔧 高级配置

### 启动参数

```bash
# 禁用RAG功能
python start_with_rag.py --no-rag

# 强制重建知识库
python start_with_rag.py --rebuild-kb

# 不从文件结构加载知识
python start_with_rag.py --no-file-structure

# 启动后测试RAG功能
python start_with_rag.py --test-rag

# 自定义端口
python start_with_rag.py --port 8080

# 启用调试模式
python start_with_rag.py --debug
```

### 知识库结构

```
knowledge_base/
├── clinical_guidelines/     # 临床指南
│   └── anxiety_disorder_diagnosis.md
├── therapy_methods/         # 治疗方法
│   └── cbt_worksheet_guide.md
├── self_help_tools/         # 自助工具
│   └── mindfulness_script.txt
└── organization_policy/     # 机构政策
    └── crisis_intervention_protocol.md
```

## 🧪 测试验证

### API测试

```bash
# 测试RAG API
python test_rag_api.py
```

### 功能测试

```bash
# 测试知识库结构
python test_knowledge_base_structure.py

# 快速RAG设置测试
python quick_rag_setup.py
```

## 📊 监控与调试

### 查看知识库状态

```bash
curl http://localhost:8000/api/rag/status
```

### 测试RAG功能

```bash
curl http://localhost:8000/api/rag/test
```

### 知识问答测试

```bash
curl -X POST http://localhost:8000/api/rag/ask \
  -H "Content-Type: application/json" \
  -d '{
    "question": "我最近总是失眠，怎么办？",
    "search_k": 3
  }'
```

## 🔄 工作流程

### 1. 首次启动

```bash
# 1. 安装依赖
make install

# 2. 初始化数据库
make db-init

# 3. 快速启动（自动构建知识库）
make quick-start
```

### 2. 日常开发

```bash
# 启动开发服务器
make run

# 或者带RAG功能
make run-rag
```

### 3. 生产部署

```bash
# 使用智能启动脚本
python start_with_rag.py --host 0.0.0.0 --port 8000
```

## 🛠️ 故障排查

### 常见问题

1. **依赖缺失**
   ```bash
   pip install -r requirements.txt
   ```

2. **知识库初始化失败**
   ```bash
   # 检查API密钥配置
   cat config.env
   
   # 重新初始化
   make rag-init
   ```

3. **RAG功能不可用**
   ```bash
   # 检查知识库状态
   curl http://localhost:8000/api/rag/status
   
   # 重新构建知识库
   python start_with_rag.py --rebuild-kb
   ```

### 日志查看

```bash
# 查看后端日志
tail -f backend.log

# 查看RAG相关日志
tail -f backend.log | grep "RAG\|knowledge"
```

## 📈 性能优化

### 知识库优化

1. **定期更新知识库**
   ```bash
   # 从文件结构重新加载
   python start_with_rag.py --rebuild-kb
   ```

2. **监控知识库大小**
   ```bash
   # 查看存储目录大小
   du -sh chroma_db/
   ```

3. **清理无用数据**
   ```bash
   # 重置知识库
   curl -X DELETE http://localhost:8000/api/rag/reset
   ```

### 响应时间优化

1. **调整检索参数**
   ```python
   # 减少检索文档数量
   search_k = 2  # 默认3
   ```

2. **启用缓存**
   ```python
   # 在RAGService中启用缓存
   @lru_cache(maxsize=100)
   def cached_search(self, query: str):
       return self.kb_manager.search_similar(query)
   ```

## 🎯 最佳实践

### 1. 知识库管理

- 定期更新知识库内容
- 使用标准化的文件结构
- 为文档添加适当的元数据

### 2. 性能监控

- 监控知识库响应时间
- 定期检查知识库状态
- 优化检索参数

### 3. 安全考虑

- 保护API密钥
- 限制知识库访问权限
- 定期备份知识库数据

## 📚 相关文档

- [本地知识库接入_实现文档.md](./本地知识库接入_实现文档.md)
- [RAG实施步骤.md](./RAG实施步骤.md)
- [敏感内容过滤与安全机制_实现文档.md](./敏感内容过滤与安全机制_实现文档.md)

## 🆘 获取帮助

如果遇到问题，请：

1. 查看日志文件
2. 检查配置文件
3. 运行测试脚本
4. 查看相关文档

---

**文档版本**: v1.0  
**创建日期**: 2025-10-22  
**项目**: 心语（HeartTalk）情感陪伴机器人
