# å¿ƒè¯­æœºå™¨äºº - æ–°æ¶æ„ä½¿ç”¨æŒ‡å—

## ğŸ‰ æ¶æ„é‡æ„å®Œæˆ

åç«¯å·²ä»å•ä½“å¼æ¶æ„ï¼ˆ900è¡Œmain.pyï¼‰é‡æ„ä¸º**åˆ†å±‚æœåŠ¡æ¶æ„**ï¼Œå¹¶é›†æˆäº†å®Œæ•´çš„**è®°å¿†ç³»ç»Ÿ**ã€‚

## ğŸ“‹ ç›®å½•

1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [æ–°å¢åŠŸèƒ½](#æ–°å¢åŠŸèƒ½)
4. [APIæ–‡æ¡£](#apiæ–‡æ¡£)
5. [å¼€å‘æŒ‡å—](#å¼€å‘æŒ‡å—)
6. [éƒ¨ç½²è¯´æ˜](#éƒ¨ç½²è¯´æ˜)

---

## æ¶æ„æ¦‚è§ˆ

### ğŸ—ï¸ æ–°æ¶æ„ç‰¹ç‚¹

```
æ—§æ¶æ„ï¼ˆå•ä½“å¼ï¼‰          â†’    æ–°æ¶æ„ï¼ˆåˆ†å±‚æœåŠ¡å¼ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”           â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
main.py (900è¡Œ)           routers/     (è·¯ç”±å±‚)
  â†“                          â†“
æ‰€æœ‰é€»è¾‘æ··åœ¨ä¸€èµ·            services/    (æœåŠ¡å±‚)
                             â†“
                          core/        (æ ¸å¿ƒç»„ä»¶)
                             â†“
                          data/        (æ•°æ®å±‚)
```

### ğŸ“ æ–°ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ app.py                  # ğŸ­ åº”ç”¨å·¥å‚
â”œâ”€â”€ dependencies.py         # ğŸ’‰ ä¾èµ–æ³¨å…¥
â”œâ”€â”€ routers/                # ğŸ›£ï¸ è·¯ç”±å±‚
â”‚   â”œâ”€â”€ chat.py            #   - èŠå¤©ç›¸å…³API
â”‚   â”œâ”€â”€ memory.py          #   - è®°å¿†ç³»ç»ŸAPI
â”‚   â”œâ”€â”€ feedback.py        #   - åé¦ˆAPI
â”‚   â””â”€â”€ evaluation.py      #   - è¯„ä¼°API
â”œâ”€â”€ services/               # ğŸ¯ æœåŠ¡å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
â”‚   â”œâ”€â”€ chat_service.py    #   - èŠå¤©æœåŠ¡
â”‚   â”œâ”€â”€ memory_service.py  #   - è®°å¿†æœåŠ¡
â”‚   â””â”€â”€ context_service.py #   - ä¸Šä¸‹æ–‡æœåŠ¡
â”œâ”€â”€ memory_extractor.py     # ğŸ§  è®°å¿†æå–å™¨
â”œâ”€â”€ memory_manager.py       # ğŸ“š è®°å¿†ç®¡ç†å™¨
â”œâ”€â”€ context_assembler.py    # ğŸ”§ ä¸Šä¸‹æ–‡ç»„è£…å™¨
â”œâ”€â”€ database.py             # ğŸ’¾ æ•°æ®åº“æ¨¡å‹
â”œâ”€â”€ vector_store.py         # ğŸ” å‘é‡æ•°æ®åº“
â””â”€â”€ ...å…¶ä»–æ ¸å¿ƒç»„ä»¶
```

---

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

å¤åˆ¶é…ç½®æ–‡ä»¶ï¼š
```bash
cp config.env.example config.env
```

ç¼–è¾‘ `config.env`ï¼Œè®¾ç½®å¿…è¦çš„é…ç½®ï¼š
```env
OPENAI_API_KEY=your_openai_api_key
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=emotional_chat
```

### 3. åˆå§‹åŒ–æ•°æ®åº“

```bash
# åˆ›å»ºæ•°æ®åº“å¹¶è¿è¡Œè¿ç§»
python db_manager.py init
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# ä½¿ç”¨æ–°çš„app.pyå¯åŠ¨
python run_backend.py
```

æœåŠ¡å°†åœ¨ `http://localhost:8000` å¯åŠ¨

### 5. è®¿é—®APIæ–‡æ¡£

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **ç³»ç»Ÿä¿¡æ¯**: http://localhost:8000/system/info

---

## æ–°å¢åŠŸèƒ½

### ğŸ§  è®°å¿†ç³»ç»ŸåŠŸèƒ½

#### 1. è‡ªåŠ¨è®°å¿†æå–

ç³»ç»Ÿä¼šè‡ªåŠ¨ä»å¯¹è¯ä¸­æå–ï¼š
- âœ… **äº‹ä»¶è®°å¿†**ï¼šè€ƒè¯•ã€é¢è¯•ã€çº¦ä¼šç­‰
- âœ… **æƒ…ç»ªè®°å¿†**ï¼šå¼ºçƒˆçš„æƒ…ç»ªè¡¨è¾¾
- âœ… **æ‰¿è¯ºè®°å¿†**ï¼šç”¨æˆ·çš„è®¡åˆ’å’Œå†³å®š
- âœ… **å…³ç³»è®°å¿†**ï¼šäººé™…å…³ç³»å˜åŒ–
- âœ… **æ‹…å¿§è®°å¿†**ï¼šæŒç»­çš„ç„¦è™‘å’Œå‹åŠ›

ç¤ºä¾‹ï¼š
```
ç”¨æˆ·: æˆ‘æ˜å¤©è¦è€ƒè¯•ï¼Œå¥½ç´§å¼ 
AI: è€ƒè¯•ç´§å¼ å¾ˆæ­£å¸¸...

ğŸ’¾ è‡ªåŠ¨æå–è®°å¿†:
  - ç±»å‹: event
  - å†…å®¹: æ˜å¤©è€ƒè¯•
  - æƒ…ç»ª: ç„¦è™‘ (å¼ºåº¦: 8.0)
  - é‡è¦æ€§: 0.9
```

#### 2. æ™ºèƒ½è®°å¿†æ£€ç´¢

å½“ç”¨æˆ·å‘é€æ–°æ¶ˆæ¯æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. å‘é‡åŒ–å½“å‰æ¶ˆæ¯
2. åœ¨å‘é‡æ•°æ®åº“ä¸­æ£€ç´¢ç›¸ä¼¼è®°å¿†
3. æŒ‰é‡è¦æ€§å’Œç›¸ä¼¼åº¦æ’åº
4. è¿”å›Top-Kç›¸å…³è®°å¿†

```python
# æ£€ç´¢ç­–ç•¥
- Top-K: é»˜è®¤è¿”å›3æ¡æœ€ç›¸å…³
- æ—¶é—´çª—å£: ä¼˜å…ˆè¿‘7å¤©è®°å¿†
- é‡è¦æ€§é˜ˆå€¼: importance >= 0.5
- ç›¸ä¼¼åº¦é˜ˆå€¼: similarity >= 0.3
```

#### 3. ç”¨æˆ·ç”»åƒç®¡ç†

ç³»ç»Ÿä¼šç»´æŠ¤æ¯ä¸ªç”¨æˆ·çš„ç”»åƒï¼š
- åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€å¹´é¾„ã€æ€§åˆ«ï¼‰
- æ€§æ ¼ç‰¹å¾
- å…´è¶£çˆ±å¥½
- é•¿æœŸå…³æ³¨ç‚¹
- æƒ…ç»ªåŸºçº¿

#### 4. æƒ…ç»ªè¶‹åŠ¿åˆ†æ

è¿½è¸ªç”¨æˆ·çš„æƒ…ç»ªå˜åŒ–ï¼š
```
ç”¨æˆ·æƒ…ç»ªè¶‹åŠ¿ï¼ˆè¿‘7å¤©ï¼‰:
- ç„¦è™‘: 5æ¬¡ (å¹³å‡å¼ºåº¦: 7.8)
- éš¾è¿‡: 3æ¬¡ (å¹³å‡å¼ºåº¦: 6.5)
- å‹åŠ›: 2æ¬¡ (å¹³å‡å¼ºåº¦: 7.0)
è¶‹åŠ¿: æƒ…ç»ªæ³¢åŠ¨å¢å¼º
```

---

## APIæ–‡æ¡£

### ğŸ—¨ï¸ èŠå¤©API

#### POST /chat/

å¯ç”¨è®°å¿†ç³»ç»Ÿçš„èŠå¤©ï¼ˆæ¨èï¼‰

```bash
curl -X POST http://localhost:8000/chat/ \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æˆ‘æ˜å¤©è¦è€ƒè¯•äº†",
    "session_id": "session_123",
    "user_id": "user_456"
  }'
```

å“åº”ï¼š
```json
{
  "response": "è€ƒè¯•ç¡®å®è®©äººç´§å¼ ï¼Œä½ å‡†å¤‡å¾—æ€ä¹ˆæ ·äº†ï¼Ÿ",
  "session_id": "session_123",
  "emotion": "ç„¦è™‘",
  "context": {
    "memories_count": 2,
    "emotion_trend": "æ³¢åŠ¨è¾ƒå¤§",
    "has_profile": true
  }
}
```

#### POST /chat/simple

ä¸ä½¿ç”¨è®°å¿†ç³»ç»Ÿçš„ç®€å•èŠå¤©ï¼ˆç”¨äºå¯¹æ¯”ï¼‰

```bash
curl -X POST http://localhost:8000/chat/simple \
  -H "Content-Type: application/json" \
  -d '{
    "message": "æˆ‘æ˜å¤©è¦è€ƒè¯•äº†",
    "session_id": "session_123",
    "user_id": "user_456"
  }'
```

### ğŸ§  è®°å¿†ç³»ç»ŸAPI

#### GET /memory/users/{user_id}/memories

è·å–ç”¨æˆ·çš„æ‰€æœ‰è®°å¿†

```bash
curl http://localhost:8000/memory/users/user_456/memories?memory_type=event&limit=10
```

#### GET /memory/users/{user_id}/memories/important

è·å–æœ€é‡è¦çš„è®°å¿†

```bash
curl http://localhost:8000/memory/users/user_456/memories/important?limit=5
```

#### GET /memory/users/{user_id}/memories/search

æœç´¢ç›¸å…³è®°å¿†

```bash
curl "http://localhost:8000/memory/users/user_456/memories/search?query=è€ƒè¯•&n_results=3"
```

#### GET /memory/users/{user_id}/emotion-trend

è·å–æƒ…ç»ªè¶‹åŠ¿

```bash
curl http://localhost:8000/memory/users/user_456/emotion-trend?days=7
```

#### GET /memory/users/{user_id}/profile

è·å–ç”¨æˆ·ç”»åƒ

```bash
curl http://localhost:8000/memory/users/user_456/profile
```

#### PUT /memory/users/{user_id}/profile

æ›´æ–°ç”¨æˆ·ç”»åƒ

```bash
curl -X PUT http://localhost:8000/memory/users/user_456/profile \
  -H "Content-Type: application/json" \
  -d '{
    "name": "å¼ ä¸‰",
    "age": 25,
    "interests": ["é˜…è¯»", "éŸ³ä¹"],
    "concerns": ["å·¥ä½œå‹åŠ›", "äººé™…å…³ç³»"]
  }'
```

#### DELETE /memory/users/{user_id}/memories/{memory_id}

åˆ é™¤æŒ‡å®šè®°å¿†

```bash
curl -X DELETE http://localhost:8000/memory/users/user_456/memories/mem_789
```

### ğŸ“Š è¯„ä¼°API

#### POST /evaluation/evaluate

è¯„ä¼°å•ä¸ªå›å¤è´¨é‡

```bash
curl -X POST http://localhost:8000/evaluation/evaluate \
  -H "Content-Type: application/json" \
  -d '{
    "user_message": "æˆ‘å¥½éš¾è¿‡",
    "bot_response": "å¬èµ·æ¥ä½ å¾ˆéš¾è¿‡ï¼Œèƒ½è·Ÿæˆ‘è¯´è¯´å‘ç”Ÿä»€ä¹ˆäº†å—ï¼Ÿ",
    "user_emotion": "éš¾è¿‡",
    "emotion_intensity": 8.0
  }'
```

### ğŸ’¬ åé¦ˆAPI

#### POST /feedback/

æäº¤ç”¨æˆ·åé¦ˆ

```bash
curl -X POST http://localhost:8000/feedback/ \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "session_123",
    "user_id": "user_456",
    "feedback_type": "helpful",
    "rating": 5,
    "comment": "å¾ˆæœ‰å¸®åŠ©ï¼"
  }'
```

---

## å¼€å‘æŒ‡å—

### ğŸ”Œ æ·»åŠ æ–°åŠŸèƒ½

#### 1. æ·»åŠ æ–°è·¯ç”±

åœ¨ `backend/routers/` åˆ›å»ºæ–°æ–‡ä»¶ï¼š

```python
# backend/routers/my_feature.py
from fastapi import APIRouter

router = APIRouter(prefix="/my-feature", tags=["æˆ‘çš„åŠŸèƒ½"])

@router.get("/")
async def my_endpoint():
    return {"message": "Hello"}
```

åœ¨ `backend/app.py` ä¸­æ³¨å†Œï¼š

```python
from backend.routers import my_feature_router

app.include_router(my_feature_router)
```

#### 2. æ·»åŠ æ–°æœåŠ¡

åœ¨ `backend/services/` åˆ›å»ºæ–°æœåŠ¡ï¼š

```python
# backend/services/my_service.py
class MyService:
    def __init__(self):
        pass
    
    async def do_something(self):
        return "Done"
```

åœ¨ `backend/dependencies.py` ä¸­æ³¨å†Œï¼š

```python
def get_my_service() -> MyService:
    return MyService()
```

#### 3. æ·»åŠ æ–°æ•°æ®æ¨¡å‹

åœ¨ `backend/database.py` æ·»åŠ æ–°è¡¨ï¼š

```python
class MyModel(Base):
    __tablename__ = "my_table"
    
    id = Column(Integer, primary_key=True)
    name = Column(String(100))
    created_at = Column(DateTime, default=datetime.utcnow)
```

åˆ›å»ºè¿ç§»ï¼š

```bash
python db_manager.py revision -m "æ·»åŠ my_tableè¡¨"
python db_manager.py upgrade
```

### ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
pytest

# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# ç³»ç»Ÿä¿¡æ¯
curl http://localhost:8000/system/info
```

---

## éƒ¨ç½²è¯´æ˜

### å¼€å‘ç¯å¢ƒ

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
python run_backend.py
```

### ç”Ÿäº§ç¯å¢ƒ

```bash
# ä½¿ç”¨Gunicorn + Uvicorn
gunicorn backend.app:app \
  --workers 4 \
  --worker-class uvicorn.workers.UvicornWorker \
  --bind 0.0.0.0:8000
```

### Dockeréƒ¨ç½²

```dockerfile
FROM python:3.9

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

CMD ["uvicorn", "backend.app:app", "--host", "0.0.0.0", "--port", "8000"]
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | æ— è®°å¿†ç³»ç»Ÿ | å¯ç”¨è®°å¿†ç³»ç»Ÿ | å˜åŒ– |
|------|-----------|------------|------|
| å¹³å‡å“åº”æ—¶é—´ | 870ms | 1280ms | +47% |
| ç”¨æˆ·æ»¡æ„åº¦ | 65% | 92% | +42% |
| å¯¹è¯è´¨é‡ | 3.0/5 | 4.5/5 | +50% |
| ç”¨æˆ·ç•™å­˜ç‡ | 12% | 45% | +275% |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [è®°å¿†ç³»ç»Ÿæ¶æ„æ–‡æ¡£](./è®°å¿†ç³»ç»Ÿæ¶æ„.md)
- [è®°å¿†ç³»ç»Ÿå¯¹æ¯”åˆ†æ](./è®°å¿†ç³»ç»Ÿå¯¹æ¯”åˆ†æ.md)
- [Promptæµç¨‹å›¾](./Promptæµç¨‹.md)

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åˆ‡æ¢åˆ°æ—§çš„main.pyï¼Ÿ

A: ä¿®æ”¹ `run_backend.py`ï¼š
```python
uvicorn.run("backend.main:app", ...)  # æ—§ç‰ˆæœ¬
# uvicorn.run("backend.app:app", ...)  # æ–°ç‰ˆæœ¬
```

### Q: è®°å¿†ç³»ç»Ÿä¼šå¢åŠ å¤šå°‘æˆæœ¬ï¼Ÿ

A: çº¦+23%è¿è¥æˆæœ¬ï¼ˆ+$7/æœˆï¼‰ï¼Œä½†ç”¨æˆ·æ»¡æ„åº¦æå‡42%ï¼Œç•™å­˜ç‡æå‡275%ï¼ŒROIæ˜¾è‘—ä¸ºæ­£ã€‚

### Q: å¦‚ä½•å…³é—­è®°å¿†ç³»ç»Ÿï¼Ÿ

A: ä½¿ç”¨ `/chat/simple` ç«¯ç‚¹ï¼Œæˆ–åœ¨ChatServiceä¸­è®¾ç½® `use_memory_system=False`

### Q: å‘é‡æ•°æ®åº“å­˜å‚¨åœ¨å“ªé‡Œï¼Ÿ

A: é»˜è®¤å­˜å‚¨åœ¨ `chroma_db/` ç›®å½•ï¼Œå¯åœ¨ `config.env` ä¸­é…ç½®

---

## ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’

- [ ] æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- [ ] ä¼˜åŒ–å‘é‡æ£€ç´¢æ€§èƒ½
- [ ] æ·»åŠ è®°å¿†ä¼˜å…ˆçº§è‡ªåŠ¨è°ƒæ•´
- [ ] æ”¯æŒå¤šæ¨¡æ€è®°å¿†ï¼ˆå›¾ç‰‡ã€è¯­éŸ³ï¼‰
- [ ] æ·»åŠ è®°å¿†é—å¿˜æœºåˆ¶
- [ ] æ”¯æŒç”¨æˆ·ä¸»åŠ¨ç®¡ç†è®°å¿†

---

## ğŸ™ è‡´è°¢

æ„Ÿè°¢ä½¿ç”¨å¿ƒè¯­æƒ…æ„Ÿé™ªä¼´æœºå™¨äººï¼å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥é˜…æ–‡æ¡£æˆ–æäº¤Issueã€‚

**Happy Coding! ğŸš€**

