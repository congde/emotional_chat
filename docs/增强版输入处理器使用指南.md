# 增强版输入处理器使用指南

## 📖 概述

增强版输入处理器 (`EnhancedInputProcessor`) 是对用户输入进行全面预处理的核心组件，在进行情感分析和意图识别之前对原始输入进行清洗、验证和标准化。

## ✨ 核心功能

### 1. 基本清洗
- ✅ 去除首尾空格和多余空白符
- ✅ 统一换行符和制表符
- ✅ 去除特殊控制字符
- ✅ 标点符号规范化

### 2. 错别字/网络用语纠正
自动纠正常见的错别字和网络流行语：

| 输入 | 自动纠正为 |
|------|-----------|
| emo了 | 情绪不好了 |
| 蓝瘦香菇 | 难受想哭 |
| 我裂开了 | 我心态崩了 |
| 破防了 | 心理防线被击破了 |
| ... | ... |

### 3. 智能长度管理
- **建议长度**: 500字（超过会提示但不截断）
- **绝对最大**: 2000字（超过会自动截断）
- **友好提示**: "为了更好地交流，建议每次输入不超过500字哦~ 🌟"

### 4. 重复输入检测
- 自动记录用户最近10条消息
- 检测连续重复输入
- 连续3次以上重复会特别提示
- 每个用户独立追踪

### 5. 问句类型识别

| 类型 | 说明 | 示例 |
|------|------|------|
| **how** | 怎样类（寻求方法） | "我该怎么办？" |
| **why** | 为何类（寻求原因） | "为什么我睡不着？" |
| **what** | 什么类（寻求信息） | "什么是焦虑？" |
| **confirm** | 确认类（是非判断） | "我这样做对不对？" |
| **other** | 其他问句 | "你好吗？" |

### 6. 语言检测
- 计算中文字符占比
- 中文占比 < 30% 时友好提示
- 提示语："我更擅长中文交流哦，如果方便的话可以用中文告诉我吗？ 🌸"

### 7. 高风险内容检测 ⚠️
检测危机干预相关关键词：
- "自杀"、"自残"、"不想活"、"想死"等
- 自动标记为 `risk_level: "high"`
- 触发 `requires_crisis_intervention: True`
- 记录警告日志

### 8. 敏感词过滤
- 支持自定义敏感词列表
- 自动替换为星号（***）
- 记录被过滤的词汇

### 9. 分词功能（可选）
- 基于jieba分词引擎
- 提取关键词
- 支持自定义词典（已预置心理健康相关词汇）

## 🚀 使用方法

### 方法1：在 ChatService 中使用（推荐）

增强版处理器已经自动集成到 `ChatService` 中，默认启用：

```python
from backend.services.chat_service import ChatService

# 初始化时自动启用增强版处理器
chat_service = ChatService(
    use_enhanced_processor=True  # 默认值
)

# 在聊天时自动调用预处理
response = await chat_service.chat(request)

# 响应中会包含预处理信息
print(response.context['input_preprocessed'])  # True/False
print(response.context['input_metadata'])  # 预处理元数据
```

### 方法2：直接使用处理器

```python
from backend.modules.intent.core.enhanced_input_processor import EnhancedInputProcessor

# 初始化处理器
processor = EnhancedInputProcessor(
    enable_jieba=True,  # 启用分词（需要安装jieba）
    enable_duplicate_check=True  # 启用重复检测
)

# 预处理输入
user_input = "我今天emo了，该怎么办呢？"
result = processor.preprocess(user_input, user_id="user_123")

# 检查结果
if result["blocked"]:
    print(f"输入被阻止: {result['friendly_message']}")
else:
    cleaned_text = result["cleaned"]  # "我今天情绪不好了，该怎么办呢？"
    print(f"清洗后的文本: {cleaned_text}")
    
    # 检查风险
    if result["risk_level"] == "high":
        print("⚠️ 检测到高风险内容，需要危机干预")
    
    # 获取元数据
    metadata = result["metadata"]
    print(f"问句类型: {metadata.get('question_type')}")  # "how"
    print(f"中文占比: {metadata.get('chinese_ratio')}")
```

### 方法3：快速验证

```python
# 轻量级验证（不进行完整预处理）
is_valid, error_msg = processor.validate_input(user_input)

if not is_valid:
    return error_msg  # 友好的错误提示
```

## 📊 返回结果说明

```python
result = {
    "original": str,           # 原始输入文本
    "cleaned": str,            # 清洗后的文本
    "blocked": bool,           # 是否被阻止（True表示无效输入）
    "risk_level": str,         # 风险等级："low" | "medium" | "high"
    "warnings": List[str],     # 警告信息列表
    "friendly_message": str,   # 友好的提示信息（如果有问题）
    "metadata": {              # 元数据
        "length": int,                      # 文本长度
        "typos_corrected": bool,            # 是否纠正了错别字
        "is_duplicate": bool,               # 是否重复
        "duplicate_count": int,             # 连续重复次数
        "high_frequency_repeat": bool,      # 是否高频重复（3次+）
        "contains_question": bool,          # 是否包含问句
        "question_type": str,               # 问句类型（如果有）
        "chinese_ratio": float,             # 中文占比（0-1）
        "low_chinese_ratio": bool,          # 中文占比是否过低
        "risk_keywords": List[str],         # 匹配的高风险关键词
        "requires_crisis_intervention": bool,  # 是否需要危机干预
        "words": List[str],                 # 分词结果（如果启用）
        "word_count": int,                  # 词数（如果启用）
        "keywords": List[str],              # 提取的关键词（如果启用）
    }
}
```

## 🛠️ 高级功能

### 动态添加纠错规则

```python
# 添加自定义错别字纠正规则
processor.add_typo_rule("你咋了", "你怎么了")

# 之后的输入会自动纠正
result = processor.preprocess("你咋了？")
print(result["cleaned"])  # "你怎么了？"
```

### 动态添加高风险关键词

```python
# 添加新的高风险关键词
processor.add_high_risk_keyword("想自杀")

# 之后会被检测
result = processor.preprocess("我想自杀")
print(result["risk_level"])  # "high"
```

### 清除用户历史

```python
# 清除某个用户的输入历史（例如：用户注销时）
processor.clear_user_history("user_123")
```

### 获取统计信息

```python
stats = processor.get_statistics()
print(stats)
# {
#     "jieba_enabled": True,
#     "duplicate_check_enabled": True,
#     "tracked_users": 100,
#     "max_length": 500,
#     "absolute_max_length": 2000,
#     "typo_rules": 21,
#     "high_risk_keywords": 14,
#     "sensitive_words": 0
# }
```

## 🧪 测试

运行测试脚本验证功能：

```bash
cd /home/workSpace/emotional_chat
python3 test_enhanced_processor.py
```

测试覆盖：
- ✅ 空输入检测
- ✅ 错别字纠正
- ✅ 长度检查
- ✅ 重复检测
- ✅ 问句识别
- ✅ 语言检测
- ✅ 高风险检测
- ✅ 快速验证

## 📦 依赖安装

### 核心功能（无需额外依赖）
基本功能无需额外安装，开箱即用。

### 可选功能：分词

如果需要启用分词功能，安装jieba：

```bash
pip install jieba
```

安装后会自动启用：
- 中文分词
- 关键词提取
- 自定义词典（心理健康相关）

## ⚙️ 配置说明

### 修改长度限制

编辑 `enhanced_input_processor.py`:

```python
class EnhancedInputProcessor:
    MAX_LENGTH = 500           # 建议最大长度（可调整）
    ABSOLUTE_MAX_LENGTH = 2000  # 绝对最大长度（硬限制）
```

### 扩展错别字映射表

编辑 `TYPO_MAP` 字典：

```python
TYPO_MAP = {
    "你的错别字": "正确写法",
    "网络用语": "标准表达",
    # 添加更多...
}
```

### 扩展高风险关键词

编辑 `HIGH_RISK_KEYWORDS` 列表：

```python
HIGH_RISK_KEYWORDS = [
    "自杀", "自残", 
    # 添加更多...
]
```

## 🎯 最佳实践

### 1. 在路由层快速验证

```python
# backend/routers/chat.py
@router.post("/chat")
async def chat(request: ChatRequest):
    # 快速验证
    is_valid, error_msg = processor.validate_input(request.message)
    if not is_valid:
        return ChatResponse(
            response=error_msg,
            emotion="neutral",
            session_id=request.session_id
        )
    
    # 继续处理...
```

### 2. 在服务层完整预处理

```python
# backend/services/chat_service.py
async def process_message(self, message, user_id):
    # 完整预处理
    preprocessed = self.processor.preprocess(message, user_id)
    
    if preprocessed["blocked"]:
        return self._handle_blocked_input(preprocessed)
    
    if preprocessed["risk_level"] == "high":
        return self._handle_crisis(preprocessed)
    
    # 使用清洗后的文本
    cleaned_message = preprocessed["cleaned"]
    # ...
```

### 3. 利用元数据优化回复

```python
# 根据问句类型选择回复策略
question_type = preprocessed["metadata"].get("question_type")

if question_type == "how":
    # 提供具体的方法和建议
    prompt_style = "solution-oriented"
elif question_type == "why":
    # 提供原因分析和解释
    prompt_style = "explanation-oriented"
elif question_type == "confirm":
    # 提供肯定/否定的明确答复
    prompt_style = "confirmation-oriented"
```

## 🔒 安全注意事项

1. **高风险内容处理**
   - 检测到高风险内容时应记录日志
   - 考虑通知管理员或触发人工审核
   - 提供专业求助资源（心理热线等）

2. **隐私保护**
   - 用户输入历史仅保留最近10条
   - 不持久化敏感信息
   - 用户注销时清除历史

3. **敏感词过滤**
   - 谨慎使用敏感词过滤
   - 心理健康场景应允许用户自由表达
   - 避免过度过滤影响体验

## 📚 相关文档

- [用户输入处理流程设计](../README.md#用户输入处理流程设计)
- [意图识别模块说明](./意图识别模块说明.md)
- [意图识别快速开始](./意图识别快速开始.md)

## 🤝 贡献

欢迎提交以下内容：
- 新的错别字/网络用语规则
- 改进的检测算法
- 更多测试用例
- 文档完善

---

**版本**: v1.0.0  
**最后更新**: 2025-10-17  
**维护者**: 心语开发团队

