# 记忆系统架构

## 概述

Agent的记忆系统采用分层架构，包括短期记忆（工作记忆）和长期记忆（情景记忆、语义记忆），实现智能的记忆管理和检索。

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Agent Core                           │
│  ┌──────────────────────────────────────────────────┐  │
│  │              Memory Hub (记忆中枢)                │  │
│  │  ┌──────────────┐      ┌──────────────────────┐  │  │
│  │  │  工作记忆    │      │     长期记忆          │  │  │
│  │  │ (Working     │      │  ┌──────────────────┐ │  │  │
│  │  │  Memory)     │      │  │   情景记忆       │ │  │  │
│  │  │              │      │  │ (Episodic)       │ │  │  │
│  │  │ - 对话上下文  │      │  └──────────────────┘ │  │  │
│  │  │ - 激活任务    │      │  ┌──────────────────┐ │  │  │
│  │  │ - 临时变量    │      │  │   语义记忆       │ │  │  │
│  │  └──────────────┘      │  │ (Semantic)       │ │  │  │
│  │                         │  └──────────────────┘ │  │  │
│  │                         │  ┌──────────────────┐ │  │  │
│  │                         │  │   对话记忆       │ │  │  │
│  │                         │  │ (Conversation)   │ │  │  │
│  │                         │  └──────────────────┘ │  │  │
│  │                         └──────────────────────┘  │  │
│  └──────────────────────────────────────────────────┘  │
│                                                          │
│  ┌──────────────────────────────────────────────────┐  │
│  │           用户画像 & 行为日志                      │  │
│  │  - 情绪基线                                        │  │
│  │  - 兴趣偏好                                        │  │
│  │  - 性格特征                                        │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
         │                    │                    │
         ▼                    ▼                    ▼
    ┌─────────┐         ┌─────────┐         ┌─────────┐
    │  MySQL  │         │ ChromaDB │         │ Memory  │
    │ 数据库   │         │ 向量数据库│         │ Manager │
    └─────────┘         └─────────┘         └─────────┘
```

## 核心组件

### 1. Memory Hub (记忆中枢)

统一的记忆管理接口，负责：

- **编码 (Encode)**: 将新经验转换为记忆
- **检索 (Retrieve)**: 基于查询和上下文检索相关记忆
- **巩固 (Consolidate)**: 将工作记忆转移到长期记忆
- **更新 (Update)**: 维护工作记忆和用户画像

### 2. 工作记忆 (Working Memory)

短期记忆，存储在内存中：

- **对话上下文**: 最近10轮对话
- **激活任务**: 当前正在处理的任务
- **临时变量**: 会话期间的临时数据

特点：
- 快速访问
- 容量有限（最近10轮对话）
- 会话结束后可转移到长期记忆

### 3. 长期记忆 (Long-term Memory)

持久化存储的记忆：

#### 情景记忆 (Episodic Memory)
- 存储：事件、经历
- 特点：有时间戳、有情感标签
- 用途：回忆特定事件

#### 语义记忆 (Semantic Memory)
- 存储：知识、概念
- 特点：抽象、通用
- 用途：知识检索

#### 对话记忆 (Conversation Memory)
- 存储：历史对话
- 特点：结构化、可检索
- 用途：上下文理解

### 4. 用户画像 (User Profile)

基于记忆构建的用户模型：

- **情绪基线**: 主导情绪、平均强度、情绪分布
- **兴趣偏好**: 阅读、音乐、运动等
- **性格特征**: 敏感型、乐观型等
- **行为模式**: 活跃度、交互频率

## 记忆流程

### 编码流程

```
用户输入
    ↓
情感分析
    ↓
记忆编码
    ├─→ 计算重要性
    ├─→ 推断记忆类型
    └─→ 生成记忆对象
    ↓
工作记忆 (临时存储)
```

### 检索流程

```
用户查询
    ↓
多路径检索
    ├─→ 向量语义检索 (相似度)
    ├─→ 时间序列检索 (近期优先)
    └─→ 情绪关联检索 (情绪一致性)
    ↓
合并去重
    ↓
按重要性排序
    ↓
返回Top-K记忆
```

### 巩固流程

```
工作记忆
    ↓
重要性评估
    ├─→ 高重要性 → 长期记忆
    └─→ 低重要性 → 丢弃
    ↓
记忆类型分类
    ├─→ 情景记忆 → 向量数据库
    ├─→ 语义记忆 → 知识库
    └─→ 对话记忆 → 关系数据库
```

## 存储方案

### MySQL (关系数据库)

存储：
- 对话记录 (ChatMessage)
- 用户信息 (User)
- 会话信息 (ChatSession)

特点：
- 结构化数据
- 快速查询
- 事务支持

### ChromaDB (向量数据库)

存储：
- 情景记忆向量
- 语义记忆向量

特点：
- 语义相似度检索
- 高维向量支持
- 快速检索

### Memory Manager (内存管理)

存储：
- 工作记忆
- 用户画像缓存

特点：
- 快速访问
- 易失性
- 容量有限

## 检索策略

### 1. 语义检索

使用向量相似度搜索：

```python
similar_memories = vector_store.search(
    query=user_input,
    top_k=5,
    min_similarity=0.7
)
```

### 2. 时间检索

优先检索近期记忆：

```python
recent_memories = db.query(
    ChatMessage
).filter(
    created_at >= since_date
).order_by(
    created_at.desc()
).limit(5)
```

### 3. 情绪检索

检索相同情绪状态的记忆：

```python
emotion_memories = db.query(
    ChatMessage
).filter(
    emotion == current_emotion
).limit(3)
```

## 优化策略

### 1. 重要性计算

考虑因素：
- 情绪强度 (30%)
- 关键词匹配 (20%)
- 内容长度 (10%)
- 用户反馈 (40%)

### 2. 记忆去重

- 基于内容相似度
- 基于时间接近度
- 基于情绪一致性

### 3. 缓存策略

- 用户画像缓存（1小时）
- 工作记忆缓存（会话期间）
- 热门记忆缓存（LRU）

## 性能指标

- **检索速度**: < 100ms (Top-5)
- **编码速度**: < 50ms
- **巩固速度**: < 200ms
- **内存占用**: < 100MB (工作记忆)

## 扩展方向

1. **多模态记忆**: 支持图像、音频记忆
2. **记忆压缩**: 长期记忆的压缩和摘要
3. **记忆遗忘**: 实现主动遗忘机制
4. **记忆关联**: 构建记忆图谱
