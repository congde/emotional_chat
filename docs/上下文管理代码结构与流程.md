# ä¸Šä¸‹æ–‡ç®¡ç†ä»£ç ç»“æ„ä¸æµç¨‹

> **æ–‡æ¡£è¯´æ˜**: æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æƒ…æ„ŸèŠå¤©ç³»ç»Ÿä¸­ä¸Šä¸‹æ–‡ç®¡ç†çš„ä»£ç ç»“æ„ã€æ ¸å¿ƒç»„ä»¶å’Œæ‰§è¡Œæµç¨‹ï¼Œç”¨äºæ‰“é€ è¿è´¯è‡ªç„¶çš„æƒ…æ„ŸèŠå¤©å¯¹è¯ä½“éªŒã€‚

## ğŸ“‹ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. ä»£ç ç»“æ„](#2-ä»£ç ç»“æ„)
- [3. æ ¸å¿ƒç»„ä»¶](#3-æ ¸å¿ƒç»„ä»¶)
- [4. æ‰§è¡Œæµç¨‹](#4-æ‰§è¡Œæµç¨‹)
- [5. æ•°æ®æµè½¬](#5-æ•°æ®æµè½¬)
- [6. å…³é”®æ–¹æ³•è¯¦è§£](#6-å…³é”®æ–¹æ³•è¯¦è§£)
- [7. Gitè·¯å¾„](#7-gitè·¯å¾„)
- [8. ä½¿ç”¨ç¤ºä¾‹](#8-ä½¿ç”¨ç¤ºä¾‹)
- [9. æœ€ä½³å®è·µ](#9-æœ€ä½³å®è·µ)
- [10. ä¸Šä¸‹æ–‡è…çƒ‚ï¼ˆContext Rotï¼‰è§£å†³æ–¹æ¡ˆ](#10-ä¸Šä¸‹æ–‡è…çƒ‚context-rotè§£å†³æ–¹æ¡ˆ)
  - [10.1 é—®é¢˜èƒŒæ™¯](#101-é—®é¢˜èƒŒæ™¯)
  - [10.2 è§£å†³æ–¹æ¡ˆæ¶æ„](#102-è§£å†³æ–¹æ¡ˆæ¶æ„)
  - [10.3 æ ¸å¿ƒç»„ä»¶](#103-æ ¸å¿ƒç»„ä»¶)
  - [10.4 é›†æˆåˆ°ä¸Šä¸‹æ–‡æœåŠ¡](#104-é›†æˆåˆ°ä¸Šä¸‹æ–‡æœåŠ¡)
  - [10.5 æ‰§è¡Œæµç¨‹](#105-æ‰§è¡Œæµç¨‹)
  - [10.6 ä½¿ç”¨ç¤ºä¾‹](#106-ä½¿ç”¨ç¤ºä¾‹)
  - [10.7 æœ€ä½³å®è·µ](#107-æœ€ä½³å®è·µ)
  - [10.8 æ€§èƒ½ä¼˜åŒ–å»ºè®®](#108-æ€§èƒ½ä¼˜åŒ–å»ºè®®)
  - [10.9 æ³¨æ„äº‹é¡¹](#109-æ³¨æ„äº‹é¡¹)
- [11. æ€»ç»“](#11-æ€»ç»“)

---

## 1. æ¦‚è¿°

### 1.1 äººè„‘è”æƒ³è¿‡ç¨‹çš„å¯å‘

Google åœ¨ Nested Learning ä¸­æå‡ºçš„äººè„‘è”æƒ³è¿‡ç¨‹ä¸ºä¸Šä¸‹æ–‡ç®¡ç†æä¾›äº†é‡è¦çš„ç†è®ºåŸºç¡€ã€‚äººè„‘é€šè¿‡ç»Ÿä¸€ä¸”å¯å¤ç”¨çš„ç»“æ„ä»¥åŠå¤šæ—¶é—´å°ºåº¦çš„æ›´æ–°æœºåˆ¶ï¼Œå®ç°äº†æŒç»­å­¦ä¹ çš„èƒ½åŠ›ã€‚

> **æ ¸å¿ƒè§‚ç‚¹**ï¼š  
> "The uniform and reusable structure as well as multi-timeâ€“scale update in the brain are the key components of continual learning in humans. Nested Learning allows for multi-timeâ€“scale updates for each component of the brain, while showing that well-known architectures such as transformers and memory modules are in fact linear layers with different frequency updates."

**ä¸­æ–‡ç¿»è¯‘**ï¼š  
å¤§è„‘ä¸­ç»Ÿä¸€ä¸”å¯å¤ç”¨çš„ç»“æ„ä»¥åŠå¤šæ—¶é—´å°ºåº¦çš„æ›´æ–°æœºåˆ¶ï¼Œæ˜¯äººç±»æŒç»­å­¦ä¹ çš„å…³é”®ç»„æˆéƒ¨åˆ†ã€‚åµŒå¥—å­¦ä¹ ï¼ˆNested Learningï¼‰å…è®¸å¤§è„‘çš„æ¯ä¸ªç»„ä»¶è¿›è¡Œå¤šæ—¶é—´å°ºåº¦çš„æ›´æ–°ï¼ŒåŒæ—¶è¡¨æ˜ï¼Œè¯¸å¦‚ Transformer å’Œè®°å¿†æ¨¡å—ç­‰çŸ¥åæ¶æ„å®é™…ä¸Šå°±æ˜¯å…·æœ‰ä¸åŒæ›´æ–°é¢‘ç‡çš„çº¿æ€§å±‚ã€‚

![äººè„‘è”æƒ³è¿‡ç¨‹](images/äººè„‘è”æƒ³è¿‡ç¨‹.png)

è¿™ä¸€ç†è®ºå¯å‘æˆ‘ä»¬åœ¨è®¾è®¡ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿæ—¶ï¼Œåº”è¯¥ï¼š
- **ç»Ÿä¸€ç»“æ„**ï¼šä½¿ç”¨æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„ï¼ˆå¦‚ MCP åè®®ï¼‰
- **å¤šæ—¶é—´å°ºåº¦æ›´æ–°**ï¼šçŸ­æœŸè®°å¿†ï¼ˆå¯¹è¯å†å²ï¼‰å’Œé•¿æœŸè®°å¿†ï¼ˆå‘é‡åº“ï¼‰é‡‡ç”¨ä¸åŒçš„æ›´æ–°é¢‘ç‡
- **å¯å¤ç”¨ç»„ä»¶**ï¼šè®°å¿†æ¨¡å—ã€ç”¨æˆ·ç”»åƒã€æƒ…æ„ŸçŠ¶æ€ç­‰ç»„ä»¶å¯ä»¥ç‹¬ç«‹æ›´æ–°å’Œå¤ç”¨

### 1.2 Context Engineering 2.0

ã€ŠContext Engineering 2.0: The Context of Context Engineeringã€‹æ˜¯ä¸Šæµ·äº¤é€šå¤§å­¦ã€ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤ï¼ˆSIIï¼‰ã€é€šç”¨äººå·¥æ™ºèƒ½ç ”ç©¶é™¢ï¼ˆGAIRï¼‰è”åˆå‘å¸ƒçš„ç ”ç©¶ï¼Œæ ¸å¿ƒæ˜¯é‡æ–°å®šä¹‰ "ä¸Šä¸‹æ–‡å·¥ç¨‹" è¿™ä¸€é¢†åŸŸï¼Œçº æ­£äº†å¤§ä¼—å¯¹å…¶çš„å¸¸è§è¯¯è§£ã€‚

ä¸Šä¸‹æ–‡å·¥ç¨‹ä¸æ˜¯ Prompt æŠ€å·§ã€RAG åº”ç”¨çš„ â€œå°æŠ€å·§é›†åˆâ€ï¼Œè€Œæ˜¯æœ‰ 30 å¹´å†å²çš„å­¦ç§‘ï¼ˆå¯è¿½æº¯è‡³ 1990 å¹´ä»£çš„æ™®é€‚è®¡ç®—ï¼‰ï¼Œæœ¬è´¨æ˜¯ â€œç†µå‡è¿‡ç¨‹â€â€”â€” æŠŠäººç±»æ¨¡ç³Šã€éšå«çš„ â€œé«˜ç†µæ„å›¾â€ï¼ˆæ¯”å¦‚ â€œè€åœ°æ–¹è§â€ï¼‰ï¼Œè½¬åŒ–ä¸ºæœºå™¨èƒ½æ‰§è¡Œçš„ â€œä½ç†µæŒ‡ä»¤â€ï¼ˆæ¯”å¦‚ â€œXX è·¯ 123 å·æ˜Ÿå·´å…‹ 15:00 è§â€ï¼‰ã€‚

ä¸Šä¸‹æ–‡å·¥ç¨‹çš„ 4 ä¸ªæ—¶ä»£ï¼š
- 1.0ï¼ˆ1991-2010ï¼‰ï¼šé ä¼ æ„Ÿå™¨æ”¶é›†ç‰©ç†ä¸Šä¸‹æ–‡ï¼ˆä½ç½®ã€æ—¶é—´ï¼‰ï¼Œç”¨è§„åˆ™è®©æœºå™¨ â€œæ„ŸçŸ¥â€ï¼›
- 1.5ï¼ˆ2010-2022ï¼‰ï¼šèå…¥æ•°å­—ä¸Šä¸‹æ–‡ï¼ˆæ—¥å†ã€å†å²è®°å½•ï¼‰ï¼›
- 2.0ï¼ˆ2022 è‡³ä»Šï¼‰ï¼šLLM è®©æœºå™¨èƒ½ç†è§£è‡ªç„¶è¯­è¨€æ„å»ºçš„å¤æ‚ä»»åŠ¡ä¸Šä¸‹æ–‡ï¼›
- 3.0/4.0ï¼ˆæœªæ¥ï¼‰ï¼šç±»äººæ™ºèƒ½ï¼ˆç†è§£æƒ…ç»ªã€ç¤¾ä¼šä¿¡å·ï¼‰â†’ è¶…äººç±»æ™ºèƒ½ï¼ˆä¸»åŠ¨æ„å»º / å¼•å¯¼ä¸Šä¸‹æ–‡ï¼‰ã€‚

å¹¶æå‡º **â€œé‡‡é›† - ç®¡ç† - ä½¿ç”¨â€ å…¨æ ˆæ¡†æ¶**ï¼š
- é‡‡é›†ï¼šå¤šæ¨¡æ€ï¼ˆæ–‡æœ¬ / å›¾åƒ / è„‘ç”µï¼‰+ åˆ†å¸ƒå¼ï¼ˆä¼ æ„Ÿå™¨ã€å¯ç©¿æˆ´è®¾å¤‡ï¼‰ï¼›
- ç®¡ç†ï¼šåˆ†å±‚è®°å¿†ï¼ˆçŸ­æœŸ = ä¸Šä¸‹æ–‡çª—å£ã€é•¿æœŸ = å‘é‡åº“ã€æŠ½è±¡ = çŸ¥è¯†å›¾è°±ï¼‰ï¼›
- ä½¿ç”¨ï¼šè·¨ Agent å…±äº«ã€ä¸»åŠ¨æ¨æ–­éšè—éœ€æ±‚ã€‚

ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿè´Ÿè´£æ•´åˆå’Œç®¡ç†å¯¹è¯è¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- **ç”¨æˆ·ç”»åƒ**: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€æ€§æ ¼ç‰¹å¾ã€å…´è¶£çˆ±å¥½ç­‰
- **å¯¹è¯å†å²**: çŸ­æœŸå¯¹è¯è®°å½•ï¼ˆæœ€è¿‘å‡ è½®ï¼‰
- **é•¿æœŸè®°å¿†**: ä»å‘é‡æ•°æ®åº“æ£€ç´¢çš„ç›¸å…³å†å²è®°å¿†
- **æƒ…æ„ŸçŠ¶æ€**: å½“å‰æƒ…ç»ªã€æƒ…ç»ªå¼ºåº¦ã€æƒ…ç»ªè¶‹åŠ¿
- **ä»»åŠ¡ç›®æ ‡**: å½“å‰å¯¹è¯çš„ç›®æ ‡å’Œæ„å›¾

é€šè¿‡æ™ºèƒ½çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œç³»ç»Ÿèƒ½å¤Ÿï¼š
- âœ… ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œè‡ªç„¶æ€§
- âœ… è®°ä½ç”¨æˆ·çš„é‡è¦ä¿¡æ¯å’Œåå¥½
- âœ… æ ¹æ®å†å²å¯¹è¯æä¾›ä¸ªæ€§åŒ–å›åº”
- âœ… è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡ï¼Œé¿å…ä¿¡æ¯ä¸¢å¤±

---

## 2. ä»£ç ç»“æ„

```
backend/
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ agent/
â”‚       â””â”€â”€ protocol/
â”‚           â””â”€â”€ mcp.py                    # MCPåè®® - ä¸Šä¸‹æ–‡ç»“æ„å®šä¹‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ context_service.py                 # ä¸Šä¸‹æ–‡æœåŠ¡å±‚ï¼ˆä¸»å…¥å£ï¼‰
â”‚   â”œâ”€â”€ enhanced_context_assembler.py     # å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç»„è£…å™¨
â”‚   â””â”€â”€ chat_service.py                   # èŠå¤©æœåŠ¡ï¼ˆä½¿ç”¨ä¸Šä¸‹æ–‡ï¼‰
â”œâ”€â”€ context_assembler.py                   # åŸºç¡€ä¸Šä¸‹æ–‡ç»„è£…å™¨
â””â”€â”€ memory_manager.py                      # è®°å¿†ç®¡ç†å™¨ï¼ˆæ”¯æŒä¸Šä¸‹æ–‡æ£€ç´¢ï¼‰
```

### 2.1 æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | å…³é”®ç±»/æ–¹æ³• |
|------|------|-----------|
| **MCPåè®®** | å®šä¹‰æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„ | `MCPContext`, `MCPMessage` |
| **ä¸Šä¸‹æ–‡æœåŠ¡** | æä¾›ä¸Šä¸‹æ–‡æ„å»ºçš„ç»Ÿä¸€æ¥å£ | `ContextService.build_context()` |
| **ä¸Šä¸‹æ–‡ç»„è£…å™¨** | æ•´åˆå„ç±»ä¸Šä¸‹æ–‡ä¿¡æ¯ | `ContextAssembler.assemble_context()` |
| **å¢å¼ºç‰ˆç»„è£…å™¨** | æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆè¯†åˆ«é‡è¦è½®æ¬¡ï¼‰ | `EnhancedContextAssembler` |
| **è®°å¿†ç®¡ç†å™¨** | æä¾›é•¿æœŸè®°å¿†æ£€ç´¢ | `MemoryManager.retrieve_memories()` |

---

## 3. æ ¸å¿ƒç»„ä»¶

### 3.1 MCPåè®®å±‚ (`backend/modules/agent/protocol/mcp.py`)

#### 3.1.1 MCPContext ç±»

**ä½ç½®**: ç¬¬82-100è¡Œ

**åŠŸèƒ½**: å®šä¹‰æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„

```python
class MCPContext(BaseModel):
    """MCPä¸Šä¸‹æ–‡ç»“æ„"""
    user_profile: Optional[Dict[str, Any]]      # ç”¨æˆ·ç”»åƒ
    emotion_state: Optional[Dict[str, Any]]     # æƒ…æ„ŸçŠ¶æ€
    task_goal: Optional[Dict[str, Any]]         # ä»»åŠ¡ç›®æ ‡
    memory_summary: Optional[Dict[str, Any]]   # è®°å¿†æ‘˜è¦
    conversation_history: Optional[List[Dict]]  # å¯¹è¯å†å²
    metadata: Optional[Dict[str, Any]]         # å…ƒæ•°æ®
```

**å…³é”®æ–¹æ³•**:
- `to_dict()`: è½¬æ¢ä¸ºå­—å…¸æ ¼å¼

#### 3.1.2 MCPProtocol ç±»

**ä½ç½®**: ç¬¬196-580è¡Œ

**æ ¸å¿ƒæ–¹æ³•**:

1. **`_enrich_context_from_service()`** (ç¬¬220-275è¡Œ)
   - ä»ä¸Šä¸‹æ–‡æœåŠ¡è‡ªåŠ¨å¡«å……ä¸Šä¸‹æ–‡
   - è°ƒç”¨ `ContextService.build_context()` è·å–å®Œæ•´ä¸Šä¸‹æ–‡
   - å°†ä¸Šä¸‹æ–‡æ•°æ®è½¬æ¢ä¸º `MCPContext` æ ¼å¼

2. **`create_user_input_with_context()`** (ç¬¬310-370è¡Œ)
   - åˆ›å»ºå¸¦è‡ªåŠ¨ä¸Šä¸‹æ–‡çš„ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
   - æ”¯æŒè‡ªåŠ¨å¡«å……å’Œæ‰‹åŠ¨è¦†ç›–
   - åˆå¹¶è‡ªåŠ¨å¡«å……çš„ä¸Šä¸‹æ–‡å’Œæ˜¾å¼æä¾›çš„å‚æ•°

3. **`merge_context()`** (ç¬¬548-580è¡Œ)
   - åˆå¹¶ä¸¤ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡
   - é™„åŠ ä¸Šä¸‹æ–‡ä¼˜å…ˆè¦†ç›–åŸºç¡€ä¸Šä¸‹æ–‡
   - å¯¹è¯å†å²é‡‡ç”¨è¿½åŠ ç­–ç•¥

### 3.2 ä¸Šä¸‹æ–‡æœåŠ¡å±‚ (`backend/services/context_service.py`)

#### 3.2.1 ContextService ç±»

**ä½ç½®**: ç¬¬13-133è¡Œ

**èŒè´£**: æä¾›ä¸Šä¸‹æ–‡æ„å»ºçš„ç»Ÿä¸€æ¥å£

**æ ¸å¿ƒæ–¹æ³•**:

1. **`build_context()`** (ç¬¬21-55è¡Œ)
   ```python
   async def build_context(
       self,
       user_id: str,
       session_id: str,
       current_message: str,
       emotion: Optional[str] = None,
       emotion_intensity: Optional[float] = None
   ) -> Dict[str, Any]
   ```
   - **åŠŸèƒ½**: æ„å»ºå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡
   - **æµç¨‹**:
     1. è·å–å¯¹è¯å†å² (`_get_chat_history()`)
     2. è°ƒç”¨ç»„è£…å™¨æ•´åˆä¸Šä¸‹æ–‡ (`assembler.assemble_context()`)
     3. è¿”å›å®Œæ•´ä¸Šä¸‹æ–‡æ•°æ®

2. **`build_prompt()`** (ç¬¬57-72è¡Œ)
   - æ ¹æ®ä¸Šä¸‹æ–‡æ„å»ºå®Œæ•´çš„promptæ–‡æœ¬
   - è°ƒç”¨ `assembler.build_prompt_context()`

3. **`_get_chat_history()`** (ç¬¬74-91è¡Œ)
   - ä»æ•°æ®åº“è·å–å¯¹è¯å†å²
   - é»˜è®¤é™åˆ¶æœ€è¿‘10è½®å¯¹è¯
   - è¿”å›æ ¼å¼åŒ–çš„å†å²è®°å½•åˆ—è¡¨

### 3.3 ä¸Šä¸‹æ–‡ç»„è£…å™¨ (`backend/context_assembler.py`)

#### 3.3.1 ContextAssembler ç±»

**ä½ç½®**: ç¬¬91-392è¡Œ

**èŒè´£**: æ•´åˆæ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

**æ ¸å¿ƒæ–¹æ³•**:

1. **`assemble_context()`** (ç¬¬99-159è¡Œ)
   ```python
   def assemble_context(
       self, 
       user_id: str, 
       session_id: str,
       current_message: str,
       chat_history: Optional[List[Dict[str, str]]] = None,
       emotion: Optional[str] = None,
       emotion_intensity: Optional[float] = None
   ) -> Dict[str, Any]
   ```
   
   **æ‰§è¡Œæ­¥éª¤**:
   1. è·å–ç”¨æˆ·ç”»åƒ (`get_user_profile()`)
   2. æ£€ç´¢ç›¸å…³è®°å¿† (`_retrieve_relevant_memories()`)
   3. è·å–æƒ…ç»ªè¶‹åŠ¿ (`memory_manager.get_user_emotion_trend()`)
   4. å¤„ç†å¯¹è¯å†å² (`_process_chat_history()`)
   5. ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡å­—å…¸

   **è¿”å›ç»“æ„**:
   ```python
   {
       "user_profile": {
           "summary": "...",      # ç”¨æˆ·ç”»åƒæ‘˜è¦
           "full": {...}          # å®Œæ•´ç”¨æˆ·ç”»åƒ
       },
       "memories": {
           "recent_events": [...],
           "concerns": [...],
           "relationships": [...],
           "all": [...]
       },
       "emotion_context": {
           "current_emotion": "...",
           "current_intensity": 5.0,
           "trend": {...}
       },
       "chat_history": [...],
       "current_message": "...",
       "metadata": {...}
   }
   ```

2. **`build_prompt_context()`** (ç¬¬161-224è¡Œ)
   - æ ¹æ®ä¸Šä¸‹æ–‡æ„å»ºå®Œæ•´çš„promptæ–‡æœ¬
   - åŒ…å«ç”¨æˆ·ç”»åƒã€è®°å¿†ã€æƒ…ç»ªã€å¯¹è¯å†å²ç­‰éƒ¨åˆ†
   - ç”Ÿæˆç»“æ„åŒ–çš„promptå­—ç¬¦ä¸²

3. **`_retrieve_relevant_memories()`** (ç¬¬226-248è¡Œ)
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´æ£€ç´¢ç­–ç•¥
   - é«˜å¼ºåº¦æƒ…ç»ªï¼ˆâ‰¥7.0ï¼‰: æ£€ç´¢æ›´å¤šè®°å¿†ï¼ˆ5æ¡ï¼Œ14å¤©ï¼‰
   - æ­£å¸¸æƒ…å†µ: æ£€ç´¢3æ¡ï¼Œ7å¤©å†…

4. **`_process_chat_history()`** (ç¬¬250-255è¡Œ)
   - å¤„ç†å¯¹è¯å†å²ï¼Œåªä¿ç•™æœ€è¿‘çš„å‡ è½®
   - é»˜è®¤ä¿ç•™æœ€è¿‘5è½®å¯¹è¯ï¼ˆ`max_turns=5`ï¼‰

### 3.4 å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç»„è£…å™¨ (`backend/services/enhanced_context_assembler.py`)

#### 3.4.1 EnhancedContextAssembler ç±»

**ä½ç½®**: ç¬¬13-207è¡Œ

**èŒè´£**: æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œè¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡

**æ ¸å¿ƒæ–¹æ³•**:

1. **`assemble_context()`** (ç¬¬21-93è¡Œ)
   - å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç»„è£…
   - è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡ (`_identify_important_turns()`)
   - è·å–çŸ­æœŸè®°å¿†ï¼ˆè£å‰ªåçš„å¯¹è¯å†å²ï¼‰
   - æ£€ç´¢é•¿æœŸè®°å¿†ï¼ˆå‘é‡æ£€ç´¢ï¼‰
   - è·å–ç”¨æˆ·ç”»åƒå’Œå¯¹è¯è„‰ç»œå›¾è°±

2. **`_identify_important_turns()`** (ç¬¬95-121è¡Œ)
   - è¯†åˆ«é‡è¦çš„å¯¹è¯è½®æ¬¡
   - åŸºäºæƒ…ç»ªå¼ºåº¦ã€å†…å®¹é‡è¦æ€§ç­‰åˆ¤æ–­
   - è¿”å›é‡è¦è½®æ¬¡çš„ç´¢å¼•åˆ—è¡¨

3. **`build_prompt_context()`** (ç¬¬123-178è¡Œ)
   - æ„å»ºå¢å¼ºç‰ˆprompt
   - åŒ…å«ç”¨æˆ·ç”»åƒã€å†å²è®°å¿†ã€æœ€è¿‘å¯¹è¯ã€å½“å‰çŠ¶æ€ç­‰

---

## 4. æ‰§è¡Œæµç¨‹

### 4.1 å®Œæ•´ä¸Šä¸‹æ–‡æ„å»ºæµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â†“
[1] æƒ…æ„Ÿåˆ†æ
    â†“
[2] ContextService.build_context()
    â”œâ”€â†’ è·å–å¯¹è¯å†å² (_get_chat_history)
    â””â”€â†’ ContextAssembler.assemble_context()
        â”œâ”€â†’ [3] è·å–ç”¨æˆ·ç”»åƒ (get_user_profile)
        â”œâ”€â†’ [4] æ£€ç´¢ç›¸å…³è®°å¿† (_retrieve_relevant_memories)
        â”œâ”€â†’ [5] è·å–æƒ…ç»ªè¶‹åŠ¿ (get_user_emotion_trend)
        â”œâ”€â†’ [6] å¤„ç†å¯¹è¯å†å² (_process_chat_history)
        â””â”€â†’ [7] ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡
    â†“
[8] è¿”å›ä¸Šä¸‹æ–‡æ•°æ®
    â†“
[9] æ„å»ºPrompt (build_prompt_context)
    â†“
[10] ç”Ÿæˆå›å¤
```

### 4.2 MCPåè®®ä¸Šä¸‹æ–‡å¡«å……æµç¨‹

```
ç”¨æˆ·è¾“å…¥ + user_id + session_id
    â†“
MCPProtocol.create_user_input_with_context()
    â†“
æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¡«å……ä¸Šä¸‹æ–‡
    â”œâ”€â†’ æ˜¯ â†’ _enrich_context_from_service()
    â”‚         â”œâ”€â†’ ContextService.build_context()
    â”‚         â””â”€â†’ è½¬æ¢ä¸º MCPContext
    â””â”€â†’ å¦ â†’ ä½¿ç”¨æ˜¾å¼æä¾›çš„å‚æ•°
    â†“
åˆå¹¶ä¸Šä¸‹æ–‡ (merge_context)
    â”œâ”€â†’ ç”¨æˆ·ç”»åƒåˆå¹¶
    â”œâ”€â†’ æƒ…æ„ŸçŠ¶æ€åˆå¹¶
    â”œâ”€â†’ å¯¹è¯å†å²è¿½åŠ 
    â””â”€â†’ å…ƒæ•°æ®åˆå¹¶
    â†“
åˆ›å»º MCPMessage
    â†“
è¿”å›å¸¦å®Œæ•´ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
```

### 4.3 å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç®¡ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â†“
EnhancedContextAssembler.assemble_context()
    â†“
[1] è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡
    â””â”€â†’ _identify_important_turns()
        â””â”€â†’ åŸºäºæƒ…ç»ªå¼ºåº¦ã€å†…å®¹é‡è¦æ€§åˆ¤æ–­
    â†“
[2] è·å–çŸ­æœŸè®°å¿†
    â””â”€â†’ get_short_term_context()
        â””â”€â†’ è£å‰ªå¯¹è¯å†å²ï¼Œä¿ç•™é‡è¦è½®æ¬¡
    â†“
[3] æ£€ç´¢é•¿æœŸè®°å¿†
    â””â”€â†’ retrieve_memories()
        â””â”€â†’ å‘é‡æ£€ç´¢ï¼Œæ”¯æŒæ—¶é—´è¡°å‡
    â†“
[4] è·å–ç”¨æˆ·ç”»åƒ
    â””â”€â†’ build_profile() + generate_profile_summary()
    â†“
[5] è·å–å¯¹è¯è„‰ç»œå›¾è°±
    â””â”€â†’ build_conversation_graph()
    â†“
[6] ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡
    â†“
è¿”å›å¢å¼ºç‰ˆä¸Šä¸‹æ–‡
```

---

## 5. æ•°æ®æµè½¬

### 5.1 ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„

#### 5.1.1 MCPContext ç»“æ„

```python
{
    "user_profile": {
        "name": "ç”¨æˆ·å§“å",
        "age": 25,
        "gender": "å¥³",
        "personality_traits": ["å†…å‘", "æ•æ„Ÿ"],
        "interests": ["é˜…è¯»", "éŸ³ä¹"],
        "concerns": ["å·¥ä½œå‹åŠ›", "äººé™…å…³ç³»"]
    },
    "emotion_state": {
        "emotion": "ç„¦è™‘",
        "intensity": 7.5,
        "trend": "æ³¢åŠ¨ä¸Šå‡"
    },
    "task_goal": {
        "goal_type": "emotional_support",
        "complexity": "medium"
    },
    "memory_summary": {
        "recent_events": [...],
        "concerns": [...],
        "relationships": [...],
        "count": 5
    },
    "conversation_history": [
        {"role": "user", "content": "..."},
        {"role": "assistant", "content": "..."}
    ]
}
```

#### 5.1.2 ContextService è¿”å›ç»“æ„

```python
{
    "user_profile": {
        "summary": "å§“åï¼šå¼ ä¸‰ï¼›å¹´é¾„ï¼š25å²ï¼›æ€§æ ¼ï¼šå†…å‘ã€æ•æ„Ÿ",
        "full": {...}  # å®Œæ•´ç”¨æˆ·ç”»åƒå¯¹è±¡
    },
    "memories": {
        "recent_events": [...],
        "concerns": [...],
        "relationships": [...],
        "all": [...]
    },
    "emotion_context": {
        "current_emotion": "ç„¦è™‘",
        "current_intensity": 7.5,
        "trend": {
            "trend": "æ³¢åŠ¨ä¸Šå‡",
            "emotions": [...]
        }
    },
    "chat_history": [
        {"role": "user", "content": "...", "emotion": "ç„¦è™‘"},
        {"role": "assistant", "content": "..."}
    ],
    "current_message": "ç”¨æˆ·å½“å‰è¾“å…¥",
    "metadata": {
        "user_id": "user_123",
        "session_id": "session_456",
        "timestamp": "2024-01-01T12:00:00"
    }
}
```

### 5.2 æ•°æ®æµè½¬è·¯å¾„

```
æ•°æ®åº“/å‘é‡åº“
    â†“
MemoryManager / DatabaseManager
    â†“
ContextAssembler
    â†“
ContextService
    â†“
MCPProtocol
    â†“
MCPMessage
    â†“
Agent Core / Chat Service
    â†“
LLM / Response Generator
```

---

## 6. å…³é”®æ–¹æ³•è¯¦è§£

### 6.1 ContextService.build_context()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/services/context_service.py:21-55`

**åŠŸèƒ½**: æ„å»ºå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡

**å‚æ•°**:
- `user_id`: ç”¨æˆ·ID
- `session_id`: ä¼šè¯ID
- `current_message`: å½“å‰ç”¨æˆ·æ¶ˆæ¯
- `emotion`: å½“å‰æƒ…ç»ªï¼ˆå¯é€‰ï¼‰
- `emotion_intensity`: æƒ…ç»ªå¼ºåº¦ï¼ˆå¯é€‰ï¼‰

**è¿”å›å€¼**: å®Œæ•´çš„ä¸Šä¸‹æ–‡å­—å…¸

**å†…éƒ¨è°ƒç”¨é“¾**:
```
build_context()
  â”œâ”€â†’ _get_chat_history()          # è·å–å¯¹è¯å†å²
  â””â”€â†’ assembler.assemble_context()  # ç»„è£…ä¸Šä¸‹æ–‡
      â”œâ”€â†’ get_user_profile()        # è·å–ç”¨æˆ·ç”»åƒ
      â”œâ”€â†’ _retrieve_relevant_memories()  # æ£€ç´¢è®°å¿†
      â”œâ”€â†’ get_user_emotion_trend()  # è·å–æƒ…ç»ªè¶‹åŠ¿
      â””â”€â†’ _process_chat_history()   # å¤„ç†å¯¹è¯å†å²
```

### 6.2 ContextAssembler.assemble_context()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/context_assembler.py:99-159`

**åŠŸèƒ½**: æ•´åˆæ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

**æ‰§è¡Œæ­¥éª¤è¯¦è§£**:

1. **è·å–ç”¨æˆ·ç”»åƒ** (ç¬¬119è¡Œ)
   ```python
   profile = self.get_user_profile(user_id)
   ```
   - ä»ç¼“å­˜æˆ–æ•°æ®åº“åŠ è½½ç”¨æˆ·ç”»åƒ
   - å¦‚æœä¸å­˜åœ¨ï¼Œä»è®°å¿†æ¨æ–­ç”Ÿæˆ

2. **æ£€ç´¢ç›¸å…³è®°å¿†** (ç¬¬122-124è¡Œ)
   ```python
   memories = self._retrieve_relevant_memories(
       user_id, current_message, emotion, emotion_intensity
   )
   ```
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´æ£€ç´¢ç­–ç•¥
   - ä½¿ç”¨å‘é‡æ£€ç´¢æ‰¾åˆ°ç›¸å…³å†å²è®°å¿†

3. **è·å–æƒ…ç»ªè¶‹åŠ¿** (ç¬¬127è¡Œ)
   ```python
   emotion_trend = self.memory_manager.get_user_emotion_trend(user_id, days=7)
   ```
   - åˆ†ææœ€è¿‘7å¤©çš„æƒ…ç»ªå˜åŒ–è¶‹åŠ¿

4. **å¤„ç†å¯¹è¯å†å²** (ç¬¬130è¡Œ)
   ```python
   recent_history = self._process_chat_history(chat_history or [], max_turns=5)
   ```
   - åªä¿ç•™æœ€è¿‘5è½®å¯¹è¯
   - é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿

5. **ç»„è£…ä¸Šä¸‹æ–‡** (ç¬¬133-157è¡Œ)
   - å°†æ‰€æœ‰ä¿¡æ¯æ•´åˆæˆç»Ÿä¸€çš„ä¸Šä¸‹æ–‡å­—å…¸

### 6.3 MCPProtocol.create_user_input_with_context()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/modules/agent/protocol/mcp.py:310-370`

**åŠŸèƒ½**: åˆ›å»ºå¸¦è‡ªåŠ¨ä¸Šä¸‹æ–‡çš„ç”¨æˆ·è¾“å…¥æ¶ˆæ¯

**å‚æ•°**:
- `content`: ç”¨æˆ·è¾“å…¥å†…å®¹
- `user_id`: ç”¨æˆ·IDï¼ˆç”¨äºè‡ªåŠ¨å¡«å……ï¼‰
- `session_id`: ä¼šè¯IDï¼ˆç”¨äºè‡ªåŠ¨å¡«å……ï¼‰
- `emotion`: å½“å‰æƒ…ç»ªï¼ˆå¯é€‰ï¼‰
- `emotion_intensity`: æƒ…ç»ªå¼ºåº¦ï¼ˆå¯é€‰ï¼‰
- `user_profile`: ç”¨æˆ·ç”»åƒï¼ˆå¯é€‰ï¼Œè¦†ç›–è‡ªåŠ¨å¡«å……ï¼‰
- `emotion_state`: æƒ…æ„ŸçŠ¶æ€ï¼ˆå¯é€‰ï¼Œè¦†ç›–è‡ªåŠ¨å¡«å……ï¼‰
- `conversation_history`: å¯¹è¯å†å²ï¼ˆå¯é€‰ï¼Œè¦†ç›–è‡ªåŠ¨å¡«å……ï¼‰

**æ‰§è¡Œé€»è¾‘**:
```python
if user_profile is None or emotion_state is None or conversation_history is None:
    # å°è¯•ä»ä¸Šä¸‹æ–‡æœåŠ¡è‡ªåŠ¨å¡«å……
    auto_context = await self._enrich_context_from_service(...)
    
    # åˆå¹¶è‡ªåŠ¨å¡«å……å’Œæ˜¾å¼æä¾›çš„å‚æ•°
    context = MCPContext(
        user_profile=user_profile or auto_context.user_profile,
        emotion_state=emotion_state or auto_context.emotion_state,
        ...
    )
else:
    # æ‰€æœ‰å‚æ•°éƒ½æä¾›äº†ï¼Œç›´æ¥ä½¿ç”¨
    context = MCPContext(...)
```

### 6.4 EnhancedContextAssembler._identify_important_turns()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/services/enhanced_context_assembler.py:95-121`

**åŠŸèƒ½**: è¯†åˆ«é‡è¦çš„å¯¹è¯è½®æ¬¡

**åˆ¤æ–­æ ‡å‡†**:
- æƒ…ç»ªå¼ºåº¦é«˜ï¼ˆâ‰¥7.0ï¼‰
- åŒ…å«é‡è¦å…³é”®è¯
- ç”¨æˆ·æ˜ç¡®è¡¨è¾¾éœ€æ±‚
- æ¶‰åŠé‡è¦è¯é¢˜

**å®ç°é€»è¾‘**:
```python
for i, msg in enumerate(chat_history):
    if msg.get("role") != "user":
        continue
    
    message_obj = {
        "content": msg.get("content", ""),
        "emotion_intensity": msg.get("emotion_intensity", 5.0)
    }
    
    if self.memory_manager.short_term.mark_important_turn(message_obj):
        important_markers.append(i)
```

---

## 7. Gitè·¯å¾„

### 7.1 æ ¸å¿ƒæ–‡ä»¶Gitè·¯å¾„

| æ–‡ä»¶ | Gitè·¯å¾„ |
|------|---------|
| **MCPåè®®** | `https://github.com/congde/emotional_chat/blob/main/backend/modules/agent/protocol/mcp.py` |
| **ä¸Šä¸‹æ–‡æœåŠ¡** | `https://github.com/congde/emotional_chat/blob/main/backend/services/context_service.py` |
| **ä¸Šä¸‹æ–‡ç»„è£…å™¨** | `https://github.com/congde/emotional_chat/blob/main/backend/context_assembler.py` |
| **å¢å¼ºç‰ˆç»„è£…å™¨** | `https://github.com/congde/emotional_chat/blob/main/backend/services/enhanced_context_assembler.py` |
| **èŠå¤©æœåŠ¡** | `https://github.com/congde/emotional_chat/blob/main/backend/services/chat_service.py` |

### 7.2 å…³é”®ä»£ç è¡Œå·

#### MCPåè®® (`mcp.py`)
- `MCPContext` ç±»: **ç¬¬82-100è¡Œ**
- `_enrich_context_from_service()`: **ç¬¬220-275è¡Œ**
- `create_user_input_with_context()`: **ç¬¬310-370è¡Œ**
- `merge_context()`: **ç¬¬548-580è¡Œ**

#### ä¸Šä¸‹æ–‡æœåŠ¡ (`context_service.py`)
- `build_context()`: **ç¬¬21-55è¡Œ**
- `_get_chat_history()`: **ç¬¬74-91è¡Œ**

#### ä¸Šä¸‹æ–‡ç»„è£…å™¨ (`context_assembler.py`)
- `assemble_context()`: **ç¬¬99-159è¡Œ**
- `build_prompt_context()`: **ç¬¬161-224è¡Œ**
- `_retrieve_relevant_memories()`: **ç¬¬226-248è¡Œ**
- `_process_chat_history()`: **ç¬¬250-255è¡Œ**

#### å¢å¼ºç‰ˆç»„è£…å™¨ (`enhanced_context_assembler.py`)
- `assemble_context()`: **ç¬¬21-93è¡Œ**
- `_identify_important_turns()`: **ç¬¬95-121è¡Œ**
- `build_prompt_context()`: **ç¬¬123-178è¡Œ**

---

## 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 åŸºç¡€ä¸Šä¸‹æ–‡æ„å»º

```python
from backend.services.context_service import ContextService

# åˆå§‹åŒ–æœåŠ¡
context_service = ContextService()

# æ„å»ºä¸Šä¸‹æ–‡
context = await context_service.build_context(
    user_id="user_123",
    session_id="session_456",
    current_message="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    emotion="ç„¦è™‘",
    emotion_intensity=7.5
)

# æ„å»ºPrompt
prompt = await context_service.build_prompt(
    context=context,
    system_prompt=XINYU_SYSTEM_PROMPT
)
```

### 8.2 MCPåè®®ä¸Šä¸‹æ–‡ä½¿ç”¨

```python
from backend.modules.agent.protocol.mcp import MCPProtocol

# åˆå§‹åŒ–åè®®å¤„ç†å™¨ï¼ˆå¸¦ä¸Šä¸‹æ–‡æœåŠ¡ï¼‰
protocol = MCPProtocol()

# åˆ›å»ºå¸¦è‡ªåŠ¨ä¸Šä¸‹æ–‡çš„ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
user_message = await protocol.create_user_input_with_context(
    content="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    user_id="user_123",
    session_id="session_456",
    emotion="ç„¦è™‘",
    emotion_intensity=7.5
)

# æ¶ˆæ¯å·²åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
print(user_message.context.user_profile)
print(user_message.context.conversation_history)
print(user_message.context.emotion_state)
```

### 8.3 å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç®¡ç†

```python
from backend.services.enhanced_context_assembler import EnhancedContextAssembler

# åˆå§‹åŒ–å¢å¼ºç‰ˆç»„è£…å™¨
assembler = EnhancedContextAssembler()

# ç»„è£…å¢å¼ºç‰ˆä¸Šä¸‹æ–‡
context = await assembler.assemble_context(
    user_id="user_123",
    session_id="session_456",
    current_message="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    chat_history=[...],
    emotion="ç„¦è™‘",
    emotion_intensity=7.5
)

# æ„å»ºPrompt
prompt = assembler.build_prompt_context(
    context=context,
    system_prompt=XINYU_SYSTEM_PROMPT
)
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 ä¸Šä¸‹æ–‡ç®¡ç†åŸåˆ™

1. **åˆ†å±‚ç®¡ç†**
   - çŸ­æœŸè®°å¿†ï¼šæœ€è¿‘å‡ è½®å¯¹è¯ï¼ˆ5-10è½®ï¼‰
   - é•¿æœŸè®°å¿†ï¼šå‘é‡æ£€ç´¢çš„ç›¸å…³å†å²è®°å¿†
   - ç”¨æˆ·ç”»åƒï¼šæŒä¹…åŒ–çš„ç”¨æˆ·ç‰¹å¾

2. **æ™ºèƒ½è£å‰ª**
   - ä¿ç•™é‡è¦å¯¹è¯è½®æ¬¡
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´è®°å¿†æ£€ç´¢èŒƒå›´
   - é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿å¯¼è‡´æ€§èƒ½é—®é¢˜

3. **è‡ªåŠ¨å¡«å……**
   - ä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨å¡«å……çš„ä¸Šä¸‹æ–‡
   - æ”¯æŒæ‰‹åŠ¨è¦†ç›–ç‰¹å®šå­—æ®µ
   - åˆå¹¶ç­–ç•¥ï¼šé™„åŠ ä¸Šä¸‹æ–‡ä¼˜å…ˆ

### 9.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ç”¨æˆ·ç”»åƒ**
   - ä½¿ç”¨å†…å­˜ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
   - å®šæœŸæ›´æ–°ç¼“å­˜

2. **é™åˆ¶å¯¹è¯å†å²**
   - é»˜è®¤ä¿ç•™æœ€è¿‘5-10è½®å¯¹è¯
   - é‡è¦è½®æ¬¡å•ç‹¬æ ‡è®°ä¿ç•™

3. **å‘é‡æ£€ç´¢ä¼˜åŒ–**
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´æ£€ç´¢æ•°é‡
   - ä½¿ç”¨æ—¶é—´è¡°å‡å‡å°‘æ— å…³è®°å¿†

---

## 10. ä¸Šä¸‹æ–‡è…çƒ‚ï¼ˆContext Rotï¼‰è§£å†³æ–¹æ¡ˆ

### 10.1 é—®é¢˜èƒŒæ™¯

**ä¸Šä¸‹æ–‡è…çƒ‚ï¼ˆContext Rotï¼‰** æ˜¯æŒ‡åœ¨é•¿ä¸Šä¸‹æ–‡åœºæ™¯ä¸­ï¼Œå½“ä¸Šä¸‹æ–‡çª—å£è¶…è¿‡æŸä¸ª"è…çƒ‚é˜ˆå€¼"ï¼ˆPre-rot thresholdï¼‰åï¼ŒAIæ¨¡å‹å¯¹è¿œç«¯ä¿¡æ¯çš„ç†è§£å’Œåˆ©ç”¨èƒ½åŠ›æ€¥å‰§ä¸‹é™çš„ç°è±¡ã€‚

#### 10.1.1 è…çƒ‚é˜ˆå€¼

æ ¹æ® Manus å’Œ LangChain çš„ç ”ç©¶ï¼Œä¸Šä¸‹æ–‡è…çƒ‚çš„é˜ˆå€¼é€šå¸¸ä¸ºï¼š

- **å®‰å…¨åŒºåŸŸï¼ˆ0-128K tokensï¼‰**: ç»¿è‰²åŒºåŸŸï¼Œæ¨¡å‹èƒ½å¤Ÿæœ‰æ•ˆå¤„ç†ä¸Šä¸‹æ–‡ä¿¡æ¯
- **è­¦å‘ŠåŒºåŸŸï¼ˆ128K-200K tokensï¼‰**: æ©™è‰²åŒºåŸŸï¼Œæ€§èƒ½å¼€å§‹è¡°å‡
- **å±é™©åŒºåŸŸï¼ˆ>200K tokensï¼‰**: ç™½è‰²åŒºåŸŸï¼Œå¤§éƒ¨åˆ†ä¸Šä¸‹æ–‡å‡ ä¹è¢«æ¨¡å‹"å¿½ç•¥"

å³ä½¿æ¨¡å‹å£°ç§°æ”¯æŒç™¾ä¸‡çº§tokençš„ä¸Šä¸‹æ–‡çª—å£ï¼Œå®é™…å¯ç”¨çš„æœ‰æ•ˆä¸Šä¸‹æ–‡å¾€å¾€è¿œå°äºè¿™ä¸ªæ•°å­—ã€‚

#### 10.1.2 æ ¸å¿ƒæŒ‘æˆ˜

AI æ™ºèƒ½ä½“é€šè¿‡è‡ªä¸»ä¸å·¥å…·äº¤äº’å¹¶ç§¯ç´¯è§‚å¯Ÿç»“æœï¼Œäº¤äº’è½®æ¬¡å˜é•¿åä¼šå¯¼è‡´ä¸Šä¸‹æ–‡é•¿åº¦ä¸å—é™åˆ¶åœ°çˆ†ç‚¸å¼å¢é•¿ã€‚è¿™ç§ä¸æ–­å¢é•¿çš„ä¸Šä¸‹æ–‡é•¿åº¦ä¼šé™ä½ LLM çš„æ€§èƒ½ï¼Œå½¢æˆä¸€ä¸ªæ‚–è®ºï¼š

> **æ™ºèƒ½ä½“éœ€è¦å¤§é‡çš„ä¸Šä¸‹æ–‡ï¼Œä½†æ›´é•¿çš„ä¸Šä¸‹æ–‡ä¼šæŸå®³å…¶æ•ˆç‡å’Œå‡†ç¡®æ€§ã€‚**

### 10.2 è§£å†³æ–¹æ¡ˆæ¶æ„

æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡è…çƒ‚è§£å†³æ–¹æ¡ˆåŸºäº Manus çš„æœ€ä½³å®è·µï¼Œå®ç°äº†å››å¤§æ ¸å¿ƒæŠ€æœ¯ï¼š

1. **ä¸Šä¸‹æ–‡ç¼©å‡ï¼ˆContext Reductionï¼‰**: å‹ç¼©ä¸æ‘˜è¦
2. **ä¸Šä¸‹æ–‡æ£€ç´¢ï¼ˆContext Retrievalï¼‰**: æ–‡ä»¶ç³»ç»Ÿå·¥å…·å›å½’
3. **ä¸Šä¸‹æ–‡éš”ç¦»ï¼ˆContext Isolationï¼‰**: å¤šæ™ºèƒ½ä½“è®¾è®¡æ”¯æŒ
4. **ä¸Šä¸‹æ–‡å¸è½½ï¼ˆContext Offloadingï¼‰**: æ–‡ä»¶ç³»ç»Ÿå¤–éƒ¨åŒ–

### 10.3 æ ¸å¿ƒç»„ä»¶

#### 10.3.1 ContextRotSolver - ä¸Šä¸‹æ–‡è…çƒ‚è§£å†³æ–¹æ¡ˆä¸»æ§åˆ¶å™¨

**ä½ç½®**: `backend/services/context_rot_solver.py`

**æ ¸å¿ƒåŠŸèƒ½**:

```python
from backend.services.context_rot_solver import ContextRotSolver, ContextRotThreshold

# åˆå§‹åŒ–ï¼ˆé»˜è®¤é˜ˆå€¼128K tokensï¼‰
solver = ContextRotSolver(pre_rot_threshold=ContextRotThreshold.SAFE.value)

# ä¼°ç®—tokenæ•°é‡
token_count = solver.estimate_tokens(context)

# æ£€æŸ¥ä¸Šä¸‹æ–‡çŠ¶æ€
status = solver.get_context_status(context)
# è¿”å›: {
#     "token_count": 150000,
#     "threshold": 128000,
#     "usage_percent": 117.2,
#     "status": "warning",
#     "recommendation": "å»ºè®®è¿›è¡Œå‹ç¼©æˆ–æ‘˜è¦"
# }

# è‡ªåŠ¨ç¼©å‡ä¸Šä¸‹æ–‡
reduced_context = solver.reduce_context(context, preserve_recent_turns=5)
```

**å…³é”®æ–¹æ³•**:

1. **`estimate_tokens()`**: ä¼°ç®—ä¸Šä¸‹æ–‡çš„tokenæ•°é‡
   - ä¸­æ–‡å­—ç¬¦çº¦1.5ä¸ªtoken
   - è‹±æ–‡å­—ç¬¦çº¦0.5ä¸ªtoken

2. **`should_compact()`**: åˆ¤æ–­æ˜¯å¦éœ€è¦å‹ç¼©ï¼ˆè¾¾åˆ°80%é˜ˆå€¼æ—¶è§¦å‘ï¼‰

3. **`should_summarize()`**: åˆ¤æ–­æ˜¯å¦éœ€è¦æ‘˜è¦ï¼ˆè¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘ï¼‰

4. **`reduce_context()`**: ç¼©å‡ä¸Šä¸‹æ–‡
   - å…ˆå°è¯•å‹ç¼©ï¼ˆå¯é€†ï¼‰
   - å¦‚æœä»è¶…è¿‡é˜ˆå€¼ï¼Œè¿›è¡Œæ‘˜è¦ï¼ˆä¸å¯é€†ï¼‰

5. **`get_context_status()`**: è·å–ä¸Šä¸‹æ–‡çŠ¶æ€æŠ¥å‘Š

#### 10.3.2 ContextCompactionStrategy - ä¸Šä¸‹æ–‡å‹ç¼©ç­–ç•¥

**åŠŸèƒ½**: å¯é€†çš„å¤–éƒ¨åŒ–è¿‡ç¨‹ï¼Œå°†å¯ä»¥ä»å¤–éƒ¨çŠ¶æ€é‡å»ºçš„ä¿¡æ¯ä»ä¸Šä¸‹æ–‡ä¸­å‰¥ç¦»

**å‹ç¼©ç­–ç•¥**:

```python
from backend.services.context_rot_solver import ContextCompactionStrategy

compaction = ContextCompactionStrategy(storage_dir="./context_storage")

# å‹ç¼©å·¥å…·è°ƒç”¨ï¼ˆæ–‡ä»¶æ“ä½œï¼‰
compacted_call = compaction.compact_tool_call(tool_call)
# ç»“æœ: æ–‡ä»¶å†…å®¹è¢«ä¿å­˜åˆ°å¤–éƒ¨å­˜å‚¨ï¼Œåªä¿ç•™è·¯å¾„å¼•ç”¨

# æ¢å¤å‹ç¼©çš„å·¥å…·è°ƒç”¨
expanded_call = compaction.expand_tool_call(compacted_call)
# ç»“æœ: ä»å¤–éƒ¨å­˜å‚¨æ¢å¤å®Œæ•´å†…å®¹
```

**å‹ç¼©åœºæ™¯**:

1. **æ–‡ä»¶æ“ä½œ**: å°†æ–‡ä»¶å†…å®¹å¤–éƒ¨åŒ–ï¼Œåªä¿ç•™è·¯å¾„
2. **æœç´¢ç»“æœ**: å°†å®Œæ•´æœç´¢ç»“æœå¤–éƒ¨åŒ–ï¼Œåªä¿ç•™æ‘˜è¦å’Œå‰å‡ æ¡

**ä¼˜åŠ¿**: 
- âœ… å¯é€†ï¼šä¿¡æ¯æ²¡æœ‰çœŸæ­£ä¸¢å¤±ï¼Œåªæ˜¯è¢«å¤–éƒ¨åŒ–
- âœ… æ™ºèƒ½ä½“éœ€è¦æ—¶å¯ä»¥æ¢å¤å®Œæ•´å†…å®¹
- âœ… å¤§å¹…å‡å°‘tokenå ç”¨

#### 10.3.3 ContextSummarizer - ä¸Šä¸‹æ–‡æ‘˜è¦å™¨

**åŠŸèƒ½**: ä¸å¯é€†çš„ä¿¡æ¯æµ“ç¼©ï¼Œä½¿ç”¨ç»“æ„åŒ–æ¨¡å¼ç¡®ä¿ä¸€è‡´æ€§

**æ‘˜è¦æ¨¡å¼**ï¼ˆå‚è€ƒ Manus çš„åšæ³•ï¼‰:

```python
from backend.services.context_rot_solver import ContextSummarizer

summarizer = ContextSummarizer()

# ç»“æ„åŒ–æ‘˜è¦æ¨¡å¼
schema = {
    "modified_topics": "ç”¨æˆ·è®¨è®ºçš„ä¸»è¦è¯é¢˜åˆ—è¡¨",
    "user_goals": "ç”¨æˆ·è¡¨è¾¾çš„ç›®æ ‡æˆ–éœ€æ±‚",
    "key_decisions": "è¾¾æˆçš„é‡è¦å†³å®šæˆ–å…±è¯†",
    "unresolved_issues": "æœªè§£å†³çš„é—®é¢˜",
    "emotional_state": "æƒ…ç»ªçŠ¶æ€å˜åŒ–",
    "last_stop_point": "ä¸Šæ¬¡åœæ­¢çš„ä½ç½®æˆ–ä¸Šä¸‹æ–‡"
}

# æ‘˜è¦å¯¹è¯è½®æ¬¡
summary = summarizer.summarize_conversation_turns(turns, schema)
```

**æ‘˜è¦ç‰¹ç‚¹**:

- âœ… ä½¿ç”¨ç»“æ„åŒ–æ¨¡å¼ï¼Œè€Œéè‡ªç”±å½¢å¼æç¤º
- âœ… ç¡®ä¿è¾“å‡ºçš„ç¨³å®šæ€§å’Œä¸€è‡´æ€§
- âœ… å¼ºåˆ¶AIæ¦‚æ‹¬ç‰¹å®šä¿¡æ¯ï¼Œè€Œééšæ„ç”Ÿæˆ

**æ‘˜è¦å‰å¤„ç†**:

- å°†å…³é”®ä¸Šä¸‹æ–‡éƒ¨åˆ†å¸è½½åˆ°æ–‡ä»¶ä¸­
- å§‹ç»ˆä¿ç•™æœ€åå‡ æ¬¡å·¥å…·è°ƒç”¨çš„å®Œæ•´ç»†èŠ‚
- ä¿ç•™æœ€åå‡ è½®å¯¹è¯çš„å®Œæ•´å†…å®¹

#### 10.3.4 ContextRetrievalOptimizer - ä¸Šä¸‹æ–‡æ£€ç´¢ä¼˜åŒ–å™¨

**åŠŸèƒ½**: ä¼˜å…ˆä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå·¥å…·ï¼ˆglobã€grepï¼‰è€Œéå‘é‡ç´¢å¼•ï¼Œé€‚ç”¨äºç¬æ—¶ä¼šè¯åœºæ™¯

**è®¾è®¡ç†å¿µ**ï¼ˆå‚è€ƒ Manusï¼‰:

> ç”±äºä¼šè¯çš„ç¬æ—¶æ€§ï¼ŒåŠ¨æ€æ„å»ºç´¢å¼•æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œå› ä¸ºæ¯æ¬¡ä¼šè¯éƒ½æ˜¯ä¸€ä¸ªå…¨æ–°çš„ç¯å¢ƒï¼Œæ²¡æœ‰æ—¶é—´å»åŠ¨æ€æ„å»ºç´¢å¼•ã€‚å› æ­¤ï¼Œä¾èµ–äºå¯¹åŸºäºè¡Œçš„æ–‡æœ¬æ ¼å¼ï¼ˆå¦‚çº¯æ–‡æœ¬è€Œé Markdownï¼‰è¿›è¡Œæ“ä½œçš„æˆç†Ÿå‘½ä»¤è¡Œå·¥å…·ï¼Œæ˜¯æ›´é«˜æ•ˆçš„é€‰æ‹©ã€‚

**ä½¿ç”¨ç¤ºä¾‹**:

```python
from backend.services.context_retrieval_optimizer import ContextRetrievalOptimizer

optimizer = ContextRetrievalOptimizer()

# ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæœç´¢
results = optimizer.retrieve_relevant_context(
    query="ç”¨æˆ·æƒ…ç»ªç„¦è™‘",
    context_type="conversation",
    max_results=5
)

# æ ¹æ®æ–‡ä»¶è·¯å¾„æ£€ç´¢
content = optimizer.retrieve_by_file_path(
    file_path="./context_storage/context_123.json",
    start_line=1,
    end_line=100
)
```

**æ£€ç´¢ç­–ç•¥**:

1. **ç®€å•æœç´¢**: ç›´æ¥å°†å®Œæ•´æœç´¢ç»“æœé™„åŠ åˆ°ä¸Šä¸‹æ–‡ä¸­ï¼Œä¾èµ–å‹ç¼©æœºåˆ¶ç®¡ç†
2. **å¤æ‚æœç´¢**: å¯åŠ¨å­æ™ºèƒ½ä½“ï¼ˆ"æ™ºèƒ½ä½“å³å·¥å…·"ï¼‰å¤„ç†ã€æ•´åˆä¿¡æ¯

### 10.4 é›†æˆåˆ°ä¸Šä¸‹æ–‡æœåŠ¡

#### 10.4.1 è‡ªåŠ¨ä¸Šä¸‹æ–‡ä¼˜åŒ–

`ContextService` å·²é›†æˆä¸Šä¸‹æ–‡è…çƒ‚è§£å†³æ–¹æ¡ˆï¼Œæ”¯æŒè‡ªåŠ¨ä¼˜åŒ–ï¼š

```python
from backend.services.context_service import ContextService

# åˆå§‹åŒ–ï¼ˆé»˜è®¤å¯ç”¨rot_solverï¼‰
context_service = ContextService(
    enable_rot_solver=True,
    rot_threshold=128000  # 128K tokens
)

# æ„å»ºä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨åº”ç”¨ä¼˜åŒ–ï¼‰
context = await context_service.build_context(
    user_id="user_123",
    session_id="session_456",
    current_message="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    emotion="ç„¦è™‘",
    emotion_intensity=7.5,
    auto_reduce=True  # è‡ªåŠ¨ç¼©å‡ä¸Šä¸‹æ–‡
)

# æ£€æŸ¥ä¸Šä¸‹æ–‡çŠ¶æ€
status = context_service.get_context_status(context)
if status["status"] == "warning":
    print(f"è­¦å‘Š: ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡ {status['usage_percent']:.1f}%")
    print(f"å»ºè®®: {status['recommendation']}")
```

#### 10.4.2 æ‰‹åŠ¨ä¸Šä¸‹æ–‡å¸è½½

å¯¹äºè¶…é•¿ä¸Šä¸‹æ–‡ï¼Œå¯ä»¥æ‰‹åŠ¨å¸è½½åˆ°æ–‡ä»¶ç³»ç»Ÿï¼š

```python
# å¸è½½ä¸Šä¸‹æ–‡åˆ°æ–‡ä»¶
offloaded, file_path = await context_service.offload_context(
    context=context,
    session_id="session_456"
)

# åç»­éœ€è¦æ—¶åŠ è½½
full_context = await context_service.load_offloaded_context(file_path)
```

### 10.5 æ‰§è¡Œæµç¨‹

#### 10.5.1 ä¸Šä¸‹æ–‡ç¼©å‡æµç¨‹

```
æ„å»ºä¸Šä¸‹æ–‡
    â†“
ä¼°ç®—tokenæ•°é‡
    â†“
æ£€æŸ¥æ˜¯å¦è¶…è¿‡é˜ˆå€¼
    â”œâ”€â†’ å¦ â†’ ç›´æ¥è¿”å›
    â””â”€â†’ æ˜¯ â†’ åº”ç”¨ç¼©å‡ç­–ç•¥
        â”œâ”€â†’ [1] å‹ç¼©ï¼ˆå¯é€†ï¼‰
        â”‚   â””â”€â†’ å°†å¯é‡å»ºä¿¡æ¯å¤–éƒ¨åŒ–
        â”‚       â”œâ”€â†’ æ–‡ä»¶å†…å®¹ â†’ æ–‡ä»¶è·¯å¾„
        â”‚       â””â”€â†’ æœç´¢ç»“æœ â†’ å­˜å‚¨è·¯å¾„ + æ‘˜è¦
        â”‚
        â””â”€â†’ [2] å¦‚æœä»è¶…è¿‡é˜ˆå€¼ â†’ æ‘˜è¦ï¼ˆä¸å¯é€†ï¼‰
            â””â”€â†’ ä½¿ç”¨ç»“æ„åŒ–æ¨¡å¼æ‘˜è¦æ—©æœŸå¯¹è¯
                â”œâ”€â†’ ä¿ç•™æœ€è¿‘Nè½®å®Œæ•´å¯¹è¯
                â””â”€â†’ æ—©æœŸå¯¹è¯å‹ç¼©ä¸ºæ‘˜è¦
    â†“
è¿”å›ä¼˜åŒ–åçš„ä¸Šä¸‹æ–‡
```

#### 10.5.2 å‹ç¼©ç­–ç•¥æ‰§è¡Œæµç¨‹

```
å·¥å…·è°ƒç”¨å†å²
    â†“
åˆ†ç¦»ä¸ºä¸¤éƒ¨åˆ†
    â”œâ”€â†’ æ—§å·¥å…·è°ƒç”¨ï¼ˆéœ€è¦å‹ç¼©ï¼‰
    â””â”€â†’ æœ€è¿‘Nè½®ï¼ˆä¿ç•™å®Œæ•´ï¼‰
    â†“
å‹ç¼©æ—§å·¥å…·è°ƒç”¨
    â”œâ”€â†’ æ–‡ä»¶æ“ä½œ â†’ ä¿å­˜å†…å®¹åˆ°å¤–éƒ¨å­˜å‚¨
    â”œâ”€â†’ æœç´¢ç»“æœ â†’ ä¿å­˜ç»“æœåˆ°å¤–éƒ¨å­˜å‚¨
    â””â”€â†’ åªä¿ç•™è·¯å¾„å¼•ç”¨
    â†“
åˆå¹¶å‹ç¼©åçš„è°ƒç”¨ + å®Œæ•´è°ƒç”¨
    â†“
è¿”å›å‹ç¼©åçš„ä¸Šä¸‹æ–‡
```

#### 10.5.3 æ‘˜è¦ç­–ç•¥æ‰§è¡Œæµç¨‹

```
å¯¹è¯å†å²
    â†“
åˆ†ç¦»ä¸ºä¸¤éƒ¨åˆ†
    â”œâ”€â†’ æ—©æœŸå¯¹è¯ï¼ˆéœ€è¦æ‘˜è¦ï¼‰
    â””â”€â†’ æœ€è¿‘Nè½®ï¼ˆä¿ç•™å®Œæ•´ï¼‰
    â†“
ä½¿ç”¨ç»“æ„åŒ–æ¨¡å¼æ‘˜è¦æ—©æœŸå¯¹è¯
    â”œâ”€â†’ æå–ä¸»è¦è¯é¢˜
    â”œâ”€â†’ æå–ç”¨æˆ·ç›®æ ‡
    â”œâ”€â†’ æå–é‡è¦å†³å®š
    â”œâ”€â†’ æå–æœªè§£å†³é—®é¢˜
    â””â”€â†’ æå–æƒ…ç»ªè¶‹åŠ¿
    â†“
ç»„è£…æ‘˜è¦ + å®Œæ•´å¯¹è¯
    â†“
è¿”å›æ‘˜è¦åçš„ä¸Šä¸‹æ–‡
```

### 10.6 ä½¿ç”¨ç¤ºä¾‹

#### 10.6.1 åŸºç¡€ä½¿ç”¨

```python
from backend.services.context_service import ContextService
from backend.services.context_rot_solver import ContextRotThreshold

# åˆå§‹åŒ–æœåŠ¡ï¼ˆå¯ç”¨ä¸Šä¸‹æ–‡è…çƒ‚è§£å†³æ–¹æ¡ˆï¼‰
context_service = ContextService(
    enable_rot_solver=True,
    rot_threshold=ContextRotThreshold.SAFE.value  # 128K
)

# æ„å»ºä¸Šä¸‹æ–‡ï¼ˆè‡ªåŠ¨ä¼˜åŒ–ï¼‰
context = await context_service.build_context(
    user_id="user_123",
    session_id="session_456",
    current_message="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    auto_reduce=True  # è‡ªåŠ¨ç¼©å‡
)

# æ£€æŸ¥ä¼˜åŒ–ç»“æœ
if "optimization" in context:
    opt_info = context["optimization"]
    print(f"åŸå§‹tokenæ•°: {opt_info['original_tokens']}")
    print(f"ç¼©å‡åtokenæ•°: {opt_info['reduced_tokens']}")
    print(f"ä¼˜åŒ–çŠ¶æ€: {opt_info['status']}")
```

#### 10.6.2 æ‰‹åŠ¨æ§åˆ¶å‹ç¼©å’Œæ‘˜è¦

```python
from backend.services.context_rot_solver import (
    ContextRotSolver,
    ContextCompactionStrategy,
    ContextSummarizer
)

# åˆå§‹åŒ–ç»„ä»¶
solver = ContextRotSolver(pre_rot_threshold=128000)
compaction = ContextCompactionStrategy()
summarizer = ContextSummarizer()

# æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©
if solver.should_compact(context):
    # åº”ç”¨å‹ç¼©
    context = solver._apply_compaction(context, preserve_recent_turns=5)
    print("å·²åº”ç”¨å‹ç¼©ç­–ç•¥")

# æ£€æŸ¥æ˜¯å¦éœ€è¦æ‘˜è¦
if solver.should_summarize(context):
    # åº”ç”¨æ‘˜è¦
    context = solver._apply_summarization(context, preserve_recent_turns=5)
    print("å·²åº”ç”¨æ‘˜è¦ç­–ç•¥")
```

#### 10.6.3 ä¸Šä¸‹æ–‡å¸è½½å’Œæ¢å¤

```python
# å¸è½½è¶…é•¿ä¸Šä¸‹æ–‡
offloaded, file_path = await context_service.offload_context(
    context=very_long_context,
    session_id="session_456"
)

# ç²¾ç®€åçš„ä¸Šä¸‹æ–‡åªåŒ…å«å¼•ç”¨
print(offloaded["storage_path"])  # æ–‡ä»¶è·¯å¾„
print(offloaded["summary"]["token_count"])  # åŸå§‹tokenæ•°

# éœ€è¦æ—¶æ¢å¤å®Œæ•´ä¸Šä¸‹æ–‡
full_context = await context_service.load_offloaded_context(file_path)
```

#### 10.6.4 ä¸Šä¸‹æ–‡æ£€ç´¢ä¼˜åŒ–

```python
# ä½¿ç”¨ä¼˜åŒ–çš„æ£€ç´¢ç­–ç•¥
results = await context_service.retrieve_relevant_context(
    query="ç”¨æˆ·æƒ…ç»ªç„¦è™‘",
    context_type="conversation",
    max_results=5
)

for result in results:
    print(f"æ–‡ä»¶: {result['file']}")
    print(f"è¡Œå·: {result['line']}")
    print(f"ç‰‡æ®µ: {result['snippet']}")
    print(f"åŒ¹é…å…³é”®è¯: {result['matched_keywords']}")
```

### 10.7 æœ€ä½³å®è·µ

#### 10.7.1 é˜ˆå€¼è®¾ç½®

æ ¹æ®æ¨¡å‹èƒ½åŠ›è®¾ç½®åˆé€‚çš„é˜ˆå€¼ï¼š

```python
# Claude 3.5 Sonnet (200K context window)
solver = ContextRotSolver(pre_rot_threshold=160000)  # 80% of 200K

# GPT-4 Turbo (128K context window)
solver = ContextRotSolver(pre_rot_threshold=102400)  # 80% of 128K

# æ›´ä¿å®ˆçš„è®¾ç½®ï¼ˆç¡®ä¿æ€§èƒ½ï¼‰
solver = ContextRotSolver(pre_rot_threshold=64000)  # 50% of 128K
```

#### 10.7.2 å‹ç¼© vs æ‘˜è¦

**ä¼˜å…ˆä½¿ç”¨å‹ç¼©**:
- âœ… å¯é€†ï¼Œä¿¡æ¯ä¸ä¸¢å¤±
- âœ… æ™ºèƒ½ä½“éœ€è¦æ—¶å¯ä»¥æ¢å¤
- âœ… é€‚ç”¨äºæ–‡ä»¶æ“ä½œã€æœç´¢ç»“æœç­‰

**è°¨æ…ä½¿ç”¨æ‘˜è¦**:
- âš ï¸ ä¸å¯é€†ï¼Œä¿¡æ¯ä¼šä¸¢å¤±
- âš ï¸ æ‘˜è¦å‰å…ˆå¸è½½å…³é”®ä¸Šä¸‹æ–‡åˆ°æ–‡ä»¶
- âš ï¸ å§‹ç»ˆä¿ç•™æœ€åå‡ æ¬¡å·¥å…·è°ƒç”¨å’Œå¯¹è¯çš„å®Œæ•´ç»†èŠ‚

#### 10.7.3 ä¿ç•™ç­–ç•¥

```python
# ä¿ç•™æœ€è¿‘5è½®å®Œæ•´å¯¹è¯
reduced_context = solver.reduce_context(
    context,
    preserve_recent_turns=5  # ä¿ç•™æœ€è¿‘5è½®
)

# ä¿ç•™æœ€è¿‘10è½®ï¼ˆæ›´ä¿å®ˆï¼‰
reduced_context = solver.reduce_context(
    context,
    preserve_recent_turns=10  # ä¿ç•™æœ€è¿‘10è½®
)
```

#### 10.7.4 ç›‘æ§å’Œå‘Šè­¦

```python
# å®šæœŸæ£€æŸ¥ä¸Šä¸‹æ–‡çŠ¶æ€
status = context_service.get_context_status(context)

if status["status"] == "critical":
    # ç«‹å³è¿›è¡Œæ‘˜è¦å’Œå¸è½½
    offloaded, _ = await context_service.offload_context(context, session_id)
    logger.warning(f"ä¸Šä¸‹æ–‡å·²è¶…è¿‡å±é™©é˜ˆå€¼: {status['token_count']} tokens")

elif status["status"] == "warning":
    # å»ºè®®è¿›è¡Œå‹ç¼©æˆ–æ‘˜è¦
    logger.info(f"ä¸Šä¸‹æ–‡ä½¿ç”¨ç‡: {status['usage_percent']:.1f}%")
    logger.info(f"å»ºè®®: {status['recommendation']}")
```

### 10.8 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å»¶è¿Ÿå‹ç¼©**: åªåœ¨è¾¾åˆ°80%é˜ˆå€¼æ—¶æ‰å¼€å§‹å‹ç¼©ï¼Œé¿å…è¿‡æ—©ä¼˜åŒ–
2. **æ‰¹é‡å‹ç¼©**: ä¸€æ¬¡æ€§å‹ç¼©æœ€æ—§çš„50%å·¥å…·è°ƒç”¨ï¼Œè€Œéé€ä¸ªå‹ç¼©
3. **ä¿ç•™ç¤ºä¾‹**: ä¿ç•™æœ€è¿‘å‡ æ¬¡å·¥å…·è°ƒç”¨çš„å®Œæ•´ç»†èŠ‚ï¼Œä½œä¸ºå°‘æ ·æœ¬ç¤ºä¾‹
4. **æ–‡ä»¶ç³»ç»Ÿä¼˜å…ˆ**: å¯¹äºç¬æ—¶ä¼šè¯ï¼Œä¼˜å…ˆä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå·¥å…·è€Œéå‘é‡ç´¢å¼•
5. **ç»“æ„åŒ–æ‘˜è¦**: ä½¿ç”¨ç»“æ„åŒ–æ¨¡å¼è€Œéè‡ªç”±å½¢å¼æç¤ºï¼Œç¡®ä¿æ‘˜è¦è´¨é‡

### 10.9 æ³¨æ„äº‹é¡¹

1. **å‹ç¼©çš„å¯é€†æ€§**: ç¡®ä¿å¤–éƒ¨å­˜å‚¨çš„æ–‡ä»¶åœ¨éœ€è¦æ—¶å¯ä»¥è®¿é—®
2. **æ‘˜è¦çš„ä¿¡æ¯ä¸¢å¤±**: æ‘˜è¦ä¼šä¸¢å¤±ç»†èŠ‚ï¼Œæ‘˜è¦å‰å…ˆå¸è½½å…³é”®ä¿¡æ¯
3. **ä¿ç•™æœ€è¿‘è½®æ¬¡**: å§‹ç»ˆä¿ç•™æœ€åå‡ è½®å¯¹è¯å’Œå·¥å…·è°ƒç”¨çš„å®Œæ•´ç»†èŠ‚
4. **é˜ˆå€¼é€‰æ‹©**: æ ¹æ®å®é™…æ¨¡å‹èƒ½åŠ›å’Œä»»åŠ¡éœ€æ±‚è°ƒæ•´é˜ˆå€¼
5. **å­˜å‚¨ç®¡ç†**: å®šæœŸæ¸…ç†å¤–éƒ¨å­˜å‚¨çš„æ–‡ä»¶ï¼Œé¿å…ç£ç›˜ç©ºé—´è€—å°½

---

## 11. æ€»ç»“

ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°è¿è´¯è‡ªç„¶çš„æƒ…æ„ŸèŠå¤©å¯¹è¯ä½“éªŒï¼š

1. **ç»“æ„åŒ–ä¸Šä¸‹æ–‡**: ä½¿ç”¨MCPåè®®å®šä¹‰æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡ç»“æ„
2. **æ™ºèƒ½ç»„è£…**: è‡ªåŠ¨æ•´åˆç”¨æˆ·ç”»åƒã€è®°å¿†ã€æƒ…ç»ªã€å¯¹è¯å†å²
3. **é‡è¦è½®æ¬¡è¯†åˆ«**: å¢å¼ºç‰ˆç»„è£…å™¨è¯†åˆ«å¹¶ä¿ç•™é‡è¦å¯¹è¯è½®æ¬¡
4. **çµæ´»å¡«å……**: æ”¯æŒè‡ªåŠ¨å¡«å……å’Œæ‰‹åŠ¨è¦†ç›–
5. **ä¸Šä¸‹æ–‡åˆå¹¶**: æ™ºèƒ½åˆå¹¶å¤šä¸ªä¸Šä¸‹æ–‡æº
6. **ä¸Šä¸‹æ–‡è…çƒ‚é˜²æŠ¤**: è‡ªåŠ¨æ£€æµ‹å’Œä¼˜åŒ–é•¿ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢æ€§èƒ½è¡°å‡

é€šè¿‡è¿™å¥—ç³»ç»Ÿï¼ŒAIèƒ½å¤Ÿï¼š
- âœ… è®°ä½ç”¨æˆ·çš„é‡è¦ä¿¡æ¯å’Œåå¥½
- âœ… æ ¹æ®å†å²å¯¹è¯æä¾›ä¸ªæ€§åŒ–å›åº”
- âœ… ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œè‡ªç„¶æ€§
- âœ… è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡ï¼Œé¿å…ä¿¡æ¯ä¸¢å¤±
- âœ… è‡ªåŠ¨ä¼˜åŒ–é•¿ä¸Šä¸‹æ–‡ï¼Œé˜²æ­¢ä¸Šä¸‹æ–‡è…çƒ‚å¯¼è‡´çš„æ€§èƒ½ä¸‹é™
- âœ… åœ¨ä¿æŒä¸Šä¸‹æ–‡å®Œæ•´æ€§çš„åŒæ—¶ï¼Œæ§åˆ¶tokenä½¿ç”¨é‡

### 11.1 ä¸Šä¸‹æ–‡è…çƒ‚è§£å†³æ–¹æ¡ˆæ€»ç»“

ä¸Šä¸‹æ–‡è…çƒ‚è§£å†³æ–¹æ¡ˆé€šè¿‡å››å¤§æ ¸å¿ƒæŠ€æœ¯æœ‰æ•ˆè§£å†³äº†é•¿ä¸Šä¸‹æ–‡åœºæ™¯ä¸‹çš„æ€§èƒ½é—®é¢˜ï¼š

1. **ä¸Šä¸‹æ–‡ç¼©å‡**: 
   - å‹ç¼©ï¼ˆå¯é€†ï¼‰ï¼šå°†å¯é‡å»ºä¿¡æ¯å¤–éƒ¨åŒ–
   - æ‘˜è¦ï¼ˆä¸å¯é€†ï¼‰ï¼šä½¿ç”¨ç»“æ„åŒ–æ¨¡å¼æµ“ç¼©ä¿¡æ¯

2. **ä¸Šä¸‹æ–‡æ£€ç´¢**: 
   - ä¼˜å…ˆä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿå·¥å…·ï¼ˆglobã€grepï¼‰
   - é€‚ç”¨äºç¬æ—¶ä¼šè¯åœºæ™¯

3. **ä¸Šä¸‹æ–‡éš”ç¦»**: 
   - æ”¯æŒå¤šæ™ºèƒ½ä½“è®¾è®¡
   - é€šè¿‡"æ™ºèƒ½ä½“å³å·¥å…·"èŒƒå¼å®ç°

4. **ä¸Šä¸‹æ–‡å¸è½½**: 
   - å°†è¶…é•¿ä¸Šä¸‹æ–‡ä¿å­˜åˆ°æ–‡ä»¶ç³»ç»Ÿ
   - åªä¿ç•™å¼•ç”¨å’Œæ‘˜è¦

### 11.2 å…³é”®æ–‡ä»¶è·¯å¾„

| ç»„ä»¶ | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| **ä¸Šä¸‹æ–‡è…çƒ‚è§£å†³æ–¹æ¡ˆ** | `backend/services/context_rot_solver.py` |
| **ä¸Šä¸‹æ–‡æ£€ç´¢ä¼˜åŒ–å™¨** | `backend/services/context_retrieval_optimizer.py` |
| **ä¸Šä¸‹æ–‡æœåŠ¡ï¼ˆå·²é›†æˆï¼‰** | `backend/services/context_service.py` |
| **ä¸Šä¸‹æ–‡ç»„è£…å™¨** | `backend/context_assembler.py` |
| **å¢å¼ºç‰ˆç»„è£…å™¨** | `backend/services/enhanced_context_assembler.py` |

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0  
**æœ€åæ›´æ–°**: 2025-01-XX  
**ç»´æŠ¤è€…**: emotional_chat å¼€å‘å›¢é˜Ÿ  
**æ–°å¢å†…å®¹**: ä¸Šä¸‹æ–‡è…çƒ‚ï¼ˆContext Rotï¼‰è§£å†³æ–¹æ¡ˆå®Œæ•´æŒ‡å—

