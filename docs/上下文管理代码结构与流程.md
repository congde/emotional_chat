# ä¸Šä¸‹æ–‡ç®¡ç†ä»£ç ç»“æ„ä¸æµç¨‹

> **æ–‡æ¡£è¯´æ˜**: æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†æƒ…æ„ŸèŠå¤©ç³»ç»Ÿä¸­ä¸Šä¸‹æ–‡ç®¡ç†çš„ä»£ç ç»“æ„ã€æ ¸å¿ƒç»„ä»¶å’Œæ‰§è¡Œæµç¨‹ï¼Œç”¨äºæ‰“é€ è¿è´¯è‡ªç„¶çš„æƒ…æ„ŸèŠå¤©å¯¹è¯ä½“éªŒã€‚

## ğŸ“‹ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. ä»£ç ç»“æ„](#2-ä»£ç ç»“æ„)
- [3. æ ¸å¿ƒç»„ä»¶](#3-æ ¸å¿ƒç»„ä»¶)
- [4. æ‰§è¡Œæµç¨‹](#4-æ‰§è¡Œæµç¨‹)
- [5. æ•°æ®æµè½¬](#5-æ•°æ®æµè½¬)
- [6. å…³é”®æ–¹æ³•è¯¦è§£](#6-å…³é”®æ–¹æ³•è¯¦è§£)
- [7. Gitè·¯å¾„](#7-gitè·¯å¾„)

---

## 1. æ¦‚è¿°

ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿè´Ÿè´£æ•´åˆå’Œç®¡ç†å¯¹è¯è¿‡ç¨‹ä¸­çš„æ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ï¼š
- **ç”¨æˆ·ç”»åƒ**: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ã€æ€§æ ¼ç‰¹å¾ã€å…´è¶£çˆ±å¥½ç­‰
- **å¯¹è¯å†å²**: çŸ­æœŸå¯¹è¯è®°å½•ï¼ˆæœ€è¿‘å‡ è½®ï¼‰
- **é•¿æœŸè®°å¿†**: ä»å‘é‡æ•°æ®åº“æ£€ç´¢çš„ç›¸å…³å†å²è®°å¿†
- **æƒ…æ„ŸçŠ¶æ€**: å½“å‰æƒ…ç»ªã€æƒ…ç»ªå¼ºåº¦ã€æƒ…ç»ªè¶‹åŠ¿
- **ä»»åŠ¡ç›®æ ‡**: å½“å‰å¯¹è¯çš„ç›®æ ‡å’Œæ„å›¾

é€šè¿‡æ™ºèƒ½çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œç³»ç»Ÿèƒ½å¤Ÿï¼š
- âœ… ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œè‡ªç„¶æ€§
- âœ… è®°ä½ç”¨æˆ·çš„é‡è¦ä¿¡æ¯å’Œåå¥½
- âœ… æ ¹æ®å†å²å¯¹è¯æä¾›ä¸ªæ€§åŒ–å›åº”
- âœ… è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡ï¼Œé¿å…ä¿¡æ¯ä¸¢å¤±

---

## 2. ä»£ç ç»“æ„

```
backend/
â”œâ”€â”€ modules/
â”‚   â””â”€â”€ agent/
â”‚       â””â”€â”€ protocol/
â”‚           â””â”€â”€ mcp.py                    # MCPåè®® - ä¸Šä¸‹æ–‡ç»“æ„å®šä¹‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ context_service.py                 # ä¸Šä¸‹æ–‡æœåŠ¡å±‚ï¼ˆä¸»å…¥å£ï¼‰
â”‚   â”œâ”€â”€ enhanced_context_assembler.py     # å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç»„è£…å™¨
â”‚   â””â”€â”€ chat_service.py                   # èŠå¤©æœåŠ¡ï¼ˆä½¿ç”¨ä¸Šä¸‹æ–‡ï¼‰
â”œâ”€â”€ context_assembler.py                   # åŸºç¡€ä¸Šä¸‹æ–‡ç»„è£…å™¨
â””â”€â”€ memory_manager.py                      # è®°å¿†ç®¡ç†å™¨ï¼ˆæ”¯æŒä¸Šä¸‹æ–‡æ£€ç´¢ï¼‰
```

### 2.1 æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | èŒè´£ | å…³é”®ç±»/æ–¹æ³• |
|------|------|-----------|
| **MCPåè®®** | å®šä¹‰æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„ | `MCPContext`, `MCPMessage` |
| **ä¸Šä¸‹æ–‡æœåŠ¡** | æä¾›ä¸Šä¸‹æ–‡æ„å»ºçš„ç»Ÿä¸€æ¥å£ | `ContextService.build_context()` |
| **ä¸Šä¸‹æ–‡ç»„è£…å™¨** | æ•´åˆå„ç±»ä¸Šä¸‹æ–‡ä¿¡æ¯ | `ContextAssembler.assemble_context()` |
| **å¢å¼ºç‰ˆç»„è£…å™¨** | æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆè¯†åˆ«é‡è¦è½®æ¬¡ï¼‰ | `EnhancedContextAssembler` |
| **è®°å¿†ç®¡ç†å™¨** | æä¾›é•¿æœŸè®°å¿†æ£€ç´¢ | `MemoryManager.retrieve_memories()` |

---

## 3. æ ¸å¿ƒç»„ä»¶

### 3.1 MCPåè®®å±‚ (`backend/modules/agent/protocol/mcp.py`)

#### 3.1.1 MCPContext ç±»

**ä½ç½®**: ç¬¬82-100è¡Œ

**åŠŸèƒ½**: å®šä¹‰æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„

```python
class MCPContext(BaseModel):
    """MCPä¸Šä¸‹æ–‡ç»“æ„"""
    user_profile: Optional[Dict[str, Any]]      # ç”¨æˆ·ç”»åƒ
    emotion_state: Optional[Dict[str, Any]]     # æƒ…æ„ŸçŠ¶æ€
    task_goal: Optional[Dict[str, Any]]         # ä»»åŠ¡ç›®æ ‡
    memory_summary: Optional[Dict[str, Any]]   # è®°å¿†æ‘˜è¦
    conversation_history: Optional[List[Dict]]  # å¯¹è¯å†å²
    metadata: Optional[Dict[str, Any]]         # å…ƒæ•°æ®
```

**å…³é”®æ–¹æ³•**:
- `to_dict()`: è½¬æ¢ä¸ºå­—å…¸æ ¼å¼

#### 3.1.2 MCPProtocol ç±»

**ä½ç½®**: ç¬¬196-580è¡Œ

**æ ¸å¿ƒæ–¹æ³•**:

1. **`_enrich_context_from_service()`** (ç¬¬220-275è¡Œ)
   - ä»ä¸Šä¸‹æ–‡æœåŠ¡è‡ªåŠ¨å¡«å……ä¸Šä¸‹æ–‡
   - è°ƒç”¨ `ContextService.build_context()` è·å–å®Œæ•´ä¸Šä¸‹æ–‡
   - å°†ä¸Šä¸‹æ–‡æ•°æ®è½¬æ¢ä¸º `MCPContext` æ ¼å¼

2. **`create_user_input_with_context()`** (ç¬¬310-370è¡Œ)
   - åˆ›å»ºå¸¦è‡ªåŠ¨ä¸Šä¸‹æ–‡çš„ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
   - æ”¯æŒè‡ªåŠ¨å¡«å……å’Œæ‰‹åŠ¨è¦†ç›–
   - åˆå¹¶è‡ªåŠ¨å¡«å……çš„ä¸Šä¸‹æ–‡å’Œæ˜¾å¼æä¾›çš„å‚æ•°

3. **`merge_context()`** (ç¬¬548-580è¡Œ)
   - åˆå¹¶ä¸¤ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡
   - é™„åŠ ä¸Šä¸‹æ–‡ä¼˜å…ˆè¦†ç›–åŸºç¡€ä¸Šä¸‹æ–‡
   - å¯¹è¯å†å²é‡‡ç”¨è¿½åŠ ç­–ç•¥

### 3.2 ä¸Šä¸‹æ–‡æœåŠ¡å±‚ (`backend/services/context_service.py`)

#### 3.2.1 ContextService ç±»

**ä½ç½®**: ç¬¬13-133è¡Œ

**èŒè´£**: æä¾›ä¸Šä¸‹æ–‡æ„å»ºçš„ç»Ÿä¸€æ¥å£

**æ ¸å¿ƒæ–¹æ³•**:

1. **`build_context()`** (ç¬¬21-55è¡Œ)
   ```python
   async def build_context(
       self,
       user_id: str,
       session_id: str,
       current_message: str,
       emotion: Optional[str] = None,
       emotion_intensity: Optional[float] = None
   ) -> Dict[str, Any]
   ```
   - **åŠŸèƒ½**: æ„å»ºå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡
   - **æµç¨‹**:
     1. è·å–å¯¹è¯å†å² (`_get_chat_history()`)
     2. è°ƒç”¨ç»„è£…å™¨æ•´åˆä¸Šä¸‹æ–‡ (`assembler.assemble_context()`)
     3. è¿”å›å®Œæ•´ä¸Šä¸‹æ–‡æ•°æ®

2. **`build_prompt()`** (ç¬¬57-72è¡Œ)
   - æ ¹æ®ä¸Šä¸‹æ–‡æ„å»ºå®Œæ•´çš„promptæ–‡æœ¬
   - è°ƒç”¨ `assembler.build_prompt_context()`

3. **`_get_chat_history()`** (ç¬¬74-91è¡Œ)
   - ä»æ•°æ®åº“è·å–å¯¹è¯å†å²
   - é»˜è®¤é™åˆ¶æœ€è¿‘10è½®å¯¹è¯
   - è¿”å›æ ¼å¼åŒ–çš„å†å²è®°å½•åˆ—è¡¨

### 3.3 ä¸Šä¸‹æ–‡ç»„è£…å™¨ (`backend/context_assembler.py`)

#### 3.3.1 ContextAssembler ç±»

**ä½ç½®**: ç¬¬91-392è¡Œ

**èŒè´£**: æ•´åˆæ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

**æ ¸å¿ƒæ–¹æ³•**:

1. **`assemble_context()`** (ç¬¬99-159è¡Œ)
   ```python
   def assemble_context(
       self, 
       user_id: str, 
       session_id: str,
       current_message: str,
       chat_history: Optional[List[Dict[str, str]]] = None,
       emotion: Optional[str] = None,
       emotion_intensity: Optional[float] = None
   ) -> Dict[str, Any]
   ```
   
   **æ‰§è¡Œæ­¥éª¤**:
   1. è·å–ç”¨æˆ·ç”»åƒ (`get_user_profile()`)
   2. æ£€ç´¢ç›¸å…³è®°å¿† (`_retrieve_relevant_memories()`)
   3. è·å–æƒ…ç»ªè¶‹åŠ¿ (`memory_manager.get_user_emotion_trend()`)
   4. å¤„ç†å¯¹è¯å†å² (`_process_chat_history()`)
   5. ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡å­—å…¸

   **è¿”å›ç»“æ„**:
   ```python
   {
       "user_profile": {
           "summary": "...",      # ç”¨æˆ·ç”»åƒæ‘˜è¦
           "full": {...}          # å®Œæ•´ç”¨æˆ·ç”»åƒ
       },
       "memories": {
           "recent_events": [...],
           "concerns": [...],
           "relationships": [...],
           "all": [...]
       },
       "emotion_context": {
           "current_emotion": "...",
           "current_intensity": 5.0,
           "trend": {...}
       },
       "chat_history": [...],
       "current_message": "...",
       "metadata": {...}
   }
   ```

2. **`build_prompt_context()`** (ç¬¬161-224è¡Œ)
   - æ ¹æ®ä¸Šä¸‹æ–‡æ„å»ºå®Œæ•´çš„promptæ–‡æœ¬
   - åŒ…å«ç”¨æˆ·ç”»åƒã€è®°å¿†ã€æƒ…ç»ªã€å¯¹è¯å†å²ç­‰éƒ¨åˆ†
   - ç”Ÿæˆç»“æ„åŒ–çš„promptå­—ç¬¦ä¸²

3. **`_retrieve_relevant_memories()`** (ç¬¬226-248è¡Œ)
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´æ£€ç´¢ç­–ç•¥
   - é«˜å¼ºåº¦æƒ…ç»ªï¼ˆâ‰¥7.0ï¼‰: æ£€ç´¢æ›´å¤šè®°å¿†ï¼ˆ5æ¡ï¼Œ14å¤©ï¼‰
   - æ­£å¸¸æƒ…å†µ: æ£€ç´¢3æ¡ï¼Œ7å¤©å†…

4. **`_process_chat_history()`** (ç¬¬250-255è¡Œ)
   - å¤„ç†å¯¹è¯å†å²ï¼Œåªä¿ç•™æœ€è¿‘çš„å‡ è½®
   - é»˜è®¤ä¿ç•™æœ€è¿‘5è½®å¯¹è¯ï¼ˆ`max_turns=5`ï¼‰

### 3.4 å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç»„è£…å™¨ (`backend/services/enhanced_context_assembler.py`)

#### 3.4.1 EnhancedContextAssembler ç±»

**ä½ç½®**: ç¬¬13-207è¡Œ

**èŒè´£**: æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†ï¼Œè¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡

**æ ¸å¿ƒæ–¹æ³•**:

1. **`assemble_context()`** (ç¬¬21-93è¡Œ)
   - å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç»„è£…
   - è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡ (`_identify_important_turns()`)
   - è·å–çŸ­æœŸè®°å¿†ï¼ˆè£å‰ªåçš„å¯¹è¯å†å²ï¼‰
   - æ£€ç´¢é•¿æœŸè®°å¿†ï¼ˆå‘é‡æ£€ç´¢ï¼‰
   - è·å–ç”¨æˆ·ç”»åƒå’Œå¯¹è¯è„‰ç»œå›¾è°±

2. **`_identify_important_turns()`** (ç¬¬95-121è¡Œ)
   - è¯†åˆ«é‡è¦çš„å¯¹è¯è½®æ¬¡
   - åŸºäºæƒ…ç»ªå¼ºåº¦ã€å†…å®¹é‡è¦æ€§ç­‰åˆ¤æ–­
   - è¿”å›é‡è¦è½®æ¬¡çš„ç´¢å¼•åˆ—è¡¨

3. **`build_prompt_context()`** (ç¬¬123-178è¡Œ)
   - æ„å»ºå¢å¼ºç‰ˆprompt
   - åŒ…å«ç”¨æˆ·ç”»åƒã€å†å²è®°å¿†ã€æœ€è¿‘å¯¹è¯ã€å½“å‰çŠ¶æ€ç­‰

---

## 4. æ‰§è¡Œæµç¨‹

### 4.1 å®Œæ•´ä¸Šä¸‹æ–‡æ„å»ºæµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â†“
[1] æƒ…æ„Ÿåˆ†æ
    â†“
[2] ContextService.build_context()
    â”œâ”€â†’ è·å–å¯¹è¯å†å² (_get_chat_history)
    â””â”€â†’ ContextAssembler.assemble_context()
        â”œâ”€â†’ [3] è·å–ç”¨æˆ·ç”»åƒ (get_user_profile)
        â”œâ”€â†’ [4] æ£€ç´¢ç›¸å…³è®°å¿† (_retrieve_relevant_memories)
        â”œâ”€â†’ [5] è·å–æƒ…ç»ªè¶‹åŠ¿ (get_user_emotion_trend)
        â”œâ”€â†’ [6] å¤„ç†å¯¹è¯å†å² (_process_chat_history)
        â””â”€â†’ [7] ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡
    â†“
[8] è¿”å›ä¸Šä¸‹æ–‡æ•°æ®
    â†“
[9] æ„å»ºPrompt (build_prompt_context)
    â†“
[10] ç”Ÿæˆå›å¤
```

### 4.2 MCPåè®®ä¸Šä¸‹æ–‡å¡«å……æµç¨‹

```
ç”¨æˆ·è¾“å…¥ + user_id + session_id
    â†“
MCPProtocol.create_user_input_with_context()
    â†“
æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¡«å……ä¸Šä¸‹æ–‡
    â”œâ”€â†’ æ˜¯ â†’ _enrich_context_from_service()
    â”‚         â”œâ”€â†’ ContextService.build_context()
    â”‚         â””â”€â†’ è½¬æ¢ä¸º MCPContext
    â””â”€â†’ å¦ â†’ ä½¿ç”¨æ˜¾å¼æä¾›çš„å‚æ•°
    â†“
åˆå¹¶ä¸Šä¸‹æ–‡ (merge_context)
    â”œâ”€â†’ ç”¨æˆ·ç”»åƒåˆå¹¶
    â”œâ”€â†’ æƒ…æ„ŸçŠ¶æ€åˆå¹¶
    â”œâ”€â†’ å¯¹è¯å†å²è¿½åŠ 
    â””â”€â†’ å…ƒæ•°æ®åˆå¹¶
    â†“
åˆ›å»º MCPMessage
    â†“
è¿”å›å¸¦å®Œæ•´ä¸Šä¸‹æ–‡çš„æ¶ˆæ¯
```

### 4.3 å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç®¡ç†æµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â†“
EnhancedContextAssembler.assemble_context()
    â†“
[1] è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡
    â””â”€â†’ _identify_important_turns()
        â””â”€â†’ åŸºäºæƒ…ç»ªå¼ºåº¦ã€å†…å®¹é‡è¦æ€§åˆ¤æ–­
    â†“
[2] è·å–çŸ­æœŸè®°å¿†
    â””â”€â†’ get_short_term_context()
        â””â”€â†’ è£å‰ªå¯¹è¯å†å²ï¼Œä¿ç•™é‡è¦è½®æ¬¡
    â†“
[3] æ£€ç´¢é•¿æœŸè®°å¿†
    â””â”€â†’ retrieve_memories()
        â””â”€â†’ å‘é‡æ£€ç´¢ï¼Œæ”¯æŒæ—¶é—´è¡°å‡
    â†“
[4] è·å–ç”¨æˆ·ç”»åƒ
    â””â”€â†’ build_profile() + generate_profile_summary()
    â†“
[5] è·å–å¯¹è¯è„‰ç»œå›¾è°±
    â””â”€â†’ build_conversation_graph()
    â†“
[6] ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡
    â†“
è¿”å›å¢å¼ºç‰ˆä¸Šä¸‹æ–‡
```

---

## 5. æ•°æ®æµè½¬

### 5.1 ä¸Šä¸‹æ–‡æ•°æ®ç»“æ„

#### 5.1.1 MCPContext ç»“æ„

```python
{
    "user_profile": {
        "name": "ç”¨æˆ·å§“å",
        "age": 25,
        "gender": "å¥³",
        "personality_traits": ["å†…å‘", "æ•æ„Ÿ"],
        "interests": ["é˜…è¯»", "éŸ³ä¹"],
        "concerns": ["å·¥ä½œå‹åŠ›", "äººé™…å…³ç³»"]
    },
    "emotion_state": {
        "emotion": "ç„¦è™‘",
        "intensity": 7.5,
        "trend": "æ³¢åŠ¨ä¸Šå‡"
    },
    "task_goal": {
        "goal_type": "emotional_support",
        "complexity": "medium"
    },
    "memory_summary": {
        "recent_events": [...],
        "concerns": [...],
        "relationships": [...],
        "count": 5
    },
    "conversation_history": [
        {"role": "user", "content": "..."},
        {"role": "assistant", "content": "..."}
    ]
}
```

#### 5.1.2 ContextService è¿”å›ç»“æ„

```python
{
    "user_profile": {
        "summary": "å§“åï¼šå¼ ä¸‰ï¼›å¹´é¾„ï¼š25å²ï¼›æ€§æ ¼ï¼šå†…å‘ã€æ•æ„Ÿ",
        "full": {...}  # å®Œæ•´ç”¨æˆ·ç”»åƒå¯¹è±¡
    },
    "memories": {
        "recent_events": [...],
        "concerns": [...],
        "relationships": [...],
        "all": [...]
    },
    "emotion_context": {
        "current_emotion": "ç„¦è™‘",
        "current_intensity": 7.5,
        "trend": {
            "trend": "æ³¢åŠ¨ä¸Šå‡",
            "emotions": [...]
        }
    },
    "chat_history": [
        {"role": "user", "content": "...", "emotion": "ç„¦è™‘"},
        {"role": "assistant", "content": "..."}
    ],
    "current_message": "ç”¨æˆ·å½“å‰è¾“å…¥",
    "metadata": {
        "user_id": "user_123",
        "session_id": "session_456",
        "timestamp": "2024-01-01T12:00:00"
    }
}
```

### 5.2 æ•°æ®æµè½¬è·¯å¾„

```
æ•°æ®åº“/å‘é‡åº“
    â†“
MemoryManager / DatabaseManager
    â†“
ContextAssembler
    â†“
ContextService
    â†“
MCPProtocol
    â†“
MCPMessage
    â†“
Agent Core / Chat Service
    â†“
LLM / Response Generator
```

---

## 6. å…³é”®æ–¹æ³•è¯¦è§£

### 6.1 ContextService.build_context()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/services/context_service.py:21-55`

**åŠŸèƒ½**: æ„å»ºå®Œæ•´çš„å¯¹è¯ä¸Šä¸‹æ–‡

**å‚æ•°**:
- `user_id`: ç”¨æˆ·ID
- `session_id`: ä¼šè¯ID
- `current_message`: å½“å‰ç”¨æˆ·æ¶ˆæ¯
- `emotion`: å½“å‰æƒ…ç»ªï¼ˆå¯é€‰ï¼‰
- `emotion_intensity`: æƒ…ç»ªå¼ºåº¦ï¼ˆå¯é€‰ï¼‰

**è¿”å›å€¼**: å®Œæ•´çš„ä¸Šä¸‹æ–‡å­—å…¸

**å†…éƒ¨è°ƒç”¨é“¾**:
```
build_context()
  â”œâ”€â†’ _get_chat_history()          # è·å–å¯¹è¯å†å²
  â””â”€â†’ assembler.assemble_context()  # ç»„è£…ä¸Šä¸‹æ–‡
      â”œâ”€â†’ get_user_profile()        # è·å–ç”¨æˆ·ç”»åƒ
      â”œâ”€â†’ _retrieve_relevant_memories()  # æ£€ç´¢è®°å¿†
      â”œâ”€â†’ get_user_emotion_trend()  # è·å–æƒ…ç»ªè¶‹åŠ¿
      â””â”€â†’ _process_chat_history()   # å¤„ç†å¯¹è¯å†å²
```

### 6.2 ContextAssembler.assemble_context()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/context_assembler.py:99-159`

**åŠŸèƒ½**: æ•´åˆæ‰€æœ‰ä¸Šä¸‹æ–‡ä¿¡æ¯

**æ‰§è¡Œæ­¥éª¤è¯¦è§£**:

1. **è·å–ç”¨æˆ·ç”»åƒ** (ç¬¬119è¡Œ)
   ```python
   profile = self.get_user_profile(user_id)
   ```
   - ä»ç¼“å­˜æˆ–æ•°æ®åº“åŠ è½½ç”¨æˆ·ç”»åƒ
   - å¦‚æœä¸å­˜åœ¨ï¼Œä»è®°å¿†æ¨æ–­ç”Ÿæˆ

2. **æ£€ç´¢ç›¸å…³è®°å¿†** (ç¬¬122-124è¡Œ)
   ```python
   memories = self._retrieve_relevant_memories(
       user_id, current_message, emotion, emotion_intensity
   )
   ```
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´æ£€ç´¢ç­–ç•¥
   - ä½¿ç”¨å‘é‡æ£€ç´¢æ‰¾åˆ°ç›¸å…³å†å²è®°å¿†

3. **è·å–æƒ…ç»ªè¶‹åŠ¿** (ç¬¬127è¡Œ)
   ```python
   emotion_trend = self.memory_manager.get_user_emotion_trend(user_id, days=7)
   ```
   - åˆ†ææœ€è¿‘7å¤©çš„æƒ…ç»ªå˜åŒ–è¶‹åŠ¿

4. **å¤„ç†å¯¹è¯å†å²** (ç¬¬130è¡Œ)
   ```python
   recent_history = self._process_chat_history(chat_history or [], max_turns=5)
   ```
   - åªä¿ç•™æœ€è¿‘5è½®å¯¹è¯
   - é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿

5. **ç»„è£…ä¸Šä¸‹æ–‡** (ç¬¬133-157è¡Œ)
   - å°†æ‰€æœ‰ä¿¡æ¯æ•´åˆæˆç»Ÿä¸€çš„ä¸Šä¸‹æ–‡å­—å…¸

### 6.3 MCPProtocol.create_user_input_with_context()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/modules/agent/protocol/mcp.py:310-370`

**åŠŸèƒ½**: åˆ›å»ºå¸¦è‡ªåŠ¨ä¸Šä¸‹æ–‡çš„ç”¨æˆ·è¾“å…¥æ¶ˆæ¯

**å‚æ•°**:
- `content`: ç”¨æˆ·è¾“å…¥å†…å®¹
- `user_id`: ç”¨æˆ·IDï¼ˆç”¨äºè‡ªåŠ¨å¡«å……ï¼‰
- `session_id`: ä¼šè¯IDï¼ˆç”¨äºè‡ªåŠ¨å¡«å……ï¼‰
- `emotion`: å½“å‰æƒ…ç»ªï¼ˆå¯é€‰ï¼‰
- `emotion_intensity`: æƒ…ç»ªå¼ºåº¦ï¼ˆå¯é€‰ï¼‰
- `user_profile`: ç”¨æˆ·ç”»åƒï¼ˆå¯é€‰ï¼Œè¦†ç›–è‡ªåŠ¨å¡«å……ï¼‰
- `emotion_state`: æƒ…æ„ŸçŠ¶æ€ï¼ˆå¯é€‰ï¼Œè¦†ç›–è‡ªåŠ¨å¡«å……ï¼‰
- `conversation_history`: å¯¹è¯å†å²ï¼ˆå¯é€‰ï¼Œè¦†ç›–è‡ªåŠ¨å¡«å……ï¼‰

**æ‰§è¡Œé€»è¾‘**:
```python
if user_profile is None or emotion_state is None or conversation_history is None:
    # å°è¯•ä»ä¸Šä¸‹æ–‡æœåŠ¡è‡ªåŠ¨å¡«å……
    auto_context = await self._enrich_context_from_service(...)
    
    # åˆå¹¶è‡ªåŠ¨å¡«å……å’Œæ˜¾å¼æä¾›çš„å‚æ•°
    context = MCPContext(
        user_profile=user_profile or auto_context.user_profile,
        emotion_state=emotion_state or auto_context.emotion_state,
        ...
    )
else:
    # æ‰€æœ‰å‚æ•°éƒ½æä¾›äº†ï¼Œç›´æ¥ä½¿ç”¨
    context = MCPContext(...)
```

### 6.4 EnhancedContextAssembler._identify_important_turns()

**å®Œæ•´ä»£ç è·¯å¾„**: `backend/services/enhanced_context_assembler.py:95-121`

**åŠŸèƒ½**: è¯†åˆ«é‡è¦çš„å¯¹è¯è½®æ¬¡

**åˆ¤æ–­æ ‡å‡†**:
- æƒ…ç»ªå¼ºåº¦é«˜ï¼ˆâ‰¥7.0ï¼‰
- åŒ…å«é‡è¦å…³é”®è¯
- ç”¨æˆ·æ˜ç¡®è¡¨è¾¾éœ€æ±‚
- æ¶‰åŠé‡è¦è¯é¢˜

**å®ç°é€»è¾‘**:
```python
for i, msg in enumerate(chat_history):
    if msg.get("role") != "user":
        continue
    
    message_obj = {
        "content": msg.get("content", ""),
        "emotion_intensity": msg.get("emotion_intensity", 5.0)
    }
    
    if self.memory_manager.short_term.mark_important_turn(message_obj):
        important_markers.append(i)
```

---

## 7. Gitè·¯å¾„

### 7.1 æ ¸å¿ƒæ–‡ä»¶Gitè·¯å¾„

| æ–‡ä»¶ | Gitè·¯å¾„ |
|------|---------|
| **MCPåè®®** | `https://github.com/congde/emotional_chat/blob/main/backend/modules/agent/protocol/mcp.py` |
| **ä¸Šä¸‹æ–‡æœåŠ¡** | `https://github.com/congde/emotional_chat/blob/main/backend/services/context_service.py` |
| **ä¸Šä¸‹æ–‡ç»„è£…å™¨** | `https://github.com/congde/emotional_chat/blob/main/backend/context_assembler.py` |
| **å¢å¼ºç‰ˆç»„è£…å™¨** | `https://github.com/congde/emotional_chat/blob/main/backend/services/enhanced_context_assembler.py` |
| **èŠå¤©æœåŠ¡** | `https://github.com/congde/emotional_chat/blob/main/backend/services/chat_service.py` |

### 7.2 å…³é”®ä»£ç è¡Œå·

#### MCPåè®® (`mcp.py`)
- `MCPContext` ç±»: **ç¬¬82-100è¡Œ**
- `_enrich_context_from_service()`: **ç¬¬220-275è¡Œ**
- `create_user_input_with_context()`: **ç¬¬310-370è¡Œ**
- `merge_context()`: **ç¬¬548-580è¡Œ**

#### ä¸Šä¸‹æ–‡æœåŠ¡ (`context_service.py`)
- `build_context()`: **ç¬¬21-55è¡Œ**
- `_get_chat_history()`: **ç¬¬74-91è¡Œ**

#### ä¸Šä¸‹æ–‡ç»„è£…å™¨ (`context_assembler.py`)
- `assemble_context()`: **ç¬¬99-159è¡Œ**
- `build_prompt_context()`: **ç¬¬161-224è¡Œ**
- `_retrieve_relevant_memories()`: **ç¬¬226-248è¡Œ**
- `_process_chat_history()`: **ç¬¬250-255è¡Œ**

#### å¢å¼ºç‰ˆç»„è£…å™¨ (`enhanced_context_assembler.py`)
- `assemble_context()`: **ç¬¬21-93è¡Œ**
- `_identify_important_turns()`: **ç¬¬95-121è¡Œ**
- `build_prompt_context()`: **ç¬¬123-178è¡Œ**

---

## 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 åŸºç¡€ä¸Šä¸‹æ–‡æ„å»º

```python
from backend.services.context_service import ContextService

# åˆå§‹åŒ–æœåŠ¡
context_service = ContextService()

# æ„å»ºä¸Šä¸‹æ–‡
context = await context_service.build_context(
    user_id="user_123",
    session_id="session_456",
    current_message="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    emotion="ç„¦è™‘",
    emotion_intensity=7.5
)

# æ„å»ºPrompt
prompt = await context_service.build_prompt(
    context=context,
    system_prompt=XINYU_SYSTEM_PROMPT
)
```

### 8.2 MCPåè®®ä¸Šä¸‹æ–‡ä½¿ç”¨

```python
from backend.modules.agent.protocol.mcp import MCPProtocol

# åˆå§‹åŒ–åè®®å¤„ç†å™¨ï¼ˆå¸¦ä¸Šä¸‹æ–‡æœåŠ¡ï¼‰
protocol = MCPProtocol()

# åˆ›å»ºå¸¦è‡ªåŠ¨ä¸Šä¸‹æ–‡çš„ç”¨æˆ·è¾“å…¥æ¶ˆæ¯
user_message = await protocol.create_user_input_with_context(
    content="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    user_id="user_123",
    session_id="session_456",
    emotion="ç„¦è™‘",
    emotion_intensity=7.5
)

# æ¶ˆæ¯å·²åŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡
print(user_message.context.user_profile)
print(user_message.context.conversation_history)
print(user_message.context.emotion_state)
```

### 8.3 å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç®¡ç†

```python
from backend.services.enhanced_context_assembler import EnhancedContextAssembler

# åˆå§‹åŒ–å¢å¼ºç‰ˆç»„è£…å™¨
assembler = EnhancedContextAssembler()

# ç»„è£…å¢å¼ºç‰ˆä¸Šä¸‹æ–‡
context = await assembler.assemble_context(
    user_id="user_123",
    session_id="session_456",
    current_message="æˆ‘æœ€è¿‘å¿ƒæƒ…å¾ˆä¸å¥½",
    chat_history=[...],
    emotion="ç„¦è™‘",
    emotion_intensity=7.5
)

# æ„å»ºPrompt
prompt = assembler.build_prompt_context(
    context=context,
    system_prompt=XINYU_SYSTEM_PROMPT
)
```

---

## 9. æœ€ä½³å®è·µ

### 9.1 ä¸Šä¸‹æ–‡ç®¡ç†åŸåˆ™

1. **åˆ†å±‚ç®¡ç†**
   - çŸ­æœŸè®°å¿†ï¼šæœ€è¿‘å‡ è½®å¯¹è¯ï¼ˆ5-10è½®ï¼‰
   - é•¿æœŸè®°å¿†ï¼šå‘é‡æ£€ç´¢çš„ç›¸å…³å†å²è®°å¿†
   - ç”¨æˆ·ç”»åƒï¼šæŒä¹…åŒ–çš„ç”¨æˆ·ç‰¹å¾

2. **æ™ºèƒ½è£å‰ª**
   - ä¿ç•™é‡è¦å¯¹è¯è½®æ¬¡
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´è®°å¿†æ£€ç´¢èŒƒå›´
   - é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿å¯¼è‡´æ€§èƒ½é—®é¢˜

3. **è‡ªåŠ¨å¡«å……**
   - ä¼˜å…ˆä½¿ç”¨è‡ªåŠ¨å¡«å……çš„ä¸Šä¸‹æ–‡
   - æ”¯æŒæ‰‹åŠ¨è¦†ç›–ç‰¹å®šå­—æ®µ
   - åˆå¹¶ç­–ç•¥ï¼šé™„åŠ ä¸Šä¸‹æ–‡ä¼˜å…ˆ

### 9.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ç”¨æˆ·ç”»åƒ**
   - ä½¿ç”¨å†…å­˜ç¼“å­˜å‡å°‘æ•°æ®åº“æŸ¥è¯¢
   - å®šæœŸæ›´æ–°ç¼“å­˜

2. **é™åˆ¶å¯¹è¯å†å²**
   - é»˜è®¤ä¿ç•™æœ€è¿‘5-10è½®å¯¹è¯
   - é‡è¦è½®æ¬¡å•ç‹¬æ ‡è®°ä¿ç•™

3. **å‘é‡æ£€ç´¢ä¼˜åŒ–**
   - æ ¹æ®æƒ…ç»ªå¼ºåº¦è°ƒæ•´æ£€ç´¢æ•°é‡
   - ä½¿ç”¨æ—¶é—´è¡°å‡å‡å°‘æ— å…³è®°å¿†

---

## 10. æ€»ç»“

ä¸Šä¸‹æ–‡ç®¡ç†ç³»ç»Ÿé€šè¿‡ä»¥ä¸‹æœºåˆ¶å®ç°è¿è´¯è‡ªç„¶çš„æƒ…æ„ŸèŠå¤©å¯¹è¯ä½“éªŒï¼š

1. **ç»“æ„åŒ–ä¸Šä¸‹æ–‡**: ä½¿ç”¨MCPåè®®å®šä¹‰æ ‡å‡†åŒ–çš„ä¸Šä¸‹æ–‡ç»“æ„
2. **æ™ºèƒ½ç»„è£…**: è‡ªåŠ¨æ•´åˆç”¨æˆ·ç”»åƒã€è®°å¿†ã€æƒ…ç»ªã€å¯¹è¯å†å²
3. **é‡è¦è½®æ¬¡è¯†åˆ«**: å¢å¼ºç‰ˆç»„è£…å™¨è¯†åˆ«å¹¶ä¿ç•™é‡è¦å¯¹è¯è½®æ¬¡
4. **çµæ´»å¡«å……**: æ”¯æŒè‡ªåŠ¨å¡«å……å’Œæ‰‹åŠ¨è¦†ç›–
5. **ä¸Šä¸‹æ–‡åˆå¹¶**: æ™ºèƒ½åˆå¹¶å¤šä¸ªä¸Šä¸‹æ–‡æº

é€šè¿‡è¿™å¥—ç³»ç»Ÿï¼ŒAIèƒ½å¤Ÿï¼š
- âœ… è®°ä½ç”¨æˆ·çš„é‡è¦ä¿¡æ¯å’Œåå¥½
- âœ… æ ¹æ®å†å²å¯¹è¯æä¾›ä¸ªæ€§åŒ–å›åº”
- âœ… ä¿æŒå¯¹è¯çš„è¿è´¯æ€§å’Œè‡ªç„¶æ€§
- âœ… è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡ï¼Œé¿å…ä¿¡æ¯ä¸¢å¤±

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2024-01-01  
**ç»´æŠ¤è€…**: emotional_chat å¼€å‘å›¢é˜Ÿ

