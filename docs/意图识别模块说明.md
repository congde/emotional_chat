# æ„å›¾è¯†åˆ«æ¨¡å—è¯´æ˜æ–‡æ¡£

## ğŸ“– æ¦‚è¿°

æ„å›¾è¯†åˆ«æ¨¡å—æ˜¯"å¿ƒè¯­"æƒ…æ„Ÿé™ªä¼´æœºå™¨äººçš„æ ¸å¿ƒç»„ä»¶ä¹‹ä¸€ï¼Œé‡‡ç”¨"è§„åˆ™+æ¨¡å‹"çš„æ··åˆæ¶æ„ï¼Œèƒ½å¤Ÿå‡†ç¡®è¯†åˆ«ç”¨æˆ·çš„æ„å›¾ï¼Œä¸ºåç»­çš„å¯¹è¯ç”Ÿæˆæä¾›å…³é”®ä¾æ®ã€‚

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. æ··åˆå¼è¯†åˆ«æ¶æ„
- **è§„åˆ™å¼•æ“**ï¼šåŸºäºå…³é”®è¯å¿«é€ŸåŒ¹é…å¸¸è§æ¨¡å¼
- **æœºå™¨å­¦ä¹ åˆ†ç±»å™¨**ï¼šå¤„ç†å¤æ‚è¯­ä¹‰å’Œè¾¹ç¼˜æƒ…å†µ
- **èåˆç­–ç•¥**ï¼šæ™ºèƒ½ç»„åˆä¸¤ç§æ–¹æ³•çš„ä¼˜åŠ¿

### 2. å…­å¤§æ„å›¾ç±»å‹

| æ„å›¾ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| **emotion** | æƒ…æ„Ÿè¡¨è¾¾ | "æˆ‘å¥½éš¾è¿‡"ã€"ä»Šå¤©å¿ƒæƒ…ä¸å¥½" |
| **advice** | å¯»æ±‚å»ºè®® | "æ€ä¹ˆåŠï¼Ÿ"ã€"ä½ æœ‰ä»€ä¹ˆå»ºè®®" |
| **conversation** | æ™®é€šå¯¹è¯ | "ä»Šå¤©å¤©æ°”ä¸é”™"ã€"æˆ‘åœ¨çœ‹ä¹¦" |
| **function** | åŠŸèƒ½è¯·æ±‚ | "æé†’æˆ‘åƒè¯"ã€"è®°å½•ä»Šå¤©çš„å¿ƒæƒ…" |
| **crisis** | å±æœºå¹²é¢„ | "ä¸æƒ³æ´»äº†"ã€"æ’‘ä¸ä¸‹å»" |
| **chat** | é—²èŠ | "ä½ å¥½"ã€"åœ¨å—"ã€"æ™šä¸Šå¥½" |

### 3. è¾“å…¥é¢„å¤„ç†
- æ–‡æœ¬æ¸…æ´—å’Œè§„èŒƒåŒ–
- é«˜é£é™©å†…å®¹æ£€æµ‹
- æ•æ„Ÿè¯è¿‡æ»¤
- è¾“å…¥åˆè§„æ€§éªŒè¯

### 4. æ™ºèƒ½Promptæ„å»º
- æ ¹æ®æ„å›¾ç±»å‹ç”Ÿæˆé’ˆå¯¹æ€§çš„å“åº”ç­–ç•¥
- æä¾›è¯¦ç»†çš„å“åº”æŒ‡å¯¼å’Œé¿å…äº‹é¡¹
- é’ˆå¯¹å±æœºæƒ…å†µçš„ç‰¹æ®Šå¤„ç†

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```
ç”¨æˆ·è¾“å…¥
  â†“
è¾“å…¥é¢„å¤„ç†å™¨ (InputProcessor)
  â”œâ”€â”€ æ–‡æœ¬æ¸…æ´—
  â”œâ”€â”€ é£é™©æ£€æµ‹
  â””â”€â”€ åˆè§„éªŒè¯
  â†“
æ„å›¾åˆ†ç±»å™¨ (IntentClassifier)
  â”œâ”€â”€ è§„åˆ™å¼•æ“ (RuleEngine)
  â”‚   â”œâ”€â”€ å…³é”®è¯åŒ¹é…
  â”‚   â””â”€â”€ æ­£åˆ™è¡¨è¾¾å¼
  â””â”€â”€ MLåˆ†ç±»å™¨ (MLClassifier)
      â”œâ”€â”€ BERTæ¨¡å‹
      â””â”€â”€ å¯å‘å¼è§„åˆ™
  â†“
èåˆç­–ç•¥
  â”œâ”€â”€ å±æœºä¼˜å…ˆ
  â”œâ”€â”€ é«˜ç½®ä¿¡åº¦è§„åˆ™
  â””â”€â”€ æ¨¡å‹é¢„æµ‹
  â†“
æ„å›¾ç»“æœ + å“åº”å»ºè®®
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
backend/modules/intent/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ models/                      # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ intent_models.py         # IntentType, IntentResult, IntentRequest
â”œâ”€â”€ core/                        # æ ¸å¿ƒç»„ä»¶
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ rule_engine.py           # è§„åˆ™å¼•æ“
â”‚   â”œâ”€â”€ intent_classifier.py     # æ„å›¾åˆ†ç±»å™¨ï¼ˆæ··åˆï¼‰
â”‚   â””â”€â”€ input_processor.py       # è¾“å…¥é¢„å¤„ç†å™¨
â”œâ”€â”€ services/                    # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ intent_service.py        # æ„å›¾æœåŠ¡
â””â”€â”€ routers/                     # APIè·¯ç”±
    â”œâ”€â”€ __init__.py
    â””â”€â”€ intent_router.py         # APIæ¥å£
```

## ğŸ”Œ APIæ¥å£

### 1. åˆ†ææ„å›¾ï¼ˆå®Œæ•´åˆ†æï¼‰

**ç«¯ç‚¹**: `POST /intent/analyze`

**è¯·æ±‚ä½“**:
```json
{
  "text": "æˆ‘æœ€è¿‘æ€»æ˜¯ç¡ä¸ç€ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ",
  "user_id": "user_123",
  "session_id": "session_456"
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "æ„å›¾è¯†åˆ«æˆåŠŸ",
  "data": {
    "success": true,
    "processed": {
      "raw": "æˆ‘æœ€è¿‘æ€»æ˜¯ç¡ä¸ç€ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ",
      "cleaned": "æˆ‘æœ€è¿‘æ€»æ˜¯ç¡ä¸ç€ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿ",
      "blocked": false,
      "risk_level": "low",
      "warnings": []
    },
    "intent": {
      "intent": "advice",
      "confidence": 0.85,
      "source": "model",
      "secondary_intents": null,
      "metadata": null
    },
    "action_required": false,
    "suggestion": {
      "response_style": "å»ºè®¾æ€§ã€å®ç”¨ã€æ¸©å’Œ",
      "priority": "medium",
      "actions": ["åˆ†æé—®é¢˜", "æä¾›å¤šä¸ªé€‰æ‹©", "åˆ†äº«ç›¸å…³çŸ¥è¯†"],
      "avoid": ["å¼ºåˆ¶å»ºè®®", "è¿‡äºå¤æ‚"],
      "prompt_hint": "å»ºè®®æä¾›æ¨¡å¼ï¼šæä¾›å®ç”¨å»ºè®®ï¼Œä½†å°Šé‡ç”¨æˆ·é€‰æ‹©"
    }
  }
}
```

### 2. å¿«é€Ÿæ£€æµ‹æ„å›¾

**ç«¯ç‚¹**: `POST /intent/detect?text=ä½ å¥½å‘€`

**å“åº”**:
```json
{
  "intent": "chat",
  "confidence": 0.85,
  "source": "model",
  "secondary_intents": null,
  "metadata": {
    "method": "heuristic"
  }
}
```

### 3. æ„å»ºPrompt

**ç«¯ç‚¹**: `POST /intent/build_prompt`

**è¯·æ±‚ä½“**:
```json
{
  "analysis": {
    "emotion": {"primary": "ç„¦è™‘"},
    "intent": {
      "intent": "advice",
      "confidence": 0.85,
      "source": "model"
    }
  }
}
```

**å“åº”**:
```json
{
  "code": 200,
  "message": "Promptæ„å»ºæˆåŠŸ",
  "data": {
    "prompt": "ä½ æ˜¯ä¸€ä½æ¸©æš–ã€è€å¿ƒçš„å¿ƒç†é™ªä¼´åŠ©æ‰‹..."
  }
}
```

### 4. è·å–æ„å›¾ç±»å‹åˆ—è¡¨

**ç«¯ç‚¹**: `GET /intent/types`

### 5. è·å–æœåŠ¡çŠ¶æ€

**ç«¯ç‚¹**: `GET /intent/status`

### 6. æ‰¹é‡åˆ†æ

**ç«¯ç‚¹**: `POST /intent/batch`

**è¯·æ±‚ä½“**:
```json
{
  "texts": [
    "ä½ å¥½",
    "æˆ‘å¥½éš¾è¿‡",
    "è¯¥æ€ä¹ˆåŠï¼Ÿ"
  ]
}
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### Pythonå®¢æˆ·ç«¯

```python
import requests

# APIåŸºç¡€URL
BASE_URL = "http://localhost:8000"

# 1. åˆ†ææ„å›¾
response = requests.post(
    f"{BASE_URL}/intent/analyze",
    json={
        "text": "æˆ‘æœ€è¿‘å‹åŠ›å¾ˆå¤§ï¼Œç¡ä¸å¥½è§‰",
        "user_id": "user_123"
    }
)
result = response.json()
print(f"æ„å›¾: {result['data']['intent']['intent']}")
print(f"ç½®ä¿¡åº¦: {result['data']['intent']['confidence']}")

# 2. è·å–æœåŠ¡çŠ¶æ€
status = requests.get(f"{BASE_URL}/intent/status").json()
print(f"æœåŠ¡çŠ¶æ€: {status['data']['status']}")

# 3. æ‰¹é‡åˆ†æ
batch_response = requests.post(
    f"{BASE_URL}/intent/batch",
    json={
        "texts": [
            "ä½ å¥½",
            "æˆ‘å¾ˆç„¦è™‘",
            "æ€ä¹ˆåŠï¼Ÿ",
            "æé†’æˆ‘æ˜å¤©åƒè¯"
        ]
    }
)
batch_results = batch_response.json()
for i, result in enumerate(batch_results['data']['results']):
    print(f"æ–‡æœ¬{i+1}: {result['intent']['intent']}")
```

### cURLæµ‹è¯•

```bash
# æµ‹è¯•æ„å›¾è¯†åˆ«
curl -X POST http://localhost:8000/intent/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "text": "æˆ‘å¥½éš¾è¿‡ï¼Œä¸çŸ¥é“è¯¥æ€ä¹ˆåŠ",
    "user_id": "test_user"
  }'

# è·å–æ„å›¾ç±»å‹
curl http://localhost:8000/intent/types

# è·å–æœåŠ¡çŠ¶æ€
curl http://localhost:8000/intent/status
```

## ğŸ¨ é›†æˆåˆ°èŠå¤©æµç¨‹

æ„å›¾è¯†åˆ«æ¨¡å—å·²ç»é›†æˆåˆ°ä¸»åº”ç”¨ä¸­ï¼Œå¯ä»¥åœ¨èŠå¤©æœåŠ¡ä¸­ä½¿ç”¨ï¼š

```python
from backend.modules.intent.services import IntentService

# åˆå§‹åŒ–æœåŠ¡
intent_service = IntentService()

# åœ¨å¤„ç†ç”¨æˆ·æ¶ˆæ¯æ—¶
def process_user_message(user_message: str, user_id: str):
    # 1. åˆ†ææ„å›¾
    analysis = intent_service.analyze(user_message, user_id)
    
    # 2. æ£€æŸ¥æ˜¯å¦éœ€è¦ç‰¹æ®Šå¤„ç†
    if analysis['action_required']:
        # å±æœºæƒ…å†µï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        return handle_crisis(analysis)
    
    # 3. æ„å»ºä¸Šä¸‹æ–‡
    user_context = {
        "analysis": {
            "emotion": get_emotion(user_message),  # ä»æƒ…æ„Ÿåˆ†æè·å–
            "intent": analysis['intent']
        }
    }
    
    # 4. ç”ŸæˆPrompt
    prompt = intent_service.build_prompt(user_context)
    
    # 5. è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå›å¤
    response = llm_generate(prompt, user_message)
    
    return response
```

## ğŸ“Š æ„å›¾è¯†åˆ«ç­–ç•¥

### èåˆç­–ç•¥ä¼˜å…ˆçº§

1. **å±æœºä¼˜å…ˆ** - å¦‚æœè§„åˆ™å¼•æ“æ£€æµ‹åˆ°å±æœºå…³é”®è¯ï¼Œç«‹å³è¿”å›å±æœºæ„å›¾
2. **é«˜ç½®ä¿¡åº¦è§„åˆ™** - è§„åˆ™å¼•æ“ç½®ä¿¡åº¦ > 0.85ï¼Œä½¿ç”¨è§„åˆ™ç»“æœ
3. **æ¨¡å‹é¢„æµ‹** - ä½¿ç”¨MLåˆ†ç±»å™¨è¿›è¡Œé¢„æµ‹
4. **ç»“æœèåˆ** - å¦‚æœè§„åˆ™å’Œæ¨¡å‹ä¸€è‡´ï¼Œæé«˜ç½®ä¿¡åº¦ï¼›å¦åˆ™è®°å½•æ¬¡è¦æ„å›¾

### å±æœºæ£€æµ‹æœºåˆ¶

- **å…³é”®è¯åˆ—è¡¨**: "è‡ªæ€"ã€"è‡ªæ®‹"ã€"ä¸æƒ³æ´»"ã€"ç»“æŸç”Ÿå‘½"ç­‰
- **æ­£åˆ™è¡¨è¾¾å¼**: åŒ¹é…å¤æ‚è¡¨è¾¾æ¨¡å¼
- **ç½®ä¿¡åº¦**: å±æœºæ£€æµ‹ç½®ä¿¡åº¦å›ºå®šä¸º 1.0
- **ç‰¹æ®Šå¤„ç†**: æ ‡è®°ä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼Œè§¦å‘ä¸“ä¸šæ±‚åŠ©æµç¨‹

## ğŸ”§ é…ç½®å’Œæ‰©å±•

### æ‰©å±•å…³é”®è¯è§„åˆ™

ç¼–è¾‘ `backend/modules/intent/core/rule_engine.py`:

```python
INTENT_RULES = {
    IntentType.ADVICE: [
        "æ€ä¹ˆåŠ", "å»ºè®®", "æ€ä¹ˆå¤„ç†", "ä½ è§‰å¾—",
        # æ·»åŠ æ›´å¤šå…³é”®è¯
        "åº”è¯¥å¦‚ä½•", "å¯ä»¥ç»™æˆ‘", "å¸®å¸®æˆ‘"
    ],
    # ... å…¶ä»–æ„å›¾
}
```

### é›†æˆçœŸå®BERTæ¨¡å‹

ç¼–è¾‘ `backend/modules/intent/core/intent_classifier.py`:

```python
def _load_model(self):
    """åŠ è½½é¢„è®­ç»ƒæ¨¡å‹"""
    from transformers import AutoTokenizer, AutoModelForSequenceClassification
    
    self.tokenizer = AutoTokenizer.from_pretrained(self.model_path)
    self.model = AutoModelForSequenceClassification.from_pretrained(self.model_path)
    logger.info("BERTæ¨¡å‹åŠ è½½æˆåŠŸ")
```

### è‡ªå®šä¹‰å“åº”ç­–ç•¥

åœ¨ `intent_service.py` çš„ `_generate_suggestion` æ–¹æ³•ä¸­è‡ªå®šä¹‰å“åº”ç­–ç•¥ã€‚

## ğŸ§ª æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

åˆ›å»º `tests/test_intent.py`:

```python
import pytest
from backend.modules.intent import IntentService

@pytest.fixture
def intent_service():
    return IntentService()

def test_crisis_detection(intent_service):
    result = intent_service.analyze("æˆ‘ä¸æƒ³æ´»äº†")
    assert result['intent']['intent'] == 'crisis'
    assert result['action_required'] == True

def test_advice_detection(intent_service):
    result = intent_service.analyze("æˆ‘è¯¥æ€ä¹ˆåŠï¼Ÿ")
    assert result['intent']['intent'] == 'advice'
```

### é›†æˆæµ‹è¯•

ä½¿ç”¨æä¾›çš„ `test_intent_module.py` è„šæœ¬è¿›è¡Œå®Œæ•´æµ‹è¯•ã€‚

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ¨¡å‹ç¼“å­˜**: ä½¿ç”¨å•ä¾‹æ¨¡å¼ç¼“å­˜MLæ¨¡å‹
2. **æ‰¹é‡å¤„ç†**: ä½¿ç”¨ `/intent/batch` ç«¯ç‚¹æ‰¹é‡å¤„ç†
3. **è§„åˆ™ä¼˜å…ˆ**: å¯¹äºå¸¸è§æ¨¡å¼ï¼Œè§„åˆ™å¼•æ“æ¯”æ¨¡å‹æ›´å¿«
4. **å¼‚æ­¥å¤„ç†**: åœ¨FastAPIä¸­ä½¿ç”¨ `async/await`

## ğŸ”’ å®‰å…¨è€ƒè™‘

1. **è¾“å…¥éªŒè¯**: æ‰€æœ‰è¾“å…¥éƒ½ç»è¿‡é¢„å¤„ç†å’ŒéªŒè¯
2. **å±æœºå“åº”**: å±æœºæƒ…å†µä¼šè¢«è®°å½•æ—¥å¿—å¹¶è§¦å‘ç‰¹æ®Šæµç¨‹
3. **æ•æ„Ÿè¯è¿‡æ»¤**: å¯é…ç½®çš„æ•æ„Ÿè¯è¿‡æ»¤æœºåˆ¶
4. **é£é™©åˆ†çº§**: ä¸‰çº§é£é™©è¯„ä¼°ï¼ˆlow/medium/highï¼‰

## ğŸ“š å‚è€ƒèµ„æ–™

- [è¡¨11-3 ç”¨æˆ·æ„å›¾åˆ†ç±»](../README.md#æ„å›¾åˆ†ç±»)
- [FastAPIæ–‡æ¡£](https://fastapi.tiangolo.com/)
- [Transformersåº“](https://huggingface.co/docs/transformers/)

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç å’Œæ”¹è¿›å»ºè®®ï¼

---

**ç‰ˆæœ¬**: v1.0.0  
**æœ€åæ›´æ–°**: 2025-10-17  
**ç»´æŠ¤è€…**: å¿ƒè¯­å¼€å‘å›¢é˜Ÿ

