# 意图识别模块说明文档

## 📖 概述

意图识别模块是"心语"情感陪伴机器人的核心组件之一，采用"规则+模型"的混合架构，能够准确识别用户的意图，为后续的对话生成提供关键依据。

## 🎯 功能特性

### 1. 混合式识别架构
- **规则引擎**：基于关键词快速匹配常见模式
- **机器学习分类器**：处理复杂语义和边缘情况
- **融合策略**：智能组合两种方法的优势

### 2. 六大意图类型

| 意图类型 | 说明 | 示例 |
|---------|------|------|
| **emotion** | 情感表达 | "我好难过"、"今天心情不好" |
| **advice** | 寻求建议 | "怎么办？"、"你有什么建议" |
| **conversation** | 普通对话 | "今天天气不错"、"我在看书" |
| **function** | 功能请求 | "提醒我吃药"、"记录今天的心情" |
| **crisis** | 危机干预 | "不想活了"、"撑不下去" |
| **chat** | 闲聊 | "你好"、"在吗"、"晚上好" |

### 3. 输入预处理
- 文本清洗和规范化
- 高风险内容检测
- 敏感词过滤
- 输入合规性验证

### 4. 智能Prompt构建
- 根据意图类型生成针对性的响应策略
- 提供详细的响应指导和避免事项
- 针对危机情况的特殊处理

## 🏗️ 架构设计

```
用户输入
  ↓
输入预处理器 (InputProcessor)
  ├── 文本清洗
  ├── 风险检测
  └── 合规验证
  ↓
意图分类器 (IntentClassifier)
  ├── 规则引擎 (RuleEngine)
  │   ├── 关键词匹配
  │   └── 正则表达式
  └── ML分类器 (MLClassifier)
      ├── BERT模型
      └── 启发式规则
  ↓
融合策略
  ├── 危机优先
  ├── 高置信度规则
  └── 模型预测
  ↓
意图结果 + 响应建议
```

## 📁 项目结构

```
backend/modules/intent/
├── __init__.py
├── models/                      # 数据模型
│   ├── __init__.py
│   └── intent_models.py         # IntentType, IntentResult, IntentRequest
├── core/                        # 核心组件
│   ├── __init__.py
│   ├── rule_engine.py           # 规则引擎
│   ├── intent_classifier.py     # 意图分类器（混合）
│   └── input_processor.py       # 输入预处理器
├── services/                    # 服务层
│   ├── __init__.py
│   └── intent_service.py        # 意图服务
└── routers/                     # API路由
    ├── __init__.py
    └── intent_router.py         # API接口
```

## 🔌 API接口

### 1. 分析意图（完整分析）

**端点**: `POST /intent/analyze`

**请求体**:
```json
{
  "text": "我最近总是睡不着，该怎么办？",
  "user_id": "user_123",
  "session_id": "session_456"
}
```

**响应**:
```json
{
  "code": 200,
  "message": "意图识别成功",
  "data": {
    "success": true,
    "processed": {
      "raw": "我最近总是睡不着，该怎么办？",
      "cleaned": "我最近总是睡不着，该怎么办？",
      "blocked": false,
      "risk_level": "low",
      "warnings": []
    },
    "intent": {
      "intent": "advice",
      "confidence": 0.85,
      "source": "model",
      "secondary_intents": null,
      "metadata": null
    },
    "action_required": false,
    "suggestion": {
      "response_style": "建设性、实用、温和",
      "priority": "medium",
      "actions": ["分析问题", "提供多个选择", "分享相关知识"],
      "avoid": ["强制建议", "过于复杂"],
      "prompt_hint": "建议提供模式：提供实用建议，但尊重用户选择"
    }
  }
}
```

### 2. 快速检测意图

**端点**: `POST /intent/detect?text=你好呀`

**响应**:
```json
{
  "intent": "chat",
  "confidence": 0.85,
  "source": "model",
  "secondary_intents": null,
  "metadata": {
    "method": "heuristic"
  }
}
```

### 3. 构建Prompt

**端点**: `POST /intent/build_prompt`

**请求体**:
```json
{
  "analysis": {
    "emotion": {"primary": "焦虑"},
    "intent": {
      "intent": "advice",
      "confidence": 0.85,
      "source": "model"
    }
  }
}
```

**响应**:
```json
{
  "code": 200,
  "message": "Prompt构建成功",
  "data": {
    "prompt": "你是一位温暖、耐心的心理陪伴助手..."
  }
}
```

### 4. 获取意图类型列表

**端点**: `GET /intent/types`

### 5. 获取服务状态

**端点**: `GET /intent/status`

### 6. 批量分析

**端点**: `POST /intent/batch`

**请求体**:
```json
{
  "texts": [
    "你好",
    "我好难过",
    "该怎么办？"
  ]
}
```

## 🚀 使用示例

### Python客户端

```python
import requests

# API基础URL
BASE_URL = "http://localhost:8000"

# 1. 分析意图
response = requests.post(
    f"{BASE_URL}/intent/analyze",
    json={
        "text": "我最近压力很大，睡不好觉",
        "user_id": "user_123"
    }
)
result = response.json()
print(f"意图: {result['data']['intent']['intent']}")
print(f"置信度: {result['data']['intent']['confidence']}")

# 2. 获取服务状态
status = requests.get(f"{BASE_URL}/intent/status").json()
print(f"服务状态: {status['data']['status']}")

# 3. 批量分析
batch_response = requests.post(
    f"{BASE_URL}/intent/batch",
    json={
        "texts": [
            "你好",
            "我很焦虑",
            "怎么办？",
            "提醒我明天吃药"
        ]
    }
)
batch_results = batch_response.json()
for i, result in enumerate(batch_results['data']['results']):
    print(f"文本{i+1}: {result['intent']['intent']}")
```

### cURL测试

```bash
# 测试意图识别
curl -X POST http://localhost:8000/intent/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "text": "我好难过，不知道该怎么办",
    "user_id": "test_user"
  }'

# 获取意图类型
curl http://localhost:8000/intent/types

# 获取服务状态
curl http://localhost:8000/intent/status
```

## 🎨 集成到聊天流程

意图识别模块已经集成到主应用中，可以在聊天服务中使用：

```python
from backend.modules.intent.services import IntentService

# 初始化服务
intent_service = IntentService()

# 在处理用户消息时
def process_user_message(user_message: str, user_id: str):
    # 1. 分析意图
    analysis = intent_service.analyze(user_message, user_id)
    
    # 2. 检查是否需要特殊处理
    if analysis['action_required']:
        # 危机情况，需要特殊处理
        return handle_crisis(analysis)
    
    # 3. 构建上下文
    user_context = {
        "analysis": {
            "emotion": get_emotion(user_message),  # 从情感分析获取
            "intent": analysis['intent']
        }
    }
    
    # 4. 生成Prompt
    prompt = intent_service.build_prompt(user_context)
    
    # 5. 调用大模型生成回复
    response = llm_generate(prompt, user_message)
    
    return response
```

## 📊 意图识别策略

### 融合策略优先级

1. **危机优先** - 如果规则引擎检测到危机关键词，立即返回危机意图
2. **高置信度规则** - 规则引擎置信度 > 0.85，使用规则结果
3. **模型预测** - 使用ML分类器进行预测
4. **结果融合** - 如果规则和模型一致，提高置信度；否则记录次要意图

### 危机检测机制

- **关键词列表**: "自杀"、"自残"、"不想活"、"结束生命"等
- **正则表达式**: 匹配复杂表达模式
- **置信度**: 危机检测置信度固定为 1.0
- **特殊处理**: 标记为最高优先级，触发专业求助流程

## 🔧 配置和扩展

### 扩展关键词规则

编辑 `backend/modules/intent/core/rule_engine.py`:

```python
INTENT_RULES = {
    IntentType.ADVICE: [
        "怎么办", "建议", "怎么处理", "你觉得",
        # 添加更多关键词
        "应该如何", "可以给我", "帮帮我"
    ],
    # ... 其他意图
}
```

### 集成真实BERT模型

编辑 `backend/modules/intent/core/intent_classifier.py`:

```python
def _load_model(self):
    """加载预训练模型"""
    from transformers import AutoTokenizer, AutoModelForSequenceClassification
    
    self.tokenizer = AutoTokenizer.from_pretrained(self.model_path)
    self.model = AutoModelForSequenceClassification.from_pretrained(self.model_path)
    logger.info("BERT模型加载成功")
```

### 自定义响应策略

在 `intent_service.py` 的 `_generate_suggestion` 方法中自定义响应策略。

## 🧪 测试建议

### 单元测试

创建 `tests/test_intent.py`:

```python
import pytest
from backend.modules.intent import IntentService

@pytest.fixture
def intent_service():
    return IntentService()

def test_crisis_detection(intent_service):
    result = intent_service.analyze("我不想活了")
    assert result['intent']['intent'] == 'crisis'
    assert result['action_required'] == True

def test_advice_detection(intent_service):
    result = intent_service.analyze("我该怎么办？")
    assert result['intent']['intent'] == 'advice'
```

### 集成测试

使用提供的 `test_intent_module.py` 脚本进行完整测试。

## 📈 性能优化建议

1. **模型缓存**: 使用单例模式缓存ML模型
2. **批量处理**: 使用 `/intent/batch` 端点批量处理
3. **规则优先**: 对于常见模式，规则引擎比模型更快
4. **异步处理**: 在FastAPI中使用 `async/await`

## 🔒 安全考虑

1. **输入验证**: 所有输入都经过预处理和验证
2. **危机响应**: 危机情况会被记录日志并触发特殊流程
3. **敏感词过滤**: 可配置的敏感词过滤机制
4. **风险分级**: 三级风险评估（low/medium/high）

## 📚 参考资料

- [表11-3 用户意图分类](../README.md#意图分类)
- [FastAPI文档](https://fastapi.tiangolo.com/)
- [Transformers库](https://huggingface.co/docs/transformers/)

## 🤝 贡献

欢迎贡献代码和改进建议！

---

**版本**: v1.0.0  
**最后更新**: 2025-10-17  
**维护者**: 心语开发团队

