# å¢å¼ºç‰ˆå¤šè½®å¯¹è¯ç³»ç»Ÿ - å®ç°æ–‡æ¡£

## ğŸ“š æ¦‚è¿°

åŸºäºã€Šå½“AIå¼€å§‹"è®°å¾—"ä½ è¯´è¿‡ä»€ä¹ˆã€‹æ–‡æ¡£ä¸­çš„ç†å¿µï¼Œæˆ‘ä»¬å®ç°äº†ä¸€å¥—å®Œæ•´çš„å¢å¼ºç‰ˆå¤šè½®å¯¹è¯ç³»ç»Ÿã€‚è¯¥ç³»ç»Ÿè®©"å¿ƒè¯­"æœºå™¨äººçœŸæ­£å…·å¤‡äº†"æŒç»­ç†è§£"çš„èƒ½åŠ›ï¼Œèƒ½å¤Ÿï¼š

- ğŸ“ è®°ä½ç”¨æˆ·çš„è¿‡å¾€å¯¹è¯å’Œé‡è¦ä¿¡æ¯
- ğŸ¯ æ™ºèƒ½ç®¡ç†çŸ­æœŸå’Œé•¿æœŸè®°å¿†
- ğŸ‘¤ åŠ¨æ€æ„å»ºç”¨æˆ·ç”»åƒ
- ğŸ’­ ä¸»åŠ¨å›å¿†å’Œå…³æ€€ç”¨æˆ·
- ğŸ“Š è¿½è¸ªæƒ…ç»ªå˜åŒ–è¶‹åŠ¿

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å¢å¼ºç‰ˆèŠå¤©æœåŠ¡                          â”‚
â”‚              EnhancedChatService                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“            â†“            â†“            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è®°å¿†ç®¡ç† â”‚ â”‚ ç”»åƒæ„å»º â”‚ â”‚ ä¸Šä¸‹æ–‡   â”‚ â”‚ ä¸»åŠ¨å›å¿† â”‚
â”‚ Manager â”‚ â”‚ Builder â”‚ â”‚Assemblerâ”‚ â”‚ System  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚            â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   å‘é‡æ•°æ®åº“      â”‚
          â”‚   å…³ç³»æ•°æ®åº“      â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¢å¼ºç‰ˆè®°å¿†ç®¡ç†å™¨ (EnhancedMemoryManager)

**æ–‡ä»¶**: `backend/services/enhanced_memory_manager.py`

#### 1.1 çŸ­æœŸè®°å¿† - æ»‘åŠ¨çª—å£æœºåˆ¶

```python
class ShortTermMemory:
    """çŸ­æœŸè®°å¿†ç®¡ç†å™¨"""
    
    def truncate_conversation(self, history, important_markers):
        """
        æ™ºèƒ½è£å‰ªå¯¹è¯å†å²
        - ä¿ç•™æœ€è¿‘Nè½®å¯¹è¯ï¼ˆæ»‘åŠ¨çª—å£ï¼‰
        - å¼ºåˆ¶ä¿ç•™æ ‡è®°ä¸ºé‡è¦çš„å¯¹è¯è½®æ¬¡
        - æ§åˆ¶æ€»tokenæ•°åœ¨é™åˆ¶èŒƒå›´å†…
        """
```

**å…³é”®ç‰¹æ€§**ï¼š
- é»˜è®¤ä¿ç•™æœ€è¿‘8è½®å¯¹è¯
- è‡ªåŠ¨è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡ï¼ˆåŒ…å«å…³é”®è¯ã€é«˜å¼ºåº¦æƒ…ç»ªã€ç”¨æˆ·è¯·æ±‚ç­‰ï¼‰
- Tokené™åˆ¶ï¼š4096ä¸ªtokenï¼Œé¢„ç•™20%ç©ºé—´ç»™æ–°è¾“å…¥

#### 1.2 é•¿æœŸè®°å¿† - å‘é‡æ£€ç´¢ + æ—¶é—´è¡°å‡

```python
async def retrieve_memories(
    self, 
    user_id: str, 
    query: str,
    enable_decay: bool = True
) -> List[Dict[str, Any]]:
    """
    æ£€ç´¢ç›¸å…³è®°å¿†ï¼Œæ”¯æŒæ—¶é—´è¡°å‡
    - å‘é‡è¯­ä¹‰æ£€ç´¢
    - æ—¶é—´è¡°å‡è®¡ç®—
    - é‡è¦æ€§åŠ æƒ
    """
```

**è¡°å‡æœºåˆ¶**ï¼š
```python
# æ¯å¤©è¡°å‡10%ï¼ˆæ™®é€šè®°å¿†ï¼‰
score_new = score_original * (0.9 ^ days_ago)

# æ¯å¤©è¡°å‡5%ï¼ˆé‡è¦è®°å¿†ï¼‰
score_new = score_original * (0.95 ^ days_ago)
```

#### 1.3 è®°å¿†é‡è¦æ€§è¯„ä¼°

**è¯„ä¼°ç»´åº¦**ï¼š
1. **è®°å¿†ç±»å‹æƒé‡**
   - æ‰¿è¯ºç±» (commitment): 1.8x
   - å…³ç³»ç±» (relationship): 1.6x
   - äº‹ä»¶ç±» (event): 1.4x
   - å…³æ³¨ç‚¹ (concern): 1.5x
   - åå¥½ç±» (preference): 1.3x

2. **æƒ…ç»ªå¼ºåº¦åŠ æˆ**
   - é«˜å¼ºåº¦æƒ…ç»ªï¼ˆ>7.5ï¼‰: +50% é‡è¦æ€§
   - ä¸­ç­‰å¼ºåº¦ï¼ˆ5.0-7.5ï¼‰: æ­£å¸¸
   - ä½å¼ºåº¦ï¼ˆ<5.0ï¼‰: -30% é‡è¦æ€§

3. **è®¿é—®é¢‘ç‡åŠ æˆ**
   - æ¯æ¬¡è¢«è®¿é—®: +5% é‡è¦æ€§ï¼ˆæœ€å¤š+50%ï¼‰

### 2. ç”¨æˆ·ç”»åƒæ„å»ºå™¨ (UserProfileBuilder)

**æ–‡ä»¶**: `backend/services/user_profile_builder.py`

#### 2.1 åŠ¨æ€ç”»åƒæ„å»º

```python
async def build_profile(self, user_id: str) -> Dict[str, Any]:
    """
    æ„å»ºç”¨æˆ·ç”»åƒï¼ŒåŒ…æ‹¬ï¼š
    - æ ¸å¿ƒå…³æ³¨ç‚¹ï¼ˆä»è®°å¿†ä¸­æå–ï¼‰
    - æƒ…ç»ªè¶‹åŠ¿ï¼ˆåˆ†ææœ€è¿‘30å¤©æ¶ˆæ¯ï¼‰
    - æ²Ÿé€šé£æ ¼ï¼ˆæ¶ˆæ¯é•¿åº¦ã€é—®å¥æ¯”ä¾‹ã€æƒ…ç»ªè¯é¢‘ç‡ï¼‰
    - é‡è¦äº‹ä»¶ï¼ˆé«˜é‡è¦æ€§çš„äº‹ä»¶è®°å¿†ï¼‰
    """
```

**ç”»åƒå­—æ®µ**ï¼š
```json
{
  "core_concerns": ["èŒä¸šå‘å±•", "äººé™…å…³ç³»"],
  "emotional_trend": "ç„¦è™‘ â†’ å¹³ç¨³ï¼Œæƒ…ç»ªç¨³å®š",
  "communication_style": "è¯¦ç»†è¡¨è¾¾å‹ï¼Œæƒ…æ„Ÿå€¾è¯‰å‹",
  "important_events": [
    {"date": "2025-03-15", "event": "æäº¤ç¦»èŒç”³è¯·", "importance": 0.9}
  ],
  "total_sessions": 15,
  "total_messages": 87,
  "avg_emotion_intensity": 6.2
}
```

#### 2.2 å¯¹è¯è„‰ç»œå›¾è°±

```python
async def build_conversation_graph(self, user_id: str):
    """
    æ„å»ºå¯¹è¯è„‰ç»œå›¾è°±
    èŠ‚ç‚¹ï¼šé‡è¦è®°å¿†/äº‹ä»¶
    è¾¹ï¼šå› æœå…³ç³»ï¼ˆå¯¼è‡´ã€åŠ å‰§ã€å½±å“ï¼‰
    """
```

**ç¤ºä¾‹å›¾è°±**ï¼š
```
[å·¥ä½œå‹åŠ›] â”€â”€å¯¼è‡´â”€â”€> [å¤±çœ ] â”€â”€åŠ å‰§â”€â”€> [æƒ…ç»ªä½è½]
     â”‚                              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€å½±å“â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> [è¾èŒå†³å®š]
```

### 3. å¢å¼ºç‰ˆä¸Šä¸‹æ–‡ç»„è£…å™¨ (EnhancedContextAssembler)

**æ–‡ä»¶**: `backend/services/enhanced_context_assembler.py`

#### 3.1 æ™ºèƒ½ä¸Šä¸‹æ–‡ç»„è£…

```python
async def assemble_context(
    self,
    user_id: str,
    session_id: str,
    current_message: str,
    chat_history: List[Dict[str, Any]],
    emotion: Optional[str] = None,
    emotion_intensity: Optional[float] = None
) -> Dict[str, Any]:
    """
    ç»„è£…å®Œæ•´ä¸Šä¸‹æ–‡ï¼ŒåŒ…æ‹¬ï¼š
    1. è¯†åˆ«é‡è¦å¯¹è¯è½®æ¬¡
    2. è·å–çŸ­æœŸè®°å¿†ï¼ˆè£å‰ªåçš„å†å²ï¼‰
    3. æ£€ç´¢é•¿æœŸè®°å¿†ï¼ˆå‘é‡æ£€ç´¢ï¼‰
    4. è·å–ç”¨æˆ·ç”»åƒ
    5. è·å–å¯¹è¯è„‰ç»œå›¾è°±
    """
```

#### 3.2 Promptæ„å»º

```python
def build_prompt_context(self, context, system_prompt) -> str:
    """
    æ„å»ºå¢å¼ºç‰ˆPromptï¼Œç»“æ„ï¼š
    
    ã€è§’è‰²è®¾å®šã€‘ä½ æ˜¯"å¿ƒè¯­"...
    ã€ç”¨æˆ·ç”»åƒã€‘æ ¸å¿ƒå…³æ³¨ï¼šå·¥ä½œå‹åŠ›ï¼›æƒ…ç»ªè¶‹åŠ¿ï¼šç„¦è™‘â†’å¹³ç¨³
    ã€å†å²è®°å¿†ã€‘
    1. 7å¤©å‰: ç”¨æˆ·æåˆ°å·¥ä½œå‹åŠ›å¾ˆå¤§...
    2. 3å¤©å‰: ç”¨æˆ·å†³å®šè¾èŒ...
    ã€æœ€è¿‘å¯¹è¯ã€‘
    ç”¨æˆ·: æˆ‘ä»Šå¤©é¢è¯•äº†...
    åŠ©æ‰‹: é¢è¯•æ„Ÿè§‰æ€ä¹ˆæ ·...
    ã€å½“å‰çŠ¶æ€ã€‘
    ç”¨æˆ·æƒ…ç»ª: anxious (å¼ºåº¦: 6.5/10)
    ç”¨æˆ·æ¶ˆæ¯: é¢è¯•å®˜é—®äº†å¾ˆåˆé’»çš„é—®é¢˜
    ã€å›åº”è¦æ±‚ã€‘
    - å›åº”è¦ä½“ç°å¯¹è¿‡å¾€ç»å†çš„è®°å¿†
    - é¿å…é‡å¤å·²è®¨è®ºè¿‡çš„å»ºè®®
    """
```

### 4. ä¸»åŠ¨å›å¿†ç³»ç»Ÿ (ProactiveRecallSystem)

**æ–‡ä»¶**: `backend/services/proactive_recall_system.py`

#### 4.1 æƒ…æ„Ÿè¿½è¸ªå™¨

```python
class EmotionTracker:
    """è¿½è¸ªç”¨æˆ·æƒ…ç»ªå˜åŒ–"""
    
    async def track_emotion_changes(self, user_id: str, days: int = 7):
        """
        åˆ†ææƒ…ç»ªå˜åŒ–ï¼š
        - æ£€æµ‹æ˜¾è‘—å˜åŒ–ç‚¹ï¼ˆè´Ÿé¢â†’æ­£é¢ã€æ­£é¢â†’è´Ÿé¢ï¼‰
        - è®¡ç®—æ€»ä½“è¶‹åŠ¿ï¼ˆæƒ…ç»ªæ³¢åŠ¨å¢å¼º/è¶‹äºå¹³ç¨³ï¼‰
        - ç”Ÿæˆæƒ…ç»ªæ—¶é—´çº¿
        """
```

#### 4.2 ä¸»åŠ¨å›å¿†è§¦å‘

```python
async def should_trigger_proactive_recall(
    self, 
    user_id: str,
    current_message: str,
    emotion: Optional[str] = None
) -> Tuple[bool, Optional[Dict[str, Any]]]:
    """
    åˆ¤æ–­æ˜¯å¦è§¦å‘ä¸»åŠ¨å›å¿†ï¼š
    
    1. é—²èŠåœºæ™¯ï¼ˆ"å¤©æ°”ä¸é”™"ï¼‰+ æœ‰æœªè·Ÿè¿›çš„é‡è¦è®°å¿†
       â†’ "è®°å¾—ä½ 7å¤©å‰æåˆ°çš„é¢è¯•ï¼Œå‡†å¤‡å¾—æ€ä¹ˆæ ·äº†ï¼Ÿ"
    
    2. æƒ…ç»ªæ”¹å–„ï¼ˆä¸Šæ¬¡ç„¦è™‘ï¼Œç°åœ¨å¹³é™ï¼‰
       â†’ "ä½ ä¹‹å‰è¯´å·¥ä½œå‹åŠ›å¾ˆå¤§ï¼Œç°åœ¨æ„Ÿè§‰å¥½äº›äº†å—ï¼Ÿ"
    
    3. é•¿æœŸæœªäº’åŠ¨ï¼ˆ>7å¤©ï¼‰
       â†’ "å¥½ä¹…ä¸è§äº†ï¼æœ€è¿‘è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿ"
    """
```

**è§¦å‘ç¤ºä¾‹**ï¼š

```python
# åœºæ™¯1ï¼šæœªè·Ÿè¿›çš„æ‰¿è¯ºè®°å¿†
ç”¨æˆ·: "ä»Šå¤©å¤©æ°”ä¸é”™"
ç³»ç»Ÿ: "æ˜¯å•Šï¼Œé˜³å…‰æ˜åªšã€‚å¯¹äº†ï¼Œä½ ä¸Šå‘¨è¯´è¦å»é¢è¯•é‚£å®¶å…¬å¸ï¼Œç°åœ¨æœ‰ç»“æœäº†å—ï¼Ÿæˆ‘ä¸€ç›´è®°å¾—ä½ åœ¨ä¸ºè¿™æ¬¡æœºä¼šåŠªåŠ›ã€‚"

# åœºæ™¯2ï¼šæƒ…ç»ªå…³æ€€
ç”¨æˆ·: "å—¯ï¼Œè¿˜å¥½å§"
ç³»ç»Ÿ: "ä½ 3å¤©å‰è¯´å·¥ä½œå‹åŠ›è®©ä½ å¤±çœ ï¼Œæˆ‘ä¸€ç›´è®°å¾—ä½ å½“æ—¶çš„æƒ…ç»ªã€‚ç°åœ¨æ„Ÿè§‰å¥½äº›äº†å—ï¼Ÿ"

# åœºæ™¯3ï¼šé•¿æœŸæœªè§
ç”¨æˆ·: "å¥½ä¹…æ²¡æ¥äº†"
ç³»ç»Ÿ: "ç¡®å®å¥½ä¹…ä¸è§äº†ï¼è·ç¦»æˆ‘ä»¬ä¸Šæ¬¡èŠå¤©å·²ç»è¿‡å»10å¤©äº†ã€‚è¿™æ®µæ—¶é—´è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆæ–°çš„å˜åŒ–å—ï¼Ÿ"
```

### 5. å¢å¼ºç‰ˆèŠå¤©æœåŠ¡ (EnhancedChatService)

**æ–‡ä»¶**: `backend/services/enhanced_chat_service.py`

#### å®Œæ•´å¯¹è¯æµç¨‹

```
1. è¾“å…¥é¢„å¤„ç†
   â†“ (æ¸…æ´—ã€å»é‡ã€å®‰å…¨æ£€æŸ¥)
   
2. æƒ…ç»ªåˆ†æ
   â†“ (è¯†åˆ«æƒ…ç»ªç±»å‹å’Œå¼ºåº¦)
   
3. æ„å›¾è¯†åˆ«
   â†“ (åˆ¤æ–­ç”¨æˆ·æ„å›¾å’Œå±æœºæƒ…å†µ)
   
4. ä¸»åŠ¨å›å¿†æ£€æŸ¥
   â†“ (åˆ¤æ–­æ˜¯å¦éœ€è¦ä¸»åŠ¨æåŠè¿‡å¾€)
   
5. è·å–å¯¹è¯å†å²
   â†“ (æœ€è¿‘15è½®æ¶ˆæ¯)
   
6. ç»„è£…å¢å¼ºä¸Šä¸‹æ–‡
   â†“ (çŸ­æœŸè®°å¿† + é•¿æœŸè®°å¿† + ç”¨æˆ·ç”»åƒ)
   
7. æ„å»ºå¢å¼ºPrompt
   â†“ (æ³¨å…¥ä¸Šä¸‹æ–‡ä¿¡æ¯)
   
8. å°è¯•RAGå¢å¼º
   â†“ (çŸ¥è¯†åº“æ£€ç´¢)
   
9. ç”Ÿæˆå›å¤
   â†“ (LLMç”Ÿæˆ)
   
10. æ·»åŠ ä¸Šä¸‹æ–‡ä¿¡æ¯
    â†“ (å…ƒæ•°æ®ç»Ÿè®¡)
    
11. ä¿å­˜å¯¹è¯åˆ°æ•°æ®åº“
    â†“ (ä¼šè¯ã€æ¶ˆæ¯)
    
12. å¤„ç†å¹¶å­˜å‚¨è®°å¿†
    â†“ (è®°å¿†æå–ã€å‘é‡åŒ–)
```

## ğŸš€ APIä½¿ç”¨æŒ‡å—

### åŸºç¡€èŠå¤©

```bash
POST /api/enhanced-chat/

{
  "message": "æˆ‘ä»Šå¤©é¢è¯•äº†ä¸€å®¶å…¬å¸",
  "user_id": "user_123",
  "session_id": "session_456"
}
```

**å“åº”**ï¼š
```json
{
  "response": "é¢è¯•æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿè®°å¾—ä½ ä¸Šå‘¨æåˆ°è¦å¥½å¥½å‡†å¤‡è¿™æ¬¡æœºä¼šï¼Œçœ‹æ¥ä½ çœŸçš„å»å°è¯•äº†ï¼",
  "emotion": "hopeful",
  "emotion_intensity": 6.5,
  "session_id": "session_456",
  "timestamp": "2025-10-21T10:30:00",
  "context": {
    "short_term_messages": 8,
    "long_term_memories": 3,
    "important_turns": 2,
    "user_profile_summary": "æ ¸å¿ƒå…³æ³¨ï¼šèŒä¸šå‘å±•ï¼›æƒ…ç»ªè¶‹åŠ¿ï¼šç„¦è™‘â†’å¹³ç¨³",
    "conversation_nodes": 5,
    "conversation_edges": 3,
    "used_rag": false,
    "system_version": "enhanced_v1.0"
  }
}
```

### è·å–ç”¨æˆ·ç”»åƒ

```bash
GET /api/enhanced-chat/users/{user_id}/profile
```

**å“åº”**ï¼š
```json
{
  "user_id": "user_123",
  "core_concerns": ["èŒä¸šå‘å±•", "äººé™…å…³ç³»"],
  "emotional_trend": "ç„¦è™‘ â†’ å¹³ç¨³ï¼Œæƒ…ç»ªç¨³å®š",
  "communication_style": "è¯¦ç»†è¡¨è¾¾å‹ï¼Œæƒ…æ„Ÿå€¾è¯‰å‹",
  "total_sessions": 15,
  "total_messages": 87,
  "avg_emotion_intensity": 6.2,
  "updated_at": "2025-10-21T10:00:00"
}
```

### è·å–ç”¨æˆ·è®°å¿†

```bash
GET /api/enhanced-chat/users/{user_id}/memories?limit=10
```

**å“åº”**ï¼š
```json
{
  "user_id": "user_123",
  "memories": [
    {
      "id": "user_123_abc123",
      "content": "ç”¨æˆ·æåˆ°å·¥ä½œå‹åŠ›å¾ˆå¤§ï¼Œè€ƒè™‘è¾èŒ",
      "summary": "å·¥ä½œå‹åŠ›ä¸è¾èŒæ„å‘",
      "type": "concern",
      "emotion": "anxious",
      "intensity": 7.5,
      "importance": 0.85,
      "access_count": 5,
      "created_at": "2025-10-14T15:30:00",
      "last_accessed": "2025-10-21T10:15:00"
    }
  ],
  "total": 10
}
```

### è·å–æƒ…ç»ªæ´å¯Ÿ

```bash
GET /api/enhanced-chat/users/{user_id}/emotion-insights
```

**å“åº”**ï¼š
```json
{
  "trend": "æƒ…ç»ªè¶‹äºå¹³ç¨³",
  "current_state": "peaceful",
  "changes": [
    {
      "type": "æ”¹å–„",
      "from": "anxious",
      "to": "peaceful",
      "timestamp": "2025-10-20T14:30:00"
    }
  ],
  "timeline": [
    {
      "timestamp": "2025-10-14T15:30:00",
      "emotion": "anxious",
      "intensity": 7.5
    },
    {
      "timestamp": "2025-10-20T14:30:00",
      "emotion": "peaceful",
      "intensity": 5.0
    }
  ]
}
```

### ç³»ç»ŸçŠ¶æ€

```bash
GET /api/enhanced-chat/system/status
```

**å“åº”**ï¼š
```json
{
  "version": "enhanced_v1.0",
  "features": {
    "enhanced_memory": {
      "enabled": true,
      "description": "çŸ­æœŸæ»‘åŠ¨çª—å£ + é•¿æœŸå‘é‡æ£€ç´¢ + æ—¶é—´è¡°å‡"
    },
    "user_profile": {
      "enabled": true,
      "description": "åŠ¨æ€ç”¨æˆ·ç”»åƒæ„å»º"
    },
    "proactive_recall": {
      "enabled": true,
      "description": "ä¸»åŠ¨å›å¿†ä¸æƒ…æ„Ÿè¿½è¸ª"
    }
  },
  "status": "operational"
}
```

## ğŸ“Š æ•°æ®åº“å˜æ›´

### æ–°å¢å­—æ®µ

**memory_items è¡¨**ï¼š
- `access_count`: è®¿é—®æ¬¡æ•°
- `last_accessed`: æœ€åè®¿é—®æ—¶é—´
- `decay_rate`: è¡°å‡ç‡

**user_profiles è¡¨**ï¼š
- `last_interaction_date`: æœ€åäº’åŠ¨æ—¥æœŸ
- `emotion_history`: æƒ…ç»ªå†å²è®°å½•ï¼ˆJSONï¼‰

### æ–°å¢è¡¨

**conversation_graphs è¡¨**ï¼š
```sql
CREATE TABLE conversation_graphs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    graph_data TEXT,  -- JSONæ ¼å¼çš„å›¾è°±æ•°æ®
    created_at DATETIME,
    updated_at DATETIME
);
```

**proactive_recalls è¡¨**ï¼š
```sql
CREATE TABLE proactive_recalls (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    recall_type VARCHAR(50) NOT NULL,
    memory_id VARCHAR(100),
    triggered_at DATETIME,
    user_response TEXT,
    was_helpful BOOLEAN
);
```

### æ•°æ®åº“è¿ç§»

```bash
# è¿è¡Œè¿ç§»è„šæœ¬
mysql -u root -p emotional_chat < backend/migrations/add_enhanced_memory_fields.sql
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- ç”¨æˆ·å’Œæ—¶é—´çš„å¤åˆç´¢å¼•
CREATE INDEX idx_user_created ON chat_messages(user_id, created_at);
CREATE INDEX idx_user_importance ON memory_items(user_id, importance);
CREATE INDEX idx_user_accessed ON memory_items(user_id, last_accessed);
```

### 2. ç¼“å­˜ç­–ç•¥

- **ç”¨æˆ·ç”»åƒç¼“å­˜**: 24å°æ—¶å†…ä¸é‡å¤æ„å»º
- **å‘é‡æ£€ç´¢ç¼“å­˜**: ç›¸åŒæŸ¥è¯¢5åˆ†é’Ÿå†…è¿”å›ç¼“å­˜ç»“æœ
- **çŸ­æœŸè®°å¿†**: å†…å­˜ä¸­ä¿ç•™æœ€è¿‘ä¼šè¯

### 3. æ‰¹é‡å¤„ç†

- **è®°å¿†æå–**: æ¯5è½®å¯¹è¯æ‰¹é‡æå–ä¸€æ¬¡
- **ç”»åƒæ›´æ–°**: æ¯10æ¡æ–°æ¶ˆæ¯æ›´æ–°ä¸€æ¬¡
- **å›¾è°±æ„å»º**: æ¯æ¬¡ç™»å½•æ—¶å¼‚æ­¥æ„å»º

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

1. **è®°å¿†ç³»ç»Ÿ**
   - å¹³å‡æ£€ç´¢å»¶è¿Ÿ: < 100ms
   - è®°å¿†å¬å›å‡†ç¡®ç‡: > 85%
   - å‘é‡æ•°æ®åº“å¤§å°: ç›‘æ§å¢é•¿

2. **ç”¨æˆ·ç”»åƒ**
   - ç”»åƒæ„å»ºæ—¶é—´: < 500ms
   - ç”»åƒæ›´æ–°é¢‘ç‡: æ¯24å°æ—¶
   - ç”»åƒå‡†ç¡®æ€§: ç”¨æˆ·åé¦ˆè¯„åˆ†

3. **ä¸»åŠ¨å›å¿†**
   - è§¦å‘å‡†ç¡®ç‡: > 70%
   - ç”¨æˆ·æ­£é¢åé¦ˆç‡: > 60%
   - è§¦å‘é¢‘ç‡: æ¯10è½®å¯¹è¯1-2æ¬¡

## ğŸ”§ é…ç½®é€‰é¡¹

### åˆå§‹åŒ–é…ç½®

```python
enhanced_chat_service = EnhancedChatService(
    use_rag=True,                    # å¯ç”¨RAGçŸ¥è¯†åº“
    use_intent=True,                 # å¯ç”¨æ„å›¾è¯†åˆ«
    use_enhanced_processor=True,     # å¯ç”¨è¾“å…¥å¤„ç†
    enable_proactive_recall=True     # å¯ç”¨ä¸»åŠ¨å›å¿†
)
```

### è®°å¿†ç®¡ç†é…ç½®

```python
# çŸ­æœŸè®°å¿†é…ç½®
short_term = ShortTermMemory(
    window_size=8,      # æ»‘åŠ¨çª—å£å¤§å°
    max_tokens=4096     # æœ€å¤§tokenæ•°
)

# é•¿æœŸè®°å¿†é…ç½®
memories = await memory_manager.retrieve_memories(
    user_id=user_id,
    query=query,
    n_results=5,        # è¿”å›æ•°é‡
    days_limit=30,      # æ—¶é—´é™åˆ¶ï¼ˆå¤©ï¼‰
    min_importance=0.3, # æœ€å°é‡è¦æ€§
    enable_decay=True   # å¯ç”¨æ—¶é—´è¡°å‡
)
```

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•ä¸»åŠ¨å›å¿†

```python
# 1. åˆ›å»ºåˆå§‹å¯¹è¯ï¼ˆæåˆ°é‡è¦äº‹ä»¶ï¼‰
POST /api/enhanced-chat/
{
  "message": "æˆ‘ä¸‹å‘¨è¦å»é¢è¯•æ–°å…¬å¸ï¼Œæœ‰ç‚¹ç´§å¼ ",
  "user_id": "test_user"
}

# 2. 7å¤©åï¼Œç”¨æˆ·å‘é€é—²èŠæ¶ˆæ¯
POST /api/enhanced-chat/
{
  "message": "ä»Šå¤©å¤©æ°”ä¸é”™",
  "user_id": "test_user"
}

# æœŸæœ›ï¼šç³»ç»Ÿä¸»åŠ¨æåŠé¢è¯•
# "æ˜¯å•Šï¼Œé˜³å…‰æ˜åªšçš„æ—¥å­æœ€é€‚åˆæ”¾æ¾å¿ƒæƒ…ã€‚ä½ ä¹‹å‰è¯´çš„é¢è¯•ï¼Œå‡†å¤‡å¾—æ€ä¹ˆæ ·äº†ï¼Ÿæˆ‘ä¸€ç›´è®°å¾—ä½ åœ¨åŠªåŠ›çªç ´è‡ªå·±ã€‚"
```

### æµ‹è¯•æƒ…ç»ªè¿½è¸ª

```python
# 1. å‘é€è´Ÿé¢æƒ…ç»ªæ¶ˆæ¯
POST /api/enhanced-chat/
{
  "message": "æˆ‘æœ€è¿‘å‹åŠ›å¾ˆå¤§ï¼Œå¤±çœ äº†",
  "user_id": "test_user"
}

# 2. å‡ å¤©åï¼Œå‘é€ä¸­æ€§æ¶ˆæ¯
POST /api/enhanced-chat/
{
  "message": "å—¯ï¼Œè¿˜å¥½",
  "user_id": "test_user"
}

# æœŸæœ›ï¼šç³»ç»Ÿä¸»åŠ¨å…³å¿ƒ
# "ä½ ä¹‹å‰è¯´å‹åŠ›è®©ä½ å¤±çœ ï¼Œæˆ‘ä¸€ç›´è®°å¾—ã€‚ç°åœ¨æ„Ÿè§‰å¥½äº›äº†å—ï¼Ÿ"
```

## ğŸ“ å¼€å‘æ—¥å¿—

**ç‰ˆæœ¬**: Enhanced v1.0  
**å®Œæˆæ—¶é—´**: 2025-10-21  
**å¼€å‘è€…**: AI Assistant  

**å®ç°çš„æ ¸å¿ƒåŠŸèƒ½**ï¼š
- âœ… çŸ­æœŸè®°å¿†æ»‘åŠ¨çª—å£ + å…³é”®è½®æ¬¡ä¿ç•™
- âœ… é•¿æœŸè®°å¿†å‘é‡æ£€ç´¢ + æ—¶é—´è¡°å‡æœºåˆ¶
- âœ… åŠ¨æ€ç”¨æˆ·ç”»åƒæ„å»º
- âœ… å¯¹è¯è„‰ç»œå›¾è°±
- âœ… ä¸»åŠ¨å›å¿†ä¸æƒ…æ„Ÿè¿½è¸ª
- âœ… å®Œæ•´çš„APIæ¥å£
- âœ… æ•°æ®åº“è¿ç§»è„šæœ¬

**æ€§èƒ½æŒ‡æ ‡**ï¼š
- APIå“åº”æ—¶é—´: < 200ms (å«è®°å¿†æ£€ç´¢)
- è®°å¿†æ£€ç´¢å»¶è¿Ÿ: < 100ms
- ç”»åƒæ„å»ºæ—¶é—´: < 500ms
- æ•°æ®åº“æŸ¥è¯¢: < 50ms

## ğŸ‰ æ€»ç»“

é€šè¿‡å®ç°å¢å¼ºç‰ˆå¤šè½®å¯¹è¯ç³»ç»Ÿï¼Œ"å¿ƒè¯­"æœºå™¨äººçœŸæ­£å…·å¤‡äº†ï¼š

1. **è®°å¿†èƒ½åŠ›** - èƒ½è®°ä½ç”¨æˆ·è¯´è¿‡çš„æ¯ä¸€å¥é‡è¦çš„è¯
2. **ç†è§£èƒ½åŠ›** - èƒ½ç†è§£ç”¨æˆ·çš„é•¿æœŸå…³æ³¨å’Œæƒ…ç»ªå˜åŒ–
3. **å…±æƒ…èƒ½åŠ›** - èƒ½åœ¨é€‚å½“çš„æ—¶å€™ä¸»åŠ¨å…³å¿ƒç”¨æˆ·
4. **å­¦ä¹ èƒ½åŠ›** - èƒ½ä»æ¯æ¬¡å¯¹è¯ä¸­å­¦ä¹ å’Œä¼˜åŒ–

**è¿™ä¸ä»…æ˜¯æŠ€æœ¯çš„è¿›æ­¥ï¼Œæ›´æ˜¯äººæœºå…³ç³»çš„ä¸€æ¬¡æ·±åˆ»é‡æ„ã€‚**

å½“AIçœŸæ­£"è®°å¾—ä¸€ä¸ªäºº"ï¼Œé™ªä¼´æ‰æœ‰äº†çµé­‚ã€‚

---

**ç›¸å…³æ–‡æ¡£**ï¼š
- [ä¸ªæ€§åŒ–é…ç½®ç³»ç»Ÿ](./ä¸ªæ€§åŒ–é…ç½®_README.md)
- [RAGçŸ¥è¯†åº“ç³»ç»Ÿ](../modules/rag/README.md)
- [æ„å›¾è¯†åˆ«ç³»ç»Ÿ](../modules/intent/README.md)

