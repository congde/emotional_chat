# AgentæŠ€æœ¯æ¶æ„å®Œæ•´æŒ‡å—

> æœ¬æ–‡æ¡£æ•´åˆäº†æƒ…æ„ŸèŠå¤©æœºå™¨äººé¡¹ç›®ä¸­æ‰€æœ‰Agentç›¸å…³çš„æŠ€æœ¯å®ç°ï¼Œå¸®åŠ©è¯»è€…ä»æŠ€æœ¯è§’åº¦æ·±å…¥ç†è§£Agentæ¶æ„ã€‚

---

## ã€‡ã€Agentä¼˜åŒ–åå¤§å®æˆ˜ç»éªŒ

> åŸºäºä¸Šä¸‹æ–‡å·¥ç¨‹å’ŒMulti-Agentæ„å»ºçš„å®æˆ˜æ€»ç»“ï¼Œå¸®åŠ©ä½ è®©Agentæ›´ç¬¦åˆé¢„æœŸã€‚

### ä¸ºä»€ä¹ˆAgentä¸æŒ‰é¢„æœŸè¾“å‡ºï¼Ÿ

åœ¨æ„å»ºAgentæ—¶ï¼Œæˆ‘ä»¬ç»å¸¸é‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š
- "ä¸ºä»€ä¹ˆè°ƒäº†æç¤ºè¯ï¼ŒAgentæ•ˆæœè¿˜æ˜¯è¿™ä¹ˆå·®ï¼Ÿ"
- "ä¸ºä»€ä¹ˆAgentè¿è¡Œä¸ç¨³å®šï¼Œäº¤äº’å‡ è½®åå°±å¼€å§‹ä¸éµå¾ªæŒ‡ä»¤äº†ï¼Ÿ"
- "ä¸ºä»€ä¹ˆAgentæ€»æ˜¯äº§ç”Ÿå¹»è§‰ï¼Œä¸æŒ‰é¢„æœŸè¾“å‡ºï¼Ÿ"

è¿™éœ€è¦ä»ä¸¤ä¸ªè§’åº¦åˆ†æï¼š**é¢„æœŸå±‚é¢**å’Œ**æŠ€æœ¯å±‚é¢**ã€‚

### ç»éªŒä¸€ï¼šæ¸…æ™°åŒ–ä½ çš„é¢„æœŸ

**æ ¸å¿ƒåŸåˆ™**ï¼šé¿å…æ¨¡ç³Šé¢„æœŸï¼Œç»™åˆ°è¶³å¤Ÿæ¸…æ™°çš„é¢„æœŸï¼Œè®©å¤§æ¨¡å‹ç†è§£èµ·æ¥æ²¡æœ‰ä»»ä½•çš„æ­§ä¹‰å’Œå›°æƒ‘ã€‚

æ¨¡ç³Šé¢„æœŸä¼šè®©å¤§æ¨¡å‹äº§ç”Ÿå›°æƒ‘ï¼ˆConfuseï¼‰ï¼Œå¿…é¡»å°†æ¨¡ç³Šçš„é¢„æœŸè½¬åŒ–ä¸ºå…·ä½“ã€å¯è¡¡é‡çš„æ¸…æ™°é¢„æœŸã€‚

**å¦‚ä½•å®šä¹‰æ¸…æ™°é¢„æœŸï¼Ÿ**

| ç»´åº¦ | æ¨¡ç³Šé¢„æœŸ | æ¸…æ™°é¢„æœŸ |
|------|---------|---------|
| ä»»åŠ¡è¦æ±‚ | "åˆ¤æ–­ç”¨æˆ·æƒ…ç»ªæ˜¯å¦éœ€è¦å¹²é¢„" | "å¦‚æœç”¨æˆ·æƒ…ç»ªåˆ†æ•°è¿ç»­3å¤©ä½äº3åˆ†ï¼ˆæ»¡åˆ†5åˆ†ï¼‰ï¼Œæˆ–å‡ºç°'ä¸æƒ³æ´»'ç­‰å±æœºè¯æ±‡ï¼Œåˆ™éœ€è¦å¹²é¢„" |
| è¾“å‡ºæ ¼å¼ | "ç»™æˆ‘ä¸€ä¸ªæƒ…ç»ªåˆ†ææŠ¥å‘Š" | "è¾“å‡ºåŒ…å«emotion_typeã€intensity(1-10)ã€needs_intervention(bool)çš„JSONå¯¹è±¡" |
| é£æ ¼è¯­æ°” | "ç”¨æ¸©æš–çš„æ–¹å¼å›å¤" | "ä»¥ç¬¬ä¸€äººç§°ã€ä½¿ç”¨'æˆ‘ç†è§£'å¼€å¤´ï¼Œè¯­å¥ä¸è¶…è¿‡50å­—ï¼Œé¿å…ä½¿ç”¨æ„Ÿå¹å·" |

**è¸©å‘æ¡ˆä¾‹**ï¼šæƒ…æ„Ÿæ”¯æŒåœºæ™¯ä¸‹çš„æ­§ä¹‰

å½“ç”¨æˆ·è¯´"æˆ‘å¥½ç´¯"æ—¶ï¼Œå¯èƒ½æ˜¯ï¼š
1. **èº«ä½“ç–²åŠ³**ï¼šéœ€è¦å»ºè®®ä¼‘æ¯ã€æ”¾æ¾
2. **å¿ƒç†ç–²æƒ«**ï¼šéœ€è¦æƒ…æ„Ÿæ”¯æŒã€å€¾å¬

è§£å†³æ–¹æ¡ˆï¼šæ˜ç¡®æè¿°ä¸¤ç§æƒ…å†µçš„åŒºåˆ«ï¼Œæä¾›åˆ¤æ–­è§„åˆ™æˆ–è®©æ¨¡å‹é€šè¿‡è¿½é—®æ¾„æ¸…ã€‚

### ç»éªŒäºŒï¼šä¸Šä¸‹æ–‡ç²¾å‡†æŠ•å–‚

**æ ¸å¿ƒåŸåˆ™**ï¼š"ç»™å…¶æ‰€éœ€ï¼Œå»å…¶æ‰€æ‰°"ã€‚æ¨¡å‹éœ€è¦ä¸”å…³å¿ƒçš„ä¿¡æ¯ï¼Œä¸€å®šè¦ç»™åˆ°ï¼›æ¨¡å‹ä¸éœ€è¦ä¸”ä¸ç›¸å…³çš„å¹²æ‰°ä¿¡æ¯ï¼Œä¸€å®šè¦å‰”é™¤ã€‚

**è¸©å‘æ¡ˆä¾‹**ï¼šæƒ…ç»ªåˆ†ææ—¶çš„ä¿¡æ¯å¹²æ‰°

å½“è°ƒç”¨æƒ…ç»ªåˆ†æå·¥å…·è¿”å›å¤§é‡å­—æ®µï¼ˆæƒ…ç»ªç±»å‹ã€å¼ºåº¦ã€ç½®ä¿¡åº¦ã€å†å²è¶‹åŠ¿ã€ç”Ÿç†æŒ‡æ ‡ç­‰ï¼‰æ—¶ï¼Œæ¨¡å‹å¯èƒ½éšæ„é€‰æ‹©å­—æ®µè¿›è¡Œåˆ¤æ–­ï¼Œå¯¼è‡´ç»“è®ºä¸ä¸€è‡´ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# é”™è¯¯åšæ³•ï¼šç›´æ¥è¿”å›æ‰€æœ‰å­—æ®µ
return emotion_api_response  # åŒ…å«20+å­—æ®µ

# æ­£ç¡®åšæ³•ï¼šåªè¿”å›æ¨¡å‹éœ€è¦çš„å­—æ®µ
return {
    "primary_emotion": emotion_api_response["primary_emotion"],
    "intensity": emotion_api_response["intensity"],
    "needs_support": emotion_api_response["intensity"] > 7
}
```

### ç»éªŒä¸‰ï¼šèº«ä»½å’Œå†å²æ‰§è¡Œæ¸…æ™°åŒ–

**æ ¸å¿ƒåŸåˆ™**ï¼šæ¨¡å‹éœ€è¦æ˜ç¡®çŸ¥é“æœ‰å‡ æ–¹çš„èº«ä»½ï¼Œéœ€è¦çŸ¥é“è‡ªå·±åšè¿‡å“ªäº›äº‹æƒ…ï¼Œå½“å‰æ‰§è¡Œåˆ°å“ªä¸ªé˜¶æ®µã€‚

**è¸©å‘æ¡ˆä¾‹**ï¼šä¸‰æ–¹è§’è‰²ä¸æ¸…æ™°å¯¼è‡´æ¨¡å‹"é”™ä¹±"

åœ¨å¿ƒç†å’¨è¯¢åœºæ™¯ä¸­ï¼Œå­˜åœ¨ä¸‰ä¸ªè§’è‰²ï¼šç”¨æˆ·ã€AIåŠ©æ‰‹ã€äººå·¥å’¨è¯¢å¸ˆã€‚å¦‚æœå°†å’¨è¯¢å¸ˆä¸ç”¨æˆ·çš„å¯¹è¯ç›´æ¥ä½œä¸ºHistoryå–‚ç»™æ¨¡å‹ï¼Œæ¨¡å‹ä¼šæ··æ·†è§’è‰²ï¼Œäº§ç”Ÿå¹»è§‰ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **ä¸»çº¿å›å½’ç”¨æˆ·ä¸å¤§æ¨¡å‹**ï¼šå¯¹è¯çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ï¼Œä»¥ç”¨æˆ·å’Œå¤§æ¨¡å‹ä¹‹é—´çš„äº¤äº’ä¸ºä¸»çº¿
2. **å’¨è¯¢å¸ˆå¯¹è¯ä½œå‚è€ƒ**ï¼šå°†å’¨è¯¢å¸ˆä¸ç”¨æˆ·çš„å¯¹è¯æ ‡è¯†ä¸º"å¯¹è¯è®°å¿†"ï¼ˆDialogue Memoryï¼‰æ³¨å…¥ä¸Šä¸‹æ–‡
3. **ä¿ç•™å®Œæ•´åŠ¨ä½œ**ï¼šå¤§æ¨¡å‹è‡ªå·±æ‰§è¡Œè¿‡çš„Action Historyå®Œæ•´ä¿ç•™

**å…³é”®åŸåˆ™**ï¼š
- **Mask, Don't Remove**ï¼šä¸è¦åˆ é™¤å†å²ï¼Œå¯ä»¥æ ‡è®°æˆ–å‹ç¼©
- **Keep the Wrong Stuff In**ï¼šä¿ç•™å¤±è´¥çš„å°è¯•ï¼Œè®©æ¨¡å‹å­¦ä¼šé€‚åº”

### ç»éªŒå››ï¼šå–„ç”¨ç»“æ„åŒ–å½¢å¼è¡¨è¾¾é€»è¾‘

**æ ¸å¿ƒåŸåˆ™**ï¼šç›¸å¯¹å¤æ‚çš„æµç¨‹ã€é€»è¾‘ï¼Œä¼˜å…ˆè€ƒè™‘å½¢å¼åŒ–ã€ç»“æ„åŒ–æ–¹å¼è¡¨è¾¾ï¼Œä¸è¦åªç”¨è‡ªç„¶è¯­è¨€ã€‚

ç»“æ„åŒ–è¯­è¨€æ¶ˆé™¤æ­§ä¹‰ï¼Œç¨‹åºåŒ–è¯­è¨€å¤©ç„¶ä¸º"è¿è¡Œ"è®¾è®¡ã€‚

```yaml
# ç”¨YAMLè¡¨è¾¾æƒ…ç»ªå¹²é¢„æµç¨‹
intervention_flow:
  - step: analyze_emotion
    condition: always
  - step: check_crisis_keywords
    condition: emotion.intensity > 7
    action: trigger_crisis_protocol
  - step: provide_support
    condition: emotion.needs_support == true
    tools:
      - play_meditation_audio
      - set_reminder
```

### ç»éªŒäº”ï¼šå°è¯•è‡ªå®šä¹‰å·¥å…·åè®®

**æ ¸å¿ƒåŸåˆ™**ï¼šå¦‚æœä½ çš„é¢†åŸŸä»»åŠ¡ç›¸å¯¹ç‹¬ç‰¹ä¸”å¯¹ç¨³å®šæ€§è¦æ±‚è¾ƒé«˜ï¼Œè‡ªå®šä¹‰å·¥å…·åè®®å’ŒæŒ‡ä»¤æ˜¯å€¼å¾—å°è¯•çš„ã€‚

é€šç”¨çš„Function Callåè®®åœ¨ç‰¹å®šé¢†åŸŸåœºæ™¯ä¸‹ï¼Œå¯èƒ½ä¸å¦‚è‡ªå®šä¹‰åè®®ç¨³å®šï¼Œå› ä¸ºæ¨¡å‹ä¼šæŒ‰ç…§è®­ç»ƒæ•°æ®ä¸­çš„æ–¹å¼å»ç†è§£å’Œè°ƒç”¨ã€‚

### ç»éªŒå…­ï¼šFew-Shotè¦åˆç†ä½¿ç”¨

**æ ¸å¿ƒåŸåˆ™**ï¼šçµæ´»æ€§å¼ºçš„åœºæ™¯æ…ç”¨Few-Shotï¼Œç‰¹å®šä»»åŠ¡ä¸­å»ºè®®ç”¨å¤šæ ·åŒ–çš„Few-Shotã€‚

| åœºæ™¯ç±»å‹ | Few-Shotç­–ç•¥ |
|---------|-------------|
| å•ä»»åŠ¡ï¼ˆå‚æ•°æå–ã€åˆ†ç±»åˆ¤æ–­ï¼‰ | æä¾›å¤šæ ·åŒ–çš„Few-Shotç¤ºä¾‹ï¼Œè¦†ç›–ä¸åŒæƒ…å†µ |
| çµæ´»ä»»åŠ¡ï¼ˆå¼€æ”¾å¼å¯¹è¯ã€åˆ›æ„ç”Ÿæˆï¼‰ | å‡å°‘æˆ–ä¸ç”¨Few-Shotï¼Œé¿å…æ¨¡å‹"è¿‡æ‹Ÿåˆ" |

**å»ºè®®**ï¼šFew-Shotç¤ºä¾‹è¦å¤šæ ·åŒ–ï¼ŒåŒ…æ‹¬æ­£ä¾‹ã€åä¾‹ã€è¾¹ç•Œæƒ…å†µã€‚

### ç»éªŒä¸ƒï¼šä¿æŒä¸Šä¸‹æ–‡çš„"è‹—æ¡"

**æ ¸å¿ƒåŸåˆ™**ï¼šåœ¨ä¸æŸå¤±æ€§èƒ½çš„å‰æä¸‹ï¼Œå°½å¯èƒ½å¯¹ä¸Šä¸‹æ–‡è¿›è¡Œ"ç˜¦èº«"ã€‚

å½“ä¸Šä¸‹æ–‡è¶…è¿‡ä¸€å®šé•¿åº¦ï¼ˆå¦‚1ä¸‡Tokenï¼‰ï¼Œæ¨¡å‹å¯¹å†å²ä¿¡æ¯çš„é—å¿˜ç‡æ˜¾è‘—å¢åŠ ï¼Œç”šè‡³ç³»ç»ŸæŒ‡ä»¤éƒ½ä¼šè¢«é—´æ­‡æ€§é—å¿˜ã€‚

**ä¼˜åŒ–æ–¹æ³•**ï¼š
- é€šè¿‡RAGåŠ¨æ€ç­›é€‰å½“å‰ä»»åŠ¡éœ€è¦çš„ä¿¡æ¯
- ç²¾ç®€é‡å¤çš„æç¤ºè¯è¦æ±‚
- æµ‹è¯•ç§»é™¤æŸäº›æŒ‡ä»¤åæ¨¡å‹çš„ååº”æ˜¯å¦æ•æ„Ÿ

### ç»éªŒå…«ï¼šä½¿ç”¨è®°å¿†ç®¡ç†æ¥é¿å…æ¨¡å‹é—å¿˜

**æ ¸å¿ƒåŸåˆ™**ï¼šé‡ç‚¹ä¿¡æ¯å¤šæ¬¡å¢å¼ºæç¤ºï¼Œä¸Šä¸‹æ–‡å‹ç¼©å‡å°‘å†å²å¯¹è¯è½®æ¬¡ï¼Œå¤–éƒ¨å­˜å‚¨å¸®åŠ©å®æ—¶å”¤èµ·æ›´ä¹…çš„è®°å¿†ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®°å¿†ç®¡ç†ç­–ç•¥                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. é‡ç‚¹ä¿¡æ¯å¢å¼ºæç¤º                                      â”‚
â”‚    - å…³é”®ä¿¡æ¯ï¼ˆç”¨æˆ·IDã€åå¥½ç­‰ï¼‰åœ¨å¯¹è¯ä¸­å¤šæ¬¡"å¤ä¹ "        â”‚
â”‚    - ä½œä¸ºå·¥å…·è°ƒç”¨çš„"å†…éƒ¨å˜é‡"æŒç»­ä¼ é€’                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. ä¸Šä¸‹æ–‡è®°å¿†å‹ç¼©                                        â”‚
â”‚    - æ—©æœŸå¯¹è¯é€šè¿‡summaryæ–¹å¼æå–æ ¸å¿ƒä¿¡æ¯                 â”‚
â”‚    - ç±»ä¼¼è®¡ç®—æœºçš„"å†…å­˜"ç®¡ç†                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. å¤–éƒ¨è®°å¿†å­˜å‚¨                                          â”‚
â”‚    - é•¿æœŸä¿¡æ¯è®°å½•åˆ°Memoryæ±                               â”‚
â”‚    - æ”¯æŒ"è¯»"å’Œ"å†™"æ“ä½œ                                  â”‚
â”‚    - ç±»ä¼¼è®¡ç®—æœºçš„"å¤–å­˜"                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»éªŒä¹ï¼šä½¿ç”¨Multi-Agentæ¥å¹³è¡¡å¯æ§æ€§ä¸çµæ´»æ€§

**æ ¸å¿ƒåŸåˆ™**ï¼šWorkflowæå‡å¯æ§æ€§ï¼ŒLLMè‡ªä¸»å†³ç­–æå‡çµæ´»æ€§ï¼Œå¥½çš„Multi-Agentè®¾è®¡æ—¢å¯æ§åˆèƒ½çµæ´»ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»Agent (è°ƒåº¦å†³ç­–)                   â”‚
â”‚  - æ„å›¾è·¯ç”±ã€å­æ¨¡å—è°ƒåº¦ã€æœ€ç»ˆç”Ÿæˆçš„å†³ç­–                 â”‚
â”‚  - ä½¿ç”¨LLMè¿›è¡Œè‡ªä¸»å†³ç­–ï¼Œè´Ÿè´£çµæ´»æ€§                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æƒ…ç»ªåˆ†æAgent â”‚ â”‚ å±æœºå¹²é¢„Agent â”‚ â”‚ èµ„æºæ¨èAgent â”‚
â”‚  (å­Agent)    â”‚ â”‚  (å­Agent)    â”‚ â”‚  (å­Agent)    â”‚
â”‚              â”‚ â”‚              â”‚ â”‚              â”‚
â”‚ Workflowç¼–æ’ â”‚ â”‚ è§„åˆ™å¼•æ“+LLM â”‚ â”‚ RAG+è§„åˆ™     â”‚
â”‚ é«˜ç¨³å®šæ€§     â”‚ â”‚ é«˜å¯æ§æ€§     â”‚ â”‚ é«˜å‡†ç¡®æ€§     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»éªŒåï¼šåªæœ‰HITLæ‰èƒ½åšå‡ºæ›´å¥½çš„Agent

**æ ¸å¿ƒåŸåˆ™**ï¼šåªæœ‰åšæŒäººåœ¨å›è·¯ï¼ˆHuman-In-The-Loopï¼‰ï¼Œæ·±å…¥ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œæ‰èƒ½åšå‡ºå¥½çš„Agentã€‚

Agentçš„æœ¬è´¨æ˜¯è®©å¤§æ¨¡å‹"ä»£ç†/æ¨¡æ‹Ÿ"äººçš„è¡Œä¸ºã€‚è¦åšå¥½Agentï¼Œå¿…é¡»å…ˆçŸ¥é“"äºº"æ˜¯æ€ä¹ˆåšçš„ï¼š
- äººæ˜¯å¦‚ä½•è¯†åˆ«è¿™ä¸ªé—®é¢˜çš„ï¼Ÿ
- ä»€ä¹ˆæƒ…å†µåº”è¯¥è°ƒç”¨å“ªä¸ªå·¥å…·ï¼Ÿ
- è°ƒç”¨å·¥å…·ä¹‹åå¦‚ä½•å›å¤ç»™ç”¨æˆ·ï¼Ÿ

**å®è·µå»ºè®®**ï¼š
- æ·±å…¥äº†è§£å®é™…ç”¨æˆ·çš„å¤„ç†é€»è¾‘å’Œä¹ æƒ¯
- æŒç»­æ”¶é›†ç”¨æˆ·åé¦ˆï¼ŒæŒ‡å¯¼Agentè¿­ä»£ä¼˜åŒ–
- è§‚å¯ŸçœŸå®åœºæ™¯ï¼Œè€Œä¸ä»…ä»…ä¾èµ–éœ€æ±‚æ–‡æ¡£

---

## ä¸€ã€Agentæ•´ä½“æ¶æ„

### 1.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Agent Core                         â”‚
â”‚  (æ ¸å¿ƒæ§åˆ¶å™¨ï¼Œåè°ƒæ‰€æœ‰æ¨¡å—)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚         â”‚         â”‚
         â–¼         â–¼         â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Memory  â”‚ â”‚Planner â”‚ â”‚Tool     â”‚ â”‚Reflectorâ”‚
    â”‚Hub     â”‚ â”‚        â”‚ â”‚Caller   â”‚ â”‚        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚         â”‚         â”‚
         â–¼         â–¼         â–¼         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          External Tools              â”‚
    â”‚  - Calendar API                       â”‚
    â”‚  - Audio Player                       â”‚
    â”‚  - Psychology DB                      â”‚
    â”‚  - Scheduler Service                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ¨¡å—èŒè´£

| æ¨¡å— | èŒè´£ | ä¸»è¦åŠŸèƒ½ |
|------|------|----------|
| Agent Core | æ ¸å¿ƒæ§åˆ¶å™¨ | åè°ƒæ‰€æœ‰æ¨¡å—ï¼Œç®¡ç†å®Œæ•´äº¤äº’æµç¨‹ |
| Memory Hub | è®°å¿†ä¸­æ¢ | è®°å¿†ç¼–ç ã€æ£€ç´¢ã€å·©å›º |
| Planner | ä»»åŠ¡è§„åˆ’ | ç›®æ ‡è¯†åˆ«ã€ä»»åŠ¡åˆ†è§£ã€ç­–ç•¥é€‰æ‹© |
| Tool Caller | å·¥å…·è°ƒç”¨ | å·¥å…·æ³¨å†Œã€è°ƒç”¨æ‰§è¡Œã€ç»“æœå¤„ç† |
| Reflector | åæ€ä¼˜åŒ– | æ•ˆæœè¯„ä¼°ã€ç­–ç•¥ä¼˜åŒ–ã€å›è®¿è§„åˆ’ |

---

## äºŒã€æ ¸å¿ƒæ¨¡å—è¯¦è§£

### 2.1 Agent Core

**æ–‡ä»¶**: `backend/agent/agent_core.py`

**æ ¸å¿ƒå¤„ç†æµç¨‹**:

```python
async def process(user_input, user_id, conversation_id=None):
    """å¤„ç†ç”¨æˆ·è¾“å…¥çš„å®Œæ•´æµç¨‹"""
    # 1. æ„ŸçŸ¥å±‚ï¼šåˆ†æç”¨æˆ·è¾“å…¥ï¼ˆæƒ…æ„Ÿåˆ†æã€æ„å›¾è¯†åˆ«ã€å®ä½“æå–ï¼‰
    # 2. è®°å¿†æ£€ç´¢ï¼šè·å–ç›¸å…³è®°å¿†
    # 3. ä»»åŠ¡è§„åˆ’ï¼šç”Ÿæˆæ‰§è¡Œè®¡åˆ’
    # 4. æ‰§è¡Œè®¡åˆ’ï¼šè°ƒç”¨å·¥å…·ã€ç”Ÿæˆå›å¤
    # 5. è®°å¿†å·©å›ºï¼šä¿å­˜æ–°è®°å¿†
    # 6. åæ€è¯„ä¼°ï¼šè¯„ä¼°äº¤äº’æ•ˆæœ
    # 7. è®°å½•å†å²ï¼šä¿å­˜æ‰§è¡Œè®°å½•
```

### 2.2 Memory Hub (è®°å¿†ä¸­æ¢)

**æ–‡ä»¶**: `backend/agent/memory_hub.py`

**è®°å¿†ç±»å‹**:
- **æƒ…æ™¯è®°å¿† (Episodic)**: äº‹ä»¶ã€ç»å†ï¼Œæœ‰æ—¶é—´æˆ³å’Œæƒ…æ„Ÿæ ‡ç­¾
- **è¯­ä¹‰è®°å¿† (Semantic)**: çŸ¥è¯†ã€æ¦‚å¿µï¼ŒæŠ½è±¡é€šç”¨
- **ç¨‹åºè®°å¿† (Procedural)**: æŠ€èƒ½ã€ç­–ç•¥
- **å¯¹è¯è®°å¿† (Conversation)**: å¯¹è¯å†å²

**æ ¸å¿ƒæ–¹æ³•**:

```python
def encode(experience) -> Dict        # ç¼–ç ï¼šå°†æ–°ç»éªŒè½¬æ¢ä¸ºè®°å¿†
def retrieve(query, user_id, context, top_k) -> List[Dict]  # æ£€ç´¢ç›¸å…³è®°å¿†
def consolidate(memory) -> bool       # å·©å›ºï¼šå·¥ä½œè®°å¿†è½¬ç§»åˆ°é•¿æœŸè®°å¿†
def get_user_profile(user_id) -> Dict # è·å–ç”¨æˆ·ç”»åƒ
```

**æ£€ç´¢ç­–ç•¥**:
1. **è¯­ä¹‰æ£€ç´¢**: å‘é‡ç›¸ä¼¼åº¦æœç´¢
2. **æ—¶é—´æ£€ç´¢**: è¿‘æœŸä¼˜å…ˆ
3. **æƒ…ç»ªæ£€ç´¢**: æƒ…ç»ªä¸€è‡´æ€§åŒ¹é…

**åˆ†å±‚æ¶æ„**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Memory Hub (è®°å¿†ä¸­æ¢)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  å·¥ä½œè®°å¿†    â”‚      â”‚     é•¿æœŸè®°å¿†          â”‚  â”‚
â”‚  â”‚ (Working     â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  Memory)     â”‚      â”‚  â”‚   æƒ…æ™¯è®°å¿†       â”‚ â”‚  â”‚
â”‚  â”‚              â”‚      â”‚  â”‚ (Episodic)       â”‚ â”‚  â”‚
â”‚  â”‚ - å¯¹è¯ä¸Šä¸‹æ–‡  â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚ - æ¿€æ´»ä»»åŠ¡    â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚ - ä¸´æ—¶å˜é‡    â”‚      â”‚  â”‚   è¯­ä¹‰è®°å¿†       â”‚ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚ (Semantic)       â”‚ â”‚  â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚                         â”‚  â”‚   å¯¹è¯è®°å¿†       â”‚ â”‚  â”‚
â”‚                         â”‚  â”‚ (Conversation)   â”‚ â”‚  â”‚
â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
         â–¼                    â–¼                    â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  MySQL  â”‚         â”‚ ChromaDB â”‚         â”‚ Memory  â”‚
    â”‚ æ•°æ®åº“   â”‚         â”‚ å‘é‡æ•°æ®åº“â”‚         â”‚ Manager â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ£€ç´¢æµç¨‹**:

```
ç”¨æˆ·æŸ¥è¯¢
    â†“
å¤šè·¯å¾„æ£€ç´¢
    â”œâ”€â†’ å‘é‡è¯­ä¹‰æ£€ç´¢ (ç›¸ä¼¼åº¦)
    â”œâ”€â†’ æ—¶é—´åºåˆ—æ£€ç´¢ (è¿‘æœŸä¼˜å…ˆ)
    â””â”€â†’ æƒ…ç»ªå…³è”æ£€ç´¢ (æƒ…ç»ªä¸€è‡´æ€§)
    â†“
åˆå¹¶å»é‡ â†’ æŒ‰é‡è¦æ€§æ’åº â†’ è¿”å›Top-Kè®°å¿†
```

**é‡è¦æ€§è®¡ç®—**:

- æƒ…ç»ªå¼ºåº¦ (30%)
- å…³é”®è¯åŒ¹é… (20%)
- å†…å®¹é•¿åº¦ (10%)
- ç”¨æˆ·åé¦ˆ (40%)

### 2.3 Planner (è§„åˆ’æ¨¡å—)

**æ–‡ä»¶**: `backend/agent/planner.py`

**ç›®æ ‡ç±»å‹**:
- `INFORMATION_QUERY`: ä¿¡æ¯æŸ¥è¯¢
- `EMOTIONAL_SUPPORT`: æƒ…æ„Ÿæ”¯æŒ
- `PROBLEM_SOLVING`: é—®é¢˜è§£å†³
- `BEHAVIOR_CHANGE`: è¡Œä¸ºæ”¹å˜
- `CASUAL_CHAT`: é—²èŠ

**æ‰§è¡Œç­–ç•¥**:
- `DIRECT_RESPONSE`: ç›´æ¥å›å¤
- `EMPATHY_FIRST`: æƒ…æ„Ÿä¼˜å…ˆ
- `TOOL_USE`: å·¥å…·è°ƒç”¨
- `SCHEDULED_FOLLOWUP`: å®šæ—¶å›è®¿
- `CONVERSATIONAL`: å¯¹è¯å¼•å¯¼

### 2.4 Tool Caller (å·¥å…·è°ƒç”¨)

**æ–‡ä»¶**: `backend/agent/tool_caller.py`

**å†…ç½®å·¥å…·**:
- `search_memory`: æœç´¢è®°å¿†
- `get_emotion_log`: è·å–æƒ…ç»ªæ—¥å¿—
- `set_reminder`: è®¾ç½®æé†’
- `recommend_meditation`: æ¨èå†¥æƒ³
- `recommend_resource`: æ¨èèµ„æº
- `psychological_assessment`: å¿ƒç†è¯„ä¼°

### 2.5 Reflector (åæ€æ¨¡å—)

**æ–‡ä»¶**: `backend/agent/reflector.py`

**è¯„ä¼°æŒ‡æ ‡**:
- ç”¨æˆ·æ»¡æ„åº¦
- å“åº”æ—¶é—´
- ç›®æ ‡è¾¾æˆåº¦
- æƒ…ç»ªå˜åŒ–
- å·¥å…·ä½¿ç”¨æ•ˆæœ

### 2.6 æ„å›¾è¯†åˆ« (Intent Recognition)

**æ··åˆå¼æ¶æ„**:

```
ç”¨æˆ·è¾“å…¥
  â†“
è¾“å…¥é¢„å¤„ç†å™¨ (InputProcessor)
  â”œâ”€â”€ æ–‡æœ¬æ¸…æ´—
  â”œâ”€â”€ é£é™©æ£€æµ‹
  â””â”€â”€ åˆè§„éªŒè¯
  â†“
æ„å›¾åˆ†ç±»å™¨ (IntentClassifier)
  â”œâ”€â”€ è§„åˆ™å¼•æ“ (RuleEngine) - å…³é”®è¯å¿«é€ŸåŒ¹é…
  â””â”€â”€ MLåˆ†ç±»å™¨ (MLClassifier) - BERTæ¨¡å‹å¤„ç†å¤æ‚è¯­ä¹‰
  â†“
èåˆç­–ç•¥
  â”œâ”€â”€ å±æœºä¼˜å…ˆ
  â”œâ”€â”€ é«˜ç½®ä¿¡åº¦è§„åˆ™
  â””â”€â”€ æ¨¡å‹é¢„æµ‹
  â†“
æ„å›¾ç»“æœ + å“åº”å»ºè®®
```

**å…­å¤§æ„å›¾ç±»å‹**:

| æ„å›¾ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|---------|------|------|
| **emotion** | æƒ…æ„Ÿè¡¨è¾¾ | "æˆ‘å¥½éš¾è¿‡"ã€"ä»Šå¤©å¿ƒæƒ…ä¸å¥½" |
| **advice** | å¯»æ±‚å»ºè®® | "æ€ä¹ˆåŠï¼Ÿ"ã€"ä½ æœ‰ä»€ä¹ˆå»ºè®®" |
| **conversation** | æ™®é€šå¯¹è¯ | "ä»Šå¤©å¤©æ°”ä¸é”™"ã€"æˆ‘åœ¨çœ‹ä¹¦" |
| **function** | åŠŸèƒ½è¯·æ±‚ | "æé†’æˆ‘åƒè¯"ã€"è®°å½•ä»Šå¤©çš„å¿ƒæƒ…" |
| **crisis** | å±æœºå¹²é¢„ | "ä¸æƒ³æ´»äº†"ã€"æ’‘ä¸ä¸‹å»" |
| **chat** | é—²èŠ | "ä½ å¥½"ã€"åœ¨å—"ã€"æ™šä¸Šå¥½" |

---

## ä¸‰ã€MCPåè®®è¯¦è§£ (Model Context Protocol)

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦MCPï¼Ÿ

åœ¨å¤æ‚çš„ Agent ç³»ç»Ÿä¸­ï¼Œæ¨¡å—ä¹‹é—´çš„é«˜æ•ˆã€å¯é é€šä¿¡æ˜¯ç³»ç»Ÿç¨³å®šè¿è¡Œçš„å…³é”®ã€‚å¦‚æœä»…ä¾èµ–è‡ªç”±æ–‡æœ¬æˆ–å†…éƒ¨å¯¹è±¡ä¼ é€’çŠ¶æ€ï¼Œææ˜“å¯¼è‡´ä¸Šä¸‹æ–‡ä¸¢å¤±ã€è°ƒè¯•å›°éš¾ä»¥åŠæ‰©å±•æ€§å—é™ã€‚

MCP çš„å‡ºç°ï¼Œæœ¬è´¨ä¸Šæ˜¯**æç¤ºå·¥ç¨‹ï¼ˆPrompt Engineeringï¼‰å‘å±•åˆ°é«˜çº§é˜¶æ®µçš„å¿…ç„¶äº§ç‰©**ã€‚ç ”ç©¶è¡¨æ˜ï¼Œå‘æ¨¡å‹æä¾›æ›´å…·ä½“ã€ç»“æ„åŒ–çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆä¾‹å¦‚æœ¬åœ°æ–‡ä»¶ã€æ•°æ®åº“è®°å½•æˆ–å®æ—¶ç½‘ç»œæ•°æ®ï¼‰ï¼Œèƒ½æ˜¾è‘—æå‡å…¶æ¨ç†å‡†ç¡®æ€§ä¸ä»»åŠ¡å®Œæˆåº¦ã€‚

åœ¨æ²¡æœ‰ MCP çš„æ—¶ä»£ï¼Œå¼€å‘è€…å¾€å¾€éœ€è¦æ‰‹åŠ¨ä»æ•°æ®åº“ç­›é€‰ç›¸å…³ä¿¡æ¯ï¼Œå†å°†å…¶æ‹¼æ¥åˆ°æç¤ºè¯ä¸­ã€‚éšç€ä»»åŠ¡å¤æ‚åº¦ä¸Šå‡ï¼Œè¿™ç§"æ‰‹å·¥å–‚æ–™"æ–¹å¼ä¸ä»…æ•ˆç‡ä½ä¸‹ï¼Œè¿˜å®¹æ˜“å‡ºé”™ã€‚

### 3.2 Function Callingçš„å±€é™

ä¸»æµ LLM å¹³å°ï¼ˆå¦‚ OpenAIã€Googleï¼‰é™†ç»­æ¨å‡ºäº† Function Calling åŠŸèƒ½ï¼Œå…è®¸æ¨¡å‹åœ¨æ¨ç†è¿‡ç¨‹ä¸­åŠ¨æ€è°ƒç”¨é¢„å®šä¹‰å‡½æ•°ã€‚ç„¶è€Œï¼ŒFunction Calling ä»å­˜åœ¨æ˜æ˜¾å±€é™ï¼š

- **å¹³å°ç»‘å®šæ€§å¼º**ï¼šä¸åŒå‚å•†çš„å‡½æ•°è°ƒç”¨æ¥å£äº’ä¸å…¼å®¹ï¼Œåˆ‡æ¢æ¨¡å‹éœ€é‡å†™å¤§é‡ä»£ç 
- **æ‰©å±•æ€§å·®**ï¼šéš¾ä»¥æ”¯æŒå¤æ‚çš„å¤šå·¥å…·åä½œæˆ–è‡ªå®šä¹‰æ•°æ®æµ
- **å®‰å…¨æ€§ä¸å¯æ§æ€§ä¸è¶³**ï¼šæ•æ„Ÿæ•°æ®å¯èƒ½è¢«æ— æ„è¯†æš´éœ²ç»™æ¨¡å‹

### 3.3 MCPçš„æ ¸å¿ƒä¼˜åŠ¿

MCP ç”± Anthropic ç­‰æœºæ„æ¨åŠ¨ï¼Œæ—¨åœ¨å……å½“ AI æ¨¡å‹çš„"ä¸‡èƒ½è½¬æ¥å¤´"â€”â€”è®© LLM èƒ½å¤Ÿçµæ´»ã€å®‰å…¨åœ°è®¿é—®æœ¬åœ°æˆ–è¿œç¨‹å·¥å…·ï¼ŒåŒæ—¶ä¿æŒå¯¹æ•°æ®æµçš„å®Œå…¨æ§åˆ¶ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LLM æ¨¡å‹   â”‚ â†â†’  â”‚  MCP åè®®å±‚  â”‚ â†â†’  â”‚  å¤–éƒ¨å·¥å…·    â”‚
â”‚ (ä»»æ„å‚å•†)   â”‚     â”‚  (æ ‡å‡†æ¥å£)  â”‚     â”‚ (API/DBç­‰)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ ¸å¿ƒä¼˜åŠ¿ä½“ç°åœ¨ä¸‰ä¸ªæ–¹é¢ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **ç”Ÿæ€ä¸°å¯Œ** | ç¤¾åŒºå·²æä¾›å¤§é‡ç°æˆæ’ä»¶ï¼ˆå¦‚æ—¥å†ã€éŸ³é¢‘æ’­æ”¾å™¨ã€å¿ƒç†çŸ¥è¯†åº“ï¼‰ï¼Œå¯å³æ’å³ç”¨ |
| **æ¨¡å‹æ— å…³** | ä¸ä¾èµ–ç‰¹å®š LLM å¹³å°ï¼Œä»»ä½•æ”¯æŒ MCP çš„æ¨¡å‹å‡å¯æ— ç¼åˆ‡æ¢ |
| **æ•°æ®å¯æ§** | æ•æ„Ÿä¿¡æ¯æ— éœ€ä¸Šä¼ è‡³äº‘ç«¯ï¼Œå¼€å‘è€…å¯é€šè¿‡è‡ªå®šä¹‰æ¥å£ç²¾ç¡®å†³å®šä¼ è¾“å†…å®¹ |

### 3.4 æ¶ˆæ¯ç»“æ„

```json
{
    "message_id": "å”¯ä¸€æ¶ˆæ¯ID",
    "message_type": "æ¶ˆæ¯ç±»å‹",
    "content": "è‡ªç„¶è¯­è¨€å†…å®¹",
    "context": {
        "user_profile": {},
        "emotion_state": {},
        "task_goal": {},
        "memory_summary": {},
        "conversation_history": []
    },
    "tool_calls": [],
    "tool_responses": [],
    "timestamp": "æ—¶é—´æˆ³",
    "source_module": "æ¥æºæ¨¡å—",
    "target_module": "ç›®æ ‡æ¨¡å—"
}
```

### 3.5 æ¶ˆæ¯ç±»å‹

- `user_input`: ç”¨æˆ·è¾“å…¥
- `planner_output`: Plannerè§„åˆ’è¾“å‡º
- `tool_request`: å·¥å…·è¯·æ±‚
- `tool_response`: å·¥å…·å“åº”
- `agent_response`: Agentå›å¤
- `reflector_evaluation`: Reflectorè¯„ä¼°ç»“æœ

### 3.6 é€šä¿¡æµç¨‹

```
ç”¨æˆ·è¾“å…¥
    â†“
Agent Core (åˆ›å»ºuser_input MCPæ¶ˆæ¯)
    â†“
Planner (plan_with_mcp) â†’ planner_output
    â†“
Tool Caller (call_with_mcp) â†’ tool_response
    â†“
Agent Core (ç”Ÿæˆå›å¤) â†’ agent_response
    â†“
Reflector (evaluate_with_mcp) â†’ reflector_evaluation
    â†“
è¿”å›æœ€ç»ˆå›å¤
```

### 3.7 ä½¿ç”¨ç¤ºä¾‹

```python
from backend.modules.agent.core.agent.agent_core import AgentCore

agent = AgentCore()

# ä½¿ç”¨MCPåè®®å¤„ç†
mcp_response = await agent.process_with_mcp(
    user_input="æˆ‘æœ€è¿‘ç¡ä¸å¥½ï¼Œæ€ä¹ˆåŠï¼Ÿ",
    user_id="user_123"
)

# è·å–å›å¤
response = mcp_response.content
```

### 3.8 MCPä¸º"å¿ƒè¯­"å¸¦æ¥çš„ä»·å€¼

MCPåè®®çš„å¼•å…¥ä¸º"å¿ƒè¯­"Agentç³»ç»Ÿå¸¦æ¥äº†ï¼š

- æ ‡å‡†åŒ–çš„æ¨¡å—é—´é€šä¿¡
- å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¼ é€’
- å¯è¿½æº¯çš„äº¤äº’é“¾
- æ›´å¥½çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§
- ä¸ºæœªæ¥å¤šæ™ºèƒ½ä½“åä½œå¥ å®šåŸºç¡€

å¯ä»¥è¯´ï¼ŒMCP ä¸ä»…æ˜¯ä¸€ç§é€šä¿¡æ ¼å¼ï¼Œæ›´æ˜¯æ„å»ºä¸‹ä¸€ä»£æ™ºèƒ½ä½“ç³»ç»Ÿçš„åŸºç¡€è®¾æ–½ã€‚æ¯ä¸€æ¬¡å¯¹è¯ï¼Œéƒ½å°†æˆä¸ºä¸€ä»½ç»“æ„æ¸…æ™°ã€è¯­ä¹‰å®Œæ•´ã€å¯å®¡è®¡å¯å¤ç°çš„"æ•°å­—è®°å¿†"ã€‚

---

## å››ã€å®æˆ˜æ¼”ç¤ºï¼šå®Œæ•´çš„Agentå¼äº¤äº’

### 4.1 åœºæ™¯æè¿°

**ç”¨æˆ·è¾“å…¥**: "å”‰ï¼Œåˆå¤±çœ äº†ï¼Œæ„Ÿè§‰å‹åŠ›å¥½å¤§ã€‚"

### 4.2 Agentå¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ„ŸçŸ¥ä¸ç†è§£                                                 â”‚
â”‚    NLPè¯†åˆ«å…³é”®è¯ï¼šå¤±çœ ã€å‹åŠ›                                   â”‚
â”‚    è§¦å‘ï¼š"å¿ƒç†å¥åº·å¹²é¢„"æµç¨‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. è§„åˆ’å†³ç­–                                                   â”‚
â”‚    â”œâ”€ æŸ¥è¯¢è®°å¿†ï¼šè¿‡å»7å¤©æƒ…ç»ªè¯„åˆ†å¹³å‡3.2ï¼ˆæ»¡åˆ†5ï¼‰ï¼Œå‘ˆä¸‹é™è¶‹åŠ¿     â”‚
â”‚    â””â”€ åˆ¤æ–­ï¼šéœ€å¹²é¢„ï¼Œå»ºè®®"æ”¾æ¾è®­ç»ƒ + æƒ…ç»ªç–å¯¼"æ–¹æ¡ˆ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. å·¥å…·è°ƒç”¨                                                   â”‚
â”‚    â”œâ”€ play_meditation_audio("calming_music")                 â”‚
â”‚    â””â”€ set_daily_reminder("21:30", "ä»Šæ™šæ—©ç‚¹æ”¾æ¾å“¦")           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. ç”Ÿæˆå›å¤                                                   â”‚
â”‚    "å¬èµ·æ¥ä½ æœ€è¿‘çœŸçš„å¾ˆè¾›è‹¦å‘¢ã€‚æˆ‘å·²ç»ä¸ºä½ å‡†å¤‡äº†ä¸€æ®µèˆ’ç¼“éŸ³ä¹..."  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 5. åç»­è¡ŒåŠ¨                                                   â”‚
â”‚    â”œâ”€ 24å°æ—¶åè‡ªåŠ¨å›è®¿ï¼š"æ˜¨æ™šç¡å¾—æ€ä¹ˆæ ·ï¼Ÿéœ€è¦èŠèŠå—ï¼Ÿ"         â”‚
â”‚    â””â”€ è¿ç»­ä¸‰å¤©æœªæ”¹å–„ â†’ å»ºè®®ä¸“ä¸šæ­£å¿µè¯¾ç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 å®Œæ•´ä»£ç å®ç°

```python
from backend.agent import AgentCore, get_memory_hub, Planner, get_tool_caller, get_reflector

async def handle_user_message(user_input: str, user_id: str):
    """å®Œæ•´çš„Agentå¼äº¤äº’æµç¨‹"""
    
    # ========== 1. åˆå§‹åŒ–å„æ¨¡å— ==========
    agent = AgentCore()
    memory_hub = get_memory_hub()
    planner = Planner()
    tool_caller = get_tool_caller()
    reflector = get_reflector()
    
    # ========== 2. æ„ŸçŸ¥ä¸ç†è§£ ==========
    # è·å–ç”¨æˆ·ç”»åƒå’Œå†å²è®°å¿†
    user_profile = memory_hub.get_user_profile(user_id)
    relevant_memories = memory_hub.retrieve(
        query=user_input,
        user_id=user_id,
        top_k=5
    )
    
    # ========== 3. è§„åˆ’å†³ç­– ==========
    context = {
        "user_profile": user_profile,
        "memories": relevant_memories,
        "current_input": user_input
    }
    plan = await planner.plan(user_input, context)
    
    print(f"æ‰§è¡Œè®¡åˆ’: {plan}")
    # è¾“å‡ºç¤ºä¾‹:
    # {
    #     "goal": "EMOTIONAL_SUPPORT",
    #     "strategy": "EMPATHY_FIRST", 
    #     "tasks": [
    #         {"action": "analyze_emotion", "priority": 1},
    #         {"action": "play_meditation_audio", "params": {"genre": "sleep"}, "priority": 2},
    #         {"action": "set_reminder", "params": {"time": "21:30"}, "priority": 3}
    #     ]
    # }
    
    # ========== 4. å·¥å…·è°ƒç”¨ ==========
    tool_results = []
    for task in plan.get("tasks", []):
        if task.get("action") in ["play_meditation_audio", "set_reminder"]:
            result = await tool_caller.call(
                tool_name=task["action"],
                parameters=task.get("params", {})
            )
            tool_results.append(result)
            print(f"å·¥å…·è°ƒç”¨ç»“æœ: {result}")
    
    # ========== 5. ç”Ÿæˆå›å¤ ==========
    result = await agent.process(
        user_input=user_input,
        user_id=user_id
    )
    
    print(f"ç”Ÿæˆå›å¤: {result['response']}")
    # è¾“å‡º: "å¬èµ·æ¥ä½ æœ€è¿‘çœŸçš„å¾ˆè¾›è‹¦å‘¢ã€‚æˆ‘å·²ç»ä¸ºä½ å‡†å¤‡äº†ä¸€æ®µèˆ’ç¼“éŸ³ä¹ï¼Œ
    #        ç°åœ¨å°±å¯ä»¥æ’­æ”¾ã€‚å¦å¤–ï¼Œæˆ‘æ¯å¤©æ™šä¸Š9ç‚¹åŠéƒ½ä¼šæé†’ä½ æ”¾æ¾ï¼Œå¥½å—ï¼Ÿ"
    
    # ========== 6. è®°å¿†å·©å›º ==========
    new_memory = {
        "content": user_input,
        "emotion": "stressed",
        "context": "sleep_issue",
        "user_id": user_id
    }
    memory_hub.consolidate(new_memory)
    
    # ========== 7. åæ€è¯„ä¼° ==========
    interaction = {
        "user_input": user_input,
        "response": result["response"],
        "tool_calls": tool_results,
        "plan": plan
    }
    evaluation = await reflector.evaluate(interaction)
    
    print(f"åæ€è¯„ä¼°: {evaluation}")
    # è¾“å‡ºç¤ºä¾‹:
    # {
    #     "effectiveness": 0.85,
    #     "suggestions": ["å¯ä»¥è¯¢é—®ç”¨æˆ·å…·ä½“çš„å‹åŠ›æ¥æº"],
    #     "follow_up": {"delay_hours": 24, "message": "æ˜¨æ™šç¡å¾—æ€ä¹ˆæ ·ï¼Ÿ"}
    # }
    
    return result

# ä½¿ç”¨ç¤ºä¾‹
import asyncio
asyncio.run(handle_user_message(
    user_input="å”‰ï¼Œåˆå¤±çœ äº†ï¼Œæ„Ÿè§‰å‹åŠ›å¥½å¤§ã€‚",
    user_id="user_123"
))
```

### 4.4 å·¥å…·å‡½æ•°è¯¦è§£

#### 1. get_user_mood_trend - æƒ…ç»ªè¶‹åŠ¿åˆ†æ

```python
from backend.agent.tools.agent_tools import get_user_mood_trend

result = get_user_mood_trend("user_123", days=7)
# è¿”å›: {
#     "trend": [...],           # æ¯æ—¥æƒ…ç»ªæ•°æ®
#     "average_intensity": 6.5, # å¹³å‡å¼ºåº¦
#     "trend_direction": "improving",  # è¶‹åŠ¿æ–¹å‘
#     "needs_intervention": False,     # æ˜¯å¦éœ€è¦å¹²é¢„
#     "summary": "..."         # è¶‹åŠ¿æ‘˜è¦
# }
```

#### 2. play_meditation_audio - å†¥æƒ³éŸ³é¢‘æ’­æ”¾

```python
from backend.agent.tools.agent_tools import play_meditation_audio

result = play_meditation_audio("anxiety", user_id="user_123")
# genreå¯é€‰: "sleep", "anxiety", "relaxation", "breathing"
```

#### 3. set_daily_reminder - æ¯æ—¥æé†’

```python
from backend.agent.tools.agent_tools import set_daily_reminder

result = set_daily_reminder(
    time="21:30",
    message="ä»Šæ™šæ—©ç‚¹æ”¾æ¾å“¦ï¼Œè®°å¾—åšç¡å‰å†¥æƒ³",
    user_id="user_123"
)
```

#### 4. search_mental_health_resources - å¿ƒç†èµ„æºæœç´¢

```python
from backend.agent.tools.agent_tools import search_mental_health_resources

result = search_mental_health_resources("ç„¦è™‘", resource_type="article")
# resource_typeå¯é€‰: "article", "video", "exercise"
```

#### 5. send_follow_up_message - å›è®¿æ¶ˆæ¯

```python
from backend.agent.tools.agent_tools import send_follow_up_message

result = send_follow_up_message(
    user_id="user_123",
    days_ago=1,
    custom_message="ä½ å¥½ï¼Œè·ç¦»æˆ‘ä»¬ä¸Šæ¬¡èŠå¤©å·²ç»è¿‡å»1å¤©äº†ã€‚æœ€è¿‘æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ"
)
```

### 4.5 åœºæ™¯æ‰©å±•ï¼šè¿ç»­å¤±çœ çš„ä¸»åŠ¨å¹²é¢„

```python
from backend.agent.tools.agent_tools import (
    get_user_mood_trend,
    play_meditation_audio,
    set_daily_reminder,
    send_follow_up_message
)

async def proactive_sleep_intervention(user_id: str):
    """ä¸»åŠ¨å¹²é¢„ï¼šæ£€æµ‹åˆ°ç”¨æˆ·è¿ç»­å¤±çœ æ—¶è§¦å‘"""
    
    # 1. æ£€æŸ¥æƒ…ç»ªè¶‹åŠ¿
    mood_trend = get_user_mood_trend(user_id, days=7)
    print(f"æƒ…ç»ªè¶‹åŠ¿: {mood_trend['trend_direction']}")
    print(f"æ˜¯å¦éœ€è¦å¹²é¢„: {mood_trend['needs_intervention']}")
    
    if mood_trend["needs_intervention"]:
        # 2. æ’­æ”¾åŠ©çœ éŸ³é¢‘
        audio_result = play_meditation_audio("sleep", user_id)
        print(f"å·²æ’­æ”¾åŠ©çœ éŸ³é¢‘: {audio_result['audio_name']}")
        
        # 3. è®¾ç½®æ¯æ—¥æé†’
        reminder_result = set_daily_reminder(
            time="21:30",
            message="ä»Šæ™šæ—©ç‚¹æ”¾æ¾å“¦ï¼Œè®°å¾—åšç¡å‰å†¥æƒ³ ğŸŒ™",
            user_id=user_id
        )
        print(f"å·²è®¾ç½®æé†’: {reminder_result['reminder_id']}")
        
        # 4. å®‰æ’24å°æ—¶åå›è®¿
        follow_up = send_follow_up_message(
            user_id=user_id,
            days_ago=1,
            custom_message="æ˜¨æ™šç¡å¾—æ€ä¹ˆæ ·ï¼Ÿéœ€è¦èŠèŠå—ï¼Ÿ"
        )
        print(f"å·²å®‰æ’å›è®¿: {follow_up['scheduled_time']}")
        
        return {
            "intervention_triggered": True,
            "actions": ["audio", "reminder", "follow_up"]
        }
    
    return {"intervention_triggered": False}
```

### 4.6 æ•ˆæœå¯¹æ¯”

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿæœºå™¨äºº | AgentåŒ–"å¿ƒè¯­" |
|--------|-----------|---------------|
| å“åº”æ–¹å¼ | å›å¤å®‰æ…°è¯­å¥ â†’ äº¤äº’ç»“æŸ | å¯åŠ¨æœåŠ¡é—­ç¯ â†’ å»ºç«‹é•¿æœŸæ”¯æŒå…³ç³» |
| ä¸»åŠ¨æ€§ | è¢«åŠ¨ç­‰å¾…è¾“å…¥ | ä¸»åŠ¨å›è®¿ã€æé†’ |
| ä¸ªæ€§åŒ– | å›ºå®šæ¨¡æ¿å›å¤ | åŸºäºè®°å¿†çš„ä¸ªæ€§åŒ–æœåŠ¡ |
| æŒç»­æ€§ | å•æ¬¡å¯¹è¯ | é•¿æœŸé™ªä¼´ä¸è·Ÿè¸ª |

---

## äº”ã€Agentä¸RAGã€Promptçš„ååŒ

Agentä¸æ˜¯å­¤ç«‹çš„æŠ€æœ¯ï¼Œè€Œæ˜¯æ•´ä¸ªå¤§æ¨¡å‹åº”ç”¨æ¶æ„çš„"æŒ‡æŒ¥ä¸­æ¢"ã€‚

### 5.1 Agent + RAGï¼šè®©ä¸»åŠ¨æœåŠ¡"è¨€ä¹‹æœ‰æ®"

Agent åšå†³ç­–å‰ï¼Œä¼šå…ˆè®© RAG æ‰¾ä¾æ®ã€‚å½“Agentå†³å®šæä¾›å¿ƒç†å»ºè®®æ—¶ï¼Œä¸èƒ½ä»…å‡­æ¨¡å‹"æƒ³è±¡"ï¼Œè€Œåº”åŸºäºæƒå¨çŸ¥è¯†ã€‚

**ååŒæµç¨‹**:

```
ç”¨æˆ·æåŠ"ç„¦è™‘"
    â†“
Agentåˆ¤æ–­ï¼šéœ€æä¾›ç¼“è§£æ–¹æ³•
    â†“
è°ƒç”¨RAGç³»ç»Ÿï¼Œæ£€ç´¢ã€Šè®¤çŸ¥è¡Œä¸ºç–—æ³•æ‰‹å†Œã€‹ç›¸å…³å†…å®¹
    â†“
ç»“åˆæ£€ç´¢ç»“æœç”Ÿæˆå»ºè®®ï¼Œç¡®ä¿ç§‘å­¦æ€§
```

**ä¼˜åŠ¿**: é¿å…çŸ¥è¯†å¹»è§‰ï¼Œæå‡æœåŠ¡å¯ä¿¡åº¦ã€‚

### 5.2 Agent + Promptå·¥ç¨‹ï¼šå®šä¹‰"äººæ ¼åŒ–å†³ç­–é€»è¾‘"

Agentçš„è§„åˆ’ä¸åæ€è¡Œä¸ºï¼Œä¾ç„¶ä¾èµ–é«˜è´¨é‡Promptè®¾è®¡ã€‚

**å…³é”®Promptè®¾è®¡åŸåˆ™**:

| åŸåˆ™ | ç¤ºä¾‹ |
|------|------|
| è§’è‰²å¼ºåŒ– | "ä½ æ˜¯ä¸€ä½å¯Œæœ‰åŒç†å¿ƒçš„å¿ƒç†é™ªä¼´ä¸“å®¶" |
| å†³ç­–æ¡†æ¶ | "è¯·æŒ‰è¯„ä¼°â†’è§„åˆ’â†’è¡ŒåŠ¨â†’åæ€çš„æµç¨‹æ€è€ƒ" |
| å®‰å…¨çº¦æŸ | "ä¸å¾—å»ºè®®è¯ç‰©æˆ–æ›¿ä»£ä¸“ä¸šæ²»ç–—" |

**ç¤ºä¾‹Prompt**:
```
è¯·ä»¥æ¸©å’Œä½†åšå®šçš„æ–¹å¼å¼•å¯¼ç”¨æˆ·å…³æ³¨è‡ªèº«æƒ…ç»ªï¼Œé¿å…è¿‡åº¦æ‰¿è¯ºæˆ–å¼•å‘ä¾èµ–ã€‚
```

### 5.3 Agent + è®°å¿†ç³»ç»Ÿï¼šå®ç°"è¶Šç”¨è¶Šæ‡‚ä½ "

é•¿æœŸè®°å¿†è®©Agentå…·å¤‡"æˆé•¿æ€§"ï¼š

```
ç¬¬ä¸€æ¬¡å¯¹è¯ï¼šç”¨æˆ·è¯´"å–œæ¬¢çŒ«" â†’ è®°å½•åå¥½
    â†“
åç»­å¯¹è¯ï¼šç”¨æˆ·æƒ…ç»ªä½è½
    â†“
Agentä¸»åŠ¨è¯´ï¼š"è¦ä¸è¦çœ‹çœ‹å°çŒ«è§†é¢‘ï¼Ÿä¸Šæ¬¡ä½ è¯´å®ƒä»¬è®©ä½ å¼€å¿ƒã€‚"
```

è¿™ç§"ç»†èŠ‚å…³æ€€"ï¼Œæ­£æ˜¯æƒ…æ„Ÿè¿æ¥çš„æ ¸å¿ƒã€‚

### 5.4 ä¸‰è€…ååŒæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Agent Core                              â”‚
â”‚                    (æŒ‡æŒ¥ä¸­æ¢)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚              â”‚              â”‚
         â–¼              â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Prompt  â”‚   â”‚   RAG    â”‚   â”‚  Memory  â”‚
   â”‚  å·¥ç¨‹    â”‚   â”‚  æ£€ç´¢    â”‚   â”‚  ç³»ç»Ÿ    â”‚
   â”‚          â”‚   â”‚          â”‚   â”‚          â”‚
   â”‚ å®šä¹‰äººæ ¼ â”‚   â”‚ æä¾›çŸ¥è¯† â”‚   â”‚ è®°ä½ç”¨æˆ· â”‚
   â”‚ çº¦æŸè¡Œä¸º â”‚   â”‚ é¿å…å¹»è§‰ â”‚   â”‚ ä¸ªæ€§æœåŠ¡ â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€æ‰©å±•æŒ‡å—

### 6.1 æ·»åŠ æ–°å·¥å…·

```python
# 1. åœ¨ tool_caller.py ä¸­å®ç°å·¥å…·å‡½æ•°
async def _my_tool_impl(self, param1: str, param2: int) -> Dict:
    """å·¥å…·å®ç°"""
    return {"result": "success"}

# 2. æ³¨å†Œå·¥å…·
self.registry.register(
    name="my_tool",
    description="å·¥å…·æè¿°",
    function=self._my_tool_impl,
    parameters={
        "param1": {"type": "string", "required": True},
        "param2": {"type": "int", "required": False, "default": 0}
    },
    category="custom"
)
```

### 6.2 è‡ªå®šä¹‰è§„åˆ’ç­–ç•¥

åœ¨ `planner.py` çš„ `_select_strategy()` æ–¹æ³•ä¸­æ·»åŠ è‡ªå®šä¹‰é€»è¾‘ã€‚

### 6.3 æ‰©å±•è®°å¿†ç±»å‹

åœ¨ `memory_hub.py` çš„ `_infer_memory_type()` æ–¹æ³•ä¸­æ·»åŠ æ–°çš„è®°å¿†ç±»å‹åˆ¤æ–­ã€‚

### 6.4 æ„å›¾è¯†åˆ«API

```python
import requests

# åˆ†ææ„å›¾
response = requests.post(
    "http://localhost:8000/intent/analyze",
    json={
        "text": "æˆ‘æœ€è¿‘å‹åŠ›å¾ˆå¤§ï¼Œç¡ä¸å¥½è§‰",
        "user_id": "user_123"
    }
)
result = response.json()
print(f"æ„å›¾: {result['data']['intent']['intent']}")
print(f"ç½®ä¿¡åº¦: {result['data']['intent']['confidence']}")
```

---

## ä¸ƒã€ç›¸å…³æ–‡ä»¶ç´¢å¼•

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `backend/agent/agent_core.py` | Agentæ ¸å¿ƒæ§åˆ¶å™¨ |
| `backend/agent/memory_hub.py` | è®°å¿†ä¸­æ¢ |
| `backend/agent/planner.py` | ä»»åŠ¡è§„åˆ’æ¨¡å— |
| `backend/agent/tool_caller.py` | å·¥å…·è°ƒç”¨æ¨¡å— |
| `backend/agent/reflector.py` | åæ€ä¼˜åŒ–æ¨¡å— |
| `backend/agent/tools/agent_tools.py` | Agentå·¥å…·å‡½æ•° |
| `backend/modules/agent/protocol/mcp.py` | MCPåè®®å®ç° |
| `backend/modules/intent/` | æ„å›¾è¯†åˆ«æ¨¡å— |

---

---

## å…«ã€ä¸Šä¸‹æ–‡å·¥ç¨‹æœ€ä½³å®è·µ

### 8.1 ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡å·¥ç¨‹ï¼Ÿ

"æç¤ºè¯å·¥ç¨‹"ï¼ˆPrompt Engineeringï¼‰å·²ç»ä¸æ˜¯æ–°æ¦‚å¿µï¼Œä½†çœŸæ­£çš„é‡ç‚¹åœ¨äº"å·¥ç¨‹"äºŒå­—ã€‚åœ¨å®é™…ç”Ÿäº§ä¸­ï¼Œæç¤ºè¯æ˜¯åœ¨ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­**åŠ¨æ€è·å–å’Œæ‹¼æ¥**çš„ï¼Œä»¥é€‚åº”å¤æ‚åœºæ™¯ã€‚

"ä¸Šä¸‹æ–‡å·¥ç¨‹"ï¼ˆContext Engineeringï¼‰æ›´å‡†ç¡®åœ°æè¿°äº†è¿™ä¸€è¿‡ç¨‹ï¼Œå®ƒå…³æ³¨ï¼š
- ç³»ç»ŸæŒ‡ä»¤çš„åŠ¨æ€ç»„è£…
- å¯¹è¯Historyçš„ç»„è£…
- é•¿æœŸMemoryçš„å­˜å‚¨å’Œè¯»å–
- å·¥å…·è°ƒç”¨ç»“æœçš„æ•´åˆ

### 8.2 ä¸Šä¸‹æ–‡ç»„è£…ç­–ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸Šä¸‹æ–‡ç»„è£…æµç¨‹                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ System      â”‚ â† è§’è‰²å®šä¹‰ + è¡Œä¸ºçº¦æŸ + å®‰å…¨è§„åˆ™       â”‚
â”‚  â”‚ Instruction â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚         â†“                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ User        â”‚ â† ç”¨æˆ·ç”»åƒ + åå¥½è®¾ç½® + å†å²æ‘˜è¦       â”‚
â”‚  â”‚ Context     â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚         â†“                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ Memory      â”‚ â† ç›¸å…³è®°å¿†æ£€ç´¢ + é‡è¦äº‹ä»¶ + æƒ…æ„Ÿæ ‡ç­¾   â”‚
â”‚  â”‚ Injection   â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚         â†“                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ Dialogue    â”‚ â† æœ€è¿‘Nè½®å¯¹è¯ + æ—©æœŸå¯¹è¯æ‘˜è¦           â”‚
â”‚  â”‚ History     â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚         â†“                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚ Current     â”‚ â† å½“å‰ç”¨æˆ·è¾“å…¥ + æ„å›¾åˆ†æç»“æœ          â”‚
â”‚  â”‚ Query       â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 Historyç®¡ç†ç­–ç•¥

```python
class HistoryManager:
    """å¯¹è¯å†å²ç®¡ç†å™¨"""
    
    def __init__(self, max_recent_turns=5, max_tokens=2000):
        self.max_recent_turns = max_recent_turns
        self.max_tokens = max_tokens
    
    def build_history(self, full_history: List[Dict]) -> List[Dict]:
        """æ„å»ºä¼˜åŒ–åçš„å†å²ä¸Šä¸‹æ–‡"""
        if len(full_history) <= self.max_recent_turns:
            return full_history
        
        # æ—©æœŸå¯¹è¯å‹ç¼©ä¸ºæ‘˜è¦
        early_history = full_history[:-self.max_recent_turns]
        summary = self._summarize(early_history)
        
        # ä¿ç•™æœ€è¿‘Nè½®å®Œæ•´å¯¹è¯
        recent_history = full_history[-self.max_recent_turns:]
        
        return [{"role": "system", "content": f"æ—©æœŸå¯¹è¯æ‘˜è¦ï¼š{summary}"}] + recent_history
    
    def _summarize(self, history: List[Dict]) -> str:
        """å‹ç¼©æ—©æœŸå¯¹è¯ä¸ºæ‘˜è¦"""
        # æå–å…³é”®ä¿¡æ¯ï¼šç”¨æˆ·å…³å¿ƒçš„é—®é¢˜ã€è¾¾æˆçš„å…±è¯†ã€æœªè§£å†³çš„äº‹é¡¹
        pass
```

### 8.4 åŠ¨æ€ä¸Šä¸‹æ–‡æ³¨å…¥

```python
async def assemble_context(user_input: str, user_id: str) -> Dict:
    """åŠ¨æ€ç»„è£…ä¸Šä¸‹æ–‡"""
    
    # 1. è·å–ç”¨æˆ·ç”»åƒ
    user_profile = await memory_hub.get_user_profile(user_id)
    
    # 2. æ£€ç´¢ç›¸å…³è®°å¿†ï¼ˆåŸºäºå½“å‰è¾“å…¥ï¼‰
    relevant_memories = await memory_hub.retrieve(
        query=user_input,
        user_id=user_id,
        top_k=3
    )
    
    # 3. è·å–å¯¹è¯å†å²ï¼ˆå‹ç¼©åï¼‰
    history = await history_manager.build_history(
        await get_conversation_history(user_id)
    )
    
    # 4. æ„å›¾åˆ†æ
    intent = await intent_classifier.classify(user_input)
    
    # 5. æ ¹æ®æ„å›¾åŠ¨æ€é€‰æ‹©æ³¨å…¥å†…å®¹
    context_injection = await select_context_by_intent(intent, user_profile)
    
    return {
        "user_profile": user_profile,
        "memories": relevant_memories,
        "history": history,
        "intent": intent,
        "injection": context_injection
    }
```

---

**ç‰ˆæœ¬**: v2.0.0  
**æœ€åæ›´æ–°**: 2025-11-27  
**æ›´æ–°å†…å®¹**: æ–°å¢Agentä¼˜åŒ–åå¤§å®æˆ˜ç»éªŒã€ä¸Šä¸‹æ–‡å·¥ç¨‹æœ€ä½³å®è·µç« èŠ‚

