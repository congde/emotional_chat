# ç¬¬14ç« ï¼šæƒ…æ„Ÿåˆ†æé›†æˆ - ä»£ç å®ç°ä¸é›†æˆæŒ‡å—

## ä¸‰ã€é›†æˆè·¯å¾„ï¼šå°†æƒ…æ„Ÿåˆ†æåµŒå…¥"å¿ƒè¯­"å¯¹è¯æµç¨‹

åŸºäºç°æœ‰çš„æ¶æ„ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†å®Œæ•´çš„æƒ…æ„Ÿåˆ†æé›†æˆæ–¹æ¡ˆã€‚ä»¥ä¸‹æ˜¯è¯¦ç»†çš„å®ç°æ­¥éª¤å’Œä»£ç ç¤ºä¾‹ã€‚

### 3.1 æ­¥éª¤1ï¼šé€‰æ‹©åˆé€‚çš„æƒ…æ„Ÿåˆ†æå·¥å…·

æˆ‘ä»¬å®ç°äº†**å¤šå±‚çº§çš„æƒ…æ„Ÿåˆ†ææ–¹æ¡ˆ**ï¼Œæ”¯æŒï¼š

1. **æ·±åº¦å­¦ä¹ æ¨¡å‹**ï¼ˆæ¨èï¼‰ï¼šä½¿ç”¨Hugging Face Transformers
2. **å…³é”®è¯åŒ¹é…**ï¼ˆå¤‡é€‰ï¼‰ï¼šåŸºäºè§„åˆ™çš„å¿«é€Ÿåˆ†æ
3. **æ··åˆæ¨¡å¼**ï¼šè‡ªåŠ¨é™çº§ï¼Œä¿è¯é²æ£’æ€§

#### å®‰è£…ä¾èµ–

```bash
# å®‰è£…Transformersåº“ï¼ˆå¯é€‰ï¼Œæ¨èï¼‰
pip install transformers torch

# å¦‚æœä¸å®‰è£…ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨å…³é”®è¯åˆ†æ
```

#### ä»£ç å®ç°

æˆ‘ä»¬å·²ç»åˆ›å»ºäº† `backend/services/advanced_sentiment_analyzer.py`ï¼Œæ ¸å¿ƒç‰¹æ€§åŒ…æ‹¬ï¼š

```python
from backend.services.advanced_sentiment_analyzer import AdvancedSentimentAnalyzer

# åˆå§‹åŒ–åˆ†æå™¨ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹æ³•ï¼‰
analyzer = AdvancedSentimentAnalyzer(use_transformers=True)

# åˆ†æç”¨æˆ·æ¶ˆæ¯
result = analyzer.analyze(
    text="ä»Šå¤©å¥½ç´¯å•Šï¼Œå·¥ä½œå‹åŠ›å¤ªå¤§äº†",
    user_id="user_123"  # å¯é€‰ï¼Œç”¨äºè¶‹åŠ¿åˆ†æ
)

print(result)
# è¾“å‡ºï¼š
# {
#     "emotion": "sad",           # æƒ…ç»ªç±»å‹
#     "confidence": 0.876,        # ç½®ä¿¡åº¦
#     "intensity": 7.2,           # å¼ºåº¦(0-10)
#     "polarity": -1,             # ææ€§(-1/0/1)
#     "emotion_scores": {...},    # å¤šç»´åº¦å¾—åˆ†
#     "keywords": ["ç´¯", "å‹åŠ›"],
#     "suggestions": ["æˆ‘ç†è§£ä½ ç°åœ¨çš„å¿ƒæƒ…..."],
#     "method": "transformers"    # ä½¿ç”¨çš„æ–¹æ³•
# }
```

### 3.2 æ­¥éª¤2ï¼šè®¾è®¡æƒ…æ„Ÿåˆ†æä¸­é—´ä»¶

æƒ…æ„Ÿåˆ†æå™¨å·²ç»é›†æˆåˆ°å¯¹è¯æµç¨‹ä¸­ï¼Œæ”¯æŒï¼š

1. **å®æ—¶æƒ…æ„Ÿåˆ†æ**ï¼šæ¯æ¡æ¶ˆæ¯è‡ªåŠ¨åˆ†æ
2. **æƒ…æ„Ÿå†å²ç¼“å­˜**ï¼šè‡ªåŠ¨ä¿å­˜æœ€è¿‘100æ¡æƒ…ç»ªè®°å½•
3. **è¶‹åŠ¿åˆ†æ**ï¼šå®æ—¶è®¡ç®—æƒ…ç»ªè¶‹åŠ¿

#### æ ¸å¿ƒä»£ç ä½ç½®

- **é«˜çº§æƒ…æ„Ÿåˆ†æå™¨**ï¼š`backend/services/advanced_sentiment_analyzer.py`
- **è¶‹åŠ¿åˆ†æå™¨**ï¼š`backend/services/emotion_trend_analyzer.py`
- **é›†æˆç¤ºä¾‹**ï¼š`backend/services/sentiment_integration_example.py`

### 3.3 æ­¥éª¤3ï¼šåœ¨å¯¹è¯æµç¨‹ä¸­è°ƒç”¨æƒ…æ„Ÿåˆ†æ

#### æ–¹å¼ä¸€ï¼šåœ¨ç°æœ‰ ChatService ä¸­é›†æˆ

åœ¨ `backend/services/chat_service.py` ä¸­ï¼Œæƒ…æ„Ÿåˆ†æå·²ç»åœ¨ç¬¬178è¡Œè°ƒç”¨ï¼š

```python
# ç°æœ‰ä»£ç ï¼ˆç¬¬178è¡Œï¼‰
emotion_result = self.chat_engine.analyze_emotion(message)
emotion = emotion_result.get("emotion", "neutral")
emotion_intensity = emotion_result.get("intensity", 5.0)
```

**å‡çº§æ–¹æ¡ˆ**ï¼šæ›¿æ¢ä¸ºé«˜çº§æƒ…æ„Ÿåˆ†æå™¨

```python
from backend.services.advanced_sentiment_analyzer import get_analyzer

# åœ¨ ChatService.__init__ ä¸­åˆå§‹åŒ–
self.advanced_sentiment = get_analyzer(use_transformers=True)

# åœ¨ _chat_with_memory æ–¹æ³•ä¸­ä½¿ç”¨ï¼ˆæ›¿æ¢ç¬¬178-180è¡Œï¼‰
sentiment_result = self.advanced_sentiment.analyze(message, user_id)
emotion = sentiment_result["emotion"]
emotion_intensity = sentiment_result["intensity"]

# å¯é€‰ï¼šæ£€æŸ¥æƒ…ç»ªè¶‹åŠ¿
emotion_trend = self.advanced_sentiment.get_emotion_trend(user_id, window=10)
if emotion_trend.get('warning'):
    # è§¦å‘é£é™©é¢„è­¦æœºåˆ¶
    logger.warning(f"âš ï¸ ç”¨æˆ· {user_id} æƒ…ç»ªé¢„è­¦: {emotion_trend['warning']}")
```

#### æ–¹å¼äºŒï¼šä½¿ç”¨é›†æˆæœåŠ¡ï¼ˆæ¨èï¼‰

ä½¿ç”¨æˆ‘ä»¬æä¾›çš„ `SentimentIntegratedChatService` ä½œä¸ºå‚è€ƒï¼š

```python
from backend.services.sentiment_integration_example import SentimentIntegratedChatService

# åˆå§‹åŒ–é›†æˆæœåŠ¡
sentiment_service = SentimentIntegratedChatService(use_transformers=True)

# å¤„ç†æ¶ˆæ¯ï¼ˆåŒ…å«å®Œæ•´çš„æƒ…æ„Ÿåˆ†ææµç¨‹ï¼‰
result = sentiment_service.process_message_with_sentiment(
    user_message="ä»Šå¤©å¿ƒæƒ…ä¸å¥½",
    user_id="user_123",
    session_id="session_456",
    check_trend=True
)

# result åŒ…å«ï¼š
# - enhanced_prompt: æƒ…ç»ªæ„ŸçŸ¥çš„Prompt
# - sentiment: è¯¦ç»†çš„æƒ…æ„Ÿåˆ†æç»“æœ
# - trend: æƒ…ç»ªè¶‹åŠ¿ï¼ˆå¦‚æœå¯ç”¨ï¼‰
# - high_risk_detected: æ˜¯å¦æ£€æµ‹åˆ°é«˜é£é™©
# - risk_response: å±æœºå“åº”ï¼ˆå¦‚æœæœ‰ï¼‰
```

### 3.4 æ­¥éª¤4ï¼šåŸºäºæƒ…ç»ªåŠ¨æ€è°ƒæ•´Prompt

é«˜çº§æƒ…æ„Ÿåˆ†æå™¨å†…ç½®äº† `build_emotion_aware_prompt` æ–¹æ³•ï¼š

```python
# è·å–æƒ…æ„Ÿåˆ†æç»“æœ
sentiment_result = analyzer.analyze(user_message, user_id)

# æ„å»ºæƒ…ç»ªæ„ŸçŸ¥Prompt
base_prompt = "ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€è€å¿ƒçš„å¿ƒç†å¥åº·é™ªä¼´è€…ï¼Œåå«'å¿ƒè¯­'ã€‚"
enhanced_prompt = analyzer.build_emotion_aware_prompt(sentiment_result, base_prompt)

print(enhanced_prompt)
```

**ç¤ºä¾‹è¾“å‡º**ï¼ˆå½“ç”¨æˆ·éå¸¸æ‚²ä¼¤æ—¶ï¼‰ï¼š

```
ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€è€å¿ƒçš„å¿ƒç†å¥åº·é™ªä¼´è€…ï¼Œåå«'å¿ƒè¯­'ã€‚

ç”¨æˆ·å½“å‰æƒ…ç»ªéå¸¸ä½è½ï¼ˆå¼ºåº¦8.5/10ï¼‰ã€‚è¯·ç”¨æ¸©å’Œã€æ¥çº³çš„è¯­æ°”å›åº”ï¼Œ
é¿å…è¯´æ•™ã€‚ä¼˜å…ˆè¡¨è¾¾ç†è§£ä¸é™ªä¼´ï¼Œä¸è¦æ€¥äºç»™å‡ºå»ºè®®ã€‚ä½¿ç”¨çŸ­å¥ï¼Œè¯­é€Ÿæ”¾æ…¢ã€‚
```

### 3.5 å®Œæ•´é›†æˆæµç¨‹å›¾

```
ç”¨æˆ·è¾“å…¥
   â†“
[1] å®æ—¶æƒ…æ„Ÿåˆ†æ (AdvancedSentimentAnalyzer)
   â†“
   â”œâ”€ æƒ…ç»ªç±»å‹: happy/sad/angry/anxious...
   â”œâ”€ å¼ºåº¦: 0-10
   â”œâ”€ ç½®ä¿¡åº¦: 0-1
   â””â”€ å¤šç»´åº¦å¾—åˆ†
   â†“
[2] æƒ…ç»ªè¶‹åŠ¿æ£€æŸ¥ (å¯é€‰)
   â†“
   â”œâ”€ è·å–æœ€è¿‘10æ¡æƒ…ç»ªè®°å½•
   â”œâ”€ è®¡ç®—è¶‹åŠ¿: improving/declining/stable
   â””â”€ é£é™©é¢„è­¦: high_risk/declining_mood/None
   â†“
[3] åŠ¨æ€Promptæ„å»º
   â†“
   â””â”€ æ ¹æ®æƒ…ç»ªç±»å‹+å¼ºåº¦è°ƒæ•´è¯­æ°”ã€å†…å®¹ã€ç­–ç•¥
   â†“
[4] é£é™©æ£€æµ‹
   â†“
   â”œâ”€ é«˜å¼ºåº¦è´Ÿé¢æƒ…ç»ª?
   â”œâ”€ è¶‹åŠ¿é¢„è­¦?
   â””â”€ å±æœºå…³é”®è¯?
   â†“
   YES â†’ [5a] è§¦å‘å±æœºå“åº”
   NO  â†’ [5b] å¸¸è§„å›å¤ç”Ÿæˆ
   â†“
[6] ä¿å­˜æƒ…æ„Ÿæ•°æ®åˆ°æ•°æ®åº“
   â†“
[7] æ›´æ–°æƒ…æ„Ÿå†å²ç¼“å­˜ï¼ˆç”¨äºè¶‹åŠ¿åˆ†æï¼‰
   â†“
è¿”å›AIå›å¤
```

### 3.6 æ•°æ®åº“å­˜å‚¨

æƒ…æ„Ÿæ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆå·²æœ‰è¡¨ç»“æ„ï¼‰ï¼š

```sql
-- æ•°æ®åº“è¡¨ï¼šemotion_analysis
CREATE TABLE emotion_analysis (
    id INT PRIMARY KEY AUTO_INCREMENT,
    session_id VARCHAR(100),
    user_id VARCHAR(100),
    message_id INT,
    emotion VARCHAR(50),          -- æƒ…ç»ªç±»å‹
    intensity FLOAT,              -- å¼ºåº¦
    keywords TEXT,                -- JSONæ ¼å¼å…³é”®è¯
    suggestions TEXT,             -- JSONæ ¼å¼å»ºè®®
    created_at DATETIME
);
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ä¿å­˜æ¯æ¬¡åˆ†æçš„ç»“æœï¼Œç”¨äºï¼š
- å†å²å›é¡¾
- è¶‹åŠ¿åˆ†æ
- æ•°æ®å¯è§†åŒ–
- æ¨¡å‹ä¼˜åŒ–

---

## å››ã€é«˜çº§åº”ç”¨ï¼šä»ææ€§è¯†åˆ«åˆ°å¤šç»´åº¦æƒ…ç»ªå»ºæ¨¡

### 4.1 ç»†ç²’åº¦æƒ…ç»ªè¯†åˆ«

æˆ‘ä»¬æ”¯æŒ **10ç§ç»†åˆ†æƒ…ç»ª**ï¼š

| æƒ…ç»ªç±»å‹ | è‹±æ–‡ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|
| å¼€å¿ƒ | happy | æ­£é¢æƒ…ç»ª |
| æ‚²ä¼¤ | sad | è´Ÿé¢æƒ…ç»ªï¼Œéœ€è¦æ”¯æŒ |
| æ„¤æ€’ | angry | è´Ÿé¢æƒ…ç»ªï¼Œéœ€è¦æ¥çº³ |
| ç„¦è™‘ | anxious | è´Ÿé¢æƒ…ç»ªï¼Œéœ€è¦å¹³é™å¼•å¯¼ |
| å…´å¥‹ | excited | æ­£é¢æƒ…ç»ªï¼Œé«˜èƒ½é‡ |
| å›°æƒ‘ | confused | ä¸­æ€§åè´Ÿï¼Œéœ€è¦æ¾„æ¸… |
| æ²®ä¸§ | frustrated | è´Ÿé¢æƒ…ç»ªï¼Œéœ€è¦æ–°è§†è§’ |
| å­¤ç‹¬ | lonely | è´Ÿé¢æƒ…ç»ªï¼Œéœ€è¦é™ªä¼´ |
| æ„Ÿæ© | grateful | æ­£é¢æƒ…ç»ªï¼Œæ·±åŒ–è¿æ¥ |
| å¹³é™ | neutral | ä¸­æ€§æƒ…ç»ª |

#### ä»£ç ç¤ºä¾‹ï¼šç»†ç²’åº¦è¯†åˆ«

```python
analyzer = AdvancedSentimentAnalyzer(use_transformers=True)

# åˆ†ææ—¶ä¼šè‡ªåŠ¨è¿”å›å¤šç»´åº¦å¾—åˆ†
result = analyzer.analyze("ä»Šå¤©å¥½ç´¯å•Šï¼Œå·¥ä½œå‹åŠ›å¤ªå¤§äº†")

print(result["emotion"])           # ä¸»å¯¼æƒ…ç»ª: "sad"
print(result["emotion_scores"])    # æ‰€æœ‰æƒ…ç»ªå¾—åˆ†
# è¾“å‡ºï¼š
# {
#     "sad": 0.65,
#     "anxious": 0.20,
#     "frustrated": 0.10,
#     "neutral": 0.05
# }
```

### 4.2 æƒ…ç»ªè¶‹åŠ¿åˆ†æ

ä½¿ç”¨ `EmotionTrendAnalyzer` è¿›è¡Œæ·±åº¦è¶‹åŠ¿åˆ†æï¼š

```python
from backend.services.emotion_trend_analyzer import EmotionTrendAnalyzer

analyzer = EmotionTrendAnalyzer()

# åˆ†æç”¨æˆ·æœ€è¿‘7å¤©çš„æƒ…ç»ªè¶‹åŠ¿
trend = analyzer.analyze_user_emotion_trend(
    user_id="user_123",
    days=7,
    include_visualization_data=True
)

print(f"ä¸»å¯¼æƒ…ç»ª: {trend['dominant_emotion']}")
print(f"å¹³å‡å¼ºåº¦: {trend['average_intensity']}")
print(f"è¶‹åŠ¿æ–¹å‘: {trend['trend']['trend']}")
print(f"é£é™©ç­‰çº§: {trend['risk_assessment']['level']}")

# æƒ…ç»ªåˆ†å¸ƒ
for emotion, ratio in trend['emotion_distribution'].items():
    print(f"  {emotion}: {ratio*100:.1f}%")

# å¯è§†åŒ–æ•°æ®ï¼ˆå¯ç›´æ¥ç”¨äºå‰ç«¯å›¾è¡¨ï¼‰
viz_data = trend['visualization_data']
print(f"æ—¶é—´çº¿æ•°æ®ç‚¹: {len(viz_data['timeline'])} æ¡")
print(f"é¥¼å›¾æ•°æ®: {viz_data['pie_chart']}")
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
ä¸»å¯¼æƒ…ç»ª: sad
å¹³å‡å¼ºåº¦: 6.8
è¶‹åŠ¿æ–¹å‘: declining
é£é™©ç­‰çº§: moderate

æƒ…ç»ªåˆ†å¸ƒ:
  sad: 45.0%
  anxious: 30.0%
  neutral: 15.0%
  frustrated: 10.0%

æ—¶é—´çº¿æ•°æ®ç‚¹: 20 æ¡
é¥¼å›¾æ•°æ®: [
    {"emotion": "sad", "count": 9, "percentage": 45.0},
    {"emotion": "anxious", "count": 6, "percentage": 30.0},
    ...
]
```

### 4.3 å¤šç»´åº¦æƒ…ç»ªå»ºæ¨¡

ç”Ÿæˆç”¨æˆ·çš„**æƒ…ç»ªç”»åƒ**ï¼ŒåŒ…å«6ä¸ªç»´åº¦ï¼š

```python
# è·å–å¤šç»´åº¦æƒ…ç»ªç”»åƒ
profile = analyzer.get_multi_dimensional_emotion_profile(
    user_id="user_123",
    days=30
)

print(f"æ•´ä½“å¹¸ç¦æ„Ÿå¾—åˆ†: {profile['overall_wellbeing_score']}")

# 6ä¸ªç»´åº¦
dimensions = profile['dimensions']
print(f"\næƒ…ç»ªç¨³å®šæ€§: {dimensions['stability']['score']} - {dimensions['stability']['level']}")
print(f"ç§¯ææ€§æŒ‡æ•°: {dimensions['positivity']['score']} - {dimensions['positivity']['level']}")
print(f"å‹åŠ›æŒ‡æ•°: {dimensions['stress']['score']} - {dimensions['stress']['level']}")
print(f"ç¤¾äº¤è¿æ¥: {dimensions['social_connectedness']['score']} - {dimensions['social_connectedness']['level']}")
print(f"æƒ…ç»ªå¼¹æ€§: {dimensions['resilience']['score']} - {dimensions['resilience']['level']}")
print(f"æƒ…ç»ªå¤æ‚åº¦: {dimensions['complexity']['unique_emotions']} ç§")

# å…³é”®ç‰¹å¾
print(f"\nå…³é”®ç‰¹å¾: {', '.join(profile['key_characteristics'])}")
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```
æ•´ä½“å¹¸ç¦æ„Ÿå¾—åˆ†: 0.58

æƒ…ç»ªç¨³å®šæ€§: 0.65 - ä¸­
ç§¯ææ€§æŒ‡æ•°: 0.35 - ä¸­
å‹åŠ›æŒ‡æ•°: 0.45 - é«˜
ç¤¾äº¤è¿æ¥: 0.55 - ä¸­
æƒ…ç»ªå¼¹æ€§: 0.70 - é«˜
æƒ…ç»ªå¤æ‚åº¦: 6 ç§

å…³é”®ç‰¹å¾: å‹åŠ›è¾ƒé«˜, æƒ…ç»ªæ¢å¤èƒ½åŠ›å¼º
```

### 4.4 æƒ…æ„ŸåŒ¹é…ä¼˜åŒ–

æ ¹æ®æƒ…ç»ªçŠ¶æ€åŠ¨æ€è°ƒæ•´AIçš„å›å¤ç­–ç•¥ï¼š

```python
# æƒ…ç»ª â†’ å›å¤ç­–ç•¥æ˜ å°„
EMOTION_STRATEGIES = {
    "sad": {
        "tone": "æ¸©æŸ”ã€ç¼“æ…¢ã€åŒ…å®¹",
        "length": "çŸ­å¥ä¸ºä¸»",
        "avoid": ["æŒ¯ä½œèµ·æ¥", "æƒ³å¼€ç‚¹"],
        "emphasize": ["æˆ‘ç†è§£", "æˆ‘åœ¨è¿™é‡Œ"]
    },
    "anxious": {
        "tone": "å¹³é™ã€ç¨³å®šã€å®‰æŠš",
        "length": "é€‚ä¸­ï¼Œåˆ†æ­¥éª¤",
        "avoid": ["ä¸ç”¨ç´§å¼ ", "æ”¾æ¾ç‚¹"],
        "emphasize": ["æ…¢æ…¢æ¥", "ä¸€æ­¥æ­¥æ¥"]
    },
    "happy": {
        "tone": "æ¬¢å¿«ã€é¼“åŠ±",
        "length": "å¯ä»¥ç¨é•¿",
        "avoid": ["åˆ«é«˜å…´å¤ªæ—©"],
        "emphasize": ["å¤ªå¥½äº†", "æ­å–œ"]
    }
}

# åº”ç”¨ç­–ç•¥ï¼ˆåœ¨enhanced_promptä¸­è‡ªåŠ¨å¤„ç†ï¼‰
enhanced_prompt = analyzer.build_emotion_aware_prompt(sentiment_result, base_prompt)
```

### 4.5 é£é™©é¢„è­¦ä¸å¹²é¢„

**ä¸‰çº§é¢„è­¦æœºåˆ¶**ï¼š

```python
# åœ¨æƒ…æ„Ÿåˆ†ææ—¶è‡ªåŠ¨è¯„ä¼°é£é™©
trend = analyzer.get_emotion_trend(user_id, window=10)

if trend['warning'] == 'high_risk':
    # ğŸ”´ çº¢è‰²é¢„è­¦ï¼šç«‹å³å¹²é¢„
    response = """æˆ‘éå¸¸å…³å¿ƒä½ ç°åœ¨çš„çŠ¶æ€ã€‚å»ºè®®ç«‹å³è”ç³»ï¼š
    - å¸Œæœ›24çƒ­çº¿ï¼š400-161-9995ï¼ˆ24å°æ—¶ï¼‰
    - åŒ—äº¬å¿ƒç†å±æœºå¹²é¢„ä¸­å¿ƒï¼š010-82951332
    ä½ ä¸æ˜¯ä¸€ä¸ªäººï¼Œæˆ‘ä»¬éƒ½åœ¨è¿™é‡Œã€‚"""
    
elif trend['warning'] == 'declining_mood':
    # ğŸŸ¡ é»„è‰²é¢„è­¦ï¼šå¯†åˆ‡å…³æ³¨
    response = "æˆ‘æ³¨æ„åˆ°ä½ æœ€è¿‘æƒ…ç»ªæœ‰äº›ä½è½ï¼Œéœ€è¦å¤šèŠèŠå—ï¼Ÿ"
    
else:
    # ğŸŸ¢ ç»¿è‰²ï¼šæ­£å¸¸å¯¹è¯
    response = generate_normal_response(...)
```

### 4.6 å¯è§†åŒ–æ•°æ®ç”Ÿæˆ

è¶‹åŠ¿åˆ†æå™¨è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–æ•°æ®ï¼Œå¯ç›´æ¥ç”¨äºå‰ç«¯ï¼š

```python
trend = analyzer.analyze_user_emotion_trend(
    user_id="user_123",
    days=7,
    include_visualization_data=True
)

viz_data = trend['visualization_data']

# 1. æ—¶é—´åºåˆ—å›¾æ•°æ®
timeline = viz_data['timeline']
# [
#     {"timestamp": "2025-01-10T10:00:00", "emotion": "sad", "intensity": 7.5},
#     {"timestamp": "2025-01-10T14:30:00", "emotion": "anxious", "intensity": 6.0},
#     ...
# ]

# 2. é¥¼å›¾æ•°æ®ï¼ˆæƒ…ç»ªåˆ†å¸ƒï¼‰
pie_chart = viz_data['pie_chart']
# [
#     {"emotion": "sad", "count": 15, "percentage": 45.5},
#     {"emotion": "anxious", "count": 10, "percentage": 30.3},
#     ...
# ]

# 3. æŸ±çŠ¶å›¾æ•°æ®ï¼ˆæ¯æ—¥å¹³å‡å¼ºåº¦ï¼‰
bar_chart = viz_data['bar_chart']
# [
#     {"date": "2025-01-10", "average_intensity": 6.8, "count": 5},
#     {"date": "2025-01-11", "average_intensity": 7.2, "count": 3},
#     ...
# ]

# 4. çƒ­åŠ›å›¾æ•°æ®ï¼ˆæƒ…ç»ªè½¬æ¢çŸ©é˜µï¼‰
heatmap = viz_data['heatmap']
# [
#     {"from": "sad", "to": "anxious", "count": 5},
#     {"from": "anxious", "to": "neutral", "count": 3},
#     ...
# ]
```

**å‰ç«¯é›†æˆç¤ºä¾‹**ï¼ˆReact + Chart.jsï¼‰ï¼š

```javascript
// åœ¨å‰ç«¯ä½¿ç”¨è¿™äº›æ•°æ®
import { Line, Pie, Bar } from 'react-chartjs-2';

// æ—¶é—´åºåˆ—å›¾
<Line data={{
    labels: viz_data.timeline.map(d => d.timestamp),
    datasets: [{
        label: 'æƒ…ç»ªå¼ºåº¦',
        data: viz_data.timeline.map(d => d.intensity)
    }]
}} />

// æƒ…ç»ªåˆ†å¸ƒé¥¼å›¾
<Pie data={{
    labels: viz_data.pie_chart.map(d => d.emotion),
    datasets: [{
        data: viz_data.pie_chart.map(d => d.count)
    }]
}} />
```

---

## äº”ã€å®é™…ä½¿ç”¨æŒ‡å—

### 5.1 å¿«é€Ÿå¼€å§‹

**æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼**ï¼š

```python
from backend.services.advanced_sentiment_analyzer import get_analyzer

# è·å–å…¨å±€åˆ†æå™¨å®ä¾‹ï¼ˆå•ä¾‹æ¨¡å¼ï¼‰
analyzer = get_analyzer(use_transformers=True)

# åˆ†æç”¨æˆ·æ¶ˆæ¯
result = analyzer.analyze("ä»Šå¤©å¥½ç´¯å•Š", user_id="user_123")

# ä½¿ç”¨ç»“æœ
emotion = result['emotion']
intensity = result['intensity']
suggestions = result['suggestions']
```

### 5.2 åœ¨ChatServiceä¸­é›†æˆ

**ä¿®æ”¹ `backend/services/chat_service.py`**ï¼š

åœ¨ `__init__` æ–¹æ³•ä¸­æ·»åŠ ï¼š

```python
from backend.services.advanced_sentiment_analyzer import get_analyzer

self.advanced_sentiment = get_analyzer(use_transformers=True)
```

åœ¨ `_chat_with_memory` æ–¹æ³•ä¸­æ›¿æ¢ï¼ˆç¬¬178-180è¡Œï¼‰ï¼š

```python
# åŸä»£ç ï¼š
# emotion_result = self.chat_engine.analyze_emotion(message)
# emotion = emotion_result.get("emotion", "neutral")
# emotion_intensity = emotion_result.get("intensity", 5.0)

# æ–°ä»£ç ï¼š
sentiment_result = self.advanced_sentiment.analyze(message, user_id)
emotion = sentiment_result["emotion"]
emotion_intensity = sentiment_result["intensity"]

# å¯é€‰ï¼šæ£€æŸ¥è¶‹åŠ¿
emotion_trend = self.advanced_sentiment.get_emotion_trend(user_id, window=10)
if emotion_trend.get('warning'):
    logger.warning(f"âš ï¸ ç”¨æˆ· {user_id} æƒ…ç»ªé¢„è­¦: {emotion_trend['warning']}")
```

### 5.3 æ·»åŠ æƒ…ç»ªæŠ¥å‘ŠAPIç«¯ç‚¹

åœ¨ `backend/routers/chat.py` ä¸­æ·»åŠ æ–°ç«¯ç‚¹ï¼š

```python
from backend.services.emotion_trend_analyzer import EmotionTrendAnalyzer

@router.get("/emotion_report/{user_id}")
async def get_emotion_report(user_id: str, days: int = 7):
    """è·å–ç”¨æˆ·æƒ…ç»ªæŠ¥å‘Š"""
    analyzer = EmotionTrendAnalyzer()
    
    # åŸºç¡€è¶‹åŠ¿åˆ†æ
    trend = analyzer.analyze_user_emotion_trend(user_id, days, include_visualization_data=True)
    
    # å¤šç»´åº¦ç”»åƒ
    profile = analyzer.get_multi_dimensional_emotion_profile(user_id, days)
    
    return {
        "user_id": user_id,
        "trend_analysis": trend,
        "emotion_profile": profile
    }
```

### 5.4 é…ç½®é€‰é¡¹

åœ¨ `config.env` ä¸­æ·»åŠ ï¼š

```bash
# æƒ…æ„Ÿåˆ†æé…ç½®
USE_TRANSFORMERS_SENTIMENT=true  # æ˜¯å¦ä½¿ç”¨Transformersæ¨¡å‹
SENTIMENT_CACHE_SIZE=100         # æƒ…æ„Ÿå†å²ç¼“å­˜å¤§å°
EMOTION_TREND_WINDOW=10          # è¶‹åŠ¿åˆ†æçª—å£
ENABLE_RISK_WARNING=true         # æ˜¯å¦å¯ç”¨é£é™©é¢„è­¦
```

---

## å…­ã€æ€§èƒ½ä¸ä¼˜åŒ–

### 6.1 æ€§èƒ½å¯¹æ¯”

| æ–¹æ³• | å»¶è¿Ÿ | å‡†ç¡®ç‡ | èµ„æºå ç”¨ | æ¨èåœºæ™¯ |
|-----|------|--------|---------|---------|
| Transformers | ~200ms | 85-90% | ä¸­ | ç”Ÿäº§ç¯å¢ƒï¼Œå¯¹å‡†ç¡®æ€§è¦æ±‚é«˜ |
| å…³é”®è¯åŒ¹é… | ~10ms | 65-75% | ä½ | å®æ—¶åœºæ™¯ï¼Œå¯¹å»¶è¿Ÿæ•æ„Ÿ |
| æ··åˆæ¨¡å¼ | ~50ms | 75-85% | ä½ | å¹³è¡¡æ–¹æ¡ˆ |

### 6.2 ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ç¼“å­˜**ï¼šæƒ…æ„Ÿå†å²è‡ªåŠ¨ç¼“å­˜åœ¨å†…å­˜ä¸­
2. **å¼‚æ­¥å¤„ç†**ï¼šè¶‹åŠ¿åˆ†æå¯ä»¥å¼‚æ­¥æ‰§è¡Œ
3. **æ‰¹é‡åˆ†æ**ï¼šå¦‚æœéœ€è¦åˆ†æå¤§é‡å†å²æ¶ˆæ¯ï¼Œä½¿ç”¨æ‰¹å¤„ç†

```python
# å¼‚æ­¥è¶‹åŠ¿åˆ†æï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
import asyncio

async def analyze_trend_async(user_id):
    loop = asyncio.get_event_loop()
    trend = await loop.run_in_executor(
        None,
        analyzer.get_emotion_trend,
        user_id,
        10
    )
    return trend
```

---

## ä¸ƒã€æµ‹è¯•ä¸éªŒè¯

### 7.1 è¿è¡Œæµ‹è¯•

```bash
# æµ‹è¯•é«˜çº§æƒ…æ„Ÿåˆ†æå™¨
python backend/services/advanced_sentiment_analyzer.py

# æµ‹è¯•è¶‹åŠ¿åˆ†æå™¨
python backend/services/emotion_trend_analyzer.py

# æµ‹è¯•é›†æˆç¤ºä¾‹
python backend/services/sentiment_integration_example.py
```

### 7.2 æµ‹è¯•ç”¨ä¾‹

```python
test_cases = [
    {
        "text": "ä»Šå¤©å¥½ç´¯å•Šï¼Œå·¥ä½œå‹åŠ›å¤ªå¤§äº†",
        "expected_emotion": "sad",
        "expected_intensity_range": (6, 8)
    },
    {
        "text": "æˆ‘å‡èŒå•¦ï¼å¤ªå¼€å¿ƒäº†ï¼",
        "expected_emotion": "happy",
        "expected_intensity_range": (7, 9)
    },
    {
        "text": "æ˜å¤©è¦é¢è¯•ï¼Œå¥½ç´§å¼ å•Š",
        "expected_emotion": "anxious",
        "expected_intensity_range": (6, 8)
    }
]

for case in test_cases:
    result = analyzer.analyze(case["text"])
    assert result["emotion"] == case["expected_emotion"]
    assert case["expected_intensity_range"][0] <= result["intensity"] <= case["expected_intensity_range"][1]
```

---

## å…«ã€æ€»ç»“

é€šè¿‡æœ¬ç« çš„å®ç°ï¼Œæˆ‘ä»¬å®Œæˆäº†ï¼š

âœ… **é«˜çº§æƒ…æ„Ÿåˆ†æå™¨**ï¼šæ”¯æŒTransformerså’Œå…³é”®è¯åŒæ¨¡å¼
âœ… **æƒ…ç»ªè¶‹åŠ¿åˆ†æ**ï¼šå®æ—¶è¿½è¸ªç”¨æˆ·æƒ…ç»ªå˜åŒ–
âœ… **å¤šç»´åº¦æƒ…ç»ªå»ºæ¨¡**ï¼š6ç»´æƒ…ç»ªç”»åƒç”Ÿæˆ
âœ… **åŠ¨æ€Promptè°ƒæ•´**ï¼šåŸºäºæƒ…ç»ªè‡ªåŠ¨ä¼˜åŒ–å›å¤ç­–ç•¥
âœ… **é£é™©é¢„è­¦æœºåˆ¶**ï¼šä¸‰çº§é¢„è­¦å’Œå±æœºå¹²é¢„
âœ… **å¯è§†åŒ–æ•°æ®ç”Ÿæˆ**ï¼šæ”¯æŒå‰ç«¯å›¾è¡¨å±•ç¤º
âœ… **æ•°æ®åº“é›†æˆ**ï¼šè‡ªåŠ¨ä¿å­˜æƒ…æ„Ÿåˆ†æç»“æœ

**æ ¸å¿ƒæ–‡ä»¶**ï¼š
- `backend/services/advanced_sentiment_analyzer.py` - é«˜çº§æƒ…æ„Ÿåˆ†æå™¨
- `backend/services/emotion_trend_analyzer.py` - æƒ…ç»ªè¶‹åŠ¿åˆ†æå™¨
- `backend/services/sentiment_integration_example.py` - é›†æˆç¤ºä¾‹

**ä¸‹ä¸€æ­¥**ï¼š
1. åœ¨ç”Ÿäº§ç¯å¢ƒä¸­æµ‹è¯•Transformersæ¨¡å‹æ€§èƒ½
2. æ ¹æ®ç”¨æˆ·åé¦ˆè°ƒæ•´æƒ…ç»ªè¯†åˆ«é˜ˆå€¼
3. æ‰©å±•æ›´å¤šæƒ…ç»ªç±»å‹å’Œç»†åˆ†åœºæ™¯
4. æ·»åŠ æƒ…ç»ªæŠ¥å‘Šçš„å‰ç«¯å¯è§†åŒ–ç•Œé¢

è®©AIçœŸæ­£"æ‡‚ä½ "ï¼Œä»æƒ…æ„Ÿåˆ†æå¼€å§‹ã€‚

