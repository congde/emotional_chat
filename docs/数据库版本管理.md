# æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†æ–‡æ¡£

æœ¬æ–‡æ¡£ä»‹ç»å¦‚ä½•ä½¿ç”¨ Alembic è¿›è¡Œæ•°æ®åº“ç‰ˆæœ¬ç®¡ç†å’Œè¿ç§»ã€‚

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [å¸¸ç”¨å‘½ä»¤](#å¸¸ç”¨å‘½ä»¤)
4. [è¿ç§»å·¥ä½œæµ](#è¿ç§»å·¥ä½œæµ)
5. [é«˜çº§ç”¨æ³•](#é«˜çº§ç”¨æ³•)
6. [æœ€ä½³å®è·µ](#æœ€ä½³å®è·µ)
7. [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

## æ¦‚è¿°

### ä»€ä¹ˆæ˜¯æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†ï¼Ÿ

æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†ï¼ˆDatabase Migrationï¼‰æ˜¯ä¸€ç§è¿½è¸ªå’Œç®¡ç†æ•°æ®åº“ç»“æ„å˜æ›´çš„æ–¹æ³•ã€‚å®ƒå…è®¸æˆ‘ä»¬ï¼š

- ğŸ“ è®°å½•æ‰€æœ‰æ•°æ®åº“ç»“æ„çš„å˜æ›´å†å²
- ğŸ”„ åœ¨ä¸åŒç¯å¢ƒé—´åŒæ­¥æ•°æ®åº“ç»“æ„
- âª å›æ»šåˆ°ä¹‹å‰çš„æ•°æ®åº“ç‰ˆæœ¬
- ğŸ‘¥ å›¢é˜Ÿåä½œæ—¶ä¿æŒæ•°æ®åº“ä¸€è‡´æ€§

### ä¸ºä»€ä¹ˆä½¿ç”¨ Alembicï¼Ÿ

- **SQLAlchemy é›†æˆ**ï¼šä¸æˆ‘ä»¬çš„ ORM å®Œç¾é›†æˆ
- **è‡ªåŠ¨ç”Ÿæˆ**ï¼šå¯ä»¥è‡ªåŠ¨æ£€æµ‹æ¨¡å‹å˜æ›´å¹¶ç”Ÿæˆè¿ç§»è„šæœ¬
- **ç‰ˆæœ¬æ§åˆ¶**ï¼šè¿ç§»è„šæœ¬å¯ä»¥çº³å…¥ Git ç‰ˆæœ¬æ§åˆ¶
- **çµæ´»æ€§**ï¼šæ”¯æŒå¤æ‚çš„æ•°æ®åº“æ“ä½œ

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®æ•°æ®åº“

ç¡®ä¿ `config.env` æ–‡ä»¶ä¸­é…ç½®äº†æ­£ç¡®çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š

```env
MYSQL_HOST=localhost
MYSQL_PORT=3306
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_DATABASE=emotional_chat
```

### 3. åˆå§‹åŒ–æ•°æ®åº“

é¦–æ¬¡éƒ¨ç½²æ—¶ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤åˆ›å»ºæ•°æ®åº“å¹¶åº”ç”¨æ‰€æœ‰è¿ç§»ï¼š

```bash
python db_manager.py init
```

è¿™ä¸ªå‘½ä»¤ä¼šï¼š
1. åˆ›å»ºæ•°æ®åº“ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. è¿è¡Œæ‰€æœ‰è¿ç§»è„šæœ¬ï¼Œåˆ›å»ºæ‰€æœ‰è¡¨

## å¸¸ç”¨å‘½ä»¤

### åŸºç¡€å‘½ä»¤

#### æ£€æŸ¥æ•°æ®åº“è¿æ¥

```bash
python db_manager.py check
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
æ•°æ®åº“åœ°å€: localhost:3306
æ•°æ®åº“åç§°: emotional_chat
ç”¨æˆ·å: root
```

#### æŸ¥çœ‹å½“å‰æ•°æ®åº“ç‰ˆæœ¬

```bash
python db_manager.py current
```

#### æŸ¥çœ‹è¿ç§»å†å²

```bash
python db_manager.py history
```

### è¿ç§»å‘½ä»¤

#### å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬

```bash
python db_manager.py upgrade
```

#### å‡çº§åˆ°ç‰¹å®šç‰ˆæœ¬

```bash
python db_manager.py upgrade -r 001
```

#### é™çº§ä¸€ä¸ªç‰ˆæœ¬

```bash
python db_manager.py downgrade
```

#### é™çº§åˆ°ç‰¹å®šç‰ˆæœ¬

```bash
python db_manager.py downgrade -r 001
```

#### é™çº§åˆ°åˆå§‹çŠ¶æ€ï¼ˆåˆ é™¤æ‰€æœ‰è¡¨ï¼‰

```bash
python db_manager.py downgrade -r base
```

### åˆ›å»ºè¿ç§»

#### è‡ªåŠ¨ç”Ÿæˆè¿ç§»è„šæœ¬

å½“ä½ ä¿®æ”¹äº† `backend/database.py` ä¸­çš„æ¨¡å‹åï¼Œè¿è¡Œï¼š

```bash
python db_manager.py revision -m "æ·»åŠ ç”¨æˆ·å¤´åƒå­—æ®µ"
```

è¿™ä¼šè‡ªåŠ¨æ£€æµ‹æ¨¡å‹å˜æ›´å¹¶ç”Ÿæˆè¿ç§»è„šæœ¬ã€‚

#### æ‰‹åŠ¨åˆ›å»ºç©ºç™½è¿ç§»è„šæœ¬

å¦‚æœéœ€è¦ç¼–å†™è‡ªå®šä¹‰è¿ç§»é€»è¾‘ï¼š

```bash
python db_manager.py revision -m "è‡ªå®šä¹‰æ•°æ®è¿ç§»" --no-autogenerate
```

### æ•°æ®åº“ç®¡ç†å‘½ä»¤

#### åˆ›å»ºæ•°æ®åº“

```bash
python db_manager.py create
```

#### åˆ é™¤æ•°æ®åº“ï¼ˆå±é™©æ“ä½œï¼ï¼‰

```bash
python db_manager.py drop
```

ä¼šè¦æ±‚è¾“å…¥ `yes` ç¡®è®¤ã€‚

#### é‡ç½®æ•°æ®åº“

åˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ•°æ®åº“ï¼ˆå±é™©æ“ä½œï¼ï¼‰ï¼š

```bash
python db_manager.py reset
```

#### æ ‡è®°æ•°æ®åº“ç‰ˆæœ¬

å°†æ•°æ®åº“æ ‡è®°ä¸ºç‰¹å®šç‰ˆæœ¬ï¼ˆä¸è¿è¡Œè¿ç§»ï¼‰ï¼š

```bash
python db_manager.py stamp -r 001
```

## è¿ç§»å·¥ä½œæµ

### åœºæ™¯1ï¼šæ·»åŠ æ–°å­—æ®µ

å‡è®¾æˆ‘ä»¬è¦ç»™ `User` è¡¨æ·»åŠ ä¸€ä¸ª `avatar` å­—æ®µã€‚

**æ­¥éª¤1**ï¼šä¿®æ”¹æ¨¡å‹

ç¼–è¾‘ `backend/database.py`ï¼š

```python
class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String(100), unique=True, index=True)
    username = Column(String(100))
    avatar = Column(String(500))  # æ–°å¢å­—æ®µ
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)
    is_active = Column(Boolean, default=True)
```

**æ­¥éª¤2**ï¼šç”Ÿæˆè¿ç§»è„šæœ¬

```bash
python db_manager.py revision -m "add user avatar field"
```

**æ­¥éª¤3**ï¼šæ£€æŸ¥ç”Ÿæˆçš„è¿ç§»è„šæœ¬

æŸ¥çœ‹ `alembic/versions/` ç›®å½•ä¸‹æ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼Œç¡®è®¤è¿ç§»å†…å®¹æ­£ç¡®ã€‚

**æ­¥éª¤4**ï¼šåº”ç”¨è¿ç§»

```bash
python db_manager.py upgrade
```

**æ­¥éª¤5**ï¼šæäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

```bash
git add alembic/versions/xxx_add_user_avatar_field.py
git add backend/database.py
git commit -m "æ·»åŠ ç”¨æˆ·å¤´åƒå­—æ®µ"
```

### åœºæ™¯2ï¼šåˆ›å»ºæ–°è¡¨

**æ­¥éª¤1**ï¼šåœ¨ `backend/database.py` ä¸­å®šä¹‰æ–°æ¨¡å‹

```python
class UserProfile(Base):
    """ç”¨æˆ·èµ„æ–™è¡¨"""
    __tablename__ = "user_profiles"
    
    id = Column(Integer, primary_key=True, index=True)
    user_id = Column(String(100), unique=True, index=True)
    bio = Column(Text)
    avatar = Column(String(500))
    created_at = Column(DateTime, default=datetime.utcnow)
```

**æ­¥éª¤2-5**ï¼šåŒåœºæ™¯1

### åœºæ™¯3ï¼šä¿®æ”¹å­—æ®µç±»å‹

**æ­¥éª¤1**ï¼šä¿®æ”¹æ¨¡å‹

```python
# å°† rating ä» Integer æ”¹ä¸º Float
rating = Column(Float)  # åŸæ¥æ˜¯ Integer
```

**æ­¥éª¤2**ï¼šç”Ÿæˆè¿ç§»

```bash
python db_manager.py revision -m "change rating to float"
```

**æ­¥éª¤3**ï¼šæ£€æŸ¥å¹¶å¯èƒ½éœ€è¦æ‰‹åŠ¨è°ƒæ•´è¿ç§»è„šæœ¬

ç‰¹åˆ«æ˜¯å¯¹äºæœ‰æ•°æ®çš„è¡¨ï¼Œå¯èƒ½éœ€è¦æ·»åŠ æ•°æ®è½¬æ¢é€»è¾‘ã€‚

**æ­¥éª¤4-5**ï¼šåŒåœºæ™¯1

### åœºæ™¯4ï¼šé‡å‘½åå­—æ®µ

**æ­¥éª¤1**ï¼šä½¿ç”¨æ‰‹åŠ¨è¿ç§»

```bash
python db_manager.py revision -m "rename username to display_name" --no-autogenerate
```

**æ­¥éª¤2**ï¼šç¼–è¾‘ç”Ÿæˆçš„è¿ç§»æ–‡ä»¶

```python
def upgrade() -> None:
    op.alter_column('users', 'username', 
                    new_column_name='display_name')

def downgrade() -> None:
    op.alter_column('users', 'display_name', 
                    new_column_name='username')
```

**æ­¥éª¤3**ï¼šåº”ç”¨è¿ç§»

```bash
python db_manager.py upgrade
```

## é«˜çº§ç”¨æ³•

### æ•°æ®è¿ç§»

é™¤äº†ç»“æ„å˜æ›´ï¼Œæœ‰æ—¶éœ€è¦è¿ç§»æ•°æ®ã€‚ä¾‹å¦‚ï¼Œç»™ç°æœ‰ç”¨æˆ·è®¾ç½®é»˜è®¤å¤´åƒï¼š

```python
def upgrade() -> None:
    # æ·»åŠ å­—æ®µ
    op.add_column('users', sa.Column('avatar', sa.String(500), nullable=True))
    
    # æ•°æ®è¿ç§»
    from sqlalchemy import text
    connection = op.get_bind()
    connection.execute(
        text("UPDATE users SET avatar = 'default.png' WHERE avatar IS NULL")
    )

def downgrade() -> None:
    op.drop_column('users', 'avatar')
```

### æ‰¹é‡æ“ä½œ

å¯¹äº SQLite æˆ–æŸäº›éœ€è¦æ‰¹é‡æ“ä½œçš„åœºæ™¯ï¼š

```python
def upgrade() -> None:
    with op.batch_alter_table('users') as batch_op:
        batch_op.add_column(sa.Column('avatar', sa.String(500)))
        batch_op.create_index('ix_users_avatar', ['avatar'])
```

### æ¡ä»¶è¿ç§»

æ ¹æ®æ•°æ®åº“ç±»å‹æ‰§è¡Œä¸åŒçš„è¿ç§»ï¼š

```python
def upgrade() -> None:
    bind = op.get_bind()
    if bind.dialect.name == 'mysql':
        op.execute("ALTER TABLE users ENGINE=InnoDB")
    elif bind.dialect.name == 'postgresql':
        op.execute("CREATE INDEX CONCURRENTLY idx_users_email ON users(email)")
```

### å¤šä¸ªè¿ç§»è„šæœ¬ç®¡ç†

æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚ï¼š

```bash
# æŸ¥çœ‹ä»ç‰ˆæœ¬ a åˆ°ç‰ˆæœ¬ b çš„æ‰€æœ‰è¿ç§»
python db_manager.py history -r a:b
```

### åˆ†æ”¯åˆå¹¶

å¦‚æœå›¢é˜Ÿä¸­æœ‰å¤šä¸ªäººåŒæ—¶åˆ›å»ºäº†è¿ç§»ï¼Œå¯èƒ½éœ€è¦åˆå¹¶ï¼š

```bash
# 1. æŸ¥çœ‹å½“å‰çš„è¿ç§»åˆ†æ”¯
python db_manager.py branches

# 2. åˆå¹¶åˆ†æ”¯
python db_manager.py merge -m "merge migrations" head1 head2
```

## æœ€ä½³å®è·µ

### 1. è¿ç§»è„šæœ¬å‘½åè§„èŒƒ

ä½¿ç”¨æè¿°æ€§çš„åç§°ï¼š

```bash
# âœ… å¥½çš„å‘½å
python db_manager.py revision -m "add_user_avatar_field"
python db_manager.py revision -m "create_user_profile_table"
python db_manager.py revision -m "add_index_to_messages"

# âŒ ä¸å¥½çš„å‘½å
python db_manager.py revision -m "update"
python db_manager.py revision -m "fix"
python db_manager.py revision -m "test"
```

### 2. æ€»æ˜¯æ£€æŸ¥è‡ªåŠ¨ç”Ÿæˆçš„è¿ç§»

è‡ªåŠ¨ç”Ÿæˆçš„è¿ç§»å¯èƒ½ä¸å®Œç¾ï¼Œéœ€è¦äººå·¥æ£€æŸ¥ï¼š

- ç¡®è®¤å­—æ®µç±»å‹æ­£ç¡®
- ç¡®è®¤ç´¢å¼•è®¾ç½®æ­£ç¡®
- è€ƒè™‘æ˜¯å¦éœ€è¦æ·»åŠ æ•°æ®è¿ç§»é€»è¾‘
- ç¡®è®¤ downgrade å‡½æ•°èƒ½æ­£ç¡®å›æ»š

### 3. å°æ­¥è¿­ä»£

æ¯æ¬¡è¿ç§»åªåšä¸€ä»¶äº‹ï¼Œé¿å…ä¸€ä¸ªè¿ç§»è„šæœ¬åŒ…å«å¤ªå¤šå˜æ›´ï¼š

```bash
# âœ… å¥½çš„åšæ³•
python db_manager.py revision -m "add_avatar_field"
python db_manager.py revision -m "add_bio_field"

# âŒ ä¸å¥½çš„åšæ³•
python db_manager.py revision -m "add_multiple_fields_and_create_tables"
```

### 4. æµ‹è¯•è¿ç§»

åœ¨åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒå‰ï¼š

1. åœ¨å¼€å‘ç¯å¢ƒæµ‹è¯•
2. æµ‹è¯• upgrade å’Œ downgrade
3. åœ¨ç”Ÿäº§ç¯å¢ƒçš„å‰¯æœ¬ä¸Šæµ‹è¯•

```bash
# æµ‹è¯•å‡çº§
python db_manager.py upgrade

# æµ‹è¯•é™çº§
python db_manager.py downgrade

# å†æ¬¡å‡çº§
python db_manager.py upgrade
```

### 5. ç‰ˆæœ¬æ§åˆ¶

- æ€»æ˜¯å°†è¿ç§»è„šæœ¬æäº¤åˆ° Git
- è¿ç§»è„šæœ¬å’Œä»£ç å˜æ›´åœ¨åŒä¸€ä¸ª commit
- å†™æ¸…æ¥š commit message

### 6. ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹

```bash
# 1. å¤‡ä»½æ•°æ®åº“
mysqldump -u root -p emotional_chat > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 3. æ›´æ–°ä¾èµ–
pip install -r requirements.txt

# 4. æŸ¥çœ‹å¾…æ‰§è¡Œçš„è¿ç§»
python db_manager.py history

# 5. åº”ç”¨è¿ç§»
python db_manager.py upgrade

# 6. éªŒè¯
python db_manager.py current
```

### 7. ä¸è¦ä¿®æ”¹å·²åº”ç”¨çš„è¿ç§»

å¦‚æœè¿ç§»å·²ç»åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œä¸è¦ä¿®æ”¹å®ƒã€‚è€Œæ˜¯åˆ›å»ºæ–°çš„è¿ç§»æ¥ä¿®æ­£ã€‚

### 8. å¤§è¡¨å˜æ›´æ³¨æ„äº‹é¡¹

å¯¹äºå¤§è¡¨ï¼ˆå¦‚ chat_messagesï¼‰ï¼Œæ·»åŠ å­—æ®µæ—¶è€ƒè™‘ï¼š

- è®¾ç½®å­—æ®µä¸º nullable
- ä½¿ç”¨é»˜è®¤å€¼
- è€ƒè™‘åœ¨ä½å³°æœŸæ‰§è¡Œ
- å¿…è¦æ—¶åˆ†æ‰¹è¿ç§»æ•°æ®

```python
def upgrade() -> None:
    # æ·»åŠ å¯ç©ºå­—æ®µ
    op.add_column('chat_messages', 
                  sa.Column('sentiment_score', sa.Float(), nullable=True))
    
    # åˆ†æ‰¹æ›´æ–°æ•°æ®
    connection = op.get_bind()
    batch_size = 1000
    offset = 0
    
    while True:
        result = connection.execute(
            text(f"SELECT id FROM chat_messages LIMIT {batch_size} OFFSET {offset}")
        )
        ids = [row[0] for row in result]
        if not ids:
            break
        
        # æ›´æ–°è¿™æ‰¹æ•°æ®
        connection.execute(
            text("UPDATE chat_messages SET sentiment_score = 0.0 WHERE id IN :ids"),
            {"ids": tuple(ids)}
        )
        offset += batch_size
```

## æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šè¿ç§»å¤±è´¥

**ç—‡çŠ¶**ï¼šè¿è¡Œ upgrade æ—¶æŠ¥é”™

**è§£å†³æ–¹æ³•**ï¼š

1. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯
2. æ£€æŸ¥æ•°æ®åº“è¿æ¥
3. æ£€æŸ¥è¿ç§»è„šæœ¬è¯­æ³•
4. å¦‚æœæ˜¯éƒ¨åˆ†åº”ç”¨å¤±è´¥ï¼Œæ‰‹åŠ¨ä¿®å¤æ•°æ®åº“åä½¿ç”¨ stamp å‘½ä»¤æ ‡è®°ç‰ˆæœ¬

```bash
# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
python db_manager.py current

# æ‰‹åŠ¨ä¿®å¤æ•°æ®åº“åï¼Œæ ‡è®°ä¸ºå·²åº”ç”¨
python db_manager.py stamp -r xxx
```

### é—®é¢˜2ï¼šç‰ˆæœ¬ä¸åŒæ­¥

**ç—‡çŠ¶**ï¼šæœ¬åœ°å’ŒæœåŠ¡å™¨çš„è¿ç§»ç‰ˆæœ¬ä¸ä¸€è‡´

**è§£å†³æ–¹æ³•**ï¼š

1. æ‹‰å–æœ€æ–°ä»£ç 
2. æŸ¥çœ‹è¿ç§»å†å²ç¡®è®¤æ‰€æœ‰è¿ç§»è„šæœ¬éƒ½å­˜åœ¨
3. è¿è¡Œ upgrade

```bash
git pull
python db_manager.py history
python db_manager.py upgrade
```

### é—®é¢˜3ï¼šè‡ªåŠ¨ç”Ÿæˆçš„è¿ç§»ä¸ºç©º

**ç—‡çŠ¶**ï¼šä¿®æ”¹äº†æ¨¡å‹ä½†ç”Ÿæˆçš„è¿ç§»è„šæœ¬æ˜¯ç©ºçš„

**åŸå› **ï¼š

- æ¨¡å‹æ²¡æœ‰è¢«æ­£ç¡®å¯¼å…¥
- æ¨¡å‹å®šä¹‰æœ‰é”™è¯¯
- Base.metadata æ²¡æœ‰åŒ…å«æ–°æ¨¡å‹

**è§£å†³æ–¹æ³•**ï¼š

æ£€æŸ¥ `alembic/env.py` ä¸­æ˜¯å¦æ­£ç¡®å¯¼å…¥äº† Baseï¼š

```python
from backend.database import Base
target_metadata = Base.metadata
```

### é—®é¢˜4ï¼šå­—ç¬¦ç¼–ç é—®é¢˜

**ç—‡çŠ¶**ï¼šä¸­æ–‡æ•°æ®æ— æ³•æ­£å¸¸ä¿å­˜

**è§£å†³æ–¹æ³•**ï¼š

ç¡®ä¿æ•°æ®åº“ä½¿ç”¨ UTF-8 ç¼–ç ï¼š

```python
# åˆ›å»ºæ•°æ®åº“æ—¶æŒ‡å®šç¼–ç 
CREATE DATABASE emotional_chat 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;
```

### é—®é¢˜5ï¼šæ— æ³•è¿æ¥æ•°æ®åº“

**ç—‡çŠ¶**ï¼š`ERROR: Access denied for user`

**è§£å†³æ–¹æ³•**ï¼š

1. æ£€æŸ¥ MySQL æœåŠ¡æ˜¯å¦è¿è¡Œ
2. æ£€æŸ¥ config.env ä¸­çš„æ•°æ®åº“é…ç½®
3. ç¡®è®¤ç”¨æˆ·æƒé™

```bash
# æ£€æŸ¥ MySQL æœåŠ¡
systemctl status mysql

# è¿›å…¥ MySQL
mysql -u root -p

# æŸ¥çœ‹ç”¨æˆ·æƒé™
SHOW GRANTS FOR 'root'@'localhost';

# æˆæƒï¼ˆå¦‚æœéœ€è¦ï¼‰
GRANT ALL PRIVILEGES ON emotional_chat.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
```

## é™„å½•

### ç›®å½•ç»“æ„

```
emotional_chat/
â”œâ”€â”€ alembic/                    # Alembic é…ç½®ç›®å½•
â”‚   â”œâ”€â”€ versions/              # è¿ç§»è„šæœ¬ç›®å½•
â”‚   â”‚   â””â”€â”€ 001_initial_schema.py
â”‚   â”œâ”€â”€ env.py                 # Alembic ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ script.py.mako        # è¿ç§»è„šæœ¬æ¨¡æ¿
â”‚   â””â”€â”€ README                 # Alembic è¯´æ˜
â”œâ”€â”€ alembic.ini                # Alembic é…ç½®æ–‡ä»¶
â”œâ”€â”€ db_manager.py              # æ•°æ®åº“ç®¡ç†å·¥å…·
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ database.py            # æ•°æ®åº“æ¨¡å‹å®šä¹‰
â””â”€â”€ docs/
    â””â”€â”€ æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†.md      # æœ¬æ–‡æ¡£
```

### ç›¸å…³èµ„æº

- [Alembic å®˜æ–¹æ–‡æ¡£](https://alembic.sqlalchemy.org/)
- [SQLAlchemy æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [MySQL æ–‡æ¡£](https://dev.mysql.com/doc/)

### å¸¸ç”¨ SQL å‘½ä»¤

```sql
-- æŸ¥çœ‹æ‰€æœ‰è¡¨
SHOW TABLES;

-- æŸ¥çœ‹è¡¨ç»“æ„
DESCRIBE users;

-- æŸ¥çœ‹è¡¨çš„åˆ›å»ºè¯­å¥
SHOW CREATE TABLE users;

-- æŸ¥çœ‹å½“å‰æ•°æ®åº“
SELECT DATABASE();

-- æŸ¥çœ‹è¡¨çš„å¤§å°
SELECT 
    table_name AS 'Table',
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.TABLES
WHERE table_schema = 'emotional_chat'
ORDER BY (data_length + index_length) DESC;
```

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹æœ¬æ–‡æ¡£çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶
3. è”ç³»å¼€å‘å›¢é˜Ÿ

---

**æœ€åæ›´æ–°**: 2025-10-14  
**ç‰ˆæœ¬**: 1.0.0

