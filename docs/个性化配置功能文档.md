# 个性化配置功能文档

## 开场说明：从"标准化AI"到"专属数字伙伴"的跃迁

在前一章中，我们为"心语"机器人注入了情感分析能力，让它能够实时感知用户的情绪波动，并据此调整回应方式。它开始学会在用户低落时温柔安慰，在喜悦时热情共鸣——这标志着AI从"会说话"迈向"懂人心"的关键一步。

但真正的陪伴，不止于"理解"，更在于"契合"。

**个性化，是人机关系从"功能交互"升维至"情感连接"的最后一道门槛。** 当AI不仅能理解你，还能成为你希望它成为的样子，那一刻，冰冷的算法才真正拥有了温度。

## 一、功能概述

个性化配置系统允许用户自定义聊天机器人的：
- **角色身份**：温暖倾听者、智慧导师、活力伙伴等
- **表达风格**：语气、风格、正式程度、活泼度、共情程度等
- **行为边界**：核心原则、禁忌行为、安全级别等
- **长期记忆**：偏好话题、沟通习惯等

## 二、架构设计

### 2.1 三层架构模型

```
┌─────────────────────────────────────────┐
│          表达层 (Expression Layer)        │
│   - 语气 (tone)                          │
│   - 风格 (style)                         │
│   - 正式程度 (formality)                 │
│   - 活泼度 (enthusiasm)                  │
│   - 共情程度 (empathy_level)             │
│   - 幽默程度 (humor_level)               │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│           角色层 (Role Layer)            │
│   - 角色类型 (role)                      │
│   - 角色名称 (role_name)                 │
│   - 性格特征 (personality)               │
│   - 核心原则 (core_principles)           │
│   - 禁忌行为 (forbidden_behaviors)       │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          记忆层 (Memory Layer)           │
│   - 偏好话题 (preferred_topics)          │
│   - 避免话题 (avoided_topics)            │
│   - 沟通偏好 (communication_preferences) │
│   - 学习模式 (learning_mode)             │
└─────────────────────────────────────────┘
```

### 2.2 核心组件

#### 后端组件

1. **数据库模型** (`database.py`)
   ```python
   class UserPersonalization(Base):
       """用户个性化配置表"""
       user_id = Column(String(100), unique=True, index=True)
       role = Column(String(100), default="温暖倾听者")
       tone = Column(String(50), default="温和")
       # ... 更多字段
   ```

2. **Pydantic模型** (`models.py`)
   ```python
   class PersonalizationConfig(BaseModel):
       """个性化配置模型"""
       user_id: str
       role: str = "温暖倾听者"
       # ... 更多字段
   ```

3. **PromptComposer服务** (`services/prompt_composer.py`)
   ```python
   class PromptComposer:
       """根据用户配置动态生成Prompt"""
       def compose(self, context: str, emotion_state: Dict) -> str:
           # 组合角色、风格、情绪等生成最终Prompt
   ```

4. **PersonalizationService** (`services/personalization_service.py`)
   ```python
   class PersonalizationService:
       """个性化服务，处理配置获取和应用"""
       def get_user_config(self, user_id: str) -> Dict
       def create_prompt_composer(self, user_id: str) -> PromptComposer
   ```

5. **API路由** (`routers/personalization.py`)
   - `GET /api/personalization/templates` - 获取角色模板
   - `GET /api/personalization/config/{user_id}` - 获取用户配置
   - `POST /api/personalization/config/{user_id}` - 创建/更新配置
   - `POST /api/personalization/config/{user_id}/apply-template` - 应用模板
   - `GET /api/personalization/preview/{user_id}` - 预览Prompt

#### 前端组件

1. **PersonalizationPanel组件** (`components/PersonalizationPanel.js`)
   - 三个Tab标签页：角色选择、风格调节、高级设置
   - 角色模板卡片展示
   - 滑块控制风格参数
   - 开关控制高级选项

## 三、预设角色模板

系统提供5个预设角色模板：

### 3.1 温暖倾听者 ❤️
- **定位**：温暖的陪伴者，善于倾听，给予理解和支持
- **性格**：温暖、耐心、善于倾听
- **语气**：温和
- **风格**：简洁
- **核心原则**：
  - 永远不评判用户
  - 倾听优先于建议
  - 共情是第一要务

### 3.2 智慧导师 🧙
- **定位**：富有智慧的导师，善于分析问题，提供深刻见解
- **性格**：理性、洞察、启发式
- **语气**：沉稳
- **风格**：详细
- **核心原则**：
  - 引导思考而非直接给答案
  - 提供多角度的分析
  - 关注长远成长

### 3.3 活力伙伴 ✨
- **定位**：充满活力和正能量的朋友，善于鼓励和激励
- **性格**：乐观、活泼、积极向上
- **语气**：活泼
- **风格**：简洁
- **核心原则**：
  - 传递积极正面的能量
  - 鼓励行动和尝试
  - 庆祝每一个进步

### 3.4 冷静顾问 💼
- **定位**：理性客观的顾问，提供务实的建议和分析
- **性格**：理性、客观、务实
- **语气**：平和
- **风格**：直接
- **核心原则**：
  - 保持客观中立
  - 提供可行的方案
  - 关注实际效果

### 3.5 诗意灵魂 🌙
- **定位**：富有诗意和美感的灵魂伴侣，用文字抚慰心灵
- **性格**：感性、细腻、富有诗意
- **语气**：诗意
- **风格**：诗意
- **核心原则**：
  - 用美的语言表达
  - 关注情感的细腻之处
  - 给予心灵慰藉

## 四、使用指南

### 4.1 快速开始

#### 步骤1：打开个性化配置面板
1. 在左侧边栏点击"个性化配置"按钮
2. 进入AI形象定制中心

#### 步骤2：选择角色
1. 浏览5个预设角色模板
2. 点击任意角色卡片应用该模板
3. 可以自定义AI的名称

#### 步骤3：调整风格
1. 切换到"风格调节"标签页
2. 使用滑块调整以下参数：
   - **正式程度**：0%（非常随意）到100%（非常正式）
   - **活泼度**：0%（沉稳克制）到100%（热情活泼）
   - **共情程度**：0%（理性客观）到100%（深度共情）
   - **幽默程度**：0%（严肃认真）到100%（幽默风趣）
3. 开启/关闭Emoji表情

#### 步骤4：高级设置
1. 切换到"高级设置"标签页
2. 开启/关闭学习模式（AI会根据反馈自动优化）
3. 选择安全级别：
   - **严格**：严格避免敏感话题
   - **标准**：常见情况下提供支持
   - **宽松**：可以讨论更广泛的话题

#### 步骤5：保存配置
1. 点击"保存配置"按钮
2. 配置立即生效，新对话将使用新配置

### 4.2 高级用法

#### 情境化角色（计划中）
未来将支持根据时间、地点、情绪自动切换角色：
```json
{
  "situational_roles": {
    "work_hours": "冷静顾问",
    "evening": "温暖倾听者",
    "weekend": "活力伙伴"
  }
}
```

#### 自定义语料（计划中）
上传个人日记、聊天记录，让AI学习你的表达习惯。

## 五、技术实现细节

### 5.1 Prompt动态生成

PromptComposer根据配置生成个性化Prompt：

```python
def compose(self, context: str, emotion_state: Dict) -> str:
    # 1. 角色设定
    role_prompt = self._build_role_prompt()
    
    # 2. 表达风格指令
    style_prompt = self._build_style_prompt()
    
    # 3. 情绪感知指令
    emotion_prompt = self._build_emotion_prompt(emotion_state)
    
    # 4. 记忆与偏好
    memory_prompt = self._build_memory_prompt()
    
    # 5. 安全与边界
    safety_prompt = self._build_safety_prompt()
    
    # 6. 组装最终Prompt
    return f"""
    {base_prompt}
    {role_prompt}
    {style_prompt}
    {emotion_prompt}
    {memory_prompt}
    {safety_prompt}
    {context}
    """
```

### 5.2 配置持久化

配置存储在`user_personalizations`表中：
- 用户每次修改配置时更新`config_version`版本号
- 使用内存缓存提高访问速度
- 支持跨设备同步（通过JWT Token）

### 5.3 与对话流程集成（待实现）

在`ChatService`中集成个性化配置：

```python
async def _chat_with_memory(self, request: ChatRequest):
    # 1. 获取用户配置
    personalization_service = get_personalization_service()
    user_config = personalization_service.get_user_config(user_id, db)
    
    # 2. 创建Prompt组合器
    composer = PromptComposer(user_config)
    
    # 3. 生成个性化Prompt
    personalized_prompt = composer.compose(
        context=context,
        emotion_state={
            "emotion": emotion,
            "intensity": emotion_intensity
        }
    )
    
    # 4. 使用个性化Prompt生成回复
    response = llm.generate(personalized_prompt)
```

## 六、API文档

### 6.1 获取角色模板列表

**请求**
```http
GET /api/personalization/templates
```

**响应**
```json
[
  {
    "id": "warm_listener",
    "name": "温暖倾听者",
    "role": "温暖倾听者",
    "personality": "温暖、耐心、善于倾听",
    "tone": "温和",
    "style": "简洁",
    "description": "一个温暖的陪伴者，善于倾听，给予理解和支持",
    "icon": "❤️",
    "core_principles": [...],
    "sample_responses": [...]
  }
]
```

### 6.2 获取用户配置

**请求**
```http
GET /api/personalization/config/{user_id}
```

**响应**
```json
{
  "user_id": "user_123",
  "config": {
    "role": "温暖倾听者",
    "role_name": "心语",
    "tone": "温和",
    "style": "简洁",
    "formality": 0.3,
    "enthusiasm": 0.5,
    "empathy_level": 0.8,
    "humor_level": 0.3,
    "response_length": "medium",
    "use_emoji": false
  },
  "total_interactions": 45,
  "positive_feedbacks": 38,
  "config_version": 3
}
```

### 6.3 更新用户配置

**请求**
```http
POST /api/personalization/config/{user_id}
Content-Type: application/json

{
  "role": "智慧导师",
  "role_name": "智者",
  "tone": "沉稳",
  "empathy_level": 0.7,
  "use_emoji": true
}
```

**响应**
```json
{
  "user_id": "user_123",
  "config": { ... },
  "message": "配置更新成功"
}
```

### 6.4 应用角色模板

**请求**
```http
POST /api/personalization/config/{user_id}/apply-template?template_id=wise_mentor
```

**响应**
```json
{
  "user_id": "user_123",
  "config": { ... },
  "message": "模板应用成功"
}
```

### 6.5 预览Prompt

**请求**
```http
GET /api/personalization/preview/{user_id}?context=今天很开心&emotion=happy&intensity=8
```

**响应**
```json
{
  "user_id": "user_123",
  "config_summary": {
    "role": "温暖倾听者",
    "tone": "温和",
    "empathy_level": 0.8
  },
  "prompt": "你是'心语'，一位温暖倾听者...",
  "context": "今天很开心",
  "emotion_state": {
    "emotion": "happy",
    "intensity": 8
  }
}
```

## 七、数据库迁移

创建`user_personalizations`表：

```bash
# 使用Alembic创建迁移
cd backend
python db_manager.py migrate "Add user personalization table"

# 应用迁移
python db_manager.py upgrade
```

或者手动执行SQL：

```sql
CREATE TABLE user_personalizations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(100) UNIQUE NOT NULL,
    role VARCHAR(100) DEFAULT '温暖倾听者',
    role_name VARCHAR(100) DEFAULT '心语',
    role_background TEXT,
    personality VARCHAR(100) DEFAULT '温暖耐心',
    core_principles TEXT,
    forbidden_behaviors TEXT,
    tone VARCHAR(50) DEFAULT '温和',
    style VARCHAR(50) DEFAULT '简洁',
    formality FLOAT DEFAULT 0.3,
    enthusiasm FLOAT DEFAULT 0.5,
    empathy_level FLOAT DEFAULT 0.8,
    humor_level FLOAT DEFAULT 0.3,
    response_length VARCHAR(20) DEFAULT 'medium',
    use_emoji BOOLEAN DEFAULT FALSE,
    preferred_topics TEXT,
    avoided_topics TEXT,
    communication_preferences TEXT,
    learning_mode BOOLEAN DEFAULT TRUE,
    safety_level VARCHAR(20) DEFAULT 'standard',
    context_window INT DEFAULT 10,
    situational_roles TEXT,
    active_role VARCHAR(50) DEFAULT 'default',
    total_interactions INT DEFAULT 0,
    positive_feedbacks INT DEFAULT 0,
    config_version INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);
```

## 八、测试指南

### 8.1 后端测试

测试PromptComposer：
```bash
cd backend/services
python prompt_composer.py
```

测试PersonalizationService：
```bash
cd backend/services
python personalization_service.py
```

测试API端点：
```bash
# 启动后端服务
cd backend
python main.py

# 测试获取模板
curl http://localhost:8000/api/personalization/templates

# 测试获取配置
curl http://localhost:8000/api/personalization/config/test_user

# 测试更新配置
curl -X POST http://localhost:8000/api/personalization/config/test_user \
  -H "Content-Type: application/json" \
  -d '{"role": "智慧导师", "tone": "沉稳"}'
```

### 8.2 前端测试

1. 启动前端：
```bash
cd frontend
npm start
```

2. 测试流程：
   - 点击左侧边栏"个性化配置"按钮
   - 选择不同的角色模板
   - 调整风格滑块
   - 保存配置
   - 发送消息测试AI回复

## 九、后续优化方向

### 9.1 短期（1-2周）
- [ ] 集成到对话流程（修改ChatService）
- [ ] 添加配置预览功能
- [ ] 优化缓存策略
- [ ] 添加单元测试

### 9.2 中期（1-2月）
- [ ] 实现情境化角色切换
- [ ] 支持用户上传个人语料
- [ ] 开发"角色工坊"（UGC）
- [ ] 添加A/B测试功能
- [ ] 实现学习模式（基于反馈自动调整）

### 9.3 长期（3-6月）
- [ ] 多模态个性化（声音、形象）
- [ ] 社交化功能（分享角色配置）
- [ ] 高级分析仪表板
- [ ] 跨平台同步

## 十、伦理与边界

### 10.1 安全红线
- ❌ 禁止创建鼓励自残、传播虚假信息的角色
- ❌ 所有用户自定义内容需经过敏感词过滤
- ✅ 明确告知："AI不会真正拥有情感，所有回应均为算法生成"

### 10.2 防止过度依赖
- 长时间对话后提示"建议与真人交流"
- 提供心理健康资源链接
- 设计"数字排毒"模式

### 10.3 数据隐私
- 用户偏好数据加密存储
- 提供"一键清除记忆"功能
- 明确告知数据用途，遵守GDPR等法规

## 十一、常见问题

### Q1: 修改配置后立即生效吗？
A: 是的。配置保存后，新的对话会话将立即使用新配置。已有对话保持原配置，除非刷新。

### Q2: 可以恢复默认配置吗？
A: 可以。在高级设置中点击"恢复默认"按钮，或通过API删除配置。

### Q3: 配置会影响情感分析吗？
A: 不会。情感分析独立于个性化配置，但配置会影响AI如何响应检测到的情绪。

### Q4: 可以为不同场景设置不同角色吗？
A: 当前版本需要手动切换。未来版本将支持基于时间、地点、情绪的自动切换。

### Q5: 学习模式是如何工作的？
A: AI会记录你的点赞、点踩等反馈，逐步调整参数。这是一个长期的优化过程。

## 十二、贡献指南

欢迎贡献新的角色模板！请在`backend/services/prompt_composer.py`的`ROLE_TEMPLATES`中添加：

```python
"your_template_id": {
    "id": "your_template_id",
    "name": "角色名称",
    "role": "角色类型",
    "personality": "性格描述",
    "tone": "语气",
    "style": "风格",
    "description": "简短描述",
    "icon": "🔮",
    "background": "背景故事",
    "core_principles": ["原则1", "原则2"],
    "sample_responses": ["示例1", "示例2"]
}
```

## 十三、总结

个性化配置系统实现了"心语"机器人从标准化AI向专属数字伙伴的跃迁。通过三层架构（表达层、角色层、记忆层），用户可以：

1. **选择角色**：从5个预设模板中选择或自定义
2. **调整风格**：精细控制语气、活泼度、共情等参数
3. **设置边界**：定义核心原则和禁忌行为
4. **持续优化**：通过学习模式让AI越用越懂你

这不仅是功能的拓展，更是产品哲学的深化：**大模型应用的终极目标，不是制造千篇一律的智能体，而是创造万千种可能的"你"。**

---

**文档版本**: v1.0  
**最后更新**: 2025-01-20  
**作者**: 袁从德  
**联系方式**: [GitHub Issues](https://github.com/your-repo/issues)

