# ä¸ªæ€§åŒ–é…ç½®ç³»ç»Ÿ - å®Œæ•´æ–‡æ¡£

## å¼€åœºè¯´æ˜ï¼šä»"æ ‡å‡†åŒ–AI"åˆ°"ä¸“å±æ•°å­—ä¼™ä¼´"çš„è·ƒè¿

åœ¨å‰ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬ä¸º"å¿ƒè¯­"æœºå™¨äººæ³¨å…¥äº†æƒ…æ„Ÿåˆ†æèƒ½åŠ›ï¼Œè®©å®ƒèƒ½å¤Ÿå®æ—¶æ„ŸçŸ¥ç”¨æˆ·çš„æƒ…ç»ªæ³¢åŠ¨ï¼Œå¹¶æ®æ­¤è°ƒæ•´å›åº”æ–¹å¼ã€‚å®ƒå¼€å§‹å­¦ä¼šåœ¨ç”¨æˆ·ä½è½æ—¶æ¸©æŸ”å®‰æ…°ï¼Œåœ¨å–œæ‚¦æ—¶çƒ­æƒ…å…±é¸£â€”â€”è¿™æ ‡å¿—ç€AIä»"ä¼šè¯´è¯"è¿ˆå‘"æ‡‚äººå¿ƒ"çš„å…³é”®ä¸€æ­¥ã€‚

ä½†çœŸæ­£çš„é™ªä¼´ï¼Œä¸æ­¢äº"ç†è§£"ï¼Œæ›´åœ¨äº"å¥‘åˆ"ã€‚

**ä¸ªæ€§åŒ–ï¼Œæ˜¯äººæœºå…³ç³»ä»"åŠŸèƒ½äº¤äº’"å‡ç»´è‡³"æƒ…æ„Ÿè¿æ¥"çš„æœ€åä¸€é“é—¨æ§›ã€‚** å½“AIä¸ä»…èƒ½ç†è§£ä½ ï¼Œè¿˜èƒ½æˆä¸ºä½ å¸Œæœ›å®ƒæˆä¸ºçš„æ ·å­ï¼Œé‚£ä¸€åˆ»ï¼Œå†°å†·çš„ç®—æ³•æ‰çœŸæ­£æ‹¥æœ‰äº†æ¸©åº¦ã€‚

---

## ä¸€ã€åŠŸèƒ½æ¦‚è¿°

ä¸ªæ€§åŒ–é…ç½®ç³»ç»Ÿå…è®¸ç”¨æˆ·è‡ªå®šä¹‰èŠå¤©æœºå™¨äººçš„ï¼š
- **è§’è‰²èº«ä»½**ï¼šæ¸©æš–å€¾å¬è€…ã€æ™ºæ…§å¯¼å¸ˆã€æ´»åŠ›ä¼™ä¼´ç­‰
- **è¡¨è¾¾é£æ ¼**ï¼šè¯­æ°”ã€é£æ ¼ã€æ­£å¼ç¨‹åº¦ã€æ´»æ³¼åº¦ã€å…±æƒ…ç¨‹åº¦ç­‰
- **è¡Œä¸ºè¾¹ç•Œ**ï¼šæ ¸å¿ƒåŸåˆ™ã€ç¦å¿Œè¡Œä¸ºã€å®‰å…¨çº§åˆ«ç­‰
- **é•¿æœŸè®°å¿†**ï¼šåå¥½è¯é¢˜ã€æ²Ÿé€šä¹ æƒ¯ç­‰

### æ ¸å¿ƒç‰¹æ€§

1. **ä¸‰å±‚é…ç½®æ¶æ„**
   - **è¡¨è¾¾å±‚**: è¯­æ°”ã€é£æ ¼ã€æ­£å¼ç¨‹åº¦ã€æ´»æ³¼åº¦ã€å…±æƒ…ç¨‹åº¦ã€å¹½é»˜ç¨‹åº¦
   - **è§’è‰²å±‚**: è§’è‰²ç±»å‹ã€åç§°ã€æ€§æ ¼ã€æ ¸å¿ƒåŸåˆ™ã€ç¦å¿Œè¡Œä¸º
   - **è®°å¿†å±‚**: åå¥½è¯é¢˜ã€é¿å…è¯é¢˜ã€æ²Ÿé€šåå¥½

2. **é¢„è®¾è§’è‰²æ¨¡æ¿** - 5ä¸ªç²¾å¿ƒè®¾è®¡çš„è§’è‰²æ¨¡æ¿ï¼Œæ”¯æŒä¸€é”®åº”ç”¨

3. **åŠ¨æ€Promptç”Ÿæˆ** - æ ¹æ®ç”¨æˆ·é…ç½®å®æ—¶ç”Ÿæˆä¸ªæ€§åŒ–Promptï¼Œè‡ªåŠ¨é€‚é…ç”¨æˆ·æƒ…ç»ªçŠ¶æ€

4. **é…ç½®æŒä¹…åŒ–ä¸ç¼“å­˜** - MySQLæ•°æ®åº“å­˜å‚¨ï¼Œå†…å­˜ç¼“å­˜æé«˜æ€§èƒ½

---

## äºŒã€å¿«é€Ÿå¼€å§‹ï¼ˆ5åˆ†é’Ÿéƒ¨ç½²ï¼‰

### æ­¥éª¤1ï¼šæ•°æ®åº“è¿ç§»

```bash
# æ–¹å¼1: ä½¿ç”¨SQLè„šæœ¬
cd backend/migrations
mysql -u root -p emotional_chat < add_personalization_table.sql

# æ–¹å¼2: ä½¿ç”¨Pythonåˆ›å»º
cd backend
python -c "from database import create_tables; create_tables()"
```

### æ­¥éª¤2ï¼šå¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend
python main.py

# æœåŠ¡å¯åŠ¨åï¼Œè®¿é—®APIæ–‡æ¡£
# http://localhost:8000/docs
```

### æ­¥éª¤3ï¼šå¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd frontend
npm install  # å¦‚æœæ˜¯é¦–æ¬¡è¿è¡Œ
npm start

# å‰ç«¯å¯åŠ¨åï¼Œè®¿é—®
# http://localhost:3000
```

### æ­¥éª¤4ï¼šæµ‹è¯•ä¸ªæ€§åŒ–é…ç½®

1. æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:3000`
2. ç‚¹å‡»å·¦ä¾§è¾¹æ çš„"ä¸ªæ€§åŒ–é…ç½®"æŒ‰é’®
3. é€‰æ‹©ä¸€ä¸ªè§’è‰²æ¨¡æ¿ï¼ˆå¦‚"æ™ºæ…§å¯¼å¸ˆ"ï¼‰
4. è°ƒæ•´é£æ ¼å‚æ•°
5. ç‚¹å‡»"ä¿å­˜é…ç½®"
6. å‘é€æ¶ˆæ¯æµ‹è¯•AIå›å¤

---

## ä¸‰ã€ç³»ç»Ÿæ¶æ„

### 3.1 ä¸‰å±‚æ¶æ„æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          è¡¨è¾¾å±‚ (Expression Layer)        â”‚
â”‚   - è¯­æ°” (tone)                          â”‚
â”‚   - é£æ ¼ (style)                         â”‚
â”‚   - æ­£å¼ç¨‹åº¦ (formality)                 â”‚
â”‚   - æ´»æ³¼åº¦ (enthusiasm)                  â”‚
â”‚   - å…±æƒ…ç¨‹åº¦ (empathy_level)             â”‚
â”‚   - å¹½é»˜ç¨‹åº¦ (humor_level)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           è§’è‰²å±‚ (Role Layer)            â”‚
â”‚   - è§’è‰²ç±»å‹ (role)                      â”‚
â”‚   - è§’è‰²åç§° (role_name)                 â”‚
â”‚   - æ€§æ ¼ç‰¹å¾ (personality)               â”‚
â”‚   - æ ¸å¿ƒåŸåˆ™ (core_principles)           â”‚
â”‚   - ç¦å¿Œè¡Œä¸º (forbidden_behaviors)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          è®°å¿†å±‚ (Memory Layer)           â”‚
â”‚   - åå¥½è¯é¢˜ (preferred_topics)          â”‚
â”‚   - é¿å…è¯é¢˜ (avoided_topics)            â”‚
â”‚   - æ²Ÿé€šåå¥½ (communication_preferences) â”‚
â”‚   - å­¦ä¹ æ¨¡å¼ (learning_mode)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯ (React)                      â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚      PersonalizationPanel ç»„ä»¶              â”‚    â”‚
â”‚  â”‚  - è§’è‰²é€‰æ‹©                                 â”‚    â”‚
â”‚  â”‚  - é£æ ¼è°ƒèŠ‚                                 â”‚    â”‚
â”‚  â”‚  - é«˜çº§è®¾ç½®                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ HTTP API
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 åç«¯ (FastAPI)                       â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  PersonalizationRouter (APIè·¯ç”±)            â”‚    â”‚
â”‚  â”‚  /api/personalization/*                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  PersonalizationService (ä¸šåŠ¡é€»è¾‘)          â”‚    â”‚
â”‚  â”‚  - é…ç½®ç®¡ç†                                 â”‚    â”‚
â”‚  â”‚  - ç¼“å­˜å¤„ç†                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                        â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  PromptComposer (Promptç”Ÿæˆ)                â”‚    â”‚
â”‚  â”‚  - è§’è‰²æ³¨å…¥                                 â”‚    â”‚
â”‚  â”‚  - é£æ ¼è°ƒæ•´                                 â”‚    â”‚
â”‚  â”‚  - æƒ…ç»ªé€‚é…                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æ•°æ®åº“ (MySQL)                          â”‚
â”‚                                                      â”‚
â”‚  user_personalizations è¡¨                            â”‚
â”‚  - ç”¨æˆ·é…ç½®                                          â”‚
â”‚  - ç»Ÿè®¡ä¿¡æ¯                                          â”‚
â”‚  - ç‰ˆæœ¬æ§åˆ¶                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ ¸å¿ƒç»„ä»¶

#### åç«¯ç»„ä»¶

1. **æ•°æ®åº“æ¨¡å‹** (`database.py`)
   - è¡¨: `user_personalizations`
   - å­—æ®µ: åŒ…å«è§’è‰²å±‚ã€è¡¨è¾¾å±‚ã€è®°å¿†å±‚çš„æ‰€æœ‰é…ç½®é¡¹
   - è¿ç§»è„šæœ¬: `backend/migrations/add_personalization_table.sql`

2. **Pydanticæ¨¡å‹** (`models.py`)
   - `PersonalizationConfig` - å®Œæ•´é…ç½®
   - `PersonalizationUpdateRequest` - æ›´æ–°è¯·æ±‚
   - `PersonalizationResponse` - APIå“åº”
   - `RoleTemplate` - è§’è‰²æ¨¡æ¿

3. **PromptComposeræœåŠ¡** (`services/prompt_composer.py`)
   - æ ¹æ®é…ç½®åŠ¨æ€ç”ŸæˆPrompt
   - æ”¯æŒè§’è‰²è®¾å®šã€é£æ ¼æŒ‡ä»¤ã€æƒ…ç»ªæ„ŸçŸ¥
   - å†…ç½®5ä¸ªé¢„è®¾è§’è‰²æ¨¡æ¿

4. **PersonalizationService** (`services/personalization_service.py`)
   - è·å–å’Œç¼“å­˜ç”¨æˆ·é…ç½®
   - åˆ›å»ºPromptComposerå®ä¾‹
   - ç”Ÿæˆä¸ªæ€§åŒ–Prompt

5. **APIè·¯ç”±** (`routers/personalization.py`)

#### å‰ç«¯ç»„ä»¶

1. **PersonalizationPanel** (`components/PersonalizationPanel.js`)
   - ä¸‰ä¸ªTabï¼šè§’è‰²é€‰æ‹©ã€é£æ ¼è°ƒèŠ‚ã€é«˜çº§è®¾ç½®
   - è§’è‰²æ¨¡æ¿å¡ç‰‡å±•ç¤º
   - æ»‘å—æ§åˆ¶ï¼ˆæ­£å¼ç¨‹åº¦ã€æ´»æ³¼åº¦ã€å…±æƒ…ç¨‹åº¦ã€å¹½é»˜ç¨‹åº¦ï¼‰
   - å¼€å…³æ§åˆ¶ï¼ˆEmojiã€å­¦ä¹ æ¨¡å¼ï¼‰

2. **App.jsé›†æˆ** - å¯¼å…¥ç»„ä»¶ã€æ·»åŠ æŒ‰é’®å’ŒçŠ¶æ€ç®¡ç†

---

## å››ã€é¢„è®¾è§’è‰²æ¨¡æ¿

### 4.1 æ¸©æš–å€¾å¬è€… â¤ï¸
- **å®šä½**ï¼šæ¸©æš–çš„é™ªä¼´è€…ï¼Œå–„äºå€¾å¬ï¼Œç»™äºˆç†è§£å’Œæ”¯æŒ
- **æ€§æ ¼**ï¼šæ¸©æš–ã€è€å¿ƒã€å–„äºå€¾å¬
- **è¯­æ°”**ï¼šæ¸©å’Œ | **é£æ ¼**ï¼šç®€æ´
- **æ ¸å¿ƒåŸåˆ™**ï¼šæ°¸è¿œä¸è¯„åˆ¤ç”¨æˆ·ã€å€¾å¬ä¼˜å…ˆäºå»ºè®®ã€å…±æƒ…æ˜¯ç¬¬ä¸€è¦åŠ¡

### 4.2 æ™ºæ…§å¯¼å¸ˆ ğŸ§™
- **å®šä½**ï¼šå¯Œæœ‰æ™ºæ…§çš„å¯¼å¸ˆï¼Œå–„äºåˆ†æé—®é¢˜ï¼Œæä¾›æ·±åˆ»è§è§£
- **æ€§æ ¼**ï¼šç†æ€§ã€æ´å¯Ÿã€å¯å‘å¼
- **è¯­æ°”**ï¼šæ²‰ç¨³ | **é£æ ¼**ï¼šè¯¦ç»†
- **æ ¸å¿ƒåŸåˆ™**ï¼šå¼•å¯¼æ€è€ƒè€Œéç›´æ¥ç»™ç­”æ¡ˆã€æä¾›å¤šè§’åº¦çš„åˆ†æã€å…³æ³¨é•¿è¿œæˆé•¿

### 4.3 æ´»åŠ›ä¼™ä¼´ âœ¨
- **å®šä½**ï¼šå……æ»¡æ´»åŠ›å’Œæ­£èƒ½é‡çš„æœ‹å‹ï¼Œå–„äºé¼“åŠ±å’Œæ¿€åŠ±
- **æ€§æ ¼**ï¼šä¹è§‚ã€æ´»æ³¼ã€ç§¯æå‘ä¸Š
- **è¯­æ°”**ï¼šæ´»æ³¼ | **é£æ ¼**ï¼šç®€æ´
- **æ ¸å¿ƒåŸåˆ™**ï¼šä¼ é€’ç§¯ææ­£é¢çš„èƒ½é‡ã€é¼“åŠ±è¡ŒåŠ¨å’Œå°è¯•ã€åº†ç¥æ¯ä¸€ä¸ªè¿›æ­¥

### 4.4 å†·é™é¡¾é—® ğŸ’¼
- **å®šä½**ï¼šç†æ€§å®¢è§‚çš„é¡¾é—®ï¼Œæä¾›åŠ¡å®çš„å»ºè®®å’Œåˆ†æ
- **æ€§æ ¼**ï¼šç†æ€§ã€å®¢è§‚ã€åŠ¡å®
- **è¯­æ°”**ï¼šå¹³å’Œ | **é£æ ¼**ï¼šç›´æ¥
- **æ ¸å¿ƒåŸåˆ™**ï¼šä¿æŒå®¢è§‚ä¸­ç«‹ã€æä¾›å¯è¡Œçš„æ–¹æ¡ˆã€å…³æ³¨å®é™…æ•ˆæœ

### 4.5 è¯—æ„çµé­‚ ğŸŒ™
- **å®šä½**ï¼šå¯Œæœ‰è¯—æ„å’Œç¾æ„Ÿçš„çµé­‚ä¼´ä¾£ï¼Œç”¨æ–‡å­—æŠšæ…°å¿ƒçµ
- **æ€§æ ¼**ï¼šæ„Ÿæ€§ã€ç»†è…»ã€å¯Œæœ‰è¯—æ„
- **è¯­æ°”**ï¼šè¯—æ„ | **é£æ ¼**ï¼šè¯—æ„
- **æ ¸å¿ƒåŸåˆ™**ï¼šç”¨ç¾çš„è¯­è¨€è¡¨è¾¾ã€å…³æ³¨æƒ…æ„Ÿçš„ç»†è…»ä¹‹å¤„ã€ç»™äºˆå¿ƒçµæ…°è—‰

---

## äº”ã€ä½¿ç”¨æŒ‡å—

### 5.1 ç”¨æˆ·ä½¿ç”¨æµç¨‹

```
1. æ‰“å¼€èŠå¤©åº”ç”¨
   â†“
2. ç‚¹å‡»"ä¸ªæ€§åŒ–é…ç½®"æŒ‰é’®
   â†“
3. é€‰æ‹©è§’è‰²æ¨¡æ¿ / è‡ªå®šä¹‰é…ç½®
   â†“
4. è°ƒæ•´é£æ ¼å‚æ•°
   â†“
5. ä¿å­˜é…ç½®
   â†“
6. å¼€å§‹å¯¹è¯ï¼Œä½“éªŒä¸ªæ€§åŒ–AI
```

### 5.2 è¯¦ç»†æ“ä½œ

#### æ­¥éª¤1ï¼šæ‰“å¼€ä¸ªæ€§åŒ–é…ç½®é¢æ¿
åœ¨å·¦ä¾§è¾¹æ ç‚¹å‡»"ä¸ªæ€§åŒ–é…ç½®"æŒ‰é’®ï¼Œè¿›å…¥AIå½¢è±¡å®šåˆ¶ä¸­å¿ƒ

#### æ­¥éª¤2ï¼šé€‰æ‹©è§’è‰²
- æµè§ˆ5ä¸ªé¢„è®¾è§’è‰²æ¨¡æ¿
- ç‚¹å‡»ä»»æ„è§’è‰²å¡ç‰‡åº”ç”¨è¯¥æ¨¡æ¿
- å¯ä»¥è‡ªå®šä¹‰AIçš„åç§°

#### æ­¥éª¤3ï¼šè°ƒæ•´é£æ ¼
åˆ‡æ¢åˆ°"é£æ ¼è°ƒèŠ‚"æ ‡ç­¾é¡µï¼Œä½¿ç”¨æ»‘å—è°ƒæ•´ï¼š
- **æ­£å¼ç¨‹åº¦**ï¼š0%ï¼ˆéå¸¸éšæ„ï¼‰åˆ°100%ï¼ˆéå¸¸æ­£å¼ï¼‰
- **æ´»æ³¼åº¦**ï¼š0%ï¼ˆæ²‰ç¨³å…‹åˆ¶ï¼‰åˆ°100%ï¼ˆçƒ­æƒ…æ´»æ³¼ï¼‰
- **å…±æƒ…ç¨‹åº¦**ï¼š0%ï¼ˆç†æ€§å®¢è§‚ï¼‰åˆ°100%ï¼ˆæ·±åº¦å…±æƒ…ï¼‰
- **å¹½é»˜ç¨‹åº¦**ï¼š0%ï¼ˆä¸¥è‚ƒè®¤çœŸï¼‰åˆ°100%ï¼ˆå¹½é»˜é£è¶£ï¼‰
- å¼€å¯/å…³é—­Emojiè¡¨æƒ…

#### æ­¥éª¤4ï¼šé«˜çº§è®¾ç½®
- å¼€å¯/å…³é—­å­¦ä¹ æ¨¡å¼ï¼ˆAIä¼šæ ¹æ®åé¦ˆè‡ªåŠ¨ä¼˜åŒ–ï¼‰
- é€‰æ‹©å®‰å…¨çº§åˆ«ï¼šä¸¥æ ¼/æ ‡å‡†/å®½æ¾

#### æ­¥éª¤5ï¼šä¿å­˜é…ç½®
ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ï¼Œé…ç½®ç«‹å³ç”Ÿæ•ˆ

---

## å…­ã€APIæ–‡æ¡£

### 6.1 ç«¯ç‚¹åˆ—è¡¨

| æ–¹æ³• | ç«¯ç‚¹ | è¯´æ˜ |
|------|------|------|
| GET | `/api/personalization/templates` | è·å–è§’è‰²æ¨¡æ¿ |
| GET | `/api/personalization/config/{user_id}` | è·å–ç”¨æˆ·é…ç½® |
| POST | `/api/personalization/config/{user_id}` | æ›´æ–°ç”¨æˆ·é…ç½® |
| POST | `/api/personalization/config/{user_id}/apply-template` | åº”ç”¨æ¨¡æ¿ |
| GET | `/api/personalization/preview/{user_id}` | é¢„è§ˆPrompt |
| POST | `/api/personalization/feedback/{user_id}` | è®°å½•åé¦ˆ |

### 6.2 APIæµ‹è¯•ç¤ºä¾‹

#### è·å–è§’è‰²æ¨¡æ¿
```bash
curl http://localhost:8000/api/personalization/templates
```

#### è·å–ç”¨æˆ·é…ç½®
```bash
curl http://localhost:8000/api/personalization/config/test_user
```

#### æ›´æ–°é…ç½®
```bash
curl -X POST http://localhost:8000/api/personalization/config/test_user \
  -H "Content-Type: application/json" \
  -d '{
    "role": "æ™ºæ…§å¯¼å¸ˆ",
    "role_name": "æ™ºè€…",
    "tone": "æ²‰ç¨³",
    "empathy_level": 0.7
  }'
```

#### åº”ç”¨æ¨¡æ¿
```bash
curl -X POST "http://localhost:8000/api/personalization/config/test_user/apply-template?template_id=wise_mentor"
```

#### é¢„è§ˆPrompt
```bash
curl "http://localhost:8000/api/personalization/preview/test_user?context=ä»Šå¤©å¾ˆå¼€å¿ƒ&emotion=happy&intensity=8"
```

### 6.3 å“åº”ç¤ºä¾‹

**è·å–ç”¨æˆ·é…ç½®å“åº”**ï¼š
```json
{
  "user_id": "user_123",
  "config": {
    "role": "æ¸©æš–å€¾å¬è€…",
    "role_name": "å¿ƒè¯­",
    "tone": "æ¸©å’Œ",
    "style": "ç®€æ´",
    "formality": 0.3,
    "enthusiasm": 0.5,
    "empathy_level": 0.8,
    "humor_level": 0.3,
    "response_length": "medium",
    "use_emoji": false
  },
  "total_interactions": 45,
  "positive_feedbacks": 38,
  "config_version": 3
}
```

---

## ä¸ƒã€æŠ€æœ¯å®ç°

### 7.1 PromptåŠ¨æ€ç”Ÿæˆ

```python
def compose(self, context: str, emotion_state: Dict) -> str:
    # 1. è§’è‰²è®¾å®š
    role_prompt = self._build_role_prompt()
    
    # 2. è¡¨è¾¾é£æ ¼æŒ‡ä»¤
    style_prompt = self._build_style_prompt()
    
    # 3. æƒ…ç»ªæ„ŸçŸ¥æŒ‡ä»¤
    emotion_prompt = self._build_emotion_prompt(emotion_state)
    
    # 4. è®°å¿†ä¸åå¥½
    memory_prompt = self._build_memory_prompt()
    
    # 5. å®‰å…¨ä¸è¾¹ç•Œ
    safety_prompt = self._build_safety_prompt()
    
    # 6. ç»„è£…æœ€ç»ˆPrompt
    return f"""
    {base_prompt}
    {role_prompt}
    {style_prompt}
    {emotion_prompt}
    {memory_prompt}
    {safety_prompt}
    {context}
    """
```

### 7.2 ä¸å¯¹è¯æµç¨‹é›†æˆ

```python
async def _chat_with_memory(self, request: ChatRequest):
    # 1. è·å–ç”¨æˆ·é…ç½®
    personalization_service = get_personalization_service()
    user_config = personalization_service.get_user_config(user_id, db)
    
    # 2. åˆ›å»ºPromptç»„åˆå™¨
    composer = PromptComposer(user_config)
    
    # 3. ç”Ÿæˆä¸ªæ€§åŒ–Prompt
    personalized_prompt = composer.compose(
        context=context,
        emotion_state={"emotion": emotion, "intensity": emotion_intensity}
    )
    
    # 4. ä½¿ç”¨ä¸ªæ€§åŒ–Promptç”Ÿæˆå›å¤
    response = llm.generate(personalized_prompt)
```

### 7.3 æ•°æ®åº“è¿ç§»

```sql
CREATE TABLE user_personalizations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(100) UNIQUE NOT NULL,
    role VARCHAR(100) DEFAULT 'æ¸©æš–å€¾å¬è€…',
    role_name VARCHAR(100) DEFAULT 'å¿ƒè¯­',
    role_background TEXT,
    personality VARCHAR(100) DEFAULT 'æ¸©æš–è€å¿ƒ',
    core_principles TEXT,
    forbidden_behaviors TEXT,
    tone VARCHAR(50) DEFAULT 'æ¸©å’Œ',
    style VARCHAR(50) DEFAULT 'ç®€æ´',
    formality FLOAT DEFAULT 0.3,
    enthusiasm FLOAT DEFAULT 0.5,
    empathy_level FLOAT DEFAULT 0.8,
    humor_level FLOAT DEFAULT 0.3,
    response_length VARCHAR(20) DEFAULT 'medium',
    use_emoji BOOLEAN DEFAULT FALSE,
    preferred_topics TEXT,
    avoided_topics TEXT,
    communication_preferences TEXT,
    learning_mode BOOLEAN DEFAULT TRUE,
    safety_level VARCHAR(20) DEFAULT 'standard',
    context_window INT DEFAULT 10,
    situational_roles TEXT,
    active_role VARCHAR(50) DEFAULT 'default',
    total_interactions INT DEFAULT 0,
    positive_feedbacks INT DEFAULT 0,
    config_version INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);
```

---

## å…«ã€æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
```
backend/
â”œâ”€â”€ database.py                              # UserPersonalizationè¡¨å®šä¹‰
â”œâ”€â”€ models.py                                # Pydanticæ¨¡å‹
â”œâ”€â”€ routers/
â”‚   â”œâ”€â”€ __init__.py                          # å¯¼å‡ºpersonalization_router
â”‚   â””â”€â”€ personalization.py                   # ä¸ªæ€§åŒ–é…ç½®APIè·¯ç”±
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ prompt_composer.py                   # Promptç»„åˆå™¨
â”‚   â”œâ”€â”€ personalization_service.py           # ä¸ªæ€§åŒ–æœåŠ¡
â”‚   â””â”€â”€ chat_service_integration_example.py  # é›†æˆç¤ºä¾‹
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ add_personalization_table.sql        # æ•°æ®åº“è¿ç§»è„šæœ¬
â””â”€â”€ app.py                                   # æ³¨å†Œæ–°è·¯ç”±
```

### å‰ç«¯æ–‡ä»¶
```
frontend/
â””â”€â”€ src/
    â”œâ”€â”€ components/
    â”‚   â””â”€â”€ PersonalizationPanel.js          # é…ç½®é¢æ¿ç»„ä»¶
    â””â”€â”€ App.js                               # é›†æˆé…ç½®æŒ‰é’®
```

---

## ä¹ã€å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæ•°æ®åº“è¡¨ä¸å­˜åœ¨
**ç—‡çŠ¶**ï¼šAPIè¿”å›æ•°æ®åº“é”™è¯¯
**è§£å†³**ï¼š
```bash
cd backend/migrations
mysql -u root -p emotional_chat < add_personalization_table.sql
```

### é—®é¢˜2ï¼šå‰ç«¯æ— æ³•è¿æ¥åç«¯
**ç—‡çŠ¶**ï¼šå‰ç«¯æ˜¾ç¤º"åŠ è½½é…ç½®å¤±è´¥"
**æ£€æŸ¥**ï¼š
1. åç«¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼ˆè®¿é—® http://localhost:8000/healthï¼‰
2. CORSæ˜¯å¦æ­£ç¡®é…ç½®
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„ç½‘ç»œè¯·æ±‚

### é—®é¢˜3ï¼šé…ç½®æ— æ³•ä¿å­˜
**ç—‡çŠ¶**ï¼šç‚¹å‡»ä¿å­˜åæç¤ºå¤±è´¥
**è°ƒè¯•**ï¼š
```bash
cd backend
python main.py  # è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
```

### é—®é¢˜4ï¼šè§’è‰²æ¨¡æ¿ä¸æ˜¾ç¤º
**æ£€æŸ¥**ï¼š
```bash
curl http://localhost:8000/api/personalization/templates
# åº”è¯¥è¿”å›5ä¸ªæ¨¡æ¿
```

---

## åã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¯ç”¨é…ç½®ç¼“å­˜
é…ç½®å·²è‡ªåŠ¨ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥æ·»åŠ Redisç¼“å­˜æ›¿ä»£å†…å­˜ç¼“å­˜

### 2. æ•°æ®åº“ç´¢å¼•
```sql
CREATE INDEX idx_user_id ON user_personalizations(user_id);
```

### 3. å‰ç«¯ç¼“å­˜
```javascript
localStorage.setItem('user_config', JSON.stringify(config));
```

---

## åä¸€ã€å®‰å…¨è€ƒè™‘

### å®‰å…¨çº¢çº¿
- âŒ ç¦æ­¢åˆ›å»ºé¼“åŠ±è‡ªæ®‹ã€ä¼ æ’­è™šå‡ä¿¡æ¯çš„è§’è‰²
- âŒ æ‰€æœ‰ç”¨æˆ·è‡ªå®šä¹‰å†…å®¹éœ€ç»è¿‡æ•æ„Ÿè¯è¿‡æ»¤
- âœ… æ˜ç¡®å‘ŠçŸ¥ï¼š"AIä¸ä¼šçœŸæ­£æ‹¥æœ‰æƒ…æ„Ÿï¼Œæ‰€æœ‰å›åº”å‡ä¸ºç®—æ³•ç”Ÿæˆ"

### é˜²æ­¢è¿‡åº¦ä¾èµ–
- é•¿æ—¶é—´å¯¹è¯åæç¤º"å»ºè®®ä¸çœŸäººäº¤æµ"
- æä¾›å¿ƒç†å¥åº·èµ„æºé“¾æ¥
- è®¾è®¡"æ•°å­—æ’æ¯’"æ¨¡å¼

### æ•°æ®éšç§
- ç”¨æˆ·åå¥½æ•°æ®åŠ å¯†å­˜å‚¨
- æä¾›"ä¸€é”®æ¸…é™¤è®°å¿†"åŠŸèƒ½
- æ˜ç¡®å‘ŠçŸ¥æ•°æ®ç”¨é€”ï¼Œéµå®ˆGDPRç­‰æ³•è§„

---

## åäºŒã€åç»­è®¡åˆ’

### çŸ­æœŸ (1-2å‘¨)
- [ ] å®ŒæˆChatServiceé›†æˆ
- [ ] æ·»åŠ é…ç½®é¢„è§ˆåŠŸèƒ½
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–

### ä¸­æœŸ (1-2æœˆ)
- [ ] å®ç°æƒ…å¢ƒåŒ–è§’è‰²è‡ªåŠ¨åˆ‡æ¢
- [ ] æ”¯æŒç”¨æˆ·ä¸Šä¼ ä¸ªäººè¯­æ–™
- [ ] å¼€å‘è§’è‰²å·¥åŠï¼ˆUGCï¼‰
- [ ] å®ç°å­¦ä¹ æ¨¡å¼ï¼ˆè‡ªåŠ¨ä¼˜åŒ–ï¼‰

### é•¿æœŸ (3-6æœˆ)
- [ ] å¤šæ¨¡æ€ä¸ªæ€§åŒ–ï¼ˆå£°éŸ³ã€å½¢è±¡ï¼‰
- [ ] ç¤¾äº¤åŒ–åŠŸèƒ½ï¼ˆåˆ†äº«é…ç½®ï¼‰
- [ ] é«˜çº§åˆ†æä»ªè¡¨æ¿
- [ ] è·¨å¹³å°åŒæ­¥

---

## åä¸‰ã€è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®æ–°çš„è§’è‰²æ¨¡æ¿ï¼è¯·åœ¨`backend/services/prompt_composer.py`çš„`ROLE_TEMPLATES`ä¸­æ·»åŠ ï¼š

```python
"your_template_id": {
    "id": "your_template_id",
    "name": "è§’è‰²åç§°",
    "role": "è§’è‰²ç±»å‹",
    "personality": "æ€§æ ¼æè¿°",
    "tone": "è¯­æ°”",
    "style": "é£æ ¼",
    "description": "ç®€çŸ­æè¿°",
    "icon": "ğŸ”®",
    "background": "èƒŒæ™¯æ•…äº‹",
    "core_principles": ["åŸåˆ™1", "åŸåˆ™2"],
    "sample_responses": ["ç¤ºä¾‹1", "ç¤ºä¾‹2"]
}
```

---

## åå››ã€æ€»ç»“

ä¸ªæ€§åŒ–é…ç½®ç³»ç»ŸæˆåŠŸå®ç°äº†"å¿ƒè¯­"æœºå™¨äººä»æ ‡å‡†åŒ–AIå‘ä¸“å±æ•°å­—ä¼™ä¼´çš„è·ƒè¿ã€‚é€šè¿‡ï¼š

- âœ… **å®Œæ•´çš„ä¸‰å±‚æ¶æ„**ï¼šè¡¨è¾¾å±‚ã€è§’è‰²å±‚ã€è®°å¿†å±‚
- âœ… **5ä¸ªé¢„è®¾è§’è‰²æ¨¡æ¿**ï¼šæ»¡è¶³ä¸åŒç”¨æˆ·éœ€æ±‚
- âœ… **åŠ¨æ€Promptç”Ÿæˆ**ï¼šå®æ—¶é€‚é…ç”¨æˆ·é…ç½®å’Œæƒ…ç»ª
- âœ… **ç”¨æˆ·å‹å¥½ç•Œé¢**ï¼šç›´è§‚æ˜“ç”¨çš„é…ç½®ä½“éªŒ
- âœ… **å®Œå–„çš„æ–‡æ¡£**ï¼šå¿«é€Ÿä¸Šæ‰‹å’Œæ·±åº¦ç†è§£

**è®©æ¯ä¸€ä¸ªAIï¼Œéƒ½æˆä¸º"ä½ çš„AI"ï¼** ğŸŒŸ

---

**ç‰ˆæœ¬**: v1.0  
**å®Œæˆæ—¶é—´**: 2025-10-20  
**ä½œè€…**: è¢ä»å¾·  
**çŠ¶æ€**: âœ… å·²å®Œæˆ
